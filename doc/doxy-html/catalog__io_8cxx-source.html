<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>catalogAccess: catalog_io.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>catalog_io.cxx</h1><a href="catalog__io_8cxx.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00014 <span class="preprocessor">#include "<a class="code" href="catalog_8h.html">catalog.h</a>"</span>
00015 
00016 <span class="keyword">namespace </span>catalogAccess {
00017   <span class="keyword">using</span> <span class="keyword">namespace </span>tip;
00018 <span class="comment">/**********************************************************************/</span>
00019 <span class="comment">/*  DEFINING CLASS CONSTANTS                                          */</span>
00020 <span class="comment">/**********************************************************************/</span>
00021 
00022 <span class="comment">// BEWARE: the two constant below are UCD1 standard</span>
00023 <span class="comment">//         need to be changed for UCD1+</span>
00024 
00025 <span class="comment">// the order is important and must be compatible with s_CatalogGeneric</span>
00026 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_List[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00027        <span class="stringliteral">"ID_MAIN"</span>, <span class="stringliteral">"POS_EQ_RA_MAIN"</span>, <span class="stringliteral">"POS_EQ_DEC_MAIN"</span>,
00028         <span class="stringliteral">""</span>,       <span class="stringliteral">"POS_GAL_LON"</span>,    <span class="stringliteral">"POS_GAL_LAT"</span>};
00029 <span class="comment">// "ERROR", "POS_GAL_LON", "POS_GAL_LAT"</span>
00030 <span class="comment">// ERROR do not only refer to the position error</span>
00031 <span class="comment">// ERROR is for any "Uncertainty in Measurements"</span>
00032 
00033 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_Added[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00034        <span class="stringliteral">""</span>, <span class="stringliteral">"_RAJ2000"</span>, <span class="stringliteral">"_DEJ2000"</span>, <span class="stringliteral">""</span>, <span class="stringliteral">"_Glon"</span>, <span class="stringliteral">"_Glat"</span>};
00035 
00036 <span class="comment">// the 2 constants above are only defined in this file,</span>
00037 <span class="comment">// need to set catalog static members for global availability</span>
00038 
<a name="l00039"></a><a class="code" href="classcatalog_access_1_1_catalog.html#v3">00039</a> <span class="keyword">const</span> std::string Catalog::s_genericL = UCD_List[4];
<a name="l00040"></a><a class="code" href="classcatalog_access_1_1_catalog.html#v4">00040</a> <span class="keyword">const</span> std::string Catalog::s_genericB = UCD_List[5];
<a name="l00041"></a><a class="code" href="namespacecatalog_access.html#a2">00041</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a2">KeyCDS</a>[2]={<span class="stringliteral">"CDS-CAT"</span>,<span class="stringliteral">"CDS-NAME"</span>};
<a name="l00042"></a><a class="code" href="namespacecatalog_access.html#a3">00042</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a3">KeyCom</a>[2]={<span class="stringliteral">"Catalogue designation in CDS nomenclature"</span>,
00043                              <span class="stringliteral">"Table used in a VizieR Query"</span>};
<a name="l00044"></a><a class="code" href="namespacecatalog_access.html#a4">00044</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a4">Key_UCD</a>=<span class="stringliteral">"TBUCD"</span>;
<a name="l00045"></a><a class="code" href="namespacecatalog_access.html#a5">00045</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="namespacecatalog_access.html#a5">SepNull</a> = <span class="charliteral">'!'</span>;
00046 
00047 <span class="comment">/**********************************************************************/</span>
00048 <span class="comment">/*  METHODS for IMPORTING, SAVING, LOADING                            */</span>
00049 <span class="comment">/**********************************************************************/</span>
00050 
00051 <span class="comment">// set m_posErrFactor, suppose that Quantity index exist (private method)</span>
<a name="l00052"></a><a class="code" href="classcatalog_access_1_1_catalog.html#d10">00052</a> <span class="keywordtype">void</span> Catalog::setPosErrFactor(<span class="keyword">const</span> <span class="keywordtype">int</span> index) {
00053 
00054   std::string text=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[index].m_unit;
00055   <span class="keywordflow">if</span> ( text.empty() ) {
00056     std::ostringstream sortie;
00057     sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; m_quantities[index].m_name
00058            &lt;&lt; <span class="stringliteral">") has no unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#r9">m_posErrFactor</a>;
00059     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00060   }
00061   <span class="keywordflow">else</span> {
00062     <span class="comment">// use explicit cast to be sure compiler choose the right tolower()</span>
00063     std::transform(text.begin(), text.end(), text.begin(), (int(*)(<span class="keywordtype">int</span>)) tolower);
00064     <span class="keywordflow">if</span> (text == <span class="stringliteral">"deg"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#r9">m_posErrFactor</a>=1.0;
00065     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcsec"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#r9">m_posErrFactor</a>=3600.0;
00066     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcmin"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#r9">m_posErrFactor</a>=60.0;
00067     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"rad"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#r9">m_posErrFactor</a>=1.0/Angle_Conv;
00068     <span class="keywordflow">else</span> {
00069       std::ostringstream sortie;
00070       sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; m_quantities[index].m_name
00071              &lt;&lt; <span class="stringliteral">") has unknown unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#r9">m_posErrFactor</a>;
00072       <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00073     }
00074   }
00075 }
00076 <span class="comment">// search for generic quantities, private: suppose import done (private method)</span>
<a name="l00077"></a><a class="code" href="classcatalog_access_1_1_catalog.html#d11">00077</a> <span class="keywordtype">void</span> Catalog::setGeneric(<span class="keyword">const</span> <span class="keywordtype">int</span> whichCat) {
00078 
00079   <span class="keyword">const</span> std::string epoch=<span class="stringliteral">"J2000"</span>;
00080   <span class="keywordtype">int</span> max=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size();
00081   <span class="keywordtype">int</span> j;
00082   std::string text, name;
00083   <a class="code" href="classcatalog_access_1_1_catalog.html#r26">m_indexErr</a>= -1;
00084   <a class="code" href="classcatalog_access_1_1_catalog.html#r27">m_indexRA</a> = -1;
00085   <a class="code" href="classcatalog_access_1_1_catalog.html#r28">m_indexDEC</a>= -1;
00086   std::vector&lt;Quantity&gt;::iterator itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.begin();
00087   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.end(); ++itQ, ++i) {
00088 
00089     <span class="keywordflow">if</span> ((whichCat &gt;= 0) &amp;&amp; (whichCat &lt; <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>)) {
00090       <span class="comment">// if it is a known catalog, the generic are defined</span>
00091       text=itQ-&gt;m_name;
00092       <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) {
00093         name=Catalog::s_CatalogGeneric[whichCat][j];
00094         <span class="keywordflow">if</span> (name == <span class="stringliteral">"+"</span>) name=UCD_Added[j];
00095         <span class="keywordflow">if</span> (text == name) {
00096           itQ-&gt;m_isGeneric=<span class="keyword">true</span>;
00097           <span class="keywordflow">switch</span> (j) {
00098             <span class="keywordflow">case</span> 1: <a class="code" href="classcatalog_access_1_1_catalog.html#r27">m_indexRA</a>=i;
00099             <span class="keywordflow">break</span>;
00100             <span class="keywordflow">case</span> 2: <a class="code" href="classcatalog_access_1_1_catalog.html#r28">m_indexDEC</a>=i;
00101             <span class="keywordflow">break</span>;
00102             <span class="keywordflow">case</span> 3: <a class="code" href="classcatalog_access_1_1_catalog.html#r26">m_indexErr</a>=i;
00103                     <a class="code" href="classcatalog_access_1_1_catalog.html#d10">setPosErrFactor</a>(i);
00104             <span class="keywordflow">break</span>;
00105             <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
00106           }
00107         }
00108       }<span class="comment">// loop on generic</span>
00109       text=itQ-&gt;m_ucd;
00110     }
00111 
00112     <span class="keywordflow">else</span> {
00113       <span class="comment">// otherwise, take first matching UCD</span>
00114       text=itQ-&gt;m_ucd;
00115       <span class="keywordflow">if</span> (text != <span class="stringliteral">""</span>) <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) { 
00116         <span class="keywordflow">if</span> (text == UCD_List[j]) {
00117           itQ-&gt;m_isGeneric=<span class="keyword">true</span>;
00118           <span class="keywordflow">if</span> ((j == 1) || (j == 2)) {
00119             <span class="comment">// check that epoch is J2000</span>
00120             name=itQ-&gt;m_name;
00121             name.erase(0, name.length()-epoch.length());
00122             <span class="comment">// format contains at least 1 char</span>
00123             <span class="keywordflow">if</span> ((name == epoch) &amp;&amp; (itQ-&gt;m_type == Quantity::NUM)) {
00124               <span class="keywordflow">if</span> (j == 1) <a class="code" href="classcatalog_access_1_1_catalog.html#r27">m_indexRA</a>=i;
00125               <span class="keywordflow">else</span>        <a class="code" href="classcatalog_access_1_1_catalog.html#r28">m_indexDEC</a>=i;
00126             }
00127             <span class="keywordflow">else</span> itQ-&gt;m_isGeneric=<span class="keyword">false</span>;
00128           }
00129           <span class="keywordflow">break</span>;
00130         }
00131       }<span class="comment">// loop on generic</span>
00132     }
00133 
00134     <span class="comment">// flag error quantities, useless for already found generic</span>
00135     <span class="keywordflow">if</span> ((text == <span class="stringliteral">"ERROR"</span>) &amp;&amp; (!itQ-&gt;m_isGeneric)) {
00136       <span class="comment">// error column name is e_"associated column" except for position error</span>
00137       text=itQ-&gt;m_name;
00138       <span class="keywordflow">if</span> (text.find(<span class="stringliteral">"e_"</span>) == 0) {
00139         text.erase(0, 2);
00140 <span class="preprocessor">        #ifdef DEBUG_CAT</span>
00141 <span class="preprocessor"></span>        std::cout &lt;&lt; <span class="stringliteral">"ERROR column ("</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; std::endl;
00142 <span class="preprocessor">        #endif</span>
00143 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (j=0; j&lt;max; j++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.at(j).m_name == text) {
00144           itQ-&gt;m_statError=text;
00145           <span class="keywordflow">break</span>;
00146         }
00147       }
00148       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((text == <span class="stringliteral">"PosErr"</span>) || (text == <span class="stringliteral">"ErrorRad"</span>)) {
00149         itQ-&gt;m_isGeneric=<span class="keyword">true</span>;
00150         <a class="code" href="classcatalog_access_1_1_catalog.html#r26">m_indexErr</a>=i;
00151         <a class="code" href="classcatalog_access_1_1_catalog.html#d10">setPosErrFactor</a>(i);
00152       }
00153     }
00154 
00155   }<span class="comment">// loop on quantities</span>
00156 
00157   <span class="comment">/* since RA, DEC columns can be erased while importSelected() */</span>
00158   <span class="comment">/* must update the existence of elliptical region */</span>
00159   <span class="keywordflow">if</span> ((<a class="code" href="classcatalog_access_1_1_catalog.html#r27">m_indexRA</a> &lt; 0) || (<a class="code" href="classcatalog_access_1_1_catalog.html#r28">m_indexDEC</a> &lt; 0)) <a class="code" href="classcatalog_access_1_1_catalog.html#r19">m_selRegion</a>=<span class="keyword">false</span>;
00160 }
00161 
00162 <span class="comment">/**********************************************************************/</span>
00163 <span class="comment">// return the number of RAM bytes needed for numRows catalog rows</span>
<a name="l00164"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a5">00164</a> <span class="keywordtype">long</span> Catalog::getRAMsize(<span class="keyword">const</span> <span class="keywordtype">long</span> numRows, <span class="keyword">const</span> <span class="keywordtype">bool</span> writeLog) {
00165 
00166   std::string mot, text;
00167   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size();
00168   <span class="keywordflow">if</span> (quantSize == 0) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a16">IMPORT_NEED</a>;
00169 
00170   <span class="keywordtype">int</span> nD=0, nS=0, nchar=0;
00171   <span class="keywordtype">int</span> i, j;
00172   std::vector&lt;Quantity&gt;::iterator itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.begin();
00173   <span class="keywordflow">for</span> (; itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.end(); ++itQ) {
00174     <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::NUM) nD++;
00175     <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (itQ-&gt;m_type == Quantity::STRING) {
00176       nS++;
00177       text=itQ-&gt;m_format;
00178       i=text.length();
00179       <span class="keywordflow">if</span> (i &gt; 1) {
00180         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r1">m_URL</a> == <span class="stringliteral">"CDS"</span>) text.erase(0, 1);
00181         <span class="keywordflow">else</span> text.erase(i-1);
00182         j=std::atoi(text.c_str());
00183         <span class="keywordflow">if</span> (j &gt; 0) nchar+=j;
00184       }
00185     }
00186   }
00187   <span class="keywordtype">char</span> buffer[50];
00188   <span class="keywordtype">long</span> sizeD=nD*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*numRows;
00189   <span class="keywordtype">long</span> sizeS=nchar*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)*numRows;
00190   i=1+(quantSize+1)/(<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)*8);
00191   <span class="keywordtype">long</span> sizeB=i*<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)*numRows;
00192   <span class="keywordflow">if</span> (writeLog &amp;&amp; (<a class="code" href="classcatalog_access_1_1_catalog.html#r14">m_numOriRows</a> &gt; 0)) {
00193     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, <a class="code" href="classcatalog_access_1_1_catalog.html#r14">m_numOriRows</a>);
00194     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00195     text=<span class="stringliteral">"Original whole catalog number of rows = "</span>+mot;
00196     <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, text);
00197   }
00198   <span class="keywordflow">if</span> (numRows &lt;= 0) <span class="keywordflow">return</span> 0;
00199   <span class="keywordflow">if</span> (writeLog) {
00200     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, numRows);
00201     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00202     text=<span class="stringliteral">"Needed RAM space (MB) for "</span>+mot;
00203     sprintf(buffer, <span class="stringliteral">"%5.1f"</span>, (sizeD+sizeS+sizeB)/(1024.*1024.));
00204     mot=buffer;
00205     text=text+<span class="stringliteral">" data rows = "</span>+mot+<span class="stringliteral">"\n"</span>;
00206     sprintf(buffer, <span class="stringliteral">"%5.0f kB for numericals (%3d double per row)"</span>,
00207                    sizeD/1024., nD);
00208     mot=buffer;
00209     text=text+mot+<span class="stringliteral">"\n"</span>;
00210     sprintf(buffer, <span class="stringliteral">"%5.0f kB for %2d strings (%3d char per row)"</span>,
00211                    sizeS/1024., nS, nchar);
00212     mot=buffer;
00213     text=text+mot+<span class="stringliteral">"\n"</span>;
00214     sprintf(buffer, <span class="stringliteral">"%5.0f kB for select bits (%2d long per row)"</span>,
00215                    sizeB/1024., i);
00216     mot=buffer;
00217     text=text+mot;
00218     <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, text);
00219   }
00220   <span class="keywordflow">return</span> (sizeD+sizeS+sizeB);
00221 }
00222 
00223 
00224 <span class="comment">/**********************************************************************/</span>
00225 <span class="comment">// creates a new column in m_strings, m_numericals (private method)</span>
<a name="l00226"></a><a class="code" href="classcatalog_access_1_1_catalog.html#d12">00226</a> <span class="keywordtype">void</span> Catalog::create_tables(<span class="keyword">const</span> <span class="keywordtype">int</span> nbQuantAscii, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRows) {
00227 
00228   <span class="keywordtype">int</span> vecSize;
00229   std::string errText;
00230   <span class="keywordflow">if</span> (nbQuantAscii &gt; 0) {
00231     <span class="keywordflow">try</span> {
00232       <a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>.resize(nbQuantAscii);
00233     }
00234     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00235       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00236       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00237       <span class="keywordflow">throw</span>;
00238     }
00239   }
00240   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size()-nbQuantAscii;
00241 <span class="comment">// printf("sizes = %d , %d\n", nbQuantAscii, vecSize);</span>
00242   <span class="keywordflow">if</span> (vecSize &gt; 0) {
00243     <span class="keywordflow">try</span> {
00244       <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>.resize(vecSize);
00245     }
00246     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00247       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00248       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00249       <span class="keywordflow">throw</span>;
00250     }
00251   }
00252   <span class="keywordflow">if</span> (maxRows &gt; 0) <a class="code" href="classcatalog_access_1_1_catalog.html#d13">add_rows</a>(maxRows);
00253 
00254 }
00255 <span class="comment">/**********************************************************************/</span>
00256 <span class="comment">// creates a new row in m_strings, m_numericals (private method)</span>
<a name="l00257"></a><a class="code" href="classcatalog_access_1_1_catalog.html#d13">00257</a> <span class="keywordtype">void</span> Catalog::add_rows(<span class="keyword">const</span> <span class="keywordtype">long</span> maxRows) {
00258 
00259   <span class="keywordtype">int</span> i, vecSize;
00260   std::string errText;
00261 <span class="comment">// printf("!! %ld / %ld \n", m_numRows, maxRows);</span>
00262   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>.size();
00263   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00264     <span class="keywordflow">try</span> {
00265       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) {
00266         <a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>[i].resize(maxRows);
00267 <span class="comment">//        for (j=0; j&lt;maxRows; j++) m_strings[i].at(j).resize(20);</span>
00268       }
00269     }
00270     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00271       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00272       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00273       <span class="keywordflow">throw</span>;
00274     }
00275   }
00276   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>.size();
00277   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00278     <span class="keywordflow">try</span> {
00279       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[i].resize(maxRows);
00280     }
00281     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00282       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00283       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00284       <span class="keywordflow">throw</span>;
00285     }
00286   } 
00287 
00288 }
00289 
00290 
00291 <span class="comment">/**********************************************************************/</span>
00292 <span class="comment">// read the catalog from fits file (only description if getDescr is true)</span>
<a name="l00293"></a><a class="code" href="classcatalog_access_1_1_catalog.html#d15">00293</a> <span class="keywordtype">int</span> Catalog::analyze_fits(<span class="keyword">const</span> Table *myDOL, <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr,
00294                           <span class="keyword">const</span> std::string origin, <span class="keywordtype">long</span> *maxRows) {
00295   std::string text, mot;
00296   <span class="keywordtype">int</span>   i, j, max,
00297         nbQuantAscii=0;
00298   <span class="keywordtype">char</span>  name[9]; <span class="comment">/* 8 char maximum for header key */</span>
00299   <span class="keywordtype">bool</span>  binary=<span class="keyword">true</span>;
00300   <span class="keywordtype">short</span> test;
00301   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
00302   int (*pfunc)(<span class="keywordtype">int</span>)=toupper; <span class="comment">// function used by transform</span>
00303   Header &amp;header=myDOL-&gt;getHeader();
00304 
00305   <span class="keywordflow">try</span> {
00306     text=myDOL-&gt;getName();
00307     header.getKeyword(<span class="stringliteral">"XTENSION"</span>, mot);
00308   <span class="comment">/* text.rfind('_');</span>
00309 <span class="comment">    since '/' are replaced by '_' in EXTNAME</span>
00310 <span class="comment">    and  is ambiguous with '_' in catalog name:</span>
00311 <span class="comment">    must search for keywords CDS-CAT  CDS-NAME</span>
00312 <span class="comment">  */</span>
00313   }
00314   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00315     text=<span class="stringliteral">": fits EXTENSION, cannot get name"</span>;
00316     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00317     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00318   }
00319   std::ostringstream sortie;
00320   sortie &lt;&lt; <span class="stringliteral">"fits extension "</span> &lt;&lt; mot &lt;&lt; <span class="stringliteral">" name = "</span> &lt;&lt; text;
00321   <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, sortie.str());
00322   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00323 
00324   <a class="code" href="classcatalog_access_1_1_catalog.html#r2">m_catName</a>=<span class="stringliteral">""</span>;   <a class="code" href="classcatalog_access_1_1_catalog.html#r3">m_catRef</a>=<span class="stringliteral">""</span>;
00325   <a class="code" href="classcatalog_access_1_1_catalog.html#r4">m_tableName</a>=<span class="stringliteral">""</span>; <a class="code" href="classcatalog_access_1_1_catalog.html#r5">m_tableRef</a>=<span class="stringliteral">""</span>;
00326   <a class="code" href="classcatalog_access_1_1_catalog.html#r1">m_URL</a>=<span class="stringliteral">""</span>;
00327   <span class="keywordflow">if</span> (mot == <span class="stringliteral">"TABLE"</span>) {
00328     binary=<span class="keyword">false</span>;
00329     <a class="code" href="classcatalog_access_1_1_catalog.html#r1">m_URL</a>=<span class="stringliteral">"CDS"</span>; <span class="comment">/* to know that format string need to be changed for fits */</span>
00330   }
00331   <span class="keywordflow">try</span> {
00332     test=-1;
00333 <span class="comment">//    Header::Iterator itor_found;</span>
00334     <span class="keywordflow">for</span> (Header::Iterator itor=header.begin(); itor != header.end(); ++itor) {
00335       mot=itor-&gt;getName();
00336       <span class="comment">// long comment from wanted key</span>
00337       <span class="keywordflow">if</span> ( mot.empty() ) { <span class="keywordflow">switch</span> (test) {
00338         <span class="keywordflow">case</span> 0: text=itor-&gt;getComment();
00339 <span class="comment">/*                m_catRef=itor_found-&gt;getComment()+text;*/</span>
00340                 <a class="code" href="classcatalog_access_1_1_catalog.html#r3">m_catRef</a>=text;
00341                 <span class="keywordflow">break</span>;
00342         <span class="keywordflow">case</span> 1: text=itor-&gt;getComment();
00343 <span class="comment">/*                m_tableRef=itor_found-&gt;getComment()+text;*/</span>
00344                 <a class="code" href="classcatalog_access_1_1_catalog.html#r5">m_tableRef</a>=text;
00345                 <span class="keywordflow">break</span>;
00346         <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
00347       } }
00348       <span class="keywordflow">else</span> {
00349         <span class="keywordflow">if</span> (mot == <a class="code" href="namespacecatalog_access.html#a2">KeyCDS</a>[0]) {
00350           test=0; <span class="comment">//itor_found=itor;</span>
00351           <a class="code" href="classcatalog_access_1_1_catalog.html#r2">m_catName</a>=itor-&gt;getValue();
00352         }
00353         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mot == <a class="code" href="namespacecatalog_access.html#a2">KeyCDS</a>[1]) {
00354           test=1; <span class="comment">//itor_found=itor;</span>
00355           <a class="code" href="classcatalog_access_1_1_catalog.html#r4">m_tableName</a>=itor-&gt;getValue();
00356         }
00357         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (test &gt;= 0) test=2;
00358       }<span class="comment">// end of non-empty key</span>
00359     }
00360   }
00361   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00362     text=<span class="stringliteral">": fits EXTENSION, cannot read header"</span>;
00363     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00364     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00365   }
00366   <span class="keywordflow">if</span> (test &lt; 1) {
00367     <span class="keywordflow">if</span> (binary) {
00368       <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, <span class="stringliteral">"fits EXTENSION, cannot get CDS header keys"</span>);
00369     }
00370     <span class="keywordflow">else</span> {
00371       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get CDS header keys"</span>);
00372       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00373     }
00374   }
00375 <span class="comment">//  const Table::FieldCont &amp;allCol=myDOL-&gt;getValidFields();</span>
00376   <span class="keywordflow">try</span> {
00377     max=myDOL-&gt;getValidFields().size();
00378     <a class="code" href="classcatalog_access_1_1_catalog.html#r14">m_numOriRows</a>=myDOL-&gt;getNumRecords();
00379   }
00380   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00381     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get number of rows or columns"</span>);
00382     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00383   }
00384   <span class="keywordflow">if</span> (max &lt; 1) {
00385     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, need at least 1 column"</span>);
00386     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00387   }
00388   text=<span class="stringliteral">""</span>;
00389   std::vector&lt;double&gt; colNull(max, 0.0);
00390   <span class="keywordflow">try</span> {
00391     <span class="keyword">const</span> IColumn *myCol = 0;
00392     <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00393       text=<span class="stringliteral">""</span>;
00394       myCol=myDOL-&gt;getColumn(i);
00395       <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
00396       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>=myCol-&gt;getId();
00397       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o6">m_unit</a>=myCol-&gt;getUnits();
00398       sprintf(name, <span class="stringliteral">"TFORM%d"</span>, i+1);
00399       mot=name; <span class="comment">/* convert C string to C++ string */</span>
00400 <span class="comment">//      mot=myCol-&gt;getColumnKeyword("TFORM");</span>
00401       header.getKeyword(mot, text);
00402       std::transform(text.begin(), text.end(), text.begin(), pfunc);
00403       j=text.length();
00404       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o3">m_format</a>=text;
00405       text=<span class="stringliteral">""</span>;
00406       <span class="keywordflow">if</span> (binary) {
00407         <span class="keywordflow">if</span> ( !myCol-&gt;isScalar() ) {
00408           text=<span class="stringliteral">"unauthorized FITS TABLE vector"</span>;
00409           sortie &lt;&lt; <span class="stringliteral">": VECTOR not supported, column#"</span> &lt;&lt; i+1;
00410           <span class="keywordflow">throw</span> std::runtime_error(text);
00411         }
00412         <span class="keywordflow">if</span> (j == 0) {
00413           text=<span class="stringliteral">"unauthorized FITS empty format "</span>;
00414           sortie &lt;&lt; <span class="stringliteral">": FITS format is empty, column#"</span> &lt;&lt; i+1;
00415           <span class="keywordflow">throw</span> std::runtime_error(text);
00416         }
00417         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o3">m_format</a>[j-1] == <span class="charliteral">'A'</span>) readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a>=Quantity::STRING;
00418         <span class="keywordflow">else</span> readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a>=Quantity::NUM;
00419         sprintf(name, <span class="stringliteral">"TNULL%d"</span>, i+1); mot=name;
00420         <span class="keywordflow">try</span> { header.getKeyword(mot, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>); }
00421         <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00422         colNull.at(i)=atof(readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>.c_str());
00423         <span class="keywordflow">if</span> ( !readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>.empty() ) {
00424           sprintf(name, <span class="stringliteral">"TSCAL%d"</span>, i+1); mot=name;
00425           <span class="keywordflow">try</span> { header.getKeyword(mot, text); }
00426           <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00427           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>+=<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>+text;
00428           <span class="keywordflow">if</span> ( !text.empty() ) colNull.at(i)*=atof(text.c_str());
00429           text=<span class="stringliteral">""</span>;
00430           sprintf(name, <span class="stringliteral">"TZERO%d"</span>, i+1); mot=name;
00431           <span class="keywordflow">try</span> { header.getKeyword(mot, text); }
00432           <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00433           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>+=<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>+text;
00434           <span class="keywordflow">if</span> ( !text.empty() ) colNull.at(i)+=atof(text.c_str());
00435           text=<span class="stringliteral">""</span>;
00436         }
00437 <span class="comment">// printf("'%s'\n",  readQ.m_null.c_str() );</span>
00438         sprintf(name, <span class="stringliteral">"%s%d"</span>, <a class="code" href="namespacecatalog_access.html#a4">Key_UCD</a>.c_str(), i+1); mot=name;
00439         <span class="keywordflow">try</span> {
00440           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o1">m_comment</a>=header.getKeyComment(mot);
00441           header.getKeyword(mot, text);
00442         }
00443         <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00444           sortie &lt;&lt; <span class="stringliteral">"missing keyword "</span> &lt;&lt; mot &lt;&lt; <span class="stringliteral">" for column#"</span> &lt;&lt; i+1;
00445           <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, sortie.str() );
00446           sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00447         }
00448       }
00449       <span class="keywordflow">else</span> {
00450         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o3">m_format</a>[0] == <span class="charliteral">'A'</span>) readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a>=Quantity::STRING;
00451         <span class="keywordflow">else</span> readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a>=Quantity::NUM;
00452         sprintf(name, <span class="stringliteral">"TBCOL%d"</span>, i+1); mot=name;
00453         text=header.getKeyComment(mot);
00454         j=4;
00455         <span class="keywordflow">if</span> (text.substr(0,j) == <span class="stringliteral">"UCD="</span>) text.erase(0,j);
00456         pos=text.find(<span class="charliteral">'.'</span>);
00457         <span class="keywordflow">if</span> (pos != std::string::npos) text.erase(pos);
00458         <span class="comment">/* ONLY  readQ.m_comment  IS NOT SET */</span>
00459       }
00460       std::transform(text.begin(), text.end(), text.begin(), pfunc);
00461       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o2">m_ucd</a>=text;
00462       <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a> == Quantity::STRING) {
00463         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o7">m_index</a>=nbQuantAscii;
00464         nbQuantAscii++;
00465       }
00466       <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a> == Quantity::NUM) {
00467         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o7">m_index</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size()-nbQuantAscii;
00468         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a>=Quantity::NUM;
00469       }
00470       <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.push_back(readQ); }
00471       <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00472         text=std::string(<span class="stringliteral">"EXCEPTION filling m_quantities: "</span>)+prob.what();
00473         sortie &lt;&lt; text;
00474         <span class="keywordflow">throw</span>;
00475       }
00476     }<span class="comment">/* loop on columns */</span>
00477   }
00478   <span class="keywordflow">catch</span> (...) {
00479     <a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.clear();
00480     j=<a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00481     <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=j;
00482     <span class="keywordflow">if</span> ( text.empty() ) {
00483       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, error reading TABLE column#"</span>;
00484       sortie &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">" description"</span>;
00485       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00486     }
00487     <span class="keywordflow">else</span> {
00488       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00489       <span class="comment">// exception sent only for vector allocation</span>
00490       <span class="keywordflow">if</span> (text == sortie.str() ) <span class="keywordflow">throw</span>;
00491     }
00492     <span class="keywordflow">return</span> j;
00493   }
00494 <span class="comment">// printf("numRows=%ld\n", m_numOriRows );</span>
00495   <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=0;
00496   <span class="keywordflow">if</span> ( !*maxRows ) *maxRows=<a class="code" href="classcatalog_access_1_1_catalog.html#r14">m_numOriRows</a>;
00497   <span class="keywordflow">if</span> ((getDescr) || (m_numOriRows == 0)) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00498 
00499   <a class="code" href="classcatalog_access_1_1_catalog.html#d12">create_tables</a>(nbQuantAscii, *maxRows);
00500   <span class="keywordflow">try</span> {
00501     <span class="keywordtype">double</span> rowVal;
00502     std::vector&lt;Quantity&gt;::iterator itQ;
00503     <span class="comment">// Loop over all records (rows) and extract values</span>
00504     <span class="keywordflow">for</span> (Table::ConstIterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end();
00505          ++itor) {
00506       i=0;
00507       <span class="keywordflow">for</span> (itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.begin(); itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.end(); ++itQ, ++i) {
00508         j=itQ-&gt;m_index;
00509         <span class="comment">// double variable to hold the value of all the numeric fields</span>
00510         <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::NUM) {
00511           rowVal=(*itor)[itQ-&gt;m_name].get();
00512           <span class="keywordflow">if</span> ( itQ-&gt;m_null.empty() ) <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>)=rowVal;
00513           <span class="keywordflow">else</span> {
00514             <span class="keywordflow">if</span> (rowVal == colNull.at(i)) <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>)=MissNAN;
00515             <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>)=rowVal;
00516           }
00517         }
00518         <span class="keywordflow">else</span> (*itor)[itQ-&gt;m_name].get(<a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>) );
00519       }
00520       <span class="keywordflow">if</span> (++<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a> == *maxRows) <span class="keywordflow">break</span>;
00521     }<span class="comment">/* loop on rows*/</span>
00522   }
00523   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00524     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot read after row#"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>+1;
00525     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00526     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a24">BAD_ROW</a>;
00527   }
00528   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00529 }
00530 <span class="comment">/**********************************************************************/</span>
00531 <span class="comment">/* PRIVATE METHODS analyze_head, analyze_body in file "catalog_ioText.cxx" */</span>
00532 <span class="comment">/**********************************************************************/</span>
00533 <span class="comment">// common code between import and importDescription (private method)</span>
<a name="l00534"></a><a class="code" href="classcatalog_access_1_1_catalog.html#d18">00534</a> <span class="keywordtype">int</span> Catalog::load(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string ext,
00535                   <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr, <span class="keywordtype">long</span> *maxRows) {
00536 
00537   <span class="keywordtype">int</span> i, err=<a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00538   std::string origin, text;
00539   <span class="keywordflow">if</span> (getDescr) origin=<span class="stringliteral">"importDescription"</span>; <span class="keywordflow">else</span> origin=<span class="stringliteral">"import"</span>;
00540 
00541   <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=0;
00542   i=fileName.length();
00543   <span class="keywordflow">if</span> (i == 0) {
00544     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
00545     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00546     err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
00547     <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=err;
00548     <span class="keywordflow">return</span> err;
00549   }
00550   std::fstream myFile (fileName.c_str(), std::ios::in);
00551   <span class="comment">// file can be opened ?</span>
00552   <span class="keywordflow">if</span> ( !myFile.is_open() ) {
00553     text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" cannot be opened"</span>;
00554     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00555     err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
00556     <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=err;
00557     <span class="keywordflow">return</span> err;
00558   }
00559 <span class="comment">/*  DIR *testDir=opendir(fileName.c_str());</span>
00560 <span class="comment">  if (testDir != NULL) {</span>
00561 <span class="comment">    closedir(testDir);</span>
00562 <span class="comment">    text=": FILENAME \""+fileName+"\" is a directory";</span>
00563 <span class="comment">    printErr(origin, text);</span>
00564 <span class="comment">    err=BAD_FILETYPE;</span>
00565 <span class="comment">    m_numRows=err;</span>
00566 <span class="comment">    return err;</span>
00567 <span class="comment">  }*/</span>
00568   myFile.close();
00569   std::ostringstream sortie;
00570   <span class="keywordtype">bool</span>  myTest;
00571   <span class="keyword">const</span> Extension *myEXT = 0;
00572   <span class="comment">// cannot use readTable because FITS IMAGE returns also error 1</span>
00573   <span class="keywordflow">try</span> {
00574     myEXT=IFileSvc::instance().readExtension(fileName, ext);
00575   }
00576   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00577     err=x.code();
00578     <span class="keywordflow">if</span> (err == 1) {
00579       <span class="comment">// This non-cfitsio error number means the file does not exist</span>
00580       <span class="comment">// or is not a table, or is not either Root nor Fits format. </span>
00581       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00582 <span class="comment">/*      printWarn(origin, "FILENAME is NOT fits");*/</span>
00583     }
00584     <span class="keywordflow">else</span> {
00585       <span class="comment">// Other errors come from cfitsio, but apply to a file</span>
00586       <span class="comment">// which is in FITS format but has some sort of format error.</span>
00587       sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but cfitsio returned error="</span> &lt;&lt; err;
00588       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00589       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00590       <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=err;
00591       <span class="keyword">delete</span> myEXT;
00592       <span class="keywordflow">return</span> err;
00593     }
00594   }
00595   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) myTest=myEXT-&gt;isTable();
00596   <span class="keyword">delete</span> myEXT;
00597   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) {
00598  
00599     <span class="keywordflow">if</span> (!myTest) {
00600       text=<span class="stringliteral">": FILENAME is FITS, but NOT a TABLE"</span>;
00601       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00602       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00603       <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=err;
00604       <span class="keywordflow">return</span> err;
00605     }
00606     <span class="keyword">const</span> Table *myDOL = 0;
00607     <span class="keywordflow">try</span> {
00608       myDOL=IFileSvc::instance().readTable(fileName, ext);
00609     }
00610     <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00611       sortie &lt;&lt; <span class="stringliteral">": FITS is TABLE, but cfitsio returned error="</span> &lt;&lt; x.code();
00612       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00613       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00614       <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=err;
00615       <span class="keyword">delete</span> myDOL;
00616       <span class="keywordflow">return</span> err;
00617     }
00618     <span class="keyword">const</span> <span class="keywordtype">char</span> lf = 0x0A;
00619     <a class="code" href="classcatalog_access_1_1_catalog.html#r6">m_filename</a>=fileName+lf+ext;
00620     err=<a class="code" href="classcatalog_access_1_1_catalog.html#d15">analyze_fits</a>(myDOL, getDescr, origin, maxRows);
00621     <span class="keyword">delete</span> myDOL;
00622 
00623   }
00624   <span class="keywordflow">else</span> { <span class="comment">// (err == BAD_FITS)</span>
00625 
00626     err=<a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00627     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of lines read</span>
00628     <span class="keywordtype">bool</span> testCR=<span class="keyword">false</span>; <span class="comment">// true if lines ends with CR (on windows)</span>
00629     <span class="keywordtype">int</span> what=0;        <span class="comment">// 0 for unkwown, &gt;0 for csv, &lt;0 to tsv</span>
00630                        <span class="comment">// fabs()=1 for standard, =2 for meta QUERY</span>
00631 
00632     myFile.open(fileName.c_str(), std::ios::in);
00633     err=<a class="code" href="classcatalog_access_1_1_catalog.html#d16">analyze_head</a>(&amp;tot, &amp;what, &amp;testCR, &amp;myFile);
00634     <span class="keywordflow">if</span> (!tot) {
00635       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is fits without extension[] "</span>
00636              &lt;&lt; <span class="stringliteral">"specified"</span>;
00637       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00638       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00639       text=<span class="stringliteral">"input file"</span>;
00640       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
00641       <span class="comment">// in case, for strange reason, file.good() fails at first time</span>
00642     }
00643     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) {
00644       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is empty or "</span>
00645              &lt;&lt; <span class="stringliteral">"has unknown structure (stopped step "</span> &lt;&lt; -1*err &lt;&lt; <span class="stringliteral">")"</span>;
00646       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00647       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00648       text=<span class="stringliteral">"input file"</span>;
00649       <span class="keywordflow">if</span> (err == 0) err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>; <span class="comment">/* nothing is read */</span>
00650       <span class="keywordflow">else</span> err=<a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>; <span class="comment">/* can search if catalog name exist */</span>
00651     }
00652     <span class="keywordflow">else</span> {
00653 
00654       <span class="comment">//what is 1 or 2, then negate if TSV type</span>
00655       <span class="keywordflow">if</span> (what == 1) text=<span class="stringliteral">"input text file"</span>;
00656       <span class="keywordflow">else</span> text=<span class="stringliteral">"input META file"</span>;
00657 
00658       <span class="comment">// get columns description and units, data</span>
00659       err=<a class="code" href="classcatalog_access_1_1_catalog.html#d17">analyze_body</a>(&amp;tot, &amp;what, testCR, getDescr, &amp;myFile, maxRows);
00660       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a21">BAD_FILELINE</a>) {
00661         <span class="comment">// stopped before reading needed stuff (with getDescr false)</span>
00662         text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" couldn't be read (line too long)"</span>;
00663         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00664       }
00665       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) {
00666         sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName
00667              &lt;&lt; <span class="stringliteral">"\" has wrong type (stopped step "</span> &lt;&lt; 5-1*err &lt;&lt; <span class="stringliteral">")"</span>;
00668         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00669         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00670         err=<a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00671       }
00672       <span class="keywordflow">else</span> {
00673         <span class="keywordflow">if</span> (what &gt; 0) sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is CSV type (; separator)"</span>;
00674         <span class="keywordflow">else</span> sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is TSV type (Tab=0x09 separator)"</span>;
00675         <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, sortie.str());
00676         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00677       }
00678 
00679     }
00680     myFile.close();
00681     sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">": "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" lines read"</span>;
00682     <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(0, sortie.str());
00683     <a class="code" href="classcatalog_access_1_1_catalog.html#r6">m_filename</a>=fileName;
00684     <a class="code" href="classcatalog_access_1_1_catalog.html#r1">m_URL</a>=<span class="stringliteral">"CDS"</span>; <span class="comment">/* to know that format string need to be changed for fits */</span>
00685 
00686   }<span class="comment">// file is read</span>
00687   <span class="keywordflow">if</span> (err &lt; 0) {
00688     <a class="code" href="classcatalog_access_1_1_catalog.html#a23">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
00689     <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=err;
00690     <span class="comment">// exit only if nothing is read</span>
00691     <span class="keywordflow">if</span> ((err == <a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>) || (err == <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>)) <span class="keywordflow">return</span> err;
00692   }
00693   <span class="comment">// m_quantities vector maybe filled, MUST fill m_selEllipse, m_loadQuantity</span>
00694   <span class="keywordflow">try</span> {
00695     <a class="code" href="classcatalog_access_1_1_catalog.html#r29">m_selEllipse</a>.assign(7, 0.0);
00696     <a class="code" href="classcatalog_access_1_1_catalog.html#r11">m_loadQuantity</a>.assign(<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size(), <span class="keyword">true</span>);
00697   }
00698   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00699     text=std::string(<span class="stringliteral">"EXCEPTION on creating m_selEllipse, m_loadQuantity: "</span>)
00700         +prob.what();
00701     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00702     <span class="keywordflow">throw</span>;
00703   }
00704   <span class="comment">// check if tableName is known to set generic</span>
00705   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="catalog_8h.html#a0">MAX_CAT</a>; i++) {
00706     <span class="keywordflow">if</span> (Catalog::s_CatalogList[2*i+1] == <a class="code" href="classcatalog_access_1_1_catalog.html#r4">m_tableName</a>) <span class="keywordflow">break</span>;
00707   }
00708   <span class="keywordflow">if</span> (i == <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>) {
00709     text=<span class="stringliteral">"Unknown table name, all generic quantities may be not found"</span>;
00710     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, text);
00711   }
00712   <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#r0">m_code</a>=Catalog::s_CatalogList[2*i];
00713   <a class="code" href="classcatalog_access_1_1_catalog.html#d11">setGeneric</a>(i);
00714   <span class="keywordflow">return</span> err;
00715 }
00716 <span class="comment">/**********************************************************************/</span>
00717 <span class="comment">// read only the catalog description from file</span>
<a name="l00718"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a6">00718</a> <span class="keywordtype">int</span> Catalog::importDescription(<span class="keyword">const</span> std::string &amp;fileName,
00719                                <span class="keyword">const</span> std::string ext) {
00720   <span class="keywordtype">int</span> err;
00721   err=<a class="code" href="classcatalog_access_1_1_catalog.html#d24">checkImport</a>(<span class="stringliteral">"importDescription"</span>, <span class="keyword">false</span>);
00722   <span class="comment">// must be called before load() which set m_numRows to 0</span>
00723   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
00724 
00725   <span class="keywordtype">long</span> maxRows=0l;
00726   err=<a class="code" href="classcatalog_access_1_1_catalog.html#d18">load</a>(fileName, ext, <span class="keyword">true</span>, &amp;maxRows);
00727   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) <span class="keywordflow">return</span> err;
00728 
00729   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size();
00730 }
00731 <span class="comment">/**********************************************************************/</span>
00732 <span class="comment">// read from file an entire catalog without selection</span>
<a name="l00733"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a8">00733</a> <span class="keywordtype">int</span> Catalog::import(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRows,
00734                     <span class="keyword">const</span> std::string ext) {
00735   <span class="keywordtype">int</span> err;
00736   <span class="keywordtype">long</span> maxR=maxRows;
00737   err=<a class="code" href="classcatalog_access_1_1_catalog.html#d24">checkImport</a>(<span class="stringliteral">"import"</span>, <span class="keyword">false</span>);
00738   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
00739 
00740   <span class="keywordflow">if</span> (maxR &lt;= 0) {
00741     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(<span class="stringliteral">"import"</span>, <span class="stringliteral">"trying to get whole catalog file"</span>);
00742     maxR=0;
00743   }
00744 
00745   err=<a class="code" href="classcatalog_access_1_1_catalog.html#d18">load</a>(fileName, ext, <span class="keyword">false</span>, &amp;maxR);
00746   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) <span class="keywordflow">return</span> err;
00747   <a class="code" href="classcatalog_access_1_1_catalog.html#a5">getRAMsize</a>(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>, <span class="keyword">true</span>);
00748   <span class="keywordflow">try</span> {
00749     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a> &lt; maxR) {
00750       <span class="keywordtype">int</span> i;
00751       err=<a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>.size();
00752       <span class="comment">// erase unused memory  printf("ERASING\n");</span>
00753       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>);
00754       err=<a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>.size();
00755       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>);
00756     }
00757     err=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size()+2;
00758     <span class="comment">// number of required bits including global and region</span>
00759     err=1+(err-1)/(<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)*8);
00760     <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>.resize(err);
00761 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
00762 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
00763               &lt;&lt; err &lt;&lt; std::endl;
00764 <span class="preprocessor">    #endif</span>
00765 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>)
00766       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>, 0);
00767     <span class="comment">// above lines can be commented to test the try catch mechanism</span>
00768   }
00769   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00770     std::string text;
00771     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
00772     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"import"</span>, text);
00773     <span class="keywordflow">throw</span>;
00774   }
00775   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>;
00776 }
00777 
00778 
00779 <span class="comment">/**********************************************************************/</span>
<a name="l00780"></a><a class="code" href="classcatalog_access_1_1_catalog.html#d20">00780</a> <span class="keywordtype">int</span> Catalog::loadSelectFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string ext,
00781                             <span class="keywordtype">long</span> *maxRows, std::string &amp;filter)
00782 {
00783   <span class="keyword">const</span> std::string  origin=<span class="stringliteral">"importSelected"</span>;
00784   std::ostringstream sortie;
00785   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       i, max;
00786   <span class="keyword">const</span> Table *myDOL = 0;
00787 
00788   <span class="comment">/* create the selection string */</span>
00789   <span class="keywordtype">char</span> value[20];
00790   <span class="keywordtype">bool</span> test, probCase=<span class="keyword">false</span>;
00791   std::vector&lt;bool&gt; isSelected;
00792   <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#d2">existCriteria</a>(&amp;isSelected) &amp;&amp; (<a class="code" href="classcatalog_access_1_1_catalog.html#r1">m_URL</a> != <span class="stringliteral">"CDS"</span>)) {
00793     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r19">m_selRegion</a>) {
00794       <span class="comment">/* !! cannot concatenate Cstring and char !! */</span>
00795       filter+=<span class="charliteral">'('</span>+<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#r28">m_indexDEC</a>].m_name+<span class="stringliteral">" &gt;= "</span>;
00796       sprintf(value, <span class="stringliteral">"%9.5f"</span>, <a class="code" href="classcatalog_access_1_1_catalog.html#r21">m_selEllipseCentDEC_deg</a>-<a class="code" href="classcatalog_access_1_1_catalog.html#r23">m_selEllipseMajAxis_deg</a>);
00797       filter+=value;
00798       filter+=<span class="stringliteral">" &amp;&amp; "</span>+m_quantities[<a class="code" href="classcatalog_access_1_1_catalog.html#r28">m_indexDEC</a>].m_name+<span class="stringliteral">" &lt;= "</span>;
00799       sprintf(value, <span class="stringliteral">"%9.5f"</span>, <a class="code" href="classcatalog_access_1_1_catalog.html#r21">m_selEllipseCentDEC_deg</a>+m_selEllipseMajAxis_deg);
00800       filter+=value;
00801       <span class="comment">/* AND has higher priority than OR, needn't parenthesis (isnull...)*/</span>
00802       <span class="keywordflow">if</span> ( !m_quantities[<a class="code" href="classcatalog_access_1_1_catalog.html#r27">m_indexRA</a>].m_rejectNaN )
00803         filter+=<span class="stringliteral">" || isnull("</span>+m_quantities[<a class="code" href="classcatalog_access_1_1_catalog.html#r27">m_indexRA</a>].m_name+<span class="charliteral">')'</span>;
00804       <span class="keywordflow">if</span> ( !m_quantities[<a class="code" href="classcatalog_access_1_1_catalog.html#r28">m_indexDEC</a>].m_rejectNaN )
00805         filter+=<span class="stringliteral">" || isnull("</span>+m_quantities[<a class="code" href="classcatalog_access_1_1_catalog.html#r28">m_indexDEC</a>].m_name+<span class="charliteral">')'</span>;
00806       filter+=<span class="charliteral">')'</span>;
00807     }
00808     max=isSelected.size();
00809     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j, nbV;
00810     <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
00811     <span class="keywordtype">double</span>   rVal;
00812     <span class="comment">// first boolean is for elliptical region (m_selRegion)</span>
00813     <span class="keywordflow">for</span> (i=1; i&lt;max; i++) <span class="keywordflow">if</span> ( isSelected[i] ) {
00814       <span class="keywordflow">if</span> ( !filter.empty() ) {
00815         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r18">m_criteriaORed</a>) filter+=<span class="stringliteral">" || "</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" &amp;&amp; "</span>;
00816       }
00817       filter+=<span class="charliteral">'('</span>;
00818       readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[i-1];
00819       <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a> == Quantity::STRING) {
00820         nbV=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o12">m_listValS</a>.size(); <span class="comment">/* nbV is &gt;0 because criteria exist */</span>
00821         test=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o16">m_excludeList</a>;
00822         filter+=<span class="charliteral">'('</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>;
00823         <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">" != '"</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" == '"</span>;
00824         filter+=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o12">m_listValS</a>[0]+<span class="stringliteral">"')"</span>;
00825         <span class="keywordflow">for</span> (j=1; j&lt;nbV; j++) {
00826           <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">" &amp;&amp; "</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" || "</span>;
00827           filter+=<span class="charliteral">'('</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>;
00828           <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">" != '"</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" == '"</span>;
00829           filter+=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o12">m_listValS</a>[j]+<span class="stringliteral">"')"</span>;
00830         }
00831         <span class="keywordflow">if</span> ((!<a class="code" href="classcatalog_access_1_1_catalog.html#r18">m_criteriaORed</a>) &amp;&amp; (!readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o19">m_cutORed</a>)) probCase=<span class="keyword">true</span>;
00832       }
00833       <span class="keywordflow">else</span> {
00834         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o18">m_rejectNaN</a> == <span class="keyword">false</span>) {
00835           filter+=<span class="stringliteral">"isnull("</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>+<span class="stringliteral">") || "</span>;  
00836           <span class="comment">/* can put OR because criteria exist */</span>
00837           <span class="comment">/* AND has higher priority than OR, needn't parenthesis (isnull...)*/</span>
00838         }
00839         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o13">m_lowerCut</a> &lt; <a class="code" href="quantity_8h.html#a0">NO_SEL_CUT</a>) {
00840           filter+=<span class="charliteral">'('</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>+<span class="stringliteral">" &gt;= "</span>;          
00841           sprintf(value, <span class="stringliteral">"%.9E"</span>, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o13">m_lowerCut</a>);
00842           filter+=value; filter+=<span class="charliteral">')'</span>;
00843           test=<span class="keyword">true</span>;
00844         }
00845         <span class="keywordflow">else</span> test=<span class="keyword">false</span>;
00846         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o14">m_upperCut</a> &lt; <a class="code" href="quantity_8h.html#a0">NO_SEL_CUT</a>) {
00847           <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">" &amp;&amp; "</span>;
00848           filter+=<span class="charliteral">'('</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>+<span class="stringliteral">" &lt;= "</span>;          
00849           sprintf(value, <span class="stringliteral">"%.9E"</span>, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o14">m_upperCut</a>);
00850           filter+=value; filter+=<span class="charliteral">')'</span>;
00851           test=<span class="keyword">true</span>;
00852         }
00853         nbV=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o15">m_listValN</a>.size();
00854         <span class="keywordflow">if</span> (nbV) { 
00855           <span class="keywordflow">if</span> (test) {
00856             <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o19">m_cutORed</a>) filter+=<span class="stringliteral">" || ("</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" &amp;&amp; ("</span>;
00857           }
00858           <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o16">m_excludeList</a>) filter+=<span class="stringliteral">"!("</span>;
00859           filter+=<span class="stringliteral">"near("</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>+<span class="stringliteral">", "</span>;
00860           rVal=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o15">m_listValN</a>[0];
00861           sprintf(value, <span class="stringliteral">"%.9E"</span>, rVal);
00862           filter+=value; filter+=<span class="stringliteral">", "</span>;
00863           <span class="keywordflow">if</span> (fabs(rVal) &gt; NearZero) rVal*=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o17">m_precision</a>;
00864           <span class="keywordflow">else</span> rVal=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o17">m_precision</a>;
00865           sprintf(value, <span class="stringliteral">"%.9E"</span>, rVal);
00866           filter+=value; filter+=<span class="charliteral">')'</span>;
00867           <span class="keywordflow">for</span> (j=1; j&lt;nbV; j++) {
00868             filter+=<span class="stringliteral">" || near("</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>+<span class="stringliteral">", "</span>;
00869             rVal=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o15">m_listValN</a>[j];
00870             sprintf(value, <span class="stringliteral">"%.9E"</span>, rVal);
00871             filter+=value; filter+=<span class="stringliteral">", "</span>;
00872             <span class="keywordflow">if</span> (fabs(rVal) &gt; NearZero) rVal*=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o17">m_precision</a>;
00873             <span class="keywordflow">else</span> rVal=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o17">m_precision</a>;
00874             sprintf(value, <span class="stringliteral">"%.9E"</span>, rVal);
00875             filter+=value; filter+=<span class="charliteral">')'</span>;
00876           }
00877           <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o16">m_excludeList</a>) filter+=<span class="stringliteral">")"</span>;
00878           <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">")"</span>;
00879         }
00880       }
00881       filter+=<span class="charliteral">')'</span>;
00882     }
00883     <span class="keywordflow">if</span> (probCase) <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin,
00884       <span class="stringliteral">"filter (for binary fits) is NOT case sensitive for string"</span>);
00885   }
00886   <span class="keywordflow">try</span> {
00887     myDOL=IFileSvc::instance().readTable(fileName, ext, filter);
00888   }
00889   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00890     sortie &lt;&lt; <span class="stringliteral">": FITS is TABLE, but cfitsio returned error="</span> &lt;&lt; x.code();
00891     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00892     <span class="keyword">delete</span> myDOL;
00893     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00894   }
00895   <span class="keywordflow">try</span> {
00896     max=myDOL-&gt;getValidFields().size();
00897     <a class="code" href="classcatalog_access_1_1_catalog.html#r14">m_numOriRows</a>=myDOL-&gt;getNumRecords();
00898   }
00899   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00900     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get number of rows or columns"</span>);
00901     <span class="keyword">delete</span> myDOL;
00902     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00903   }
00904   <span class="keywordflow">if</span> (max &lt; 1) {
00905     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, need at least 1 column"</span>);
00906     <span class="keyword">delete</span> myDOL;
00907     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00908   }
00909   <span class="comment">/* beware some initial quantities can be skipped */</span>
00910   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r11">m_loadQuantity</a>.size() != max) {
00911     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, number of fields ("</span> &lt;&lt; max;
00912     sortie &lt;&lt; <span class="stringliteral">") differ from previous import call ("</span>;
00913     sortie &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#r11">m_loadQuantity</a>.size() &lt;&lt; <span class="stringliteral">")"</span>;
00914     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00915     <span class="keyword">delete</span> myDOL;
00916     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00917   }
00918 <span class="comment">//std::cout &lt;&lt; "Initial number of COL = " &lt;&lt; max &lt;&lt; std::endl;</span>
00919   <span class="keyword">const</span> Header &amp;header=myDOL-&gt;getHeader();
00920   std::string text, unit, mot, rescale, form;
00921   <span class="keywordtype">int</span>  err=0;
00922   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
00923   std::vector&lt;double&gt; colNull(max, 0.0);
00924   std::vector&lt;Quantity&gt;::iterator itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.begin();
00925   <span class="keywordflow">try</span> {
00926     <span class="keyword">const</span> IColumn *myCol = 0;
00927     <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00928       text=<span class="stringliteral">"start"</span>;
00929       rescale=<span class="stringliteral">""</span>;
00930       myCol=myDOL-&gt;getColumn(i);
00931       text=myCol-&gt;getId();
00932       unit=myCol-&gt;getUnits();
00933       sprintf(name, <span class="stringliteral">"TNULL%d"</span>, i+1); mot=name;
00934       <span class="keywordflow">try</span> { header.getKeyword(mot, rescale); }
00935       <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00936       colNull.at(i)=atof(rescale.c_str());
00937       <span class="keywordflow">if</span> ( !rescale.empty() ) {
00938           form=<span class="stringliteral">""</span>;
00939           sprintf(name, <span class="stringliteral">"TSCAL%d"</span>, i+1); mot=name;
00940           <span class="keywordflow">try</span> { header.getKeyword(mot, form); }
00941           <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00942           rescale+=<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>+form;
00943           <span class="keywordflow">if</span> ( !form.empty() ) colNull.at(i)*=atof(form.c_str());
00944           form=<span class="stringliteral">""</span>;
00945           sprintf(name, <span class="stringliteral">"TZERO%d"</span>, i+1); mot=name;
00946           <span class="keywordflow">try</span> { header.getKeyword(mot, form); }
00947           <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00948           rescale+=<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>+form;
00949           <span class="keywordflow">if</span> ( !form.empty() ) colNull.at(i)+=atof(form.c_str());
00950       }
00951       sprintf(name, <span class="stringliteral">"TFORM%d"</span>, i+1);
00952       mot=name; <span class="comment">/* convert C string to C++ string */</span>
00953       header.getKeyword(mot, form);
00954       <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r11">m_loadQuantity</a>[i]) {
00955 <span class="comment">//std::cout &lt;&lt; itQ-&gt;m_index &lt;&lt; " ";</span>
00956         <span class="keywordflow">if</span> ( (text!=itQ-&gt;m_name) || (unit!=itQ-&gt;m_unit)
00957             || (rescale!=itQ-&gt;m_null) || (form!=itQ-&gt;m_format) ) {
00958           text=<span class="stringliteral">""</span>;
00959           <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"fileDiff"</span>);
00960         }
00961         <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::STRING) err++;
00962         itQ++;
00963       }
00964     }<span class="comment">/* loop on columns */</span>
00965   }
00966   <span class="keywordflow">catch</span> (...) {
00967     <span class="keywordflow">if</span> ( text.empty() ) {
00968       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, column#"</span>;
00969       sortie &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">" differ from previous import call"</span>;
00970       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00971       err=<a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00972     }
00973     <span class="keywordflow">else</span> {
00974       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, error reading TABLE column#"</span>;
00975       sortie &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">" description"</span>;
00976       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00977       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00978     }
00979     <span class="keyword">delete</span> myDOL;
00980     <span class="keywordflow">return</span> err;
00981   }
00982 <span class="comment">//std::cout &lt;&lt; std::endl;</span>
00983 <span class="comment">//std::cout &lt;&lt; m_numOriRows &lt;&lt; " OriRows" &lt;&lt; std::endl;</span>
00984   <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=0;
00985   <span class="keywordflow">if</span> ( !*maxRows ) *maxRows=<a class="code" href="classcatalog_access_1_1_catalog.html#r14">m_numOriRows</a>;
00986   <span class="keywordflow">if</span> ( !m_numOriRows ) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00987 
00988   <a class="code" href="classcatalog_access_1_1_catalog.html#d12">create_tables</a>(err, *maxRows);
00989   <span class="keywordflow">try</span> {
00990     <span class="keywordtype">double</span> rowVal;
00991     <span class="comment">// max=m_quantities.size();</span>
00992     <span class="keywordflow">for</span> (Table::ConstIterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end();
00993          ++itor, ++<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>) {
00994       err=0;
00995       <span class="keywordflow">for</span> (itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.begin(); itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.end(); ++itQ, ++err) {
00996         i=itQ-&gt;m_index;
00997         <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::NUM) {
00998           rowVal=(*itor)[itQ-&gt;m_name].get();
00999           <span class="keywordflow">if</span> ( itQ-&gt;m_null.empty() ) <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>)=rowVal;
01000           <span class="keywordflow">else</span> {
01001             <span class="keywordflow">if</span> (rowVal == colNull[err]) <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>)=MissNAN;
01002             <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>)=rowVal;
01003           }
01004         }
01005         <span class="keywordflow">else</span> (*itor)[itQ-&gt;m_name].get(<a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>) );
01006       }
01007     }<span class="comment">/* loop on rows*/</span>
01008   }
01009   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01010     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot read after row#"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>+1;
01011     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
01012     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a24">BAD_ROW</a>;
01013   }
01014   <span class="keyword">delete</span> myDOL;
01015   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
01016 }
01017 <span class="comment">/**********************************************************************/</span>
01018 <span class="comment">/* PRIVATE METHOD loadSelected is in file "catalog_ioText.cxx"        */</span>
01019 <span class="comment">/**********************************************************************/</span>
01020 <span class="comment">// if a catalog description was already loaded, this method does</span>
01021 <span class="comment">// the same as import() adding selection criteria for loading</span>
<a name="l01022"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a10">01022</a> <span class="keywordtype">int</span> Catalog::importSelected(std::string &amp;filter) {
01023 
01024   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"importSelected"</span>;
01025   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#d24">checkImport</a>(origin, <span class="keyword">true</span>);
01026   <span class="keywordflow">if</span> (quantSize &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> quantSize;
01027 
01028   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a> &gt; 0) {
01029     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, <span class="stringliteral">"call 'deleteContent' before 'importSelected'"</span>);
01030     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a15">IMPORT_BIS</a>;
01031   }
01032   <span class="keywordtype">int</span> i, err=0,
01033       maxSize=<a class="code" href="classcatalog_access_1_1_catalog.html#r11">m_loadQuantity</a>.size();
01034   <span class="keywordflow">for</span> (i=0; i&lt;maxSize; i++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r11">m_loadQuantity</a>[i]) err++;
01035   <span class="keywordflow">if</span> (err &lt; 2) {
01036     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">"at least 2 quantities must be selected for import"</span>);
01037     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a33">BAD_SEL_QUANT</a>;
01038   }
01039   filter=<span class="stringliteral">""</span>;
01040   std::ostringstream sortie; 
01041   sortie &lt;&lt; err &lt;&lt; <span class="stringliteral">" quantities (over "</span> &lt;&lt; maxSize &lt;&lt; <span class="stringliteral">") selected for import"</span>;
01042   <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, sortie.str());
01043   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string</span>
01044   <span class="keywordflow">if</span> (err != quantSize) {
01045     <span class="comment">// in fact, due to select*Quantities() restrictions,</span>
01046     <span class="comment">// quantSize can only be greater than err</span>
01047     <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(2, <span class="stringliteral">"Erasing unwanted quantities for importSelected()"</span>);
01048     <a class="code" href="classcatalog_access_1_1_catalog.html#d1">deleteQuantities</a>();
01049   }
01050   err=<a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>;
01051   std::string text;
01052   <span class="keywordtype">long</span> maxRows=0l;
01053   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos=<a class="code" href="classcatalog_access_1_1_catalog.html#r6">m_filename</a>.find(0x0A);
01054   <span class="keywordflow">if</span> (pos == std::string::npos) {
01055 
01056     <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#r6">m_filename</a>.empty() ) {
01057       <span class="comment">// data must be querried via web</span>
01058 
01059 
01060     }
01061     <span class="keywordflow">else</span> {
01062       <span class="keywordflow">if</span> (!<a class="code" href="classcatalog_access_1_1_catalog.html#r7">m_filePos</a>) {
01063         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">"file import was not succesful"</span>);
01064         <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a16">IMPORT_NEED</a>;
01065       }
01066       std::fstream myFile (<a class="code" href="classcatalog_access_1_1_catalog.html#r6">m_filename</a>.c_str(), std::ios::in);
01067       <span class="comment">// file can be opened ?</span>
01068       <span class="keywordflow">if</span> ( !myFile.is_open() ) {
01069         text=<span class="stringliteral">": FILENAME \""</span>+<a class="code" href="classcatalog_access_1_1_catalog.html#r6">m_filename</a>+<span class="stringliteral">"\" cannot be opened"</span>;
01070         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01071         err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01072         <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=err;
01073         <span class="keywordflow">return</span> err;
01074       }
01075       <span class="comment">// go back to initial position</span>
01076       myFile.clear(); <span class="comment">// needed to reset flags before seekg</span>
01077       myFile.seekg(<a class="code" href="classcatalog_access_1_1_catalog.html#r7">m_filePos</a>);
01078       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of data lines read</span>
01079       err=<a class="code" href="classcatalog_access_1_1_catalog.html#d21">loadSelected</a>(&amp;tot, &amp;myFile, &amp;maxRows);
01080       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) {
01081         sortie &lt;&lt; tot &lt;&lt; <span class="stringliteral">" data lines read for importSelected()"</span>;
01082         <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(0, sortie.str());
01083       }
01084       myFile.close();
01085     }
01086 
01087   }
01088   <span class="keywordflow">else</span> { <span class="comment">//fits file</span>
01089 
01090     text=<a class="code" href="classcatalog_access_1_1_catalog.html#r6">m_filename</a>;
01091     std::string fileName=text.substr(0, pos);
01092     text.erase(0, pos+1);
01093     <span class="keyword">const</span> Extension *myEXT = 0;
01094     <span class="comment">// cannot use readTable because FITS IMAGE returns also error 1</span>
01095     <span class="keywordflow">try</span> {
01096       myEXT=IFileSvc::instance().readExtension(fileName, text);
01097     }
01098     <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01099       err=x.code();
01100       <span class="keywordflow">if</span> (err == 1) {
01101         <span class="comment">// This non-cfitsio error number means the file does not exist</span>
01102         <span class="comment">// or is not a table, or is not either Root nor Fits format. </span>
01103         sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName;
01104         sortie &lt;&lt; <span class="stringliteral">"\" cannot be opened or is NOT fits"</span>;
01105         err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01106       }
01107       <span class="keywordflow">else</span> {
01108         <span class="comment">// Other errors come from cfitsio, but apply to a file</span>
01109         <span class="comment">// which is in FITS format but has some sort of format error.</span>
01110         sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but cfitsio returned error="</span> &lt;&lt; err;
01111         err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
01112       }
01113     }
01114     <span class="keywordflow">if</span> (err &gt;= <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) {
01115       <span class="keywordflow">if</span> ( !myEXT-&gt;isTable() ) {
01116         sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but NOT a TABLE"</span>;
01117         err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
01118       }
01119     }
01120     <span class="keyword">delete</span> myEXT;
01121     <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) {
01122       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
01123       <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=err;
01124       <span class="keywordflow">return</span> err;
01125     }
01126     err=<a class="code" href="classcatalog_access_1_1_catalog.html#d20">loadSelectFits</a>(fileName, text, &amp;maxRows, filter);
01127 
01128   }
01129   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) {
01130     <a class="code" href="classcatalog_access_1_1_catalog.html#a23">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
01131     <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>=err;
01132     <span class="keywordflow">return</span> err;
01133   }
01134   <span class="keywordflow">try</span> {
01135     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a> &lt; maxRows) {
01136       err=<a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>.size();
01137       <span class="comment">// erase unused memory  printf("ERASING\n")</span>
01138       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>);
01139       err=<a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>.size();
01140       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>);
01141     }
01142     err=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size()+2;
01143     <span class="comment">// number of required bits including global and region</span>
01144     maxSize=<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)*8;
01145     err=1+(err-1)/maxSize;
01146     <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>.resize(err);
01147 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
01148 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
01149               &lt;&lt; err &lt;&lt; std::endl;
01150 <span class="preprocessor">    #endif</span>
01151 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>) {
01152       std::vector&lt;bool&gt; isSelected;
01153       <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#d2">existCriteria</a>(&amp;isSelected) ) {
01154 
01155         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> quantBit;
01156         <span class="keywordtype">int</span> j, k;
01157         quantSize=isSelected.size();
01158         <span class="keywordflow">if</span> ((<a class="code" href="classcatalog_access_1_1_catalog.html#r1">m_URL</a> == <span class="stringliteral">"CDS"</span>) || (<a class="code" href="classcatalog_access_1_1_catalog.html#r18">m_criteriaORed</a>)) {
01159           <span class="keywordflow">for</span> (j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>, 0);
01160           <span class="comment">/* for the moment, no selection applied */</span>
01161           std::vector&lt;std::string&gt; list;
01162           std::string mot;
01163           <span class="keywordtype">int</span> nbV, (*pfunc)(<span class="keywordtype">int</span>)=tolower; <span class="comment">// function used by transform</span>
01164           <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
01165           <span class="keywordtype">double</span>   myVal, precis;
01166           <span class="keywordtype">bool</span>     check, reject;
01167           <span class="keywordflow">for</span> (i=1; i&lt;quantSize; i++) <span class="keywordflow">if</span> (isSelected[i]) {
01168             readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[i-1];
01169             quantBit=<a class="code" href="classcatalog_access_1_1_catalog.html#d29">bitPosition</a>(i-1, &amp;k);
01170 <span class="comment">//std::cout &lt;&lt; m_criteriaORed &lt;&lt;"byte #"&lt;&lt; k &lt;&lt; " unsigned long="&lt;&lt;quantBit;</span>
01171             <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a> == Quantity::STRING) {
01172               nbV=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o12">m_listValS</a>.size(); <span class="comment">/* &gt;0 because criteria exist */</span>
01173               list.assign(nbV, <span class="stringliteral">""</span>);
01174               <span class="keywordflow">for</span> (j=0; j&lt;nbV; j++) {
01175                 mot=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o12">m_listValS</a>.at(j);
01176                 <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o19">m_cutORed</a>)
01177                   std::transform(mot.begin(), mot.end(), mot.begin(), pfunc);
01178                 list.at(j)=mot;
01179               }
01180               <span class="keywordflow">for</span> (maxRows=0; maxRows&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>; maxRows++) {
01181                 mot=<a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o7">m_index</a>].at(maxRows);
01182                 <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o19">m_cutORed</a>)
01183                   std::transform(mot.begin(), mot.end(), mot.begin(), pfunc);
01184                 check=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o16">m_excludeList</a>;
01185                 <span class="keywordflow">for</span> (j=0; j&lt;nbV; j++) {
01186                   <span class="keywordflow">if</span> (mot == list[j]) {check=!readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o16">m_excludeList</a>; <span class="keywordflow">break</span>;}
01187                 }
01188                 <span class="comment">// setting required bit</span>
01189                 <span class="keywordflow">if</span> (check)
01190                   <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[k].at(maxRows)|= quantBit;
01191                 <span class="keywordflow">else</span>
01192                   <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[k].at(maxRows)&amp;= (Max_Test-quantBit);
01193               }
01194             }
01195             <span class="keywordflow">else</span> { <span class="comment">// numerical quantity</span>
01196               j=i-1;
01197               nbV=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o7">m_index</a>;
01198               reject=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o18">m_rejectNaN</a>;
01199               precis=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o17">m_precision</a>;
01200               <span class="keywordflow">for</span> (maxRows=0; maxRows&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>; maxRows++) {
01201                 myVal=<a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[nbV].at(maxRows);
01202                 <span class="keywordflow">if</span> (!readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o19">m_cutORed</a>) <span class="comment">// usual case</span>
01203                   check=<a class="code" href="classcatalog_access_1_1_catalog.html#d4">checkNUM</a>(myVal,j, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o16">m_excludeList</a>,reject,precis);
01204                 <span class="keywordflow">else</span>
01205                   check=<a class="code" href="classcatalog_access_1_1_catalog.html#d5">checkNUMor</a>(myVal,j, reject,precis);
01206                 <span class="comment">// setting required bit</span>
01207                 <span class="keywordflow">if</span> (check)
01208                   <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[k].at(maxRows)|= quantBit;
01209                 <span class="keywordflow">else</span>
01210                   <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[k].at(maxRows)&amp;= (Max_Test-quantBit);
01211               }<span class="comment">// loop on rows</span>
01212             }
01213           }<span class="comment">/*loop on selected quantities */</span>
01214           <a class="code" href="classcatalog_access_1_1_catalog.html#r25">m_numSelRows</a>=0;
01215           <span class="keywordflow">for</span> (maxRows=0; maxRows&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>; maxRows++) {
01216             <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#d6">rowSelect</a>(maxRows, isSelected) == <span class="keyword">true</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#r25">m_numSelRows</a>++;
01217           }
01218         }
01219         <span class="keywordflow">else</span> {<span class="comment">// from binary fits, only if criteria ANDed</span>
01220           <a class="code" href="classcatalog_access_1_1_catalog.html#r25">m_numSelRows</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>;
01221           <span class="comment">/* easy, as criteria are ANDed: bit to 1 */</span>
01222           std::vector&lt;unsigned long&gt; selBits(err, 0);
01223           selBits[0]=1ul;
01224           j=0;
01225           quantBit=2ul;
01226           <span class="keywordflow">for</span> (i=0; i&lt;quantSize; ) {
01227             <span class="keywordflow">if</span> (isSelected[i]) selBits[j]|=quantBit;
01228             <span class="keywordflow">if</span> ((++i % maxSize) == 0) {
01229               quantBit=1ul; <span class="comment">// first bit</span>
01230               j++;          <span class="comment">// of next vector index.</span>
01231             }
01232             <span class="keywordflow">else</span> quantBit*=2ul;
01233           }
01234 <span class="comment">//std::cout &lt;&lt; m_criteriaORed &lt;&lt;"first unsigned long selection="&lt;&lt; selBits[0];</span>
01235           <span class="keywordflow">for</span> (j=0; j&lt;err; j++)
01236             <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[j].assign(m_numRows, selBits[j]);
01237         }
01238         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r19">m_selRegion</a>) {
01239           sortie &lt;&lt; origin &lt;&lt; <span class="stringliteral">", selecting region from "</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>;
01240           sortie &lt;&lt; <span class="stringliteral">" loaded rows"</span>;
01241           <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, sortie.str());
01242           <span class="keywordtype">int</span> nRA =<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#r27">m_indexRA</a>].m_index,
01243               nDEC=m_quantities[<a class="code" href="classcatalog_access_1_1_catalog.html#r28">m_indexDEC</a>].m_index;
01244           <span class="keywordtype">bool</span> check;
01245           <span class="keywordflow">for</span> (maxRows=0; maxRows&lt;m_numRows; maxRows++) {
01246             check=<a class="code" href="classcatalog_access_1_1_catalog.html#d3">checkRegion</a>(maxRows, nRA, nDEC);
01247             <span class="keywordflow">if</span> (!check) {<span class="comment">// setting 2nd bit to 0</span>
01248               <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[0].at(maxRows)&amp;=(Max_Test-2ul);
01249               <span class="keywordflow">if</span> (!<a class="code" href="classcatalog_access_1_1_catalog.html#r18">m_criteriaORed</a>) {<span class="comment">// setting 1st bit to 0</span>
01250                 <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[0].at(maxRows)&amp;=(Max_Test-1ul);
01251                 <a class="code" href="classcatalog_access_1_1_catalog.html#r25">m_numSelRows</a>--;
01252               }
01253               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#d6">rowSelect</a>(maxRows, isSelected) == <span class="keyword">false</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#r25">m_numSelRows</a>--;
01254             }
01255           }<span class="comment">/* loop on rows */</span>
01256         }
01257         <a class="code" href="classcatalog_access_1_1_catalog.html#a67">eraseNonSelected</a>();
01258 
01259       }
01260       <span class="keywordflow">else</span>  <span class="comment">// lines can be commented to test the try catch mechanism</span>
01261         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>, 0);
01262     }<span class="comment">/* row exist ==&gt; MUST create selection array */</span>
01263   }
01264   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01265     std::string text;
01266     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
01267     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"import"</span>, text);
01268     <span class="keywordflow">throw</span>;
01269   }
01270   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>;
01271 }
01272 
01273 
01274 <span class="comment">/**********************************************************************/</span>
01275 <span class="comment">// create catalog header from memory to a FITS file</span>
<a name="l01276"></a><a class="code" href="classcatalog_access_1_1_catalog.html#d23">01276</a> <span class="keywordtype">int</span> Catalog::createFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string &amp;extName,
01277                         <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append, <span class="keyword">const</span> std::string origin,
01278                         tip::Table **ptrTable) {
01279 
01280   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
01281   std::string text, newName;
01282   <span class="keywordtype">int</span>  j, err;
01283   <span class="keywordtype">bool</span> create=<span class="keyword">true</span>;
01284 
01285   err=<a class="code" href="classcatalog_access_1_1_catalog.html#d24">checkImport</a>(origin, <span class="keyword">true</span>);
01286   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
01287 
01288   err=fileName.length();
01289   <span class="keywordflow">if</span> (err == 0) {
01290     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
01291     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01292     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01293   }
01294   <span class="keywordflow">if</span> (extName.length() &gt; 68) {
01295     text=<span class="stringliteral">": EXTENSION name is TOO long (limited to 68 characters)"</span>;
01296     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01297     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01298   }
01299   <span class="comment">// overwrite existing file ?</span>
01300   <span class="keywordflow">if</span> (!clobber) {
01301     std::fstream file;
01302     file.open(fileName.c_str(), std::ios::in);
01303     <span class="keywordflow">if</span> (file) {
01304       file.close();
01305       create=<span class="keyword">false</span>;
01306       <span class="keywordflow">if</span> (!append) {
01307         text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" exist (clobber=no, append=no)"</span>;
01308         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01309         <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01310       }
01311       <span class="keywordflow">else</span> {
01312         text=<span class="stringliteral">"appending extension to existing FILENAME (method "</span>+origin+<span class="stringliteral">")"</span>;
01313         <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, text);
01314       }
01315     }
01316   }
01317   <span class="keywordflow">if</span> ( extName.empty() ) {
01318     <span class="comment">/* max length is 68, as keyword value starts/ends with ' in 11/80 */</span>
01319     newName=<a class="code" href="classcatalog_access_1_1_catalog.html#r4">m_tableName</a>.substr(0,68);
01320     <span class="comment">/* replace forbidden char. */</span>
01321     err=newName.length();
01322     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01323       <span class="keywordflow">if</span> (newName[j] == <span class="charliteral">'/'</span>) newName[j]=<span class="charliteral">'_'</span>;
01324     }
01325     text=<span class="stringliteral">"EXTENSION name set to '"</span>+newName+<span class="stringliteral">"'"</span>;
01326     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, text); 
01327     err=<a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
01328   }
01329   <span class="keywordflow">else</span> newName=extName;
01330 
01331   <span class="keywordflow">try</span> {
01332     <span class="keywordflow">if</span> (create) IFileSvc::instance().createFile(fileName);
01333     IFileSvc::instance().appendTable(fileName, newName);
01334     (*ptrTable)=IFileSvc::instance().editTable(fileName, newName);
01335   }
01336   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01337     text=<span class="stringliteral">": cannot append and edit fits EXTENSION"</span>;
01338     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01339     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
01340   }
01341   Header &amp;header=(*ptrTable)-&gt;getHeader();
01342   <span class="keywordflow">try</span> {
01343     header.setKeyword(<a class="code" href="namespacecatalog_access.html#a2">KeyCDS</a>[0], <a class="code" href="classcatalog_access_1_1_catalog.html#r2">m_catName</a>);
01344     header.setKeyComment(<a class="code" href="namespacecatalog_access.html#a2">KeyCDS</a>[0], <a class="code" href="namespacecatalog_access.html#a3">KeyCom</a>[0]);
01345     header.setKeyword(<a class="code" href="namespacecatalog_access.html#a2">KeyCDS</a>[1], <a class="code" href="classcatalog_access_1_1_catalog.html#r4">m_tableName</a>);
01346     header.setKeyComment(<a class="code" href="namespacecatalog_access.html#a2">KeyCDS</a>[1], <a class="code" href="namespacecatalog_access.html#a3">KeyCom</a>[1]);
01347 <span class="comment">//    if ( !m_tableRef.empty() ) header.setKeyComment("        ", m_tableRef);</span>
01348     <span class="comment">/* test </span>
01349 <span class="comment">    header.setKeyUnit(KeyCDS[1], "deg");*/</span>
01350   }
01351   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01352     text=<span class="stringliteral">"fits EXTENSION, cannot add CDS header keys"</span>;
01353     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, text);
01354   }
01355   <span class="keywordflow">try</span> {
01356     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
01357     err=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size();
01358     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01359       <span class="keyword">const</span> <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> &amp;readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[j];
01360       <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a> == Quantity::NUM) {
01361         <span class="keywordflow">if</span> ( !readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>.empty() ) {
01362           sprintf(name, <span class="stringliteral">"TNULL%d"</span>, j+1);
01363           newName=name; <span class="comment">/* convert C string to C++ string */</span>
01364           text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o3">m_format</a>;
01365           <span class="comment">// to be improved for integers</span>
01366         }
01367         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r1">m_URL</a> == <span class="stringliteral">"CDS"</span>) text=<span class="stringliteral">"1D"</span>;
01368         <span class="keywordflow">else</span> text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o3">m_format</a>;
01369       }
01370       <span class="keywordflow">else</span> {
01371         text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o3">m_format</a>;
01372         <span class="keywordflow">if</span> ( isalpha(readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o3">m_format</a>[0]) ) {
01373           text.erase(0,1);
01374           text=text+<span class="stringliteral">"A"</span>;
01375         }
01376       }
01377       (*ptrTable)-&gt;appendField(readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>, text);
01378       text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>;
01379       <span class="keywordflow">if</span> ( !text.empty() ) {
01380         header.setKeyword(newName, atoi(text.c_str()) );
01381         header.setKeyComment(newName, <span class="stringliteral">"Undefined value of field"</span>);
01382         pos=text.find(<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>); <span class="comment">/* always exist */</span>
01383         text.erase(0, pos+1);
01384         pos=text.find(<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>);
01385         <span class="keywordflow">if</span> (pos &gt; 0) {
01386           sprintf(name, <span class="stringliteral">"TSCAL%d"</span>, j+1);
01387           newName=name; <span class="comment">/* convert C string to C++ string */</span>
01388           header.setKeyword(newName, atoi(text.c_str()) );
01389           header.setKeyComment(newName, <span class="stringliteral">"to rescale data"</span>);
01390         }
01391         text.erase(0, pos+1);
01392         <span class="keywordflow">if</span> ( !text.empty() ) {
01393           sprintf(name, <span class="stringliteral">"TZERO%d"</span>, j+1);
01394           newName=name; <span class="comment">/* convert C string to C++ string */</span>
01395           header.setKeyword(newName, atoi(text.c_str()) );
01396           header.setKeyComment(newName, <span class="stringliteral">"offset for unsigned integers"</span>);
01397         }
01398       }
01399       text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o6">m_unit</a>;
01400       <span class="keywordflow">if</span> ( !text.empty() ) {
01401         sprintf(name, <span class="stringliteral">"TUNIT%d"</span>, j+1);
01402         newName=name; <span class="comment">/* convert C string to C++ string */</span>
01403         header.setKeyword(newName, text);
01404         header.setKeyComment(newName, <span class="stringliteral">"physical unit of field"</span>);
01405       }
01406       sprintf(name, <span class="stringliteral">"%s%d"</span>, <a class="code" href="namespacecatalog_access.html#a4">Key_UCD</a>.c_str(), j+1);
01407       newName=name; <span class="comment">/* convert C string to C++ string */</span>
01408       header.setKeyword(newName, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o2">m_ucd</a>);
01409       header.setKeyComment(newName, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o1">m_comment</a>);
01410     }<span class="comment">/* loop on quantities */</span>
01411   }
01412   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01413     text=<span class="stringliteral">": fits EXTENSION, cannot add column"</span>;
01414     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01415     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
01416   }
01417 <span class="comment">/* NEED new tip methods</span>
01418 <span class="comment">  const IColumn *myCol = 0;</span>
01419 <span class="comment">  try {</span>
01420 <span class="comment">    for (j=0; j &lt; err; j++) {</span>
01421 <span class="comment">      const Quantity &amp;readQ=m_quantities[j];</span>
01422 <span class="comment">      myCol=(*ptrTable)-&gt;getColumn(j);</span>
01423 <span class="comment"></span>
01424 <span class="comment">    }</span>
01425 <span class="comment">  }</span>
01426 <span class="comment">  catch (const TipException &amp;x) {</span>
01427 <span class="comment">    text=": fits EXTENSION, cannot modify column description";</span>
01428 <span class="comment">    printErr(origin, text);</span>
01429 <span class="comment">    return BAD_FITS;</span>
01430 <span class="comment">  }</span>
01431 <span class="comment">*/</span>
01432   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
01433 }
01434 <span class="comment">/**********************************************************************/</span>
01435 <span class="comment">// save whole catalog from memory to a FITS file</span>
<a name="l01436"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a13">01436</a> <span class="keywordtype">int</span> Catalog::saveFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string &amp;extName,
01437                       <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append) {
01438 
01439   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveFits"</span>;
01440   Table *myDOL=0;
01441   <span class="keywordtype">int</span> err;
01442   err=<a class="code" href="classcatalog_access_1_1_catalog.html#d23">createFits</a>(fileName, extName, clobber, append, origin, &amp;myDOL);
01443   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
01444 
01445   std::ostringstream sortie;
01446   <span class="keywordtype">long</span> tot=0l;
01447   <span class="keywordtype">int</span>  i, j;
01448 
01449   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a> &gt; 0) {
01450   <span class="keywordflow">try</span> {
01451     myDOL-&gt;setNumRecords(<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>);
01452     <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
01453     <span class="keywordtype">double</span> rowVal;
01454     err=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size();
01455     std::vector&lt;long&gt; colNull(err, 0);
01456     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01457       readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[j];
01458       colNull[j]=atoi( readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>.c_str() );
01459     }
01460     <span class="comment">// Loop over all records (rows) and set values</span>
01461     <span class="keywordflow">for</span> (Table::Iterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end(); ++itor) {
01462       <span class="comment">// double variable to hold the value of all the numeric fields</span>
01463       <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01464         readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[j];
01465         i=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o7">m_index</a>;
01466         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a> == Quantity::NUM) {
01467           rowVal= <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[i].at(tot);
01468           <span class="keywordflow">if</span> ( readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>.empty() ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set(rowVal);
01469           <span class="keywordflow">else</span> {
01470 <span class="preprocessor">#ifdef WIN32</span>
01471 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( _isnan(rowVal) ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set(colNull[j]);
01472 <span class="preprocessor">#else</span>
01473 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( std::isnan(rowVal) ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set(colNull[j]);
01474 <span class="preprocessor">#endif</span>
01475 <span class="preprocessor"></span>            <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set(rowVal);
01476           }
01477         }
01478         <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set( <a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>[i].at(tot) );
01479       }
01480       tot++;
01481     }<span class="comment">/* loop on rows */</span>
01482   }
01483   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01484     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot write at row#"</span> &lt;&lt; tot;
01485     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
01486     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a24">BAD_ROW</a>;
01487   }<span class="comment">/* end of try */</span>
01488   }<span class="comment">/* at least 1 row */</span>
01489 
01490   <span class="keyword">delete</span> myDOL; myDOL=0;
01491   sortie &lt;&lt; <span class="stringliteral">"output fits is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" rows written)"</span>;
01492   <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(0, sortie.str());
01493   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
01494 }
01495 <span class="comment">/**********************************************************************/</span>
01496 <span class="comment">// save selected rows of catalog from memory to a FITS file</span>
<a name="l01497"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a14">01497</a> <span class="keywordtype">int</span> Catalog::saveSelectedFits(<span class="keyword">const</span> std::string &amp;fileName,
01498                               <span class="keyword">const</span> std::string &amp;extName,
01499                               <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append) {
01500 
01501   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveSelectedFits"</span>;
01502   Table *myDOL=0;
01503   <span class="keywordtype">int</span> err;
01504   err=<a class="code" href="classcatalog_access_1_1_catalog.html#d23">createFits</a>(fileName, extName, clobber, append, origin, &amp;myDOL);
01505   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
01506 
01507   std::ostringstream sortie;
01508   <span class="keywordtype">long</span> tot=0l;
01509   <span class="keywordtype">int</span>  i, j;
01510 
01511   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r25">m_numSelRows</a> &gt; 0) {
01512   <span class="keywordflow">try</span> {
01513     myDOL-&gt;setNumRecords(<a class="code" href="classcatalog_access_1_1_catalog.html#r25">m_numSelRows</a>);
01514     <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
01515     <span class="keywordtype">double</span> rowVal;
01516     err=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>.size();
01517     std::vector&lt;long&gt; colNull(err, 0);
01518     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01519       readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[j];
01520       colNull[j]=atoi( readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>.c_str() );
01521     }
01522     Table::Iterator itor=myDOL-&gt;begin();
01523     <span class="comment">// Loop over all selected records (rows) and set values</span>
01524     <span class="comment">// first bit indicates global selection</span>
01525     <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k=0; k&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#r15">m_numRows</a>; k++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#r16">m_rowIsSelected</a>[0].at(k) &amp; 1) {
01526       <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01527         readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#r10">m_quantities</a>[j];
01528         i=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o7">m_index</a>;
01529         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o5">m_type</a> == Quantity::NUM) {
01530           rowVal= <a class="code" href="classcatalog_access_1_1_catalog.html#r13">m_numericals</a>[i].at(tot);
01531           <span class="keywordflow">if</span> ( readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o4">m_null</a>.empty() ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set(rowVal);
01532           <span class="keywordflow">else</span> {
01533 <span class="preprocessor">#ifdef WIN32</span>
01534 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( _isnan(rowVal) ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set(colNull[j]);
01535 <span class="preprocessor">#else</span>
01536 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( std::isnan(rowVal) ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set(colNull[j]);
01537 <span class="preprocessor">#endif</span>
01538 <span class="preprocessor"></span>            <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set(rowVal);
01539             <span class="comment">// to be improved for integers</span>
01540           }
01541         }
01542         <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#o0">m_name</a>].set( <a class="code" href="classcatalog_access_1_1_catalog.html#r12">m_strings</a>[i].at(tot) );
01543       }
01544       tot++;
01545       itor++;
01546       <span class="keywordflow">if</span> (tot == <a class="code" href="classcatalog_access_1_1_catalog.html#r25">m_numSelRows</a>) <span class="keywordflow">break</span>;
01547     }
01548   }
01549   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01550     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot write at row#"</span> &lt;&lt; tot;
01551     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
01552     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a24">BAD_ROW</a>;
01553   }<span class="comment">/* end of try */</span>
01554   }<span class="comment">/* at least 1 selected row */</span>
01555 
01556   <span class="keyword">delete</span> myDOL; myDOL=0;
01557   sortie &lt;&lt; <span class="stringliteral">"output fits is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" rows written)"</span>;
01558   <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(0, sortie.str());
01559   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
01560 }
01561 
01562 } <span class="comment">// namespace catalogAccess</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Wed Feb 1 14:22:19 2006 for catalogAccess by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
