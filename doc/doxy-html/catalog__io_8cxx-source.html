<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>catalog_io.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>catalog_io.cxx</h1><a href="catalog__io_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00015 <span class="preprocessor">#include "<a class="code" href="catalog_8h.html">catalog.h</a>"</span>
00016 
00017 <span class="keyword">namespace </span>catalogAccess {
00018   <span class="keyword">using</span> <span class="keyword">namespace </span>tip;
00019 <span class="comment">/**********************************************************************/</span>
00020 <span class="comment">/*  DEFINING CLASS CONSTANTS                                          */</span>
00021 <span class="comment">/**********************************************************************/</span>
00022 
00023 <span class="comment">// BEWARE: the two constant below are UCD1 standard</span>
00024 <span class="comment">//         need to be changed for UCD1+</span>
00025 
00026 <span class="comment">// the order is important and must be compatible with s_CatalogGeneric</span>
00027 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_List[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00028        <span class="stringliteral">"ID_MAIN"</span>, <span class="stringliteral">"POS_EQ_RA_MAIN"</span>, <span class="stringliteral">"POS_EQ_DEC_MAIN"</span>,
00029         <span class="stringliteral">""</span>,       <span class="stringliteral">"POS_GAL_LON"</span>,    <span class="stringliteral">"POS_GAL_LAT"</span>};
00030 <span class="comment">// "ERROR", "POS_GAL_LON", "POS_GAL_LAT"</span>
00031 <span class="comment">// ERROR do not only refer to the position error</span>
00032 <span class="comment">// ERROR is for any "Uncertainty in Measurements"</span>
00033 
00034 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_Added[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00035        <span class="stringliteral">""</span>, <span class="stringliteral">"_RAJ2000"</span>, <span class="stringliteral">"_DEJ2000"</span>, <span class="stringliteral">""</span>, <span class="stringliteral">"_Glon"</span>, <span class="stringliteral">"_Glat"</span>};
00036 
00037 <span class="comment">// the 2 constants above are only defined in this file,</span>
00038 <span class="comment">// need to set catalog static members for global availability</span>
00039 
00040 <span class="keyword">const</span> std::string Catalog::s_genericL = UCD_List[4];
00041 <span class="keyword">const</span> std::string Catalog::s_genericB = UCD_List[5];
00042 <span class="keyword">const</span> std::string KeyCatal[2]={<span class="stringliteral">"CDS-CAT"</span>,
00043                                <span class="stringliteral">"Catalogue designation in CDS nomenclature"</span>};
00044 <span class="keyword">const</span> std::string KeyTable[2]={<span class="stringliteral">"CDS-NAME"</span>, <span class="stringliteral">"Table used in a VizieR Query"</span>};
00045 <span class="keyword">const</span> std::string Key_UCD=<span class="stringliteral">"TBUCD"</span>;
00046 
00047 <span class="comment">/**********************************************************************/</span>
00048 <span class="comment">/*  METHODS for IMPORTING, SAVING, LOADING                            */</span>
00049 <span class="comment">/**********************************************************************/</span>
00050 
00051 <span class="comment">// set m_posErrFactor, suppose that Quantity index exist (private method)</span>
00052 <span class="keywordtype">void</span> Catalog::setPosErrFactor(<span class="keyword">const</span> <span class="keywordtype">int</span> index) {
00053 
00054   std::string text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_unit;
00055   <span class="keywordflow">if</span> (text == <span class="stringliteral">""</span>) {
00056     std::ostringstream sortie;
00057     sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_name
00058            &lt;&lt; <span class="stringliteral">") has no unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>;
00059     <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00060   }
00061   <span class="keywordflow">else</span> {
00062     <span class="comment">// use explicit cast to be sure compiler choose the right tolower()</span>
00063     transform(text.begin(), text.end(), text.begin(), (int(*)(int)) tolower);
00064     <span class="keywordflow">if</span> (text == <span class="stringliteral">"deg"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=1.0;
00065     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcsec"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=3600.0;
00066     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcmin"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=60.0;
00067     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"rad"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=1.0/Angle_Conv;
00068     <span class="keywordflow">else</span> {
00069       std::ostringstream sortie;
00070       sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_name
00071              &lt;&lt; <span class="stringliteral">") has unknown unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>;
00072       <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00073     }
00074   }
00075 }
00076 <span class="comment">// search for generic quantities, private: suppose import done (private method)</span>
00077 <span class="keywordtype">void</span> Catalog::setGeneric(<span class="keyword">const</span> <span class="keywordtype">int</span> whichCat) {
00078 
00079   <span class="keyword">const</span> std::string epoch=<span class="stringliteral">"J2000"</span>;
00080   <span class="keywordtype">int</span> max=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00081   <span class="keywordtype">int</span> j;
00082   std::string text, name;
00083   std::vector&lt;Quantity&gt;::iterator itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin();
00084   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.end(); ++itQ, ++i) {
00085 
00086     <span class="keywordflow">if</span> ((whichCat &gt;= 0) &amp;&amp; (whichCat &lt; <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>)) {
00087       <span class="comment">// if it is a known catalog, the generic are defined</span>
00088       text=itQ-&gt;m_name;
00089       <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) {
00090         name=Catalog::s_CatalogGeneric[whichCat][j];
00091         <span class="keywordflow">if</span> (name == <span class="stringliteral">"+"</span>) name=UCD_Added[j];
00092         <span class="keywordflow">if</span> (text == name) {
00093           itQ-&gt;m_isGeneric=<span class="keyword">true</span>;
00094           <span class="keywordflow">switch</span> (j) {
00095             <span class="keywordflow">case</span> 1: <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a>=i;
00096             <span class="keywordflow">break</span>;
00097             <span class="keywordflow">case</span> 2: <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>=i;
00098             <span class="keywordflow">break</span>;
00099             <span class="keywordflow">case</span> 3: <a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_indexErr</a>=i;
00100                     <a class="code" href="classcatalog_access_1_1_catalog.html#c9">setPosErrFactor</a>(i);
00101             <span class="keywordflow">break</span>;
00102             <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
00103           }
00104         }
00105       }<span class="comment">// loop on generic</span>
00106       text=itQ-&gt;m_ucd;
00107     }
00108 
00109     <span class="keywordflow">else</span> {
00110       <span class="comment">// otherwise, take first matching UCD</span>
00111       text=itQ-&gt;m_ucd;
00112       <span class="keywordflow">if</span> (text != <span class="stringliteral">""</span>) <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) { 
00113         <span class="keywordflow">if</span> (text == UCD_List[j]) {
00114           itQ-&gt;m_isGeneric=<span class="keyword">true</span>;
00115           <span class="keywordflow">if</span> ((j == 1) || (j == 2)) {
00116             <span class="comment">// check that epoch is J2000</span>
00117             name=itQ-&gt;m_name;
00118             name.erase(0, name.length()-epoch.length());
00119             <span class="comment">// format contains at least 1 char</span>
00120             <span class="keywordflow">if</span> ((name == epoch) &amp;&amp; (itQ-&gt;m_type == Quantity::NUM)) {
00121               <span class="keywordflow">if</span> (j == 1) <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a>=i;
00122               <span class="keywordflow">else</span>        <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>=i;
00123             }
00124             <span class="keywordflow">else</span> itQ-&gt;m_isGeneric=<span class="keyword">false</span>;
00125           }
00126           <span class="keywordflow">break</span>;
00127         }
00128       }<span class="comment">// loop on generic</span>
00129     }
00130 
00131     <span class="comment">// flag error quantities, useless for already found generic</span>
00132     <span class="keywordflow">if</span> ((text == <span class="stringliteral">"ERROR"</span>) &amp;&amp; (!itQ-&gt;m_isGeneric)) {
00133       <span class="comment">// error column name is e_"associated column" except for position error</span>
00134       text=itQ-&gt;m_name;
00135       <span class="keywordflow">if</span> (text.find(<span class="stringliteral">"e_"</span>) == 0) {
00136         text.erase(0, 2);
00137 <span class="preprocessor">        #ifdef DEBUG_CAT</span>
00138 <span class="preprocessor"></span>        std::cout &lt;&lt; <span class="stringliteral">"ERROR column ("</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; std::endl;
00139 <span class="preprocessor">        #endif</span>
00140 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (j=0; j&lt;max; j++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(j).m_name == text) {
00141           itQ-&gt;m_statError=text;
00142           <span class="keywordflow">break</span>;
00143         }
00144       }
00145       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((text == <span class="stringliteral">"PosErr"</span>) || (text == <span class="stringliteral">"ErrorRad"</span>)) {
00146         itQ-&gt;m_isGeneric=<span class="keyword">true</span>;
00147         <a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_indexErr</a>=i;
00148         <a class="code" href="classcatalog_access_1_1_catalog.html#c9">setPosErrFactor</a>(i);
00149       }
00150     }
00151 
00152   }<span class="comment">// loop on quantities</span>
00153 
00154 }
00155 
00156 <span class="comment">/**********************************************************************/</span>
00157 <span class="comment">// return the number of RAM bytes needed for numRows catalog rows</span>
00158 <span class="keywordtype">long</span> Catalog::getRAMsize(<span class="keyword">const</span> <span class="keywordtype">long</span> numRows, <span class="keyword">const</span> <span class="keywordtype">bool</span> writeLog) {
00159 
00160   std::string mot, text;
00161   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00162   <span class="keywordflow">if</span> (quantSize == 0) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a10">IMPORT_NEED</a>;
00163 
00164   <span class="keywordtype">int</span> nD=0, nS=0, nchar=0;
00165   <span class="keywordtype">int</span> i, j;
00166   std::vector&lt;Quantity&gt;::iterator itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin();
00167   <span class="keywordflow">for</span> (; itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.end(); ++itQ) {
00168     <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::NUM) nD++;
00169     <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (itQ-&gt;m_type == Quantity::STRING) {
00170       nS++;
00171       text=itQ-&gt;m_format;
00172       i=text.length();
00173       <span class="keywordflow">if</span> (i &gt; 1) {
00174         <span class="keywordflow">if</span>  (<a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a> == <span class="stringliteral">"CDS"</span>) text.erase(0, 1);
00175         <span class="keywordflow">else</span> text.erase(i-1);
00176         j=std::atoi(text.c_str());
00177         <span class="keywordflow">if</span> (j &gt; 0) nchar+=j;
00178       }
00179     }
00180   }
00181   <span class="keywordtype">char</span> buffer[50];
00182   <span class="keywordtype">long</span> sizeD=nD*<span class="keyword">sizeof</span>(double)*numRows;
00183   <span class="keywordtype">long</span> sizeS=nchar*<span class="keyword">sizeof</span>(char)*numRows;
00184   i=1+(quantSize+1)/(<span class="keyword">sizeof</span>(long)*8);
00185   <span class="keywordtype">long</span> sizeB=i*<span class="keyword">sizeof</span>(long)*numRows;
00186   <span class="keywordflow">if</span> (writeLog &amp;&amp; (<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> &gt; 0)) {
00187     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>);
00188     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00189     text=<span class="stringliteral">"Original whole catalog number of rows = "</span>+mot;
00190     <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(1, text);
00191   }
00192   <span class="keywordflow">if</span> (numRows &lt;= 0) <span class="keywordflow">return</span> 0;
00193   <span class="keywordflow">if</span> (writeLog) {
00194     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, numRows);
00195     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00196     text=<span class="stringliteral">"Needed RAM space (MB) for "</span>+mot;
00197     sprintf(buffer, <span class="stringliteral">"%5.1f"</span>, (sizeD+sizeS+sizeB)/(1024.*1024.));
00198     mot=buffer;
00199     text=text+<span class="stringliteral">" data rows = "</span>+mot+<span class="stringliteral">"\n"</span>;
00200     sprintf(buffer, <span class="stringliteral">"%5.0f kB for numericals (%3d double per row)"</span>,
00201                    sizeD/1024., nD);
00202     mot=buffer;
00203     text=text+mot+<span class="stringliteral">"\n"</span>;
00204     sprintf(buffer, <span class="stringliteral">"%5.0f kB for %2d strings (%3d char per row)"</span>,
00205                    sizeS/1024., nS, nchar);
00206     mot=buffer;
00207     text=text+mot+<span class="stringliteral">"\n"</span>;
00208     sprintf(buffer, <span class="stringliteral">"%5.0f kB for select bits (%2d long per row)"</span>,
00209                    sizeB/1024., i);
00210     mot=buffer;
00211     text=text+mot;
00212     <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(1, text);
00213   }
00214   <span class="keywordflow">return</span> (sizeD+sizeS+sizeB);
00215 }
00216 
00217 
00218 <span class="comment">/**********************************************************************/</span>
00219 <span class="comment">// creates a new column in m_strings, m_numericals (private method)</span>
00220 <span class="keywordtype">void</span> Catalog::create_tables(<span class="keyword">const</span> <span class="keywordtype">int</span> nbQuantAscii, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRows) {
00221 
00222   <span class="keywordtype">int</span> vecSize;
00223   std::string errText;
00224   <span class="keywordflow">if</span> (nbQuantAscii &gt; 0) {
00225     <span class="keywordflow">try</span> {
00226       <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.resize(nbQuantAscii);
00227     }
00228     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00229       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00230       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00231       <span class="keywordflow">throw</span>;
00232     }
00233   }
00234   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00235 <span class="comment">// printf("sizes = %d , %d\n", nbQuantAscii, vecSize);</span>
00236   <span class="keywordflow">if</span> (vecSize &gt; 0) {
00237     <span class="keywordflow">try</span> {
00238       <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.resize(vecSize);
00239     }
00240     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00241       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00242       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00243       <span class="keywordflow">throw</span>;
00244     }
00245   }
00246   <span class="keywordflow">if</span> (maxRows &gt; 0) <a class="code" href="classcatalog_access_1_1_catalog.html#c12">add_rows</a>(maxRows);
00247 
00248 }
00249 <span class="comment">/**********************************************************************/</span>
00250 <span class="comment">// creates a new row in m_strings, m_numericals (private method)</span>
00251 <span class="keywordtype">void</span> Catalog::add_rows(<span class="keyword">const</span> <span class="keywordtype">long</span> maxRows) {
00252 
00253   <span class="keywordtype">int</span> i, vecSize;
00254   std::string errText;
00255 <span class="comment">//printf("!! %ld / %ld \n", m_numRows, maxRows);</span>
00256   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();
00257   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00258     <span class="keywordflow">try</span> {
00259       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) {
00260         <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(maxRows);
00261 <span class="comment">//        for (j=0; j&lt;maxRows; j++) m_strings[i].at(j).resize(20);</span>
00262       }
00263     }
00264     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00265       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00266       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00267       <span class="keywordflow">throw</span>;
00268     }
00269   }
00270   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
00271   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00272     <span class="keywordflow">try</span> {
00273       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(maxRows);
00274     }
00275     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00276       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00277       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00278       <span class="keywordflow">throw</span>;
00279     }
00280   } 
00281 
00282 }
00283 
00284 
00285 <span class="comment">/**********************************************************************/</span>
00286 <span class="comment">// read the catalog from fits file (only description if getDescr is true)</span>
00287 <span class="keywordtype">int</span> Catalog::analyze_fits(<span class="keyword">const</span> Table *myDOL, <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr,
00288                           <span class="keyword">const</span> std::string origin, <span class="keywordtype">long</span> *maxRows) {
00289   std::string text, mot;
00290   <span class="keywordtype">int</span>  i, j, max,
00291        nbQuantAscii=0;
00292   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
00293   <span class="keywordtype">bool</span> binary=<span class="keyword">true</span>;
00294   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
00295   int (*pfunc)(int)=toupper; <span class="comment">// function used by transform</span>
00296   <span class="keyword">const</span> Header &amp;header=myDOL-&gt;getHeader();
00297 
00298   <span class="keywordflow">try</span> {
00299     text=myDOL-&gt;getName();
00300     header.getKeyword(<span class="stringliteral">"XTENSION"</span>, mot);
00301   <span class="comment">/* text.rfind('_');</span>
00302 <span class="comment">    since '/' are replaced by '_' in EXTNAME</span>
00303 <span class="comment">    and  is ambiguous with '_' in catalog name:</span>
00304 <span class="comment">    must search for keywords CDS-CAT  CDS-NAME</span>
00305 <span class="comment">  */</span>
00306   }
00307   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00308     text=<span class="stringliteral">": fits EXTENSION, cannot get name"</span>;
00309     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
00310     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00311   }
00312   std::ostringstream sortie;
00313   sortie &lt;&lt; <span class="stringliteral">"fits extension "</span> &lt;&lt; mot &lt;&lt; <span class="stringliteral">" name = "</span> &lt;&lt; text;
00314   <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(1, sortie.str());
00315   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00316 
00317   <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=<span class="stringliteral">""</span>;   <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a>=<span class="stringliteral">""</span>;
00318   <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=<span class="stringliteral">""</span>; <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a>=<span class="stringliteral">""</span>;
00319   <a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a>=<span class="stringliteral">""</span>;
00320   <span class="keywordflow">if</span> (mot == <span class="stringliteral">"TABLE"</span>) {
00321     binary=<span class="keyword">false</span>;
00322     <a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a>=<span class="stringliteral">"CDS"</span>; <span class="comment">/* to know that format string need to be changed for fits */</span>
00323   }
00324   <span class="keywordflow">try</span> {
00325     header.getKeyword(KeyTable[0], text);
00326     <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=text;
00327     header.getKeyword(KeyCatal[0], mot);
00328     <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=mot;
00329 
00330   }
00331   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00332     <span class="keywordflow">if</span> (binary) {
00333       <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(origin, <span class="stringliteral">"fits EXTENSION, cannot get CDS header keys"</span>);
00334     }
00335     <span class="keywordflow">else</span> {
00336       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get CDS header keys"</span>);
00337       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00338     }
00339   }
00340   <span class="keywordflow">try</span> {
00341     text=header.getKeyComment(KeyTable[0]);
00342     mot =header.getKeyComment(KeyCatal[0]);
00343     <span class="comment">// have to use long comment</span>
00344   }
00345   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00346     <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(origin, <span class="stringliteral">"fits EXTENSION, cannot get CDS header comments"</span>);
00347   }
00348 <span class="comment">//  const Table::FieldCont &amp;allCol=myDOL-&gt;getValidFields();</span>
00349   <span class="keywordflow">try</span> {
00350     max=myDOL-&gt;getValidFields().size();
00351     <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=myDOL-&gt;getNumRecords();
00352   }
00353   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00354     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get number of rows or columns"</span>);
00355     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00356   }
00357   <span class="keywordflow">if</span> (max &lt; 1) {
00358     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, need at least 1 column"</span>);
00359     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a13">BAD_FILETYPE</a>;
00360   }
00361   text=<span class="stringliteral">""</span>;
00362   std::vector&lt;double&gt; colNull(max, 0.0);
00363   <span class="keywordflow">try</span> {
00364     <span class="keyword">const</span> IColumn *myCol = 0;
00365     <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00366       text=<span class="stringliteral">""</span>;
00367       myCol=myDOL-&gt;getColumn(i);
00368       Quantity readQ;
00369       readQ.m_name=myCol-&gt;getId();
00370       readQ.m_unit=myCol-&gt;getUnits();
00371       sprintf(name, <span class="stringliteral">"TFORM%d"</span>, i+1);
00372       mot=name; <span class="comment">/* convert C string to C++ string */</span>
00373       header.getKeyword(mot, text);
00374       transform(text.begin(), text.end(), text.begin(), pfunc);
00375       j=text.length();
00376       readQ.m_format=text;
00377       text=<span class="stringliteral">""</span>;
00378       <span class="keywordflow">if</span> (binary) {
00379         <span class="keywordflow">if</span> ( !myCol-&gt;isScalar() ) {
00380           text=<span class="stringliteral">"unauthorized FITS TABLE vector"</span>;
00381           sortie &lt;&lt; <span class="stringliteral">": VECTOR not supported, column#"</span> &lt;&lt; i+1;
00382           <span class="keywordflow">throw</span> std::runtime_error(text);
00383         }
00384         <span class="keywordflow">if</span> (j == 0) {
00385           text=<span class="stringliteral">"unauthorized FITS empty format "</span>;
00386           sortie &lt;&lt; <span class="stringliteral">": FITS format is empty, column#"</span> &lt;&lt; i+1;
00387           <span class="keywordflow">throw</span> std::runtime_error(text);
00388         }
00389         <span class="keywordflow">if</span> (readQ.m_format[j-1] == <span class="charliteral">'A'</span>) readQ.m_type=Quantity::STRING;
00390         <span class="keywordflow">else</span> readQ.m_type=Quantity::NUM;
00391         sprintf(name, <span class="stringliteral">"TNULL%d"</span>, i+1); mot=name;
00392         <span class="keywordflow">try</span> { header.getKeyword(mot, readQ.m_null); }
00393         <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00394         colNull.at(i)=atof(readQ.m_null.c_str());
00395 <span class="comment">//printf("'%s'\n",  readQ.m_null.c_str() );</span>
00396         sprintf(name, <span class="stringliteral">"%s%d"</span>, Key_UCD.c_str(), i+1); mot=name;
00397         <span class="keywordflow">try</span> {
00398           readQ.m_comment=header.getKeyComment(mot);
00399           header.getKeyword(mot, text);
00400         }
00401         <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00402           sortie &lt;&lt; <span class="stringliteral">"missing keyword "</span> &lt;&lt; mot &lt;&lt; <span class="stringliteral">" for column#"</span> &lt;&lt; i+1;
00403           <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(origin, sortie.str() );
00404           sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00405         }
00406       }
00407       <span class="keywordflow">else</span> {
00408         <span class="keywordflow">if</span> (readQ.m_format[0] == <span class="charliteral">'A'</span>) readQ.m_type=Quantity::STRING;
00409         <span class="keywordflow">else</span> readQ.m_type=Quantity::NUM;
00410         sprintf(name, <span class="stringliteral">"TBCOL%d"</span>, i+1); mot=name;
00411         text=header.getKeyComment(mot);
00412         j=4;
00413         <span class="keywordflow">if</span> (text.substr(0,j) == <span class="stringliteral">"UCD="</span>) text.erase(0,j);
00414         pos=text.find(<span class="charliteral">'.'</span>);
00415         <span class="keywordflow">if</span> (pos != std::string::npos) text.erase(pos);;
00416         <span class="comment">/* ONLY  readQ.m_comment  IS NOT SET */</span>
00417       }
00418       transform(text.begin(), text.end(), text.begin(), pfunc);
00419       readQ.m_ucd=text;
00420       <span class="keywordflow">if</span> (readQ.m_type == Quantity::STRING) {
00421         readQ.m_index=nbQuantAscii;
00422         nbQuantAscii++;
00423       }
00424       <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (readQ.m_type == Quantity::NUM) {
00425         readQ.m_index=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00426         readQ.m_type=Quantity::NUM;
00427       }
00428       <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.push_back(readQ); }
00429       <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00430         text=std::string(<span class="stringliteral">"EXCEPTION filling m_quantities: "</span>)+prob.what();
00431         sortie &lt;&lt; text;
00432         <span class="keywordflow">throw</span>;
00433       }
00434     }<span class="comment">/* loop on columns */</span>
00435   }
00436   <span class="keywordflow">catch</span> (...) {
00437     <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.clear();
00438     j=<a class="code" href="namespacecatalog_access.html#a31a13">BAD_FILETYPE</a>;
00439     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=j;
00440     <span class="keywordflow">if</span> ( text.empty() ) {
00441       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, error reading TABLE column#"</span>;
00442       sortie &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">" description"</span>;
00443       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str() );
00444     }
00445     <span class="keywordflow">else</span> {
00446       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str() );
00447       <span class="comment">// exception sent only for vector allocation</span>
00448       <span class="keywordflow">if</span> (text == sortie.str() ) <span class="keywordflow">throw</span>;
00449     }
00450     <span class="keywordflow">return</span> j;
00451   }
00452 <span class="comment">//printf("numRows=%ld\n", m_numOriRows );</span>
00453   <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=0;
00454   <span class="keywordflow">if</span> ( !*maxRows ) *maxRows=<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>;
00455   <span class="keywordflow">if</span> ((getDescr) || (<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> == 0)) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
00456 
00457   <a class="code" href="classcatalog_access_1_1_catalog.html#c11">create_tables</a>(nbQuantAscii, *maxRows);
00458   <span class="keywordflow">try</span> {
00459     <span class="keywordtype">double</span> rowVal;
00460     std::vector&lt;Quantity&gt;::iterator itQ;
00461     <span class="comment">// Loop over all records (rows) and extract values</span>
00462     <span class="keywordflow">for</span> (Table::ConstIterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end();
00463          ++itor) {
00464       i=0;
00465       <span class="keywordflow">for</span> (itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin(); itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.end(); ++itQ, ++i) {
00466         j=itQ-&gt;m_index;
00467         <span class="comment">// double variable to hold the value of all the numeric fields</span>
00468         <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::NUM) {
00469           rowVal=(*itor)[itQ-&gt;m_name].get();
00470           <span class="keywordflow">if</span> (itQ-&gt;m_null == <span class="stringliteral">""</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=rowVal;
00471           <span class="keywordflow">else</span> {
00472             <span class="keywordflow">if</span> (rowVal == colNull.at(i)) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=MissNAN;
00473             <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=rowVal;
00474           }
00475         }
00476         <span class="keywordflow">else</span> (*itor)[itQ-&gt;m_name].get(<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>) );
00477       }
00478       <span class="keywordflow">if</span> (++<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> == *maxRows) <span class="keywordflow">break</span>;
00479     }<span class="comment">/* loop on rows*/</span>
00480   }
00481   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00482     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot read after row#"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>+1;
00483     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str() );
00484     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a18">BAD_ROW</a>;
00485   }
00486   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
00487 }
00488 <span class="comment">/**********************************************************************/</span>
00489 <span class="comment">/* PRIVATE METHODS analyze_head, analyze_body are in file "catalog_ioText.cxx"</span>
00490 <span class="comment">/**********************************************************************/</span>
00491 <span class="comment">// common code between import and importDescription (private method)</span>
00492 <span class="keywordtype">int</span> Catalog::load(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string ext,
00493                   <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr, <span class="keywordtype">long</span> *maxRows) {
00494 
00495   <span class="keywordtype">int</span> i, err=<a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
00496   std::string origin, text;
00497   <span class="keywordflow">if</span> (getDescr) origin=<span class="stringliteral">"importDescription"</span>; <span class="keywordflow">else</span> origin=<span class="stringliteral">"import"</span>;
00498 
00499   <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=0;
00500   i=fileName.length();
00501   <span class="keywordflow">if</span> (i == 0) {
00502     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
00503     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
00504     err=<a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
00505     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00506     <span class="keywordflow">return</span> err;
00507   }
00508   std::fstream myFile (fileName.c_str(), std::ios::in);
00509   <span class="comment">// file can be opened ?</span>
00510   <span class="keywordflow">if</span> ( !myFile.is_open() ) {
00511     text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" cannot be opened"</span>;
00512     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
00513     err=<a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
00514     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00515     <span class="keywordflow">return</span> err;
00516   }
00517 <span class="comment">/*  DIR *testDir=opendir(fileName.c_str());</span>
00518 <span class="comment">  if (testDir != NULL) {</span>
00519 <span class="comment">    closedir(testDir);</span>
00520 <span class="comment">    text=": FILENAME \""+fileName+"\" is a directory";</span>
00521 <span class="comment">    printErr(origin, text);</span>
00522 <span class="comment">    err=BAD_FILETYPE;</span>
00523 <span class="comment">    m_numRows=err;</span>
00524 <span class="comment">    return err;</span>
00525 <span class="comment">  }*/</span>
00526   myFile.close();
00527   std::ostringstream sortie;
00528   <span class="keywordtype">bool</span>  myTest;
00529   <span class="keyword">const</span> Extension *myEXT = 0;
00530   <span class="comment">// cannot use readTable because FITS IMAGE returns also error 1</span>
00531   <span class="keywordflow">try</span> {
00532     myEXT=IFileSvc::instance().readExtension(fileName, ext);
00533   }
00534   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00535     err=x.code();
00536     <span class="keywordflow">if</span> (err == 1) {
00537       <span class="comment">// This non-cfitsio error number means the file does not exist</span>
00538       <span class="comment">// or is not a table, or is not either Root nor Fits format. </span>
00539       err=<a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00540 <span class="comment">/*      printWarn(origin, "FILENAME is NOT fits");*/</span>
00541     }
00542     <span class="keywordflow">else</span> {
00543       <span class="comment">// Other errors come from cfitsio, but apply to a file</span>
00544       <span class="comment">// which is in FITS format but has some sort of format error.</span>
00545       sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but cfitsio returned error="</span> &lt;&lt; err;
00546       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str());
00547       err=<a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00548       <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00549       <span class="keyword">delete</span> myEXT;
00550       <span class="keywordflow">return</span> err;
00551     }
00552   }
00553   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>) myTest=myEXT-&gt;isTable();
00554   <span class="keyword">delete</span> myEXT;
00555   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>) {
00556  
00557     <span class="keywordflow">if</span> (!myTest) {
00558       text=<span class="stringliteral">": FILENAME is FITS, but NOT a TABLE"</span>;
00559       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
00560       err=<a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00561       <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00562       <span class="keywordflow">return</span> err;
00563     }
00564     <span class="keyword">const</span> Table *myDOL = 0;
00565     <span class="keywordflow">try</span> {
00566       myDOL=IFileSvc::instance().readTable(fileName, ext);
00567     }
00568     <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00569       sortie &lt;&lt; <span class="stringliteral">": FITS is TABLE, but cfitsio returned error="</span> &lt;&lt; x.code();
00570       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str());
00571       err=<a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00572       <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00573       <span class="keyword">delete</span> myDOL;
00574       <span class="keywordflow">return</span> err;
00575     }
00576     <span class="keyword">const</span> <span class="keywordtype">char</span> lf = 0x0A;
00577     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>=fileName+lf+ext;
00578     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c14">analyze_fits</a>(myDOL, getDescr, origin, maxRows);
00579     <span class="keyword">delete</span> myDOL;
00580 
00581   }
00582   <span class="keywordflow">else</span> { <span class="comment">// (err == BAD_FITS)</span>
00583 
00584     err=<a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
00585     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of lines read</span>
00586     <span class="keywordtype">bool</span> testCR=<span class="keyword">false</span>; <span class="comment">// true if lines ends with CR (on windows)</span>
00587     <span class="keywordtype">int</span> what=0;        <span class="comment">// 0 for unkwown, &gt;0 for csv, &lt;0 to tsv</span>
00588                        <span class="comment">// fabs()=1 for standard, =2 for meta QUERY</span>
00589 
00590     myFile.open(fileName.c_str(), std::ios::in);
00591     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c15">analyze_head</a>(&amp;tot, &amp;what, &amp;testCR, &amp;myFile);
00592     <span class="keywordflow">if</span> (!tot) {
00593       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is fits without extension[] "</span>
00594              &lt;&lt; <span class="stringliteral">"specified"</span>;
00595       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str());
00596       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00597       text=<span class="stringliteral">"input file"</span>;
00598       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>) err=<a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
00599       <span class="comment">// in case, for strange reason, file.good() fails at first time</span>
00600     }
00601     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>) {
00602       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is empty or "</span>
00603              &lt;&lt; <span class="stringliteral">"has unknown structure (stopped step "</span> &lt;&lt; -1*err &lt;&lt; <span class="stringliteral">")"</span>;
00604       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str());
00605       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00606       text=<span class="stringliteral">"input file"</span>;
00607       <span class="keywordflow">if</span> (err == 0) err=<a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>; <span class="comment">/* nothing is read */</span>
00608       <span class="keywordflow">else</span> err=<a class="code" href="namespacecatalog_access.html#a31a13">BAD_FILETYPE</a>; <span class="comment">/* can search if catalog name exist */</span>
00609     }
00610     <span class="keywordflow">else</span> {
00611 
00612       <span class="comment">//what is 1 or 2, then negate if TSV type</span>
00613       <span class="keywordflow">if</span> (what == 1) text=<span class="stringliteral">"input text file"</span>;
00614       <span class="keywordflow">else</span> text=<span class="stringliteral">"input META file"</span>;
00615 
00616       <span class="comment">// get columns description and units, data</span>
00617       err=<a class="code" href="classcatalog_access_1_1_catalog.html#c16">analyze_body</a>(&amp;tot, &amp;what, testCR, getDescr, &amp;myFile, maxRows);
00618       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a31a15">BAD_FILELINE</a>) {
00619         <span class="comment">// stopped before reading needed stuff (with getDescr false)</span>
00620         text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" couldn't be read (line too long)"</span>;
00621         <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
00622       }
00623       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>) {
00624         sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName
00625              &lt;&lt; <span class="stringliteral">"\" has wrong type (stopped step "</span> &lt;&lt; 5-1*err &lt;&lt; <span class="stringliteral">")"</span>;
00626         <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str());
00627         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00628         err=<a class="code" href="namespacecatalog_access.html#a31a13">BAD_FILETYPE</a>;
00629       }
00630       <span class="keywordflow">else</span> {
00631         <span class="keywordflow">if</span> (what &gt; 0) sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is CSV type (; separator)"</span>;
00632         <span class="keywordflow">else</span> sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is TSV type (Tab=0x09 separator)"</span>;
00633         <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(1, sortie.str());
00634         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00635       }
00636 
00637     }
00638     myFile.close();
00639     sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">": "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" lines read"</span>;
00640     <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(0, sortie.str());
00641     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>=fileName;
00642     <a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a>=<span class="stringliteral">"CDS"</span>; <span class="comment">/* to know that format string need to be changed for fits */</span>
00643 
00644   }<span class="comment">// file is read</span>
00645   <span class="keywordflow">if</span> (err &lt; 0) {
00646     <a class="code" href="classcatalog_access_1_1_catalog.html#a23">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
00647     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00648     <span class="comment">// exit only if nothing is read</span>
00649     <span class="keywordflow">if</span> ((err == <a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>) || (err == <a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>)) <span class="keywordflow">return</span> err;
00650   }
00651   <span class="comment">// m_quantities vector maybe filled, MUST fill m_selEllipse, m_loadQuantity</span>
00652   <span class="keywordflow">try</span> {
00653     <a class="code" href="classcatalog_access_1_1_catalog.html#o29">m_selEllipse</a>.assign(7, 0.0);
00654     <a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size(), <span class="keyword">true</span>);
00655   }
00656   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00657     text=std::string(<span class="stringliteral">"EXCEPTION on creating m_selEllipse, m_loadQuantity: "</span>)
00658         +prob.what();
00659     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
00660     <span class="keywordflow">throw</span>;
00661   }
00662   <span class="comment">// check if tableName is known to set generic</span>
00663   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="catalog_8h.html#a0">MAX_CAT</a>; i++) {
00664     <span class="keywordflow">if</span> (Catalog::s_CatalogList[2*i+1] == <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>) <span class="keywordflow">break</span>;
00665   }
00666   <span class="keywordflow">if</span> (i == <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>) {
00667     text=<span class="stringliteral">"Unknown table name, all generic quantities may be not found"</span>;
00668     <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(origin, text);
00669   }
00670   <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o0">m_code</a>=Catalog::s_CatalogList[2*i];
00671   <a class="code" href="classcatalog_access_1_1_catalog.html#c10">setGeneric</a>(i);
00672   <span class="keywordflow">return</span> err;
00673 }
00674 <span class="comment">/**********************************************************************/</span>
00675 <span class="comment">// read only the catalog description from file</span>
00676 <span class="keywordtype">int</span> Catalog::importDescription(<span class="keyword">const</span> std::string &amp;fileName,
00677                                <span class="keyword">const</span> std::string ext) {
00678   <span class="keywordtype">int</span> err;
00679   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c23">checkImport</a>(<span class="stringliteral">"importDescription"</span>, <span class="keyword">false</span>);
00680   <span class="comment">// must be called before load() which set m_numRows to 0</span>
00681   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) <span class="keywordflow">return</span> err;
00682 
00683   <span class="keywordtype">long</span> maxRows=0l;
00684   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c17">load</a>(fileName, ext, <span class="keyword">true</span>, &amp;maxRows);
00685   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>) <span class="keywordflow">return</span> err;
00686 
00687   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00688 }
00689 <span class="comment">/**********************************************************************/</span>
00690 <span class="comment">// read from file an entire catalog without selection</span>
00691 <span class="keywordtype">int</span> Catalog::import(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRows,
00692                     <span class="keyword">const</span> std::string ext) {
00693   <span class="keywordtype">int</span> err;
00694   <span class="keywordtype">long</span> maxR=maxRows;
00695   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c23">checkImport</a>(<span class="stringliteral">"import"</span>, <span class="keyword">false</span>);
00696   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) <span class="keywordflow">return</span> err;
00697 
00698   <span class="keywordflow">if</span> (maxR &lt;= 0) {
00699     <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(<span class="stringliteral">"import"</span>, <span class="stringliteral">"trying to get whole catalog file"</span>);
00700     maxR=0;
00701   }
00702 
00703   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c17">load</a>(fileName, ext, <span class="keyword">false</span>, &amp;maxR);
00704   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>) <span class="keywordflow">return</span> err;
00705   <a class="code" href="classcatalog_access_1_1_catalog.html#a5">getRAMsize</a>(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>, <span class="keyword">true</span>);
00706   <span class="keywordflow">try</span> {
00707     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> &lt; maxR) {
00708       <span class="keywordtype">int</span> i;
00709       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();
00710       <span class="comment">// erase unused memory  printf("ERASING\n");</span>
00711       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
00712       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
00713       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
00714     }
00715     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()+2;
00716     <span class="comment">// number of required bits including global and region</span>
00717     err=1+(err-1)/(<span class="keyword">sizeof</span>(long)*8);
00718     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>.resize(err);
00719 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
00720 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
00721               &lt;&lt; err &lt;&lt; std::endl;
00722 <span class="preprocessor">    #endif</span>
00723 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_numRows)
00724       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>, 0);
00725     <span class="comment">// above lines can be commented to test the try catch mechanism</span>
00726   }
00727   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00728     std::string text;
00729     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
00730     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(<span class="stringliteral">"import"</span>, text);
00731     <span class="keywordflow">throw</span>;
00732   }
00733   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>;
00734 }
00735 
00736 
00737 <span class="comment">/**********************************************************************/</span>
00738 <span class="keywordtype">int</span> Catalog::loadSelectFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string ext,
00739                             <span class="keywordtype">long</span> *maxRows)
00740 {
00741   <span class="keyword">const</span> std::string  origin=<span class="stringliteral">"importSelected"</span>;
00742   std::ostringstream sortie;
00743   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       i, max;
00744   <span class="keyword">const</span> Table *myDOL = 0;
00745 
00746   <span class="keywordflow">try</span> {
00747     myDOL=IFileSvc::instance().readTable(fileName, ext);
00748   }
00749   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00750     sortie &lt;&lt; <span class="stringliteral">": FITS is TABLE, but cfitsio returned error="</span> &lt;&lt; x.code();
00751     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str());
00752     <span class="keyword">delete</span> myDOL;
00753     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00754   }
00755   <span class="keywordflow">try</span> {
00756     max=myDOL-&gt;getValidFields().size();
00757     <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=myDOL-&gt;getNumRecords();
00758   }
00759   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00760     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get number of rows or columns"</span>);
00761     <span class="keyword">delete</span> myDOL;
00762     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00763   }
00764   <span class="keywordflow">if</span> (max &lt; 1) {
00765     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, need at least 1 column"</span>);
00766     <span class="keyword">delete</span> myDOL;
00767     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a13">BAD_FILETYPE</a>;
00768   }
00769   <span class="comment">/* beware some initial qunatities can be skipped */</span>
00770   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size() != max) {
00771     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, number of fields ("</span> &lt;&lt; max;
00772     sortie &lt;&lt; <span class="stringliteral">") differ from previous import call ("</span>;
00773     sortie &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size() &lt;&lt; <span class="stringliteral">")"</span>;
00774     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str());
00775     <span class="keyword">delete</span> myDOL;
00776     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a13">BAD_FILETYPE</a>;
00777   }
00778   <span class="keyword">const</span> Header &amp;header=myDOL-&gt;getHeader();
00779   std::string text, unit, mot, form;
00780   <span class="keywordtype">int</span>  err=0;
00781   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
00782   std::vector&lt;double&gt; colNull(max, 0.0);
00783   std::vector&lt;Quantity&gt;::iterator itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin();
00784   <span class="keywordflow">try</span> {
00785     <span class="keyword">const</span> IColumn *myCol = 0;
00786     <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00787       text=<span class="stringliteral">"start"</span>;
00788       myCol=myDOL-&gt;getColumn(i);
00789       text=myCol-&gt;getId();
00790       unit=myCol-&gt;getUnits();
00791       sprintf(name, <span class="stringliteral">"TNULL%d"</span>, i+1); mot=name;
00792       <span class="keywordflow">try</span> { header.getKeyword(mot, form); }
00793       <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00794       colNull.at(i)=atof(form.c_str());
00795       sprintf(name, <span class="stringliteral">"TFORM%d"</span>, i+1);
00796       mot=name; <span class="comment">/* convert C string to C++ string */</span>
00797       header.getKeyword(mot, form);
00798       <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>[i]) {
00799         <span class="keywordflow">if</span> ((text!=itQ-&gt;m_name)||(unit!=itQ-&gt;m_unit)||(form!=itQ-&gt;m_format)) {
00800           text=<span class="stringliteral">""</span>;
00801           <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"fileDiff"</span>);
00802         }
00803         <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::STRING) err++;
00804         itQ++;
00805       }
00806     }<span class="comment">/* loop on columns */</span>
00807   }
00808   <span class="keywordflow">catch</span> (...) {
00809     <span class="keywordflow">if</span> ( text.empty() ) {
00810       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, column#"</span>;
00811       sortie &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">" differ from previous import call"</span>;
00812       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str() );
00813       err=<a class="code" href="namespacecatalog_access.html#a31a13">BAD_FILETYPE</a>;
00814     }
00815     <span class="keywordflow">else</span> {
00816       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, error reading TABLE column#"</span>;
00817       sortie &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">" description"</span>;
00818       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str() );
00819       err=<a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00820     }
00821     <span class="keyword">delete</span> myDOL;
00822     <span class="keywordflow">return</span> err;
00823   }
00824 <span class="comment">//printf("%ld OriRows\n", m_numOriRows);</span>
00825   <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=0;
00826   <span class="keywordflow">if</span> ( !*maxRows ) *maxRows=<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>;
00827   <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> ) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
00828 
00829   <a class="code" href="classcatalog_access_1_1_catalog.html#c11">create_tables</a>(err, *maxRows);
00830   <span class="keywordflow">try</span> {
00831     <span class="keywordtype">double</span> rowVal;
00832     <span class="comment">// max=m_quantities.size();</span>
00833     <span class="keywordflow">for</span> (Table::ConstIterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end();
00834          ++itor, ++<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>) {
00835       err=0;
00836       <span class="keywordflow">for</span> (itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin(); itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.end(); ++itQ, ++err) {
00837         i=itQ-&gt;m_index;
00838         <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::NUM) {
00839           rowVal=(*itor)[itQ-&gt;m_name].get();
00840           <span class="keywordflow">if</span> (itQ-&gt;m_null == <span class="stringliteral">""</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=rowVal;
00841           <span class="keywordflow">else</span> {
00842             <span class="keywordflow">if</span> (rowVal == colNull[err]) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=MissNAN;
00843             <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=rowVal;
00844           }
00845         }
00846         <span class="keywordflow">else</span> (*itor)[itQ-&gt;m_name].get(<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>) );
00847       }
00848     }<span class="comment">/* loop on rows*/</span>
00849   }
00850   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00851     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot read after row#"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>+1;
00852     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str() );
00853     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a18">BAD_ROW</a>;
00854   }
00855   <span class="keyword">delete</span> myDOL;
00856   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
00857 }
00858 <span class="comment">/**********************************************************************/</span>
00859 <span class="comment">/* PRIVATE METHOD loadSelected is in file "catalog_ioText.cxx"</span>
00860 <span class="comment">/**********************************************************************/</span>
00861 <span class="comment">// if a catalog description was already loaded, this method does</span>
00862 <span class="comment">// the same as import() adding selection criteria for loading</span>
00863 <span class="keywordtype">int</span> Catalog::importSelected() {
00864 
00865   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"importSelected"</span>;
00866   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#c23">checkImport</a>(origin, <span class="keyword">true</span>);
00867   <span class="keywordflow">if</span> (quantSize &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) <span class="keywordflow">return</span> quantSize;
00868 
00869   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> &gt; 0) {
00870     <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(origin, <span class="stringliteral">"call 'deleteContent' before 'importSelected'"</span>);
00871     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a9">IMPORT_BIS</a>;
00872   }
00873   <span class="keywordtype">int</span> i, err=0,
00874       maxSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size();
00875   <span class="keywordflow">for</span> (i=0; i&lt;maxSize; i++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>[i]) err++;
00876   <span class="keywordflow">if</span> (err &lt; 2) {
00877     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, <span class="stringliteral">"at least 2 quantities must be selected for import"</span>);
00878     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a27">BAD_SEL_QUANT</a>;
00879   }
00880   std::ostringstream sortie; 
00881   sortie &lt;&lt; err &lt;&lt; <span class="stringliteral">" quantities (over "</span> &lt;&lt; maxSize &lt;&lt; <span class="stringliteral">") selected for import"</span>;
00882   <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(1, sortie.str());
00883   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string</span>
00884   <span class="keywordflow">if</span> (err != quantSize) {
00885     <span class="comment">// in fact, due to select*Quantities() restrictions,</span>
00886     <span class="comment">// quantSize can only be greater than err</span>
00887     <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(2, <span class="stringliteral">"Erasing unwanted quantities for importSelected()"</span>);
00888     <a class="code" href="classcatalog_access_1_1_catalog.html#c1">deleteQuantities</a>();
00889   }
00890   err=<a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>;
00891   std::string text;
00892   <span class="keywordtype">long</span> maxRows=0l;
00893   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos=<a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>.find(0x0A);
00894   <span class="keywordflow">if</span> (pos == std::string::npos) {
00895 
00896     <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>.empty() ) {
00897       <span class="comment">// data must be querried via web</span>
00898 
00899 
00900     }
00901     <span class="keywordflow">else</span> {
00902       <span class="keywordflow">if</span> (!<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>) {
00903         <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, <span class="stringliteral">"file import was not succesful"</span>);
00904         <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a10">IMPORT_NEED</a>;
00905       }
00906       std::fstream myFile (<a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>.c_str(), std::ios::in);
00907       <span class="comment">// file can be opened ?</span>
00908       <span class="keywordflow">if</span> ( !myFile.is_open() ) {
00909         text=<span class="stringliteral">": FILENAME \""</span>+<a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>+<span class="stringliteral">"\" cannot be opened"</span>;
00910         <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
00911         err=<a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
00912         <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00913         <span class="keywordflow">return</span> err;
00914       }
00915       <span class="comment">// go back to initial position</span>
00916       myFile.clear(); <span class="comment">// needed to reset flags before seekg</span>
00917       myFile.seekg(<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>);
00918       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of data lines read</span>
00919       err=<a class="code" href="classcatalog_access_1_1_catalog.html#c20">loadSelected</a>(&amp;tot, &amp;myFile, &amp;maxRows);
00920       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>) {
00921         sortie &lt;&lt; tot &lt;&lt; <span class="stringliteral">" data lines read for importSelected()"</span>;
00922         <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(0, sortie.str());
00923       }
00924       myFile.close();
00925     }
00926 
00927   }
00928   <span class="keywordflow">else</span> { <span class="comment">//fits file</span>
00929 
00930     text=<a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>;
00931     std::string fileName=text.substr(0, pos);
00932     text.erase(0, pos+1);
00933     <span class="keyword">const</span> Extension *myEXT = 0;
00934     <span class="comment">// cannot use readTable because FITS IMAGE returns also error 1</span>
00935     <span class="keywordflow">try</span> {
00936       myEXT=IFileSvc::instance().readExtension(fileName, text);
00937     }
00938     <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00939       err=x.code();
00940       <span class="keywordflow">if</span> (err == 1) {
00941         <span class="comment">// This non-cfitsio error number means the file does not exist</span>
00942         <span class="comment">// or is not a table, or is not either Root nor Fits format. </span>
00943         sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName;
00944         sortie &lt;&lt; <span class="stringliteral">"\" cannot be opened or is NOT fits"</span>;
00945         err=<a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
00946       }
00947       <span class="keywordflow">else</span> {
00948         <span class="comment">// Other errors come from cfitsio, but apply to a file</span>
00949         <span class="comment">// which is in FITS format but has some sort of format error.</span>
00950         sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but cfitsio returned error="</span> &lt;&lt; err;
00951         err=<a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00952       }
00953     }
00954     <span class="keywordflow">if</span> (err &gt;= <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) {
00955       <span class="keywordflow">if</span> ( !myEXT-&gt;isTable() ) {
00956         sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but NOT a TABLE"</span>;
00957         err=<a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
00958       }
00959     }
00960     <span class="keyword">delete</span> myEXT;
00961     <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) {
00962       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str());
00963       <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00964       <span class="keywordflow">return</span> err;
00965     }
00966     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c19">loadSelectFits</a>(fileName, text, &amp;maxRows);
00967 
00968   }
00969   <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(origin, <span class="stringliteral">"function only implemented for column selection"</span>);
00970   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) {
00971     <a class="code" href="classcatalog_access_1_1_catalog.html#a23">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
00972     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00973     <span class="keywordflow">return</span> err;
00974   }
00975   <span class="keywordflow">try</span> {
00976     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> &lt; maxRows) {
00977       <span class="keywordtype">int</span> i;
00978       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();printf(<span class="stringliteral">"ERASING\n"</span>);
00979       <span class="comment">// erase unused memory  </span>
00980       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
00981       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
00982       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
00983     }
00984     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()+2;
00985     <span class="comment">// number of required bits including global and region</span>
00986     err=1+(err-1)/(<span class="keyword">sizeof</span>(long)*8);
00987     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>.resize(err);
00988 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
00989 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
00990               &lt;&lt; err &lt;&lt; std::endl;
00991 <span class="preprocessor">    #endif</span>
00992 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_numRows)
00993       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>, 0);
00994     <span class="comment">// above lines can be commented to test the try catch mechanism</span>
00995   }
00996   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00997     std::string text;
00998     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
00999     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(<span class="stringliteral">"import"</span>, text);
01000     <span class="keywordflow">throw</span>;
01001   }
01002   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>;
01003 }
01004 
01005 
01006 <span class="comment">/**********************************************************************/</span>
01007 <span class="comment">// create catalog header from memory to a text file</span>
01008 <span class="keywordtype">int</span> Catalog::createText(<span class="keyword">const</span> std::string &amp;fileName, <span class="keywordtype">bool</span> clobber,
01009                         <span class="keyword">const</span> std::string origin) {
01010   std::string  text;
01011   std::fstream file;
01012   <span class="keywordtype">int</span> err;
01013 
01014   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c23">checkImport</a>(origin, <span class="keyword">true</span>);
01015   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) <span class="keywordflow">return</span> err;
01016 
01017   err=fileName.length();
01018   <span class="keywordflow">if</span> (err == 0) {
01019     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
01020     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
01021     err=<a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
01022     <span class="keywordflow">return</span> err;
01023   }
01024 
01025   <span class="comment">// overwrite existing file ?</span>
01026   <span class="keywordflow">if</span> (!clobber) {
01027     file.open(fileName.c_str(), std::ios::in);
01028     <span class="keywordflow">if</span> (file) {
01029       file.close();
01030       text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" exist (clobber=no)"</span>;
01031       <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
01032       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
01033     }
01034     file.clear();  <span class="comment">// clears all flags associated with the current stream</span>
01035   }
01036   <span class="comment">// open in write mode, if the file already existed it is erased</span>
01037   file.open(fileName.c_str(), std::ios::out | std::ios::trunc);
01038   <span class="keywordflow">if</span> (!file) {
01039     text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" cannot be written"</span>;
01040     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
01041     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
01042   }
01043 
01044   <span class="keywordtype">char</span> tab=0x09, sep=<span class="charliteral">';'</span>;
01045   <span class="keywordtype">int</span> j, vecSize;
01046   <span class="keywordtype">long</span> tot=0l, totData=0l;
01047   <span class="keywordtype">bool</span> saveAll=(origin == <span class="stringliteral">"saveText"</span>);
01048   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> == <a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>) saveAll=<span class="keyword">true</span>;
01049 
01050   file &lt;&lt; <span class="stringliteral">"#RESOURCE=catalogAccess("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o0">m_code</a> &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; std::endl;
01051   file &lt;&lt; <span class="stringliteral">"#Name: "</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a> &lt;&lt; std::endl;
01052   file &lt;&lt; <span class="stringliteral">"#Title:"</span> &lt;&lt; tab &lt;&lt;  <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a> &lt;&lt; std::endl;
01053   file &lt;&lt; <span class="stringliteral">"#Name: "</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a> &lt;&lt; std::endl;
01054   file &lt;&lt; <span class="stringliteral">"#Title:"</span> &lt;&lt; tab &lt;&lt;  <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a> &lt;&lt; std::endl;
01055   tot+=5;
01056   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01057   <span class="keywordflow">for</span> (j=0; j&lt;vecSize; j++) {
01058     file &lt;&lt; <span class="stringliteral">"#Column"</span> &lt;&lt; tab &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name &lt;&lt; tab &lt;&lt; <span class="stringliteral">"("</span>
01059          &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_format &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; tab;
01060     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name.length() &lt; 8) file &lt;&lt; <span class="stringliteral">"        "</span>;
01061     file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_comment &lt;&lt; tab &lt;&lt; <span class="stringliteral">"[ucd="</span>
01062          &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_ucd &lt;&lt; <span class="stringliteral">"]"</span>
01063          &lt;&lt; std::endl;
01064   }
01065   file &lt;&lt; std::endl;
01066   tot+=vecSize+1;
01067   <span class="comment">// line do NOT end with separator</span>
01068   <span class="keywordflow">for</span> (j=0; j&lt;vecSize-1; j++) {
01069     file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name &lt;&lt; sep;
01070   }
01071   file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name &lt;&lt; std::endl;
01072   <span class="keywordflow">for</span> (j=0; j&lt;vecSize-1; j++) {
01073     file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_unit &lt;&lt; sep;
01074   }
01075   file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_unit &lt;&lt; std::endl;
01076   file &lt;&lt; <span class="stringliteral">"---"</span> &lt;&lt; std::endl;
01077   tot+=3;
01078   <span class="keywordflow">try</span> {
01079     <span class="keywordtype">int</span> i, len, bufSize=0;
01080     <span class="keywordtype">char</span> first, *buffer=NULL;
01081     std::vector&lt;std::string&gt; formats(vecSize, <span class="stringliteral">"%s"</span>);
01082     std::vector&lt;int&gt;         lengths(vecSize, 0);
01083     std::ostringstream sortie;
01084     <span class="keywordtype">double</span> r;
01085     <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) { 
01086       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_format;
01087       j=text.length();
01088       <span class="keywordflow">if</span> (j == 0) <span class="keywordflow">continue</span>;
01089       first=text[0];
01090       text.erase(0, 1);
01091       j=std::atoi(text.c_str());
01092       <span class="keywordflow">if</span> (j &lt;= 0) <span class="keywordflow">continue</span>;
01093       lengths[i]=j;
01094       <span class="keywordflow">if</span> (j &gt; bufSize) {
01095         bufSize=j;
01096         buffer=(<span class="keywordtype">char</span> *)realloc(buffer, bufSize*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
01097         <span class="keywordflow">if</span> (buffer == NULL)
01098           <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"Cannot allocate string buffer"</span>);
01099       }
01100       <span class="keywordflow">switch</span> (first) {
01101       <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
01102         sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">"s"</span>;
01103         formats[i]=sortie.str();
01104         <span class="keywordflow">break</span>;
01105       <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
01106         sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">".0f"</span>;
01107         formats[i]=sortie.str();
01108         <span class="keywordflow">break</span>;
01109       <span class="keywordflow">case</span> <span class="charliteral">'F'</span>:  <span class="comment">// number of decimals is needed from CSV/TSV</span>
01110         <span class="keywordflow">if</span> (i == <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a>)
01111           sortie &lt;&lt; <span class="stringliteral">"%0"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"f"</span>;
01112         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>)
01113           sortie &lt;&lt; <span class="stringliteral">"%+0"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"f"</span>;
01114         <span class="keywordflow">else</span> sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"f"</span>;
01115         formats[i]=sortie.str();
01116         <span class="keywordflow">break</span>;
01117       <span class="keywordflow">default</span> :  <span class="comment">// number of decimals is needed from CSV/TSV</span>
01118         sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"e"</span>;
01119         formats[i]=sortie.str();
01120         <span class="keywordflow">break</span>;
01121       }
01122       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string</span>
01123     }
01124     <span class="comment">// all the quantities have their sprintf format</span>
01125     <span class="comment">// IF their lengths[] is positive</span>
01126     <span class="keywordflow">if</span> (saveAll) {
01127 
01128       <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k=0; k&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>; k++) <span class="keywordflow">for</span> (j=0; j&lt;vecSize; ) {
01129         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::NUM) {
01130           r=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01131           <span class="keywordflow">if</span> (isnan(r)) {
01132             len=lengths[j];
01133             <span class="keywordflow">if</span> (len == 0) len=1;
01134             file &lt;&lt; std::setw(len+1) &lt;&lt; std::setfill(<span class="charliteral">' '</span>);
01135           }
01136           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01137             sprintf(buffer, formats[j].c_str(), r);
01138             file.write(buffer, lengths[j]);
01139           }
01140           <span class="keywordflow">else</span> file &lt;&lt; r;
01141         }
01142         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::STRING) {
01143           text=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01144           <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01145             sprintf(buffer, formats[j].c_str(), text.c_str());
01146             file.write(buffer, lengths[j]);
01147           }
01148           <span class="keywordflow">else</span> file &lt;&lt; text;
01149         }
01150         <span class="keywordflow">if</span> (++j == vecSize) file &lt;&lt; std::endl; <span class="keywordflow">else</span> file &lt;&lt; sep;
01151       } <span class="comment">// loop on rows and quantities</span>
01152 
01153     }
01154     <span class="keywordflow">else</span> <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k=0; k&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>; k++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[0].at(k) &amp; 1) {
01155 
01156       <span class="keywordflow">for</span> (j=0; j&lt;vecSize; ) {
01157         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::NUM) {
01158           r=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01159           <span class="keywordflow">if</span> (isnan(r)) {
01160             len=lengths[j];
01161             <span class="keywordflow">if</span> (len == 0) len=1;
01162             file &lt;&lt; std::setw(len+1) &lt;&lt; std::setfill(<span class="charliteral">' '</span>);
01163           }
01164           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01165             sprintf(buffer, formats[j].c_str(), r);
01166             file.write(buffer, lengths[j]);
01167           }
01168           <span class="keywordflow">else</span> file &lt;&lt; r;
01169         }
01170         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::STRING) {
01171           text=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01172           <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01173             sprintf(buffer, formats[j].c_str(), text.c_str());
01174             file.write(buffer, lengths[j]);
01175           }
01176           <span class="keywordflow">else</span> file &lt;&lt; text;
01177         }
01178         <span class="keywordflow">if</span> (++j == vecSize) file &lt;&lt; std::endl; <span class="keywordflow">else</span> file &lt;&lt; sep;
01179       }
01180       totData++;
01181       <span class="keywordflow">if</span> (totData == <a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>) <span class="keywordflow">break</span>;
01182 
01183     } <span class="comment">// loop on rows and quantities, selected branch</span>
01184 
01185     <span class="keywordflow">if</span> (saveAll) tot+=<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>; <span class="keywordflow">else</span> tot+=<a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>;
01186     <span class="keywordflow">if</span> (buffer != NULL) free(buffer);
01187   }
01188   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01189     text=std::string(<span class="stringliteral">"EXCEPTION writing rows in file: "</span>)+prob.what();
01190     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
01191     <span class="keywordflow">throw</span>;
01192   }
01193   file &lt;&lt; std::endl;
01194   tot++;
01195   file.close();
01196   std::ostringstream sortie; 
01197   sortie &lt;&lt; <span class="stringliteral">"output text file is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" lines written)"</span>;
01198   <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(0, sortie.str());
01199   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;  
01200 }
01201 <span class="comment">/**********************************************************************/</span>
01202 <span class="comment">// save whole catalog from memory to a text file</span>
01203 <span class="keywordtype">int</span> Catalog::saveText(<span class="keyword">const</span> std::string &amp;fileName, <span class="keywordtype">bool</span> clobber) {
01204 
01205   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveText"</span>;
01206   <span class="keywordtype">int</span> err;
01207   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c21">createText</a>(fileName, clobber, origin);
01208   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) <span class="keywordflow">return</span> err;
01209 
01210   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
01211 }
01212 <span class="comment">/**********************************************************************/</span>
01213 <span class="comment">// save selected rows of catalog from memory to a text file</span>
01214 <span class="keywordtype">int</span> Catalog::saveSelectedText(<span class="keyword">const</span> std::string &amp;fileName, <span class="keywordtype">bool</span> clobber) {
01215 
01216   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveSelectedText"</span>;
01217   <span class="keywordtype">int</span> err;
01218   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c21">createText</a>(fileName, clobber, origin);
01219   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) <span class="keywordflow">return</span> err;
01220 
01221   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
01222 }
01223 
01224 
01225 <span class="comment">/**********************************************************************/</span>
01226 <span class="comment">// create catalog header from memory to a FITS file</span>
01227 <span class="keywordtype">int</span> Catalog::createFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string &amp;extName,
01228                         <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append, <span class="keyword">const</span> std::string origin,
01229                         tip::Table **ptrTable) {
01230 
01231   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
01232   std::string text, newName;
01233   <span class="keywordtype">int</span>  j, err;
01234   <span class="keywordtype">bool</span> create=<span class="keyword">true</span>;
01235 
01236   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c23">checkImport</a>(origin, <span class="keyword">true</span>);
01237   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) <span class="keywordflow">return</span> err;
01238 
01239   err=fileName.length();
01240   <span class="keywordflow">if</span> (err == 0) {
01241     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
01242     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
01243     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
01244   }
01245   <span class="keywordflow">if</span> (extName.length() &gt; 68) {
01246     text=<span class="stringliteral">": EXTENSION name is TOO long (limited to 68 characters)"</span>;
01247     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
01248     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
01249   }
01250   <span class="comment">// overwrite existing file ?</span>
01251   <span class="keywordflow">if</span> (!clobber) {
01252     std::fstream file;
01253     file.open(fileName.c_str(), std::ios::in);
01254     <span class="keywordflow">if</span> (file) {
01255       file.close();
01256       create=<span class="keyword">false</span>;
01257       <span class="keywordflow">if</span> (!append) {
01258         text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" exist (clobber=no, append=no)"</span>;
01259         <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
01260         <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a12">BAD_FILENAME</a>;
01261       }
01262       <span class="keywordflow">else</span> {
01263         text=<span class="stringliteral">"appending extension to existing FILENAME (method "</span>+origin+<span class="stringliteral">")"</span>;
01264         <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(1, text);
01265       }
01266     }
01267   }
01268   <span class="keywordflow">if</span> ( extName.empty() ) {
01269     <span class="comment">/* max length is 68, as keyword value starts/ends with ' in 11/80 */</span>
01270     newName=<a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>.substr(0,68);
01271     <span class="comment">/* replace forbidden char. */</span>
01272     err=newName.length();
01273     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01274       <span class="keywordflow">if</span> (newName[j] == <span class="charliteral">'/'</span>) newName[j]=<span class="charliteral">'_'</span>;
01275     }
01276     text=<span class="stringliteral">"EXTENSION name set to '"</span>+newName+<span class="stringliteral">"'"</span>;
01277     <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(origin, text); 
01278     err=<a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
01279   }
01280   <span class="keywordflow">else</span> newName=extName;
01281 
01282   <span class="keywordflow">try</span> {
01283     <span class="keywordflow">if</span> (create) IFileSvc::instance().createFile(fileName);
01284     IFileSvc::instance().appendTable(fileName, newName);
01285     (*ptrTable)=IFileSvc::instance().editTable(fileName, newName);
01286   }
01287   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01288     text=<span class="stringliteral">": cannot append and edit fits EXTENSION"</span>;
01289     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
01290     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
01291   }
01292   Header &amp;header=(*ptrTable)-&gt;getHeader();
01293   <span class="keywordflow">try</span> {
01294     header.setKeyword(KeyCatal[0], <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>);
01295     header.setKeyComment(KeyCatal[0], KeyCatal[1]);
01296     header.setKeyword(KeyTable[0], <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>);
01297     header.setKeyComment(KeyTable[0], KeyTable[1]);
01298     <span class="comment">/* test </span>
01299 <span class="comment">    header.setKeyUnit(KeyTable[0], "deg");*/</span>
01300   }
01301   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01302     text=<span class="stringliteral">"fits EXTENSION, cannot add CDS header keys"</span>;
01303     <a class="code" href="namespacecatalog_access.html#a29">printWarn</a>(origin, text);
01304   }
01305   <span class="keywordflow">try</span> {
01306     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01307     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01308       <span class="keyword">const</span> Quantity &amp;readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01309       <span class="keywordflow">if</span> (readQ.m_type == Quantity::NUM) {
01310         <span class="keywordflow">if</span> ( !readQ.m_null.empty() ) {
01311           sprintf(name, <span class="stringliteral">"TNULL%d"</span>, j+1);
01312           newName=name; <span class="comment">/* convert C string to C++ string */</span>
01313           text=readQ.m_format;
01314           <span class="comment">// to be improved for integers</span>
01315         }
01316         <span class="keywordflow">else</span> text=<span class="stringliteral">"1D"</span>;
01317       }
01318       <span class="keywordflow">else</span> {
01319         text=readQ.m_format;
01320         <span class="keywordflow">if</span> ( isalpha(readQ.m_format[0]) ) {
01321           text.erase(0,1);
01322           text=text+<span class="stringliteral">"A"</span>;
01323         }
01324       }
01325       (*ptrTable)-&gt;appendField(readQ.m_name, text);
01326       <span class="keywordflow">if</span> ( !readQ.m_null.empty() ) {
01327         header.setKeyword(newName, atoi(readQ.m_null.c_str()) );
01328         header.setKeyComment(newName, <span class="stringliteral">"Undefined value of field"</span>);
01329       }
01330       text=readQ.m_unit;
01331       <span class="keywordflow">if</span> ( !text.empty() ) {
01332         sprintf(name, <span class="stringliteral">"TUNIT%d"</span>, j+1);
01333         newName=name; <span class="comment">/* convert C string to C++ string */</span>
01334         header.setKeyword(newName, text);
01335         header.setKeyComment(newName, <span class="stringliteral">"physical unit of field"</span>);
01336       }
01337       sprintf(name, <span class="stringliteral">"%s%d"</span>, Key_UCD.c_str(), j+1);
01338       newName=name; <span class="comment">/* convert C string to C++ string */</span>
01339       header.setKeyword(newName, readQ.m_ucd);
01340       header.setKeyComment(newName, readQ.m_comment);
01341     }<span class="comment">/* loop on quantities */</span>
01342   }
01343   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01344     text=<span class="stringliteral">": fits EXTENSION, cannot add column"</span>;
01345     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, text);
01346     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a14">BAD_FITS</a>;
01347   }
01348 <span class="comment">/* NEED new tip methods</span>
01349 <span class="comment">  const IColumn *myCol = 0;</span>
01350 <span class="comment">  try {</span>
01351 <span class="comment">    for (j=0; j &lt; err; j++) {</span>
01352 <span class="comment">      const Quantity &amp;readQ=m_quantities[j];</span>
01353 <span class="comment">      myCol=(*ptrTable)-&gt;getColumn(j);</span>
01354 <span class="comment"></span>
01355 <span class="comment">    }</span>
01356 <span class="comment">  }</span>
01357 <span class="comment">  catch (const TipException &amp;x) {</span>
01358 <span class="comment">    text=": fits EXTENSION, cannot modify column description";</span>
01359 <span class="comment">    printErr(origin, text);</span>
01360 <span class="comment">    return BAD_FITS;</span>
01361 <span class="comment">  }</span>
01362 <span class="comment">*/</span>
01363   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
01364 }
01365 <span class="comment">/**********************************************************************/</span>
01366 <span class="comment">// save whole catalog from memory to a FITS file</span>
01367 <span class="keywordtype">int</span> Catalog::saveFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string &amp;extName,
01368                       <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append) {
01369 
01370   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveFits"</span>;
01371   Table *myDOL=0;
01372   <span class="keywordtype">int</span> err;
01373   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c22">createFits</a>(fileName, extName, clobber, append, origin, &amp;myDOL);
01374   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) <span class="keywordflow">return</span> err;
01375 
01376   std::ostringstream sortie;
01377   <span class="keywordtype">long</span> tot=0l;
01378   <span class="keywordtype">int</span>  i, j;
01379 
01380   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> &gt; 0) {
01381   <span class="keywordflow">try</span> {
01382     myDOL-&gt;setNumRecords(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
01383     Quantity readQ;
01384     <span class="keywordtype">double</span> rowVal;
01385     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01386     <span class="comment">// Loop over all records (rows) and set values</span>
01387     <span class="keywordflow">for</span> (Table::Iterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end(); ++itor) {
01388       <span class="comment">// double variable to hold the value of all the numeric fields</span>
01389       <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01390         readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01391         i=readQ.m_index;
01392         <span class="keywordflow">if</span> (readQ.m_type == Quantity::NUM) {
01393           rowVal= <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(tot);
01394           <span class="keywordflow">if</span> ( readQ.m_null.empty() ) (*itor)[readQ.m_name].set(rowVal);
01395           <span class="keywordflow">else</span> {
01396             <span class="keywordflow">if</span> ( isnan(rowVal) ) (*itor)[readQ.m_name].set(readQ.m_null);
01397             <span class="keywordflow">else</span> (*itor)[readQ.m_name].set(rowVal);
01398             <span class="comment">// to be improved for integers</span>
01399           }
01400         }
01401         <span class="keywordflow">else</span> (*itor)[readQ.m_name].set( <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].at(tot) );
01402       }
01403       tot++;
01404     }<span class="comment">/* loop on rows */</span>
01405   }
01406   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01407     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot write at row#"</span> &lt;&lt; tot;
01408     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str() );
01409     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a18">BAD_ROW</a>;
01410   }<span class="comment">/* end of try */</span>
01411   }<span class="comment">/* at least 1 row */</span>
01412 
01413   <span class="keyword">delete</span> myDOL; myDOL=0;
01414   sortie &lt;&lt; <span class="stringliteral">"output fits is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" rows written)"</span>;
01415   <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(0, sortie.str());
01416   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
01417 }
01418 <span class="comment">/**********************************************************************/</span>
01419 <span class="comment">// save selected rows of catalog from memory to a FITS file</span>
01420 <span class="keywordtype">int</span> Catalog::saveSelectedFits(<span class="keyword">const</span> std::string &amp;fileName,
01421                               <span class="keyword">const</span> std::string &amp;extName,
01422                               <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append) {
01423 
01424   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveSelectedFits"</span>;
01425   Table *myDOL=0;
01426   <span class="keywordtype">int</span> err;
01427   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c22">createFits</a>(fileName, extName, clobber, append, origin, &amp;myDOL);
01428   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a31a8">IS_VOID</a>) <span class="keywordflow">return</span> err;
01429 
01430   std::ostringstream sortie;
01431   <span class="keywordtype">long</span> tot=0l;
01432   <span class="keywordtype">int</span>  i, j;
01433 
01434   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a> &gt; 0) {
01435   <span class="keywordflow">try</span> {
01436     myDOL-&gt;setNumRecords(<a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>);
01437     Quantity readQ;
01438     <span class="keywordtype">double</span> rowVal;
01439     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01440     Table::Iterator itor=myDOL-&gt;begin();
01441     <span class="comment">// Loop over all selected records (rows) and set values</span>
01442     <span class="comment">// first bit indicates global selection</span>
01443     <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k=0; k&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>; k++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[0].at(k) &amp; 1) {
01444       <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01445         readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01446         i=readQ.m_index;
01447         <span class="keywordflow">if</span> (readQ.m_type == Quantity::NUM) {
01448           rowVal= <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(tot);
01449           <span class="keywordflow">if</span> ( readQ.m_null.empty() ) (*itor)[readQ.m_name].set(rowVal);
01450           <span class="keywordflow">else</span> {
01451             <span class="keywordflow">if</span> ( isnan(rowVal) ) (*itor)[readQ.m_name].set(readQ.m_null);
01452             <span class="keywordflow">else</span> (*itor)[readQ.m_name].set(rowVal);
01453             <span class="comment">// to be improved for integers</span>
01454           }
01455         }
01456         <span class="keywordflow">else</span> (*itor)[readQ.m_name].set( <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].at(tot) );
01457       }
01458       tot++;
01459       itor++;
01460       <span class="keywordflow">if</span> (tot == <a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>) <span class="keywordflow">break</span>;
01461     }
01462   }
01463   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01464     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot write at row#"</span> &lt;&lt; tot;
01465     <a class="code" href="namespacecatalog_access.html#a28">printErr</a>(origin, sortie.str() );
01466     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a18">BAD_ROW</a>;
01467   }<span class="comment">/* end of try */</span>
01468   }<span class="comment">/* at least 1 selected row */</span>
01469 
01470   <span class="keyword">delete</span> myDOL; myDOL=0;
01471   sortie &lt;&lt; <span class="stringliteral">"output fits is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" rows written)"</span>;
01472   <a class="code" href="namespacecatalog_access.html#a30">printLog</a>(0, sortie.str());
01473   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a31a7">IS_OK</a>;
01474 }
01475 
01476 } <span class="comment">// namespace catalogAccess</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jun 28 10:46:02 2005 for catalogAccess by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
