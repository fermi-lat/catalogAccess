<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>catalog_io.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>catalog_io.cxx</h1><a href="catalog__io_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00014 <span class="preprocessor">#include "<a class="code" href="catalog_8h.html">catalog.h</a>"</span>
00015 <span class="preprocessor">#include "tip/Header.h"</span>
00016 
00017 <span class="keyword">namespace </span>catalogAccess {
00018   <span class="keyword">using</span> <span class="keyword">namespace </span>tip;
00019 <span class="comment">/**********************************************************************/</span>
00020 <span class="comment">/*  DEFINING CLASS CONSTANTS                                          */</span>
00021 <span class="comment">/**********************************************************************/</span>
00022 
00023 <span class="comment">// BEWARE: the two constant below are UCD1 standard</span>
00024 <span class="comment">//         need to be changed for UCD1+</span>
00025 
00026 <span class="comment">// the order is important and must be compatible with s_CatalogGeneric</span>
00027 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_List[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00028        <span class="stringliteral">"ID_MAIN"</span>, <span class="stringliteral">"POS_EQ_RA_MAIN"</span>, <span class="stringliteral">"POS_EQ_DEC_MAIN"</span>,
00029         <span class="stringliteral">""</span>,       <span class="stringliteral">"POS_GAL_LON"</span>,    <span class="stringliteral">"POS_GAL_LAT"</span>};
00030 <span class="comment">// "ERROR", "POS_GAL_LON", "POS_GAL_LAT"</span>
00031 <span class="comment">// ERROR do not only refer to the position error</span>
00032 <span class="comment">// ERROR is for any "Uncertainty in Measurements"</span>
00033 
00034 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_Added[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00035        <span class="stringliteral">""</span>, <span class="stringliteral">"_RAJ2000"</span>, <span class="stringliteral">"_DEJ2000"</span>, <span class="stringliteral">""</span>, <span class="stringliteral">"_Glon"</span>, <span class="stringliteral">"_Glat"</span>};
00036 
00037 <span class="comment">// the 2 constants above are only defined in this file,</span>
00038 <span class="comment">// need to set catalog static members for global availability</span>
00039 
<a name="l00040"></a><a class="code" href="classcatalog_access_1_1_catalog.html#r3">00040</a> <span class="keyword">const</span> std::string Catalog::s_genericL = UCD_List[4];
<a name="l00041"></a><a class="code" href="classcatalog_access_1_1_catalog.html#r4">00041</a> <span class="keyword">const</span> std::string Catalog::s_genericB = UCD_List[5];
<a name="l00042"></a><a class="code" href="namespacecatalog_access.html#a2">00042</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[2]={<span class="stringliteral">"CDS-CAT"</span>,
00043                                <span class="stringliteral">"Catalogue designation in CDS nomenclature"</span>};
<a name="l00044"></a><a class="code" href="namespacecatalog_access.html#a3">00044</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[2]={<span class="stringliteral">"CDS-NAME"</span>, <span class="stringliteral">"Table used in a VizieR Query"</span>};
00045 
00046 <span class="comment">/**********************************************************************/</span>
00047 <span class="comment">/*  METHODS for IMPORTING, SAVING, LOADING                            */</span>
00048 <span class="comment">/**********************************************************************/</span>
00049 
00050 <span class="comment">// set m_posErrFactor, suppose that Quantity index exist (private method)</span>
<a name="l00051"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c9">00051</a> <span class="keywordtype">void</span> Catalog::setPosErrFactor(<span class="keyword">const</span> <span class="keywordtype">int</span> index) {
00052 
00053   std::string text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_unit;
00054   <span class="keywordflow">if</span> (text == <span class="stringliteral">""</span>) {
00055     std::ostringstream sortie;
00056     sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_name
00057            &lt;&lt; <span class="stringliteral">") has no unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>;
00058     <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00059   }
00060   <span class="keywordflow">else</span> {
00061     <span class="comment">// use explicit cast to be sure compiler choose the right tolower()</span>
00062     transform(text.begin(), text.end(), text.begin(), (int(*)(int)) tolower);
00063     <span class="keywordflow">if</span> (text == <span class="stringliteral">"deg"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=1.0;
00064     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcsec"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=3600.0;
00065     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcmin"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=60.0;
00066     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"rad"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=1.0/Angle_Conv;
00067     <span class="keywordflow">else</span> {
00068       std::ostringstream sortie;
00069       sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_name
00070              &lt;&lt; <span class="stringliteral">") has unknown unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>;
00071       <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00072     }
00073   }
00074 }
00075 <span class="comment">// search for generic quantities, private: suppose import done (private method)</span>
<a name="l00076"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c10">00076</a> <span class="keywordtype">void</span> Catalog::setGeneric(<span class="keyword">const</span> <span class="keywordtype">int</span> whichCat) {
00077 
00078   <span class="keyword">const</span> std::string epoch=<span class="stringliteral">"J2000"</span>;
00079   <span class="keywordtype">int</span> max=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00080   <span class="keywordtype">int</span> j;
00081   std::string text, name;
00082   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;max; i++)  {
00083 
00084     <span class="keywordflow">if</span> ((whichCat &gt;= 0) &amp;&amp; (whichCat &lt; <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>)) {
00085       <span class="comment">// if it is a known catalog, the generic are defined</span>
00086       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_name;
00087       <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) {
00088         name=Catalog::s_CatalogGeneric[whichCat][j];
00089         <span class="keywordflow">if</span> (name == <span class="stringliteral">"+"</span>) name=UCD_Added[j];
00090         <span class="keywordflow">if</span> (text == name) {
00091           <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric=<span class="keyword">true</span>;
00092           <span class="keywordflow">switch</span> (j) {
00093             <span class="keywordflow">case</span> 1: <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexRA</a>=i;
00094             <span class="keywordflow">break</span>;
00095             <span class="keywordflow">case</span> 2: <a class="code" href="classcatalog_access_1_1_catalog.html#o29">m_indexDEC</a>=i;
00096             <span class="keywordflow">break</span>;
00097             <span class="keywordflow">case</span> 3: <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexErr</a>=i;
00098                     <a class="code" href="classcatalog_access_1_1_catalog.html#c9">setPosErrFactor</a>(i);
00099             <span class="keywordflow">break</span>;
00100             <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
00101           }
00102         }
00103       }<span class="comment">// loop on generic</span>
00104       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_ucd;
00105     }
00106 
00107     <span class="keywordflow">else</span> {
00108       <span class="comment">// otherwise, take first matching UCD</span>
00109       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_ucd;
00110       <span class="keywordflow">if</span> (text != <span class="stringliteral">""</span>) <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) { 
00111         <span class="keywordflow">if</span> (text == UCD_List[j]) {
00112           <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric=<span class="keyword">true</span>;
00113           <span class="keywordflow">if</span> ((j == 1) || (j == 2)) {
00114             <span class="comment">// check that epoch is J2000</span>
00115             name=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_name;
00116             name.erase(0, name.length()-epoch.length());
00117             <span class="comment">// format contains at least 1 char</span>
00118             <span class="keywordflow">if</span> ((name == epoch) &amp;&amp; (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_format[0] == <span class="charliteral">'F'</span>)) {
00119               <span class="keywordflow">if</span> (j == 1) <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexRA</a>=i;
00120               <span class="keywordflow">else</span>        <a class="code" href="classcatalog_access_1_1_catalog.html#o29">m_indexDEC</a>=i;
00121             }
00122             <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric=<span class="keyword">false</span>;
00123           }
00124           <span class="keywordflow">break</span>;
00125         }
00126       }<span class="comment">// loop on generic</span>
00127     }
00128 
00129     <span class="comment">// flag error quantities, useless for already found generic</span>
00130     <span class="keywordflow">if</span> ((text == <span class="stringliteral">"ERROR"</span>) &amp;&amp; (!<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric)) {
00131       <span class="comment">// error column name is e_"associated column" except for position error</span>
00132       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_name;
00133       <span class="keywordflow">if</span> (text.find(<span class="stringliteral">"e_"</span>) == 0) {
00134         text.erase(0, 2);
00135 <span class="preprocessor">        #ifdef DEBUG_CAT</span>
00136 <span class="preprocessor"></span>        std::cout &lt;&lt; <span class="stringliteral">"ERROR column ("</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; std::endl;
00137 <span class="preprocessor">        #endif</span>
00138 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (j=0; j&lt;max; j++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(j).m_name == text) {
00139           <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_statError=text;
00140           <span class="keywordflow">break</span>;
00141         }
00142       }
00143       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((text == <span class="stringliteral">"PosErr"</span>) || (text == <span class="stringliteral">"ErrorRad"</span>)) {
00144         <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric=<span class="keyword">true</span>;
00145         <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexErr</a>=i;
00146         <a class="code" href="classcatalog_access_1_1_catalog.html#c9">setPosErrFactor</a>(i);
00147       }
00148     }
00149 
00150   }<span class="comment">// loop on quantities</span>
00151 
00152 }
00153 
00154 <span class="comment">/**********************************************************************/</span>
00155 <span class="comment">// return the number of RAM bytes needed for numRows catalog rows</span>
<a name="l00156"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a5">00156</a> <span class="keywordtype">long</span> Catalog::getRAMsize(<span class="keyword">const</span> <span class="keywordtype">long</span> numRows, <span class="keyword">const</span> <span class="keywordtype">bool</span> writeLog) {
00157 
00158   std::string mot, text;
00159   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00160   <span class="keywordflow">if</span> (quantSize == 0) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a13">IMPORT_NEED</a>;
00161 
00162   <span class="keywordtype">int</span> nD=0, nS=0, nchar=0;
00163   <span class="keywordtype">int</span> i, j;
00164   <span class="keywordflow">for</span> (i=0; i&lt;quantSize; i++) {
00165     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_type == Quantity::NUM) nD++;
00166     <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_type == Quantity::STRING) {
00167       nS++;
00168       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_format;
00169       <span class="keywordflow">if</span> (text.length() &gt; 1) {
00170         text.erase(0, 1);
00171         j=std::atoi(text.c_str());
00172         <span class="keywordflow">if</span> (j &lt;= 0) <span class="keywordflow">continue</span>;        
00173         nchar+=j;
00174       }
00175     }
00176   }
00177   <span class="keywordtype">char</span> buffer[50];
00178   <span class="keywordtype">long</span> sizeD=nD*<span class="keyword">sizeof</span>(double)*numRows;
00179   <span class="keywordtype">long</span> sizeS=nchar*<span class="keyword">sizeof</span>(char)*numRows;
00180   i=1+(quantSize+1)/(<span class="keyword">sizeof</span>(long)*8);
00181   <span class="keywordtype">long</span> sizeB=i*<span class="keyword">sizeof</span>(long)*numRows;
00182   <span class="keywordflow">if</span> (writeLog &amp;&amp; (<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> &gt; 0)) {
00183     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>);
00184     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00185     text=<span class="stringliteral">"Original whole catalog number of rows = "</span>+mot;
00186     <a class="code" href="namespacecatalog_access.html#a33">printLog</a>(1, text);
00187   }
00188   <span class="keywordflow">if</span> (numRows &lt;= 0) <span class="keywordflow">return</span> 0;
00189   <span class="keywordflow">if</span> (writeLog) {
00190     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, numRows);
00191     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00192     text=<span class="stringliteral">"Needed RAM space (MB) for "</span>+mot;
00193     sprintf(buffer, <span class="stringliteral">"%5.1f"</span>, (sizeD+sizeS+sizeB)/(1024.*1024.));
00194     mot=buffer;
00195     text=text+<span class="stringliteral">" data rows = "</span>+mot+<span class="stringliteral">"\n"</span>;
00196     sprintf(buffer, <span class="stringliteral">"%5.0f kB for numericals (%3d double per row)"</span>,
00197                    sizeD/1024., nD);
00198     mot=buffer;
00199     text=text+mot+<span class="stringliteral">"\n"</span>;
00200     sprintf(buffer, <span class="stringliteral">"%5.0f kB for %2d strings (%3d char per row)"</span>,
00201                    sizeS/1024., nS, nchar);
00202     mot=buffer;
00203     text=text+mot+<span class="stringliteral">"\n"</span>;
00204     sprintf(buffer, <span class="stringliteral">"%5.0f kB for select bits (%2d long per row)"</span>,
00205                    sizeB/1024., i);
00206     mot=buffer;
00207     text=text+mot;
00208     <a class="code" href="namespacecatalog_access.html#a33">printLog</a>(1, text);
00209   }
00210   <span class="keywordflow">return</span> (sizeD+sizeS+sizeB);
00211 }
00212 
00213 <span class="comment">/**********************************************************************/</span>
00214 <span class="comment">// creates a new column in m_strings, m_numericals (private method)</span>
<a name="l00215"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c11">00215</a> <span class="keywordtype">void</span> Catalog::create_tables(<span class="keyword">const</span> <span class="keywordtype">int</span> nbQuantAscii) {
00216 
00217   <span class="keywordtype">int</span> vecSize;
00218   std::string errText;
00219   <span class="keywordflow">if</span> (nbQuantAscii &gt; 0) {
00220     <span class="keywordflow">try</span> {
00221       <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.resize(nbQuantAscii);
00222     }
00223     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00224       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00225       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00226       <span class="keywordflow">throw</span>;
00227     }
00228   }
00229   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00230   <span class="keywordflow">if</span> (vecSize &gt; 0) {
00231     <span class="keywordflow">try</span> {
00232       <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.resize(vecSize);
00233     }
00234     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00235       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00236       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00237       <span class="keywordflow">throw</span>;
00238     }
00239   }
00240   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a> &gt; 0) <a class="code" href="classcatalog_access_1_1_catalog.html#c12">add_rows</a>();
00241 
00242 }
00243 <span class="comment">/**********************************************************************/</span>
00244 <span class="comment">// creates a new row in m_strings, m_numericals (private method)</span>
<a name="l00245"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c12">00245</a> <span class="keywordtype">void</span> Catalog::add_rows() {
00246 
00247   <span class="keywordtype">int</span> i, vecSize;
00248   std::string errText;
00249 <span class="comment">//printf("!! %ld / %ld \n", m_numRows, m_numReadRows);</span>
00250   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();
00251   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00252     <span class="keywordflow">try</span> {
00253       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) {
00254         <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>);
00255 <span class="comment">//        for (j=0; j&lt;m_numReadRows; j++) m_strings[i].at(j).resize(20);</span>
00256       }
00257     }
00258     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00259       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00260       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00261       <span class="keywordflow">throw</span>;
00262     }
00263   }
00264   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
00265   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00266     <span class="keywordflow">try</span> {
00267       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>);
00268     }
00269     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00270       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00271       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00272       <span class="keywordflow">throw</span>;
00273     }
00274   } 
00275 
00276 }
00277 
00278 <span class="comment">/**********************************************************************/</span>
00279 <span class="comment">// loads Ascii input in m_quantities (private method)</span>
00280 <span class="comment">// suppose that index really exists: 0 &lt;= index &lt; m_quantities.size()</span>
<a name="l00281"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c13">00281</a> <span class="keywordtype">void</span> Catalog::translate_cell(std::string mot, <span class="keyword">const</span> <span class="keywordtype">int</span> index) {
00282 
00283   <span class="keywordtype">int</span>  j, last;
00284   <span class="keywordtype">char</span> form; 
00285 
00286   <span class="comment">// remove trailing spaces</span>
00287   last=mot.length();
00288 <span class="comment">/* useless Warning, happen many times for last column of 3EG objects (EGRET)</span>
00289 <span class="comment">  if (last == 0) {</span>
00290 <span class="comment">    std::ostringstream sortie;</span>
00291 <span class="comment">    sortie &lt;&lt; "one quantity has no character (row #" &lt;&lt; m_numRows+1 &lt;&lt; ")";</span>
00292 <span class="comment">    printWarn("private translate_cell", sortie.str());</span>
00293 <span class="comment">  }</span>
00294 <span class="comment">  else {*/</span>
00295   <span class="keywordflow">if</span> (last) {
00296     <span class="keywordflow">do</span> last--;
00297     <span class="keywordflow">while</span> ( (last &gt;= 0) &amp;&amp; (mot.at(last) == <span class="charliteral">' '</span>) );
00298   }
00299   last++;
00300   j=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_index;
00301   form=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_format.at(0);
00302   <span class="keywordflow">if</span> (form == <span class="charliteral">'A'</span>) {
00303     <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>)=mot.substr(0, last);
00304   }
00305   <span class="keywordflow">else</span> {
00306     <span class="keywordflow">if</span> (last) {
00307       <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>)=std::atof(mot.c_str());
00308     }
00309     <span class="keywordflow">else</span>
00310       <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>)=0./0.;
00311   }
00312 
00313 }
00314 
00315 <span class="comment">/**********************************************************************/</span>
00316 <span class="comment">// read the catalog from fits file (only description if getDescr is true)</span>
<a name="l00317"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c14">00317</a> <span class="keywordtype">int</span> Catalog::analyze_fits(<span class="keyword">const</span> Table *myDOL, <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr,
00318                           <span class="keyword">const</span> std::string origin) {
00319 
00320   std::string text, mot;
00321   <span class="keywordtype">int</span>  i, j, max,
00322        found=0,
00323        nbQuantAscii=0;
00324   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum gor header key */</span>
00325   <span class="keywordtype">bool</span> binary=<span class="keyword">true</span>;
00326   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
00327   int (*pfunc)(int)=toupper; <span class="comment">// function used by transform</span>
00328   <span class="keyword">const</span> Header &amp;header=myDOL-&gt;getHeader();
00329 
00330   <span class="keywordflow">try</span> {
00331     text=myDOL-&gt;getName();
00332     header.getKeyword(<span class="stringliteral">"XTENSION"</span>, mot);
00333   <span class="comment">/* text.rfind('_');</span>
00334 <span class="comment">    since '/' are replaced by '_' in EXTNAME</span>
00335 <span class="comment">    and  is ambiguous with '_' in catalog name:</span>
00336 <span class="comment">    must search for keywords CDS-CAT  CDS-NAME</span>
00337 <span class="comment">  */</span>
00338   }
00339   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00340     text=<span class="stringliteral">": fits EXTENSION, cannot get name"</span>;
00341     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
00342     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a17">BAD_FITS</a>;
00343   }
00344   std::ostringstream sortie;
00345   sortie &lt;&lt; <span class="stringliteral">"fits extension "</span> &lt;&lt; mot &lt;&lt; <span class="stringliteral">" name = "</span> &lt;&lt; text;
00346   <a class="code" href="namespacecatalog_access.html#a33">printLog</a>(1, sortie.str());
00347   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00348 
00349   <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=<span class="stringliteral">""</span>;   <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a>=<span class="stringliteral">""</span>;
00350   <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=<span class="stringliteral">""</span>; <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a>=<span class="stringliteral">""</span>;
00351   <span class="keywordflow">if</span> (mot == <span class="stringliteral">"TABLE"</span>) binary=<span class="keyword">false</span>;
00352   <span class="keywordflow">try</span> {
00353     header.getKeyword(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0], text);
00354     <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=text;
00355     header.getKeyword(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0], mot);
00356     <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=mot;
00357 
00358   }
00359   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00360     <span class="keywordflow">if</span> (binary) {
00361       <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, <span class="stringliteral">"fits EXTENSION, cannot get all header keys"</span>);
00362     }
00363     <span class="keywordflow">else</span> {
00364       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get all header keys"</span>);
00365       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a17">BAD_FITS</a>;
00366     }
00367   }
00368   <span class="keywordflow">try</span> {
00369     text=header.getKeyComment(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0]);
00370     mot =header.getKeyComment(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0]);
00371     <span class="comment">// have to use long comment</span>
00372   }
00373   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00374     <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, <span class="stringliteral">"fits EXTENSION, cannot get all header comments"</span>);
00375   }
00376 <span class="comment">//  const Table::FieldCont &amp;allCol=myDOL-&gt;getValidFields();</span>
00377   max=myDOL-&gt;getValidFields().size();
00378   <span class="keywordflow">if</span> (max &lt; 1) {
00379     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, need at least 1 column"</span>);
00380     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a16">BAD_FILETYPE</a>;
00381   }
00382   text=<span class="stringliteral">""</span>;
00383   <span class="keywordflow">try</span> {
00384     <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=myDOL-&gt;getNumRecords();
00385     <span class="keyword">const</span> IColumn *myCol = 0;
00386     <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00387       found++;
00388       text=<span class="stringliteral">""</span>;
00389       myCol=myDOL-&gt;getColumn(i);
00390       <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
00391       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>=myCol-&gt;getId();
00392       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_unit</a>=myCol-&gt;getUnits();
00393       sprintf(name, <span class="stringliteral">"TFORM%d"</span>, i+1);
00394       mot=name; <span class="comment">/* convert C string to C++ string */</span>
00395       header.getKeyword(mot, text);
00396       transform(text.begin(), text.end(), text.begin(), pfunc);
00397       j=text.length();
00398       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>=text;
00399 <span class="comment">//printf("'%s', ",  text.c_str());</span>
00400       text=<span class="stringliteral">""</span>;
00401       <span class="keywordflow">if</span> (binary) {
00402         <span class="keywordflow">if</span> ( !myCol-&gt;isScalar() ) {
00403           text=<span class="stringliteral">"unauthorized FITS TABLE vector"</span>;
00404           sortie &lt;&lt; <span class="stringliteral">": VECTOR not supported, column#"</span> &lt;&lt; found;
00405           <span class="keywordflow">throw</span> std::runtime_error(text);
00406         }
00407         <span class="keywordflow">if</span> (j == 0) {
00408           text=<span class="stringliteral">"unauthorized FITS empty format "</span>;
00409           sortie &lt;&lt; <span class="stringliteral">": FITS format is empty, column#"</span> &lt;&lt; found;
00410           <span class="keywordflow">throw</span> std::runtime_error(text);
00411         }
00412         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[j-1] == <span class="charliteral">'A'</span>) readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::STRING;
00413         <span class="keywordflow">else</span> readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::NUM;
00414         
00415         
00416         <span class="comment">/* readQ.m_comment  readQ.m_comment  ARE NOT SET */</span>
00417       }
00418       <span class="keywordflow">else</span> {
00419         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[0] == <span class="charliteral">'A'</span>) readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::STRING;
00420         <span class="keywordflow">else</span> readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::NUM;
00421         sprintf(name, <span class="stringliteral">"TBCOL%d"</span>, i+1); mot=name;
00422         text=header.getKeyComment(mot);
00423         j=4;
00424         <span class="keywordflow">if</span> (text.substr(0,j) == <span class="stringliteral">"UCD="</span>) text.erase(0,j);
00425         pos=text.find(<span class="charliteral">'.'</span>);
00426         <span class="keywordflow">if</span> (pos != std::string::npos) text.erase(pos);
00427         transform(text.begin(), text.end(), text.begin(), pfunc);
00428         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m2">m_ucd</a>=text;
00429         <span class="comment">/* ONLY  readQ.m_comment  IS NOT SET */</span>
00430       }
00431       <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a> == Quantity::STRING) {
00432         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>=nbQuantAscii;
00433         nbQuantAscii++;
00434       }
00435       <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a> == Quantity::NUM) {
00436         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00437         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::NUM;
00438       }
00439       <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.push_back(readQ); }
00440       <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00441         text=std::string(<span class="stringliteral">"EXCEPTION filling m_quantities: "</span>)+prob.what();
00442         sortie &lt;&lt; text;
00443         <span class="keywordflow">throw</span>;
00444       }
00445     }<span class="comment">/* loop on columns */</span>
00446   }
00447   <span class="keywordflow">catch</span> (...) {
00448     <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.clear();
00449     j=<a class="code" href="namespacecatalog_access.html#a34a16">BAD_FILETYPE</a>;
00450     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=j;
00451     <span class="keywordflow">if</span> ( text.empty() ) {
00452       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, wrong TABLE column#"</span>;
00453       sortie &lt;&lt; found &lt;&lt; <span class="stringliteral">" description"</span>;
00454       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str() );
00455     }
00456     <span class="keywordflow">else</span> {
00457       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str() );
00458       <span class="comment">// exception sent only for vector allocation</span>
00459       <span class="keywordflow">if</span> (text == sortie.str() ) <span class="keywordflow">throw</span>;
00460     }
00461     <span class="keywordflow">return</span> j;
00462   }
00463 <span class="comment">//printf("numRows=%ld\n", m_numOriRows );</span>
00464   <span class="keywordflow">if</span> ((getDescr) || (<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> == 0)) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
00465 
00466   <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a> ) {
00467     <span class="comment">// set the total number of rows to have a maximal value</span>
00468     <span class="comment">// to allocate m_strings, m_numericals buffers.</span>
00469     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>;
00470   }
00471   <a class="code" href="classcatalog_access_1_1_catalog.html#c11">create_tables</a>(nbQuantAscii);
00472   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
00473   <span class="keywordflow">try</span> {
00474     <span class="comment">// Loop over all records (rows) and extract values</span>
00475     <span class="keywordflow">for</span> (Table::ConstIterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end();
00476          ++itor) {
00477 
00478       <span class="comment">// double variable to hold the value of all the fields for each row:</span>
00479       <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00480         j=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_index;
00481         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_type == Quantity::NUM)
00482           <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>)=(*itor)[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_name].get();
00483         <span class="keywordflow">else</span> (*itor)[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_name].get(<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>) );
00484       }
00485       <span class="keywordflow">if</span> (++<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> == <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>) <span class="keywordflow">break</span>;
00486     }
00487   }
00488   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00489     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot read after row#"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>+1;
00490     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str() );
00491     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a21">BAD_ROW</a>;
00492   }
00493   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
00494 }
00495 
00496 
00497 <span class="comment">/**********************************************************************/</span>
00498 <span class="comment">// read the catalog header from text file (private method)</span>
<a name="l00499"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c15">00499</a> <span class="keywordtype">int</span> Catalog::analyze_head(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *tot, <span class="keywordtype">int</span> *what, <span class="keywordtype">bool</span> *testCR) {
00500 
00501   std::string text, mot;
00502   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
00503   <span class="keywordtype">char</span> line[<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>];
00504   <span class="keywordtype">int</span>  i, last,
00505        found=0,
00506        err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
00507 
00508   <span class="comment">// must use good instead eof, because eof is still false</span>
00509   <span class="comment">// if getline reads MAX_LINE char ==&gt; infinite loop</span>
00510   <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=<span class="stringliteral">""</span>;   <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a> =<span class="stringliteral">""</span>;
00511   <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=<span class="stringliteral">""</span>; <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a> =<span class="stringliteral">""</span>;
00512   <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.clear();  
00513   <span class="comment">// to reset the state flags (checked by the previous load call)</span>
00514   <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
00515 
00516     <span class="comment">// extract line with delimiter \n which is discarded</span>
00517     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
00518     text=line; <span class="comment">/* convert C string to C++ string */</span>
00519     <span class="keywordflow">if</span> (*tot == 0) {
00520       pos=text.find(<span class="charliteral">' '</span>);
00521       <span class="keywordflow">if</span> (pos != std::string::npos) {
00522         mot=text.substr(0, pos);
00523         <span class="comment">// fits starts with "SIMPLE  ="</span>
00524         <span class="keywordflow">if</span> (mot == <span class="stringliteral">"SIMPLE"</span>) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a15">BAD_FILENAME</a>;
00525       }
00526     }
00527     (*tot)++;
00528 
00529     <span class="comment">/* should find something like:</span>
00530 <span class="comment">#RESOURCE=21230079</span>
00531 <span class="comment">#Name: J/ApJS/123/79</span>
00532 <span class="comment">#Title: Third EGRET catalog (3EG) (Hartman+, 1999)</span>
00533 <span class="comment">#Table  J_ApJS_123_79_3eg:</span>
00534 <span class="comment">#Name: J/ApJS/123/79/3eg</span>
00535 <span class="comment">#Title: Third EGRET Source Catalog (table 4)</span>
00536 <span class="comment">#blabla(CoosysG:galactic)</span>
00537 <span class="comment">#Column</span>
00538 <span class="comment">// Column must be followed by at least one separation line </span>
00539 <span class="comment"></span>
00540 <span class="comment">    OR (-meta.all for description)</span>
00541 <span class="comment"></span>
00542 <span class="comment">#RESOURCE=J/ApJS/123/79/3eg</span>
00543 <span class="comment">#INFO   =271Total number of tuples (rows) in the table</span>
00544 <span class="comment">#INFO   =CGRO</span>
00545 <span class="comment">#INFO   =Gamma-ray</span>
00546 <span class="comment">#    Third EGRET catalog (3EG) (Hartman+, 1999)</span>
00547 <span class="comment">#    Third EGRET Source Catalog (table 4)</span>
00548 <span class="comment">#</span>
00549 <span class="comment">*/</span>
00550     <span class="keywordflow">switch</span> (found) {
00551     <span class="keywordflow">case</span> 0:
00552       pos=text.find(<span class="stringliteral">"#RESOURCE="</span>);
00553       <span class="keywordflow">if</span> (pos == 0) {
00554         found++;
00555         last=text.length();
00556         <span class="comment">// test if last char is CR from WINDOWS</span>
00557         <span class="keywordflow">if</span> (text[last-1] == 0x0D) {
00558           *testCR=<span class="keyword">true</span>;
00559           last--;
00560           text.erase(last);
00561         }
00562         <span class="keywordflow">else</span> *testCR=<span class="keyword">false</span>;
00563         mot=text.substr(10);
00564         pos=mot.find(<span class="charliteral">'/'</span>);
00565         <span class="keywordflow">if</span> (pos == std::string::npos) {
00566           <span class="comment">// standard desciption  printf("|%s|\n", mot.c_str());</span>
00567           *what=1;
00568         }
00569         <span class="keywordflow">else</span> {
00570           <span class="comment">// -meta.all OR -meta QUERY</span>
00571           *what=2;
00572           pos=mot.rfind(<span class="charliteral">'/'</span>);
00573           <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=mot.substr(0,pos);
00574           <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=mot;
00575         }
00576       }
00577       <span class="keywordflow">break</span>;
00578 
00579     <span class="keywordflow">case</span> 1: <span class="keywordflow">case</span> 3:
00580       <span class="keywordflow">if</span> (*what &lt; 2) mot=<span class="stringliteral">"#Name:"</span>;  <span class="keywordflow">else</span> mot=<span class="stringliteral">"#INFO"</span>; 
00581       pos=text.find(mot);
00582       <span class="keywordflow">if</span> (pos == 0) {
00583         found++;
00584         last=text.length();
00585         <span class="keywordflow">if</span> (*testCR) text.erase(--last);
00586         <span class="comment">// remove heading spaces</span>
00587         <span class="keywordflow">for</span> (i=mot.length(); i&lt;last; i++) {
00588           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00589         }
00590         <span class="keywordflow">if</span> (i == last) mot=<span class="stringliteral">""</span>;
00591         <span class="keywordflow">else</span> {
00592           mot=text.substr(i, last-i);
00593           <span class="comment">// remove trailing spaces</span>
00594           pos=mot.length();
00595           <span class="keywordflow">do</span> pos--;
00596           <span class="keywordflow">while</span> ((mot[pos] == <span class="charliteral">' '</span>) || (mot[pos] == 0x09));
00597           mot.erase(pos+1);
00598         }
00599         <span class="keywordflow">if</span> (*what &lt; 2) {
00600           <span class="keywordflow">if</span> (found &gt; 2) <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=mot; <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=mot;
00601         }
00602         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (found == 2) {
00603           <span class="keywordflow">if</span> ((!<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>) &amp;&amp; ((last=mot.length()) &gt; 1)) {
00604             <span class="keywordflow">if</span> (mot[0] == <span class="charliteral">'='</span>) mot[0]=<span class="charliteral">' '</span>;
00605             <span class="keywordflow">for</span> (i=1; i&lt;last; i++) { <span class="keywordflow">if</span> (!isdigit(mot[i])) <span class="keywordflow">break</span>; } 
00606             mot.erase(i);
00607             <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=atol(mot.c_str());
00608           }
00609         }
00610       }
00611       <span class="keywordflow">break</span>;
00612 
00613     <span class="keywordflow">case</span> 2: <span class="keywordflow">case</span> 4:
00614       <span class="keywordflow">if</span> (*what &lt; 2) mot=<span class="stringliteral">"#Title:"</span>;  <span class="keywordflow">else</span> mot=<span class="stringliteral">"#INFO"</span>;
00615       pos=text.find(mot);
00616       <span class="keywordflow">if</span> (pos == 0) {
00617         <span class="keywordflow">if</span> (*what &gt;= 2) <span class="keywordflow">break</span>; <span class="comment">// read lines until do not start with #INFO</span>
00618         found++;
00619         last=text.length();
00620         <span class="keywordflow">if</span> (*testCR) text.erase(--last);
00621         <span class="comment">// remove heading spaces</span>
00622         <span class="keywordflow">for</span> (i=mot.length(); i&lt;last; i++) {
00623           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00624         }
00625         <span class="keywordflow">if</span> (i == last) mot=<span class="stringliteral">""</span>;
00626         <span class="keywordflow">else</span> {
00627           mot=text.substr(i, last-i);
00628           <span class="comment">// remove trailing spaces</span>
00629           pos=mot.length();
00630           <span class="keywordflow">do</span> pos--;
00631           <span class="keywordflow">while</span> ((mot[pos] == <span class="charliteral">' '</span>) || (mot[pos] == 0x09));
00632           mot.erase(pos+1);
00633         }
00634         <span class="keywordflow">if</span> (found &gt; 3) <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a>=mot; <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a>=mot;
00635       }
00636       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*what &gt;= 2) {
00637         <span class="comment">// separation '#' found,</span>
00638         <span class="keywordflow">if</span> ((last=text.length()) &lt; 3) { found=5; <span class="keywordflow">break</span>;}
00639         found++;
00640         <span class="keywordflow">if</span> (*testCR) text.erase(--last);
00641         <span class="comment">// remove heading spaces</span>
00642         <span class="keywordflow">for</span> (i=1; i&lt;last; i++) {
00643           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00644         }
00645         <span class="keywordflow">if</span> (i == last) mot=<span class="stringliteral">""</span>;
00646         <span class="keywordflow">else</span> {
00647           mot=text.substr(i, last-i);
00648           <span class="comment">// remove trailing spaces</span>
00649           pos=mot.length();
00650           <span class="keywordflow">do</span> pos--;
00651           <span class="keywordflow">while</span> ((mot[pos] == <span class="charliteral">' '</span>) || (mot[pos] == 0x09));
00652           mot.erase(pos+1);
00653         }
00654         <span class="keywordflow">if</span> (found &gt; 3)  <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a>=mot; 
00655         <span class="keywordflow">else</span> { found=4; <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a>=mot; }
00656       }
00657       <span class="keywordflow">break</span>;
00658 
00659     <span class="keywordflow">default</span>:
00660       <span class="comment">// case only for META file, read until #RESOURCE= or # [ucd=]</span>
00661       <span class="keywordflow">if</span> ((last=text.length()) &gt; 7) {
00662         <span class="keywordflow">if</span> (*testCR) text.erase(--last);
00663         <span class="comment">// for META file with several tables, start of 2nd table</span>
00664         mot=<span class="stringliteral">"#RESOURCE="</span>;
00665         <span class="keywordflow">if</span> (text.find(mot) == 0) { found++; <span class="keywordflow">break</span>; }
00666         <span class="comment">// otherwise, remove heading spaces</span>
00667         <span class="keywordflow">for</span> (i=1; i&lt;last; i++) {
00668           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00669         }
00670         mot=text.substr(i, last-i);
00671         <span class="comment">// before #Column, metaALL must end with following string</span>
00672         <span class="keywordflow">if</span> (mot == <span class="stringliteral">"[ucd=]"</span>) found++;
00673       }
00674       <span class="keywordflow">break</span>;
00675     }
00676 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
00677 <span class="preprocessor"></span>    std::cout &lt;&lt; *tot &lt;&lt;<span class="stringliteral">","</span>;
00678     <span class="keywordflow">if</span> (*tot &lt; 60ul) std::cout &lt;&lt; line &lt;&lt;<span class="stringliteral">"|\n"</span>;
00679 <span class="preprocessor">    #endif</span>
00680 <span class="preprocessor"></span>    err=-1*found;
00681     <span class="keywordflow">if</span> (*what &lt; 2) {
00682       <span class="keywordflow">if</span> (found == 5) { err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>; <span class="keywordflow">break</span>; }
00683     }
00684     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (found &gt; 5) { err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>; <span class="keywordflow">break</span>; }
00685 
00686   }<span class="comment">// loop on inFile lines</span>
00687 <span class="preprocessor">  #ifdef DEBUG_CAT</span>
00688 <span class="preprocessor"></span>  std::cout &lt;&lt; std::endl;
00689 <span class="preprocessor">  #endif</span>
00690 <span class="preprocessor"></span>
00691   <span class="keywordflow">return</span> err;
00692 }
00693 
00694 <span class="comment">/**********************************************************************/</span>
00695 <span class="comment">// read catalog data from text file (private method);</span>
00696 <span class="comment">// read only column/quantity description if getDescr is true</span>
<a name="l00697"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c16">00697</a> <span class="keywordtype">int</span> Catalog::analyze_body(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *tot, <span class="keywordtype">int</span> *what, <span class="keyword">const</span> <span class="keywordtype">bool</span> testCR,
00698                           <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr) {
00699 
00700   std::string  origin, text, mot;
00701   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
00702   <span class="keywordtype">char</span> sep=<span class="charliteral">';'</span>,
00703        line[<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>];
00704   std::ostringstream sortie;
00705   <span class="keywordtype">bool</span> foundColumn=<span class="keyword">false</span>,
00706        lineSkipped=<span class="keyword">false</span>;
00707   <span class="keywordtype">int</span>  i, last, err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>,
00708        found=0,
00709        nbQuantAscii=0,
00710        maxLine=<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>-1; <span class="comment">// to avoid computation each line</span>
00711   int (*pfunc)(int)=toupper; <span class="comment">// function used by transform</span>
00712 
00713   <span class="keywordflow">if</span> (getDescr) origin=<span class="stringliteral">"importDescription"</span>; <span class="keywordflow">else</span> origin=<span class="stringliteral">"import"</span>;
00714   <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
00715 
00716     <span class="comment">// extract line with delimiter \n which is discarded</span>
00717     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
00718     (*tot)++;
00719     <span class="keywordflow">switch</span> (found) {
00720     <span class="keywordflow">case</span> 0:
00721       mot=<span class="stringliteral">"#Column"</span>;
00722       text=line; <span class="comment">/* convert C string to C++ string */</span>
00723       pos=text.find(mot);
00724       <span class="keywordflow">if</span> (pos == 0) {
00725         <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
00726         foundColumn=<span class="keyword">true</span>;
00727       <span class="keywordflow">do</span> {
00728         <span class="comment">// column NAME, FORMAT, DESCR, UCD separated by only 1 TAB</span>
00729         last=text.length();
00730         <span class="keywordflow">for</span> (i=mot.length(); i&lt;last; i++) {
00731           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00732         }
00733         <span class="keywordflow">if</span> (i == last) <span class="keywordflow">break</span>; <span class="comment">//no NAME found</span>
00734         mot=text.substr(i, last-i);
00735         pos=mot.find(0x09);
00736         <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">break</span>;  <span class="comment">// lack end of data</span>
00737 
00738         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>=mot.substr(0, pos);
00739         text=mot;
00740         text.erase(0, pos+1);
00741         pos=text.find(0x09);
00742         <span class="keywordflow">if</span> ((pos == std::string::npos) || (pos &lt; 3)) <span class="keywordflow">break</span>;
00743 
00744         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>=text.substr(1, pos-2); <span class="comment">// disregard ( ) </span>
00745         text.erase(0, pos+1);
00746         last=text.length();
00747         <span class="keywordflow">for</span> (i=0; i&lt;last; i++) {
00748           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00749         }
00750         <span class="keywordflow">if</span> (i == last) <span class="keywordflow">break</span>; <span class="comment">// no DESCR found</span>
00751         mot=text.substr(i, last-i);
00752         pos=mot.find(0x09);
00753         <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">break</span>;  <span class="comment">// lack end of data</span>
00754  
00755         text=mot;
00756         text.erase(0, pos+1);
00757         <span class="comment">// remove trailing blanks</span>
00758         <span class="keywordflow">do</span> pos--; <span class="keywordflow">while</span> (mot[pos] == <span class="charliteral">' '</span>);
00759         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m1">m_comment</a>=mot.substr(0, pos+1);
00760         mot=<span class="stringliteral">"[ucd="</span>;
00761         pos=text.find(mot);
00762         <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">break</span>;  <span class="comment">// lack end of data</span>
00763         text.erase(0, mot.length());
00764         pos=text.find(<span class="charliteral">']'</span>);
00765         <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">break</span>;  <span class="comment">// lack last ]</span>
00766 
00767         mot=text.substr(0, pos);
00768         transform(mot.begin(), mot.end(), mot.begin(), pfunc);
00769         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m2">m_ucd</a>=mot;
00770         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[0] == <span class="charliteral">'A'</span>) {
00771           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>=nbQuantAscii;
00772           nbQuantAscii++;
00773           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::STRING;
00774         }
00775         <span class="keywordflow">else</span> {
00776           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00777           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::NUM;
00778         }
00779         <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.push_back(readQ); }
00780         <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00781           text=std::string(<span class="stringliteral">"EXCEPTION filling m_quantities: "</span>)+prob.what();
00782           <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
00783           <span class="keywordflow">throw</span>;
00784         }
00785       }<span class="keywordflow">while</span>(0);
00786         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a> == Quantity::VECTOR) {
00787           sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" wrong column description"</span>;
00788           <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str());
00789           sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00790           <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.clear();
00791           found++; <span class="keywordflow">break</span>; <span class="comment">// to stop reading file</span>
00792         }
00793       }
00794       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (foundColumn) found++;
00795       <span class="comment">// skip lines before #Column (foundColumn is false);</span>
00796       <span class="comment">// then: at least one line without any information</span>
00797       <span class="keywordflow">break</span>;
00798 
00799     <span class="keywordflow">case</span> 1:
00800       <span class="comment">// If lines are separated by  ;  ==&gt; CSV (what unchanged)</span>
00801       <span class="comment">// If lines are separated by TAB ==&gt; TSV (what * -1)</span>
00802       <span class="comment">// Check that first word match first quantity,</span>
00803       <span class="comment">// if not: considered as separation line and loop on case 1.</span>
00804       text=line; <span class="comment">/* convert C string to C++ string */</span>
00805       pos=text.find(sep);
00806       <span class="keywordflow">if</span> (pos != std::string::npos) {
00807         mot=text.substr(0, pos);
00808         <span class="keywordflow">if</span> (mot == <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(0).m_name) found++;
00809       }
00810       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pos=text.find(0x09)) != std::string::npos) {
00811         <span class="comment">// suppose there is at least 2 columns</span>
00812         mot=text.substr(0, pos);
00813         <span class="keywordflow">if</span> (mot == <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(0).m_name) {
00814           (*what)*=-1;
00815           found++;
00816           sep=0x09;
00817         }
00818       }
00819       <span class="keywordflow">break</span>;
00820 
00821     <span class="keywordflow">case</span> 2:
00822       <span class="comment">// most of decription is read, units on separate line</span>
00823       last=strlen(line);
00824       <span class="keywordflow">if</span> (testCR) line[--last]=<span class="charliteral">'\0'</span>;
00825       <span class="keywordflow">if</span> (last &gt; 0) {
00826         found++;
00827         text=line; <span class="comment">/* convert C string to C++ string */</span>
00828         i=0;
00829         last=text.find(sep);
00830         <span class="keywordflow">do</span> {
00831           pos=last;
00832           mot=text.substr(0, pos);
00833           <span class="keywordflow">if</span> (pos != std::string::npos) {
00834             text.erase(0, pos+1); <span class="comment">// pos); to test exception below</span>
00835             last=text.find(sep);
00836           }
00837           <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_unit=mot; }
00838           <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00839             <span class="keywordflow">if</span> (i == <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size())
00840               text=<span class="stringliteral">"more units than quantities, ignoring last unit(s)"</span>;
00841             <span class="keywordflow">else</span>
00842               text=std::string(<span class="stringliteral">"EXCEPTION setting m_unit in m_quantities "</span>)
00843                    +prob.what();
00844             <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, text);
00845             <span class="keywordflow">break</span>;
00846           }
00847           i++;
00848         }
00849         <span class="keywordflow">while</span> (pos != std::string::npos);
00850         <span class="keywordflow">if</span> (i &lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size())
00851           <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, <span class="stringliteral">"less units than quantities !"</span>);
00852       }
00853       <span class="keywordflow">break</span>;
00854 
00855     <span class="keywordflow">case</span> 3:
00856       <span class="comment">// decription is read, separation line starting with ---</span>
00857       last=strlen(line);
00858       <span class="keywordflow">if</span> (testCR) line[--last]=<span class="charliteral">'\0'</span>;
00859       <span class="keywordflow">if</span> ((last &gt; 0) &amp;&amp; (line[0] == <span class="charliteral">'-'</span>)) {
00860         found++;
00861         <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
00862         <a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.tellg();
00863         <span class="keywordflow">if</span> (getDescr) <span class="keywordflow">break</span>; <span class="comment">// must NOT read all file and create tables</span>
00864         <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a> ) {
00865           <span class="comment">// read the total number of rows to have a maximal value</span>
00866           <span class="comment">// to allocate m_strings, m_numericals buffers.</span>
00867           <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
00868             <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
00869             <span class="keywordflow">if</span> (strlen(line) &lt; 2) <span class="keywordflow">break</span>; <span class="comment">// 1 CR for WINDOWS</span>
00870             <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>++;
00871           }
00872           <span class="comment">// go back to initial position printf("%ld ReadRows\n", m_numReadRows);</span>
00873           <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.clear(); <span class="comment">// needed to reset flags before seekg</span>
00874           <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.seekg(<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>);
00875           <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>; <span class="comment">// used by importSelected();</span>
00876         }
00877         <a class="code" href="classcatalog_access_1_1_catalog.html#c11">create_tables</a>(nbQuantAscii);
00878       }
00879       <span class="keywordflow">break</span>;
00880 
00881     <span class="keywordflow">default</span>:
00882       last=strlen(line);
00883       <span class="keywordflow">if</span> ((last == 0) || (line[0] == 0x0D)) {
00884         lineSkipped=<span class="keyword">true</span>; <span class="comment">// to have Warning messages below</span>
00885         <span class="keywordflow">break</span>;
00886       }
00887       <span class="comment">// string max size is MAX_LINE-1;</span>
00888       <span class="keywordflow">if</span> (last &gt;= maxLine) {
00889         sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" exceeds maximal size ("</span>
00890                &lt;&lt; <a class="code" href="catalog_8h.html#a3">MAX_LINE</a> &lt;&lt; <span class="stringliteral">")"</span>;
00891         <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str());
00892         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00893         err=<a class="code" href="namespacecatalog_access.html#a34a18">BAD_FILELINE</a>;
00894         <span class="keywordflow">break</span>;
00895       }
00896       i=strncmp(line, <span class="stringliteral">"#Table"</span>, 6);
00897       <span class="keywordflow">if</span> (i == 0) {
00898         sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">": second table start (not read)"</span>;
00899         <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, sortie.str());
00900         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00901         err=<a class="code" href="namespacecatalog_access.html#a34a21">BAD_ROW</a>;
00902         <span class="keywordflow">break</span>;
00903       }
00904       <span class="keywordflow">if</span> (testCR) line[--last]=<span class="charliteral">'\0'</span>;
00905       text=line; <span class="comment">/* convert C string to C++ string */</span>
00906       pos=text.find(sep);
00907       <span class="keywordflow">if</span> (pos == std::string::npos) {
00908         sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" without separator, line skipped"</span>;
00909         <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, sortie.str());
00910         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00911         <span class="keywordflow">break</span>;
00912       }
00913       <span class="keywordflow">if</span> ((<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> == <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>) || lineSkipped) {
00914         err=<a class="code" href="namespacecatalog_access.html#a34a21">BAD_ROW</a>;
00915         <span class="keywordflow">break</span>;
00916       }
00917       i=0;
00918       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00919       <span class="keywordflow">do</span> {
00920         mot=text.substr(0, pos);
00921         <span class="keywordflow">if</span> (i &lt; err) <a class="code" href="classcatalog_access_1_1_catalog.html#c13">translate_cell</a>(mot, i);
00922         <span class="keywordflow">else</span> {
00923           sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" contains too many quantities"</span>;
00924           <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, sortie.str());
00925           sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00926           <span class="keywordflow">break</span>;
00927         }
00928         i++;
00929         <span class="keywordflow">if</span> (pos != std::string::npos) {
00930           text.erase(0, pos+1);
00931           pos=text.find(sep);
00932         }
00933         <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
00934       }
00935       <span class="keywordflow">while</span> (1);
00936       <span class="keywordflow">if</span> (i &lt;  err) {
00937         sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" does not contain all quantities"</span>;
00938         <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, sortie.str());
00939         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00940       }
00941       err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
00942       <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>++;
00943       <span class="comment">//found++;</span>
00944       <span class="keywordflow">break</span>;
00945     }
00946     <span class="comment">// to have only 1 test when reading all file</span>
00947     <span class="keywordflow">if</span> (found &lt; 4) {
00948       <span class="comment">// when separation line after Column is found,</span>
00949       <span class="comment">// Quantities must be set.</span>
00950       <span class="keywordflow">if</span> (found == 1) {
00951         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size() == 0) { found--; <span class="keywordflow">break</span>; }
00952         <span class="keywordflow">if</span> (*what &gt;= 2) { found=4; <span class="keywordflow">break</span>; }
00953                        <span class="comment">// found changed, no error on META ALL</span>
00954       }
00955     }
00956     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (getDescr) <span class="keywordflow">break</span>;
00957     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a34a21">BAD_ROW</a>) <span class="keywordflow">break</span>; <span class="comment">// just stop, error not taken into account</span>
00958 
00959   }<span class="comment">// loop on file lines</span>
00960   <span class="comment">//only possible errors: BAD_FILELINE or BAD_ROW</span>
00961   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a34a21">BAD_ROW</a>) err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
00962   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a34a18">BAD_FILELINE</a>) <span class="keywordflow">return</span> err;
00963   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (found &lt; 4) <span class="keywordflow">return</span> (-1*found);
00964   
00965   <span class="keywordflow">return</span> err;
00966 }
00967 
00968 <span class="comment">/**********************************************************************/</span>
00969 <span class="comment">// common code between import and importDescription (private method)</span>
<a name="l00970"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c17">00970</a> <span class="keywordtype">int</span> Catalog::load(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string ext,
00971                   <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr) {
00972 
00973   <span class="keywordtype">int</span> i, err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
00974   std::string origin, text;
00975   <span class="keywordflow">if</span> (getDescr) origin=<span class="stringliteral">"importDescription"</span>; <span class="keywordflow">else</span> origin=<span class="stringliteral">"import"</span>;
00976 
00977   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
00978   i=fileName.length();
00979   <span class="keywordflow">if</span> (i == 0) {
00980     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
00981     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
00982     err=<a class="code" href="namespacecatalog_access.html#a34a15">BAD_FILENAME</a>;
00983     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
00984     <span class="keywordflow">return</span> err;
00985   }
00986   <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.is_open() ) <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.close();
00987   <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.open(fileName.c_str(), std::ios::in);
00988   <span class="comment">// file can be opened ?</span>
00989   <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.is_open() ) {
00990     text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" cannot be opened"</span>;
00991     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
00992     err=<a class="code" href="namespacecatalog_access.html#a34a15">BAD_FILENAME</a>;
00993     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
00994     <span class="keywordflow">return</span> err;
00995   }
00996 <span class="comment">/*  DIR *testDir=opendir(fileName.c_str());</span>
00997 <span class="comment">  if (testDir != NULL) {</span>
00998 <span class="comment">    closedir(testDir);</span>
00999 <span class="comment">    myFile.close();</span>
01000 <span class="comment">    text=": FILENAME \""+fileName+"\" is a directory";</span>
01001 <span class="comment">    printErr(origin, text);</span>
01002 <span class="comment">    err=BAD_FILETYPE;</span>
01003 <span class="comment">    m_numRows=err;</span>
01004 <span class="comment">    return err;</span>
01005 <span class="comment">  }*/</span>
01006   std::ostringstream sortie;
01007   <span class="keywordtype">bool</span> myTest;
01008   { <span class="comment">// inside a block to destroy test object Extension</span>
01009     <span class="comment">// cannot use readTable because FITS IMAGE returns also error 1</span>
01010     <span class="keyword">const</span> Extension *myDOL = 0;
01011     <span class="keywordflow">try</span> {
01012       myDOL=IFileSvc::instance().readExtension(fileName, ext);
01013     }
01014     <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01015       err=x.code();
01016       <span class="keywordflow">if</span> (err == 1) {
01017         <span class="comment">// This non-cfitsio error number means the file does not exist</span>
01018         <span class="comment">// or is not a table, or is not in either Root nor Fits format. </span>
01019         err=<a class="code" href="namespacecatalog_access.html#a34a17">BAD_FITS</a>;
01020 <span class="comment">/*      printWarn(origin, "FILENAME is NOT fits");*/</span>
01021       }
01022       <span class="keywordflow">else</span> {
01023         <span class="comment">// Other errors come from cfitsio, but apply to a file</span>
01024         <span class="comment">// which is in FITS format but has some sort of format error.</span>
01025         sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but cfitsio returned error="</span> &lt;&lt; err;
01026         <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str());
01027         err=<a class="code" href="namespacecatalog_access.html#a34a17">BAD_FITS</a>;
01028         <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01029         <span class="keywordflow">return</span> err;
01030       }
01031     }
01032     <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) myTest=myDOL-&gt;isTable();
01033   }
01034   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) {
01035  
01036     <span class="keywordflow">if</span> (!myTest) {
01037       text=<span class="stringliteral">": FILENAME is FITS, but NOT a TABLE"</span>;
01038       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01039       err=<a class="code" href="namespacecatalog_access.html#a34a17">BAD_FITS</a>;
01040       <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01041       <span class="keywordflow">return</span> err;
01042     }
01043     <span class="keyword">const</span> Table *myDOL = 0;
01044     <span class="keywordflow">try</span> {
01045       myDOL=IFileSvc::instance().readTable(fileName, ext);
01046     }
01047     <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01048       sortie &lt;&lt; <span class="stringliteral">": FITS is TABLE, but cfitsio returned error="</span> &lt;&lt; err;
01049       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str());
01050       err=<a class="code" href="namespacecatalog_access.html#a34a17">BAD_FITS</a>;
01051       <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01052       <span class="keywordflow">return</span> err;
01053     }
01054     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c14">analyze_fits</a>(myDOL, getDescr, origin);
01055 
01056   }
01057   <span class="keywordflow">else</span> { <span class="comment">// (err == BAD_FITS)</span>
01058 
01059     err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
01060     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of lines read</span>
01061     <span class="keywordtype">bool</span> testCR=<span class="keyword">false</span>; <span class="comment">// true if lines ends with CR (on windows)</span>
01062     <span class="keywordtype">int</span> what=0;        <span class="comment">// 0 for unkwown, &gt;0 for csv, &lt;0 to tsv</span>
01063                        <span class="comment">// fabs()=1 for standard, =2 for meta QUERY</span>
01064     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c15">analyze_head</a>(&amp;tot, &amp;what, &amp;testCR);
01065     <span class="keywordflow">if</span> (!tot) {
01066       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is fits without extension[] "</span>
01067              &lt;&lt; <span class="stringliteral">"specified"</span>;
01068       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str());
01069       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01070       text=<span class="stringliteral">"input file"</span>;
01071       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) err=<a class="code" href="namespacecatalog_access.html#a34a15">BAD_FILENAME</a>;
01072       <span class="comment">// in case, for strange reason, file.good() fails at first time</span>
01073     }
01074     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) {
01075       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is empty or "</span>
01076              &lt;&lt; <span class="stringliteral">"has unknown structure (stopped step "</span> &lt;&lt; -1*err &lt;&lt; <span class="stringliteral">")"</span>;
01077       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str());
01078       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01079       text=<span class="stringliteral">"input file"</span>;
01080       <span class="keywordflow">if</span> (err == 0) err=<a class="code" href="namespacecatalog_access.html#a34a15">BAD_FILENAME</a>; <span class="comment">/* nothing is read */</span>
01081       <span class="keywordflow">else</span> err=<a class="code" href="namespacecatalog_access.html#a34a16">BAD_FILETYPE</a>; <span class="comment">/* can search if catalog name exist */</span>
01082     }
01083     <span class="keywordflow">else</span> {
01084 
01085       <span class="comment">//what is 1 or 2, then negate if TSV type</span>
01086       <span class="keywordflow">if</span> (what == 1) text=<span class="stringliteral">"input text file"</span>;
01087       <span class="keywordflow">else</span> text=<span class="stringliteral">"input META file"</span>;
01088 
01089       <span class="comment">// get columns description and units, data</span>
01090       err=<a class="code" href="classcatalog_access_1_1_catalog.html#c16">analyze_body</a>(&amp;tot, &amp;what, testCR, getDescr);
01091       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a34a18">BAD_FILELINE</a>) {
01092         <span class="comment">// stopped before reading needed stuff (with getDescr false)</span>
01093         text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" couldn't be read (line too long)"</span>;
01094         <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01095       }
01096       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) {
01097         sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName
01098              &lt;&lt; <span class="stringliteral">"\" has wrong type (stopped step "</span> &lt;&lt; 5-1*err &lt;&lt; <span class="stringliteral">")"</span>;
01099         <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str());
01100         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01101         err=<a class="code" href="namespacecatalog_access.html#a34a16">BAD_FILETYPE</a>;
01102       }
01103       <span class="keywordflow">else</span> {
01104         <span class="keywordflow">if</span> (what &gt; 0) sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is CSV type (; separator)"</span>;
01105         <span class="keywordflow">else</span> sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is TSV type (Tab=0x09 separator)"</span>;
01106         <a class="code" href="namespacecatalog_access.html#a33">printLog</a>(1, sortie.str());
01107         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01108       }
01109 
01110     }
01111     <span class="comment">// myFile.close();  to be commented to let file opened</span>
01112     sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">": "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" lines read"</span>;
01113     <a class="code" href="namespacecatalog_access.html#a33">printLog</a>(0, sortie.str());
01114 
01115   }<span class="comment">// file is read</span>
01116   <span class="keywordflow">if</span> (err &lt; 0) {
01117     <a class="code" href="classcatalog_access_1_1_catalog.html#a20">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
01118     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01119     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=0;
01120     <span class="comment">// exit only if nothing is read</span>
01121     <span class="keywordflow">if</span> ((err == <a class="code" href="namespacecatalog_access.html#a34a15">BAD_FILENAME</a>) || (err == <a class="code" href="namespacecatalog_access.html#a34a17">BAD_FITS</a>)) <span class="keywordflow">return</span> err;
01122   }
01123   <span class="comment">// m_quantities vector maybe filled, MUST fill m_selEllipse, m_loadQuantity</span>
01124   <span class="keywordflow">try</span> {
01125     <a class="code" href="classcatalog_access_1_1_catalog.html#o30">m_selEllipse</a>.assign(7, 0.0);
01126     <a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size(), <span class="keyword">true</span>);
01127   }
01128   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01129     text=std::string(<span class="stringliteral">"EXCEPTION on creating m_selEllipse, m_loadQuantity: "</span>)
01130         +prob.what();
01131     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01132     <span class="keywordflow">throw</span>;
01133   }
01134   <span class="comment">// check if tableName is known to set generic</span>
01135   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="catalog_8h.html#a0">MAX_CAT</a>; i++) {
01136     <span class="keywordflow">if</span> (Catalog::s_CatalogList[2*i+1] == <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>) <span class="keywordflow">break</span>;
01137   }
01138   <span class="keywordflow">if</span> (i == <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>) {
01139     text=<span class="stringliteral">"Unknown table name, all generic quantities may be not found"</span>;
01140     <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, text);
01141   }
01142   <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o0">m_code</a>=Catalog::s_CatalogList[2*i];
01143   <a class="code" href="classcatalog_access_1_1_catalog.html#c10">setGeneric</a>(i);
01144   <span class="keywordflow">return</span> err;
01145 }
01146 <span class="comment">/**********************************************************************/</span>
01147 <span class="comment">// read only the catalog description from file</span>
<a name="l01148"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a6">01148</a> <span class="keywordtype">int</span> Catalog::importDescription(<span class="keyword">const</span> std::string &amp;fileName,
01149                                <span class="keyword">const</span> std::string ext) {
01150   <span class="keywordtype">int</span> err;
01151   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c20">checkImport</a>(<span class="stringliteral">"importDescription"</span>, <span class="keyword">false</span>);
01152   <span class="comment">// must be called before load() which set m_numRows to 0</span>
01153   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a11">IS_VOID</a>) <span class="keywordflow">return</span> err;
01154 
01155   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c17">load</a>(fileName, ext, <span class="keyword">true</span>);
01156   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) <span class="keywordflow">return</span> err;
01157 
01158   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01159 }
01160 <span class="comment">/**********************************************************************/</span>
01161 <span class="comment">// read from file an entire catalog without selection</span>
<a name="l01162"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a8">01162</a> <span class="keywordtype">int</span> Catalog::import(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRow,
01163                     <span class="keyword">const</span> std::string ext) {
01164   <span class="keywordtype">int</span> err;
01165   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c20">checkImport</a>(<span class="stringliteral">"import"</span>, <span class="keyword">false</span>);
01166   <span class="comment">// after this check, m_numReadRows is 0</span>
01167   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a11">IS_VOID</a>) <span class="keywordflow">return</span> err;
01168 
01169   <span class="keywordflow">if</span> (maxRow &lt;= 0) {
01170     <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(<span class="stringliteral">"import"</span>, <span class="stringliteral">"trying to get whole catalog file"</span>);
01171     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=0;
01172   }
01173   <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=maxRow;
01174 
01175   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c17">load</a>(fileName, ext, <span class="keyword">false</span>);
01176   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) <span class="keywordflow">return</span> err;
01177   <a class="code" href="classcatalog_access_1_1_catalog.html#a5">getRAMsize</a>(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>, <span class="keyword">true</span>);
01178   <span class="keywordflow">try</span> {
01179     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> &lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>) {
01180       <span class="keywordtype">int</span> i;
01181       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();
01182       <span class="comment">// erase unused memory  printf("ERASING\n");</span>
01183       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>);
01184       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
01185       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>);
01186     }
01187     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()+2;
01188     <span class="comment">// number of required bits including global and region</span>
01189     err=1+(err-1)/(<span class="keyword">sizeof</span>(long)*8);
01190     <a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>.resize(err);
01191 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
01192 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
01193               &lt;&lt; err &lt;&lt; std::endl;
01194 <span class="preprocessor">    #endif</span>
01195 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_numRows)
01196       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>, 0);
01197     <span class="comment">// above lines can be commented to test the try catch mechanism</span>
01198   }
01199   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01200     std::string text;
01201     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
01202     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(<span class="stringliteral">"import"</span>, text);
01203     <span class="keywordflow">throw</span>;
01204   }
01205   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>;
01206 }
01207 
01208 
01209 <span class="comment">/**********************************************************************/</span>
01210 <span class="comment">// common code between importWeb and importDescriptionWeb (private method)</span>
<a name="l01211"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c18">01211</a> <span class="keywordtype">int</span> Catalog::loadWeb(<span class="keyword">const</span> std::string catName, <span class="keyword">const</span> std::string urlCode,
01212                      <span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRow) {
01213 
01214   std::string origin, text, web;
01215   <span class="keywordtype">int</span> i, err;
01216   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
01217   <span class="keywordflow">if</span> (maxRow &gt;= 0) origin=<span class="stringliteral">"importWeb"</span>; <span class="keywordflow">else</span> origin=<span class="stringliteral">"importDescriptionWeb"</span>;
01218 
01219   err=<a class="code" href="namespacecatalog_access.html#a34a19">BAD_URL</a>;
01220   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01221   <span class="keywordflow">if</span> (urlCode.length() == 0) {
01222     text=<span class="stringliteral">": CODE for URL (web http address) is empty"</span>;
01223     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01224     <span class="keywordflow">return</span> err;
01225   }
01226   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="catalog_8h.html#a2">MAX_URL</a>; i++) {
01227     text=Catalog::s_CatalogURL[i]; <span class="comment">/* convert C string to C++ string */</span>
01228     pos=text.find(<span class="charliteral">' '</span>);
01229     <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">continue</span>;
01230     <span class="keywordflow">if</span> (text.substr(0, pos) == urlCode) <span class="keywordflow">break</span>;
01231   }
01232   <span class="keywordflow">if</span> (i == <a class="code" href="catalog_8h.html#a2">MAX_URL</a>) {
01233     text=<span class="stringliteral">": CODE for URL (web http address) do not exist"</span>;
01234     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01235     <span class="keywordflow">return</span> err;
01236   }
01237   pos=text.rfind(<span class="charliteral">' '</span>);
01238   <span class="keywordflow">if</span> (pos == std::string::npos) web=text;
01239   <span class="keywordflow">else</span> web=text.substr(pos+1, text.length()-pos);
01240 
01241   <span class="keywordtype">int</span> iCat=<a class="code" href="classcatalog_access_1_1_catalog.html#c21">checkCatName</a>(origin, catName);
01242   <span class="keywordflow">if</span> (iCat &lt; 0) {
01243     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=iCat;
01244     <span class="keywordflow">return</span> iCat;
01245   }
01246   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c20">checkImport</a>(origin, <span class="keyword">false</span>);
01247   <span class="comment">// after this check, m_numOriRows is 0</span>
01248   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a11">IS_VOID</a>) <span class="keywordflow">return</span> err;
01249 
01250   <span class="keywordflow">if</span> (maxRow == 0) <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, <span class="stringliteral">"trying to query whole catalog"</span>);
01251   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
01252 <span class="comment">/* now, ASCII query must be created</span>
01253 <span class="comment">  and sent, using CDS package to given URL</span>
01254 <span class="comment">*/</span>
01255   err=-9;
01256   text=<span class="stringliteral">"Web query not implemented"</span>;
01257   <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01258 
01259 
01260   <span class="keywordflow">if</span> (err &lt; 0) {
01261     <a class="code" href="classcatalog_access_1_1_catalog.html#a20">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
01262     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01263     <span class="keywordflow">return</span> err;
01264   }
01265   <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o30">m_selEllipse</a>.assign(7, 0.0); }
01266   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01267     text=std::string(<span class="stringliteral">"EXCEPTION on creating m_selEllipse: "</span>)+prob.what();
01268     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01269     <span class="keywordflow">throw</span>;
01270   }
01271   <a class="code" href="classcatalog_access_1_1_catalog.html#o0">m_code</a>=catName;
01272   <a class="code" href="classcatalog_access_1_1_catalog.html#c10">setGeneric</a>(iCat);
01273   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
01274 }
01275 <span class="comment">/**********************************************************************/</span>
01276 <span class="comment">// load only the catalog description from CDS web site</span>
<a name="l01277"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a7">01277</a> <span class="keywordtype">int</span> Catalog::importDescriptionWeb(<span class="keyword">const</span> std::string catName,
01278                                   <span class="keyword">const</span> std::string urlCode,
01279                                   <span class="keyword">const</span> std::string &amp;fileName) {
01280 
01281   <span class="keywordtype">int</span> err;
01282   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c18">loadWeb</a>(catName, urlCode, fileName, -1);
01283   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) <span class="keywordflow">return</span> err;
01284 
01285   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01286 }
01287 <span class="comment">/**********************************************************************/</span>
01288 <span class="comment">// load from CDS web site an entire catalog without selection</span>
<a name="l01289"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a9">01289</a> <span class="keywordtype">int</span> Catalog::importWeb(<span class="keyword">const</span> std::string catName,
01290                        <span class="keyword">const</span> std::string urlCode, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRow,
01291                        <span class="keyword">const</span> std::string &amp;fileName) {
01292 
01293   <span class="keywordtype">int</span> err;
01294   <span class="keywordtype">long</span> limitRow=maxRow;
01295   <span class="keywordflow">if</span> (limitRow &lt; 0) limitRow=0; <span class="comment">// to avoid confusion with importDescriptionWeb</span>
01296   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c18">loadWeb</a>(catName, urlCode, fileName, limitRow);
01297   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) <span class="keywordflow">return</span> err;
01298   <a class="code" href="classcatalog_access_1_1_catalog.html#a5">getRAMsize</a>(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>, <span class="keyword">true</span>);
01299 
01300   <span class="keywordflow">try</span> {
01301     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()+2;
01302     <span class="comment">// number of required bits including global and region</span>
01303     err=1+(err-1)/(<span class="keyword">sizeof</span>(long)*8);
01304     <a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>.resize(err);
01305 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
01306 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
01307               &lt;&lt; err &lt;&lt; std::endl;
01308 <span class="preprocessor">    #endif</span>
01309 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_numRows)
01310       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>, 0);
01311     <span class="comment">// above lines can be commented to test the try catch mechanism</span>
01312   }
01313   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01314     std::string text;
01315     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
01316     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(<span class="stringliteral">"importWeb"</span>, text);
01317     <span class="keywordflow">throw</span>;
01318   }
01319   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>;
01320 }
01321 
01322 
01323 <span class="comment">/**********************************************************************/</span>
<a name="l01324"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c19">01324</a> <span class="keywordtype">int</span> Catalog::loadSelected(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *tot) {
01325 
01326   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"importSelected"</span>;
01327   <span class="keywordtype">int</span>  i, last,
01328        maxLine=<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>-1, <span class="comment">// to avoid computation each line</span>
01329        err=0;
01330   <span class="keywordtype">char</span> sep=<span class="charliteral">';'</span>,
01331        line[<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>];
01332 
01333   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
01334   <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> ) {
01335     <span class="comment">// read the total number of rows to have a maximal value</span>
01336     <span class="comment">// to allocate m_strings, m_numericals buffers.</span>
01337     <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
01338       <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
01339       <span class="keywordflow">if</span> (strlen(line) &lt; 2) <span class="keywordflow">break</span>; <span class="comment">// 1 CR for WINDOWS</span>
01340       <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>++;
01341     }
01342     <span class="comment">// go back to initial position</span>
01343     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.clear(); <span class="comment">// needed to reset flags before seekg</span>
01344     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.seekg(<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>);
01345   }
01346   <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>;
01347   last=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01348   <span class="keywordflow">for</span> (i=0; i&lt;last; i++)
01349     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_format[0] == <span class="charliteral">'A'</span>) err++;
01350   <a class="code" href="classcatalog_access_1_1_catalog.html#c11">create_tables</a>(err);
01351   <span class="keywordflow">if</span> (!<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
01352 
01353 <span class="comment">//printf("%ld OriRows\n", m_numOriRows);</span>
01354   <span class="keywordtype">bool</span> testCR=<span class="keyword">false</span>,
01355        first=<span class="keyword">true</span>,
01356        lineSkipped=<span class="keyword">false</span>;
01357   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
01358   std::ostringstream sortie;
01359   std::string text, mot;
01360   err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
01361   <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
01362 
01363     <span class="comment">// extract line with delimiter \n which is discarded</span>
01364     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
01365     (*tot)++;
01366     last=strlen(line);
01367     <span class="keywordflow">if</span> ((last == 0) || (line[0] == 0x0D)) {
01368       lineSkipped=<span class="keyword">true</span>; <span class="comment">// to have Warning messages below</span>
01369       <span class="keywordflow">continue</span>;
01370     }
01371     <span class="comment">// string max size is MAX_LINE-1;</span>
01372     <span class="keywordflow">if</span> (last &gt;= maxLine) {
01373       sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" exceeds maximal size ("</span>
01374              &lt;&lt; <a class="code" href="catalog_8h.html#a3">MAX_LINE</a> &lt;&lt; <span class="stringliteral">")"</span>;
01375       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, sortie.str());
01376       err=<a class="code" href="namespacecatalog_access.html#a34a18">BAD_FILELINE</a>;
01377       <span class="keywordflow">break</span>;
01378     }
01379     <span class="keywordflow">if</span> (first) {
01380       first=<span class="keyword">false</span>;
01381       <span class="comment">// test if last char is CR from WINDOWS</span>
01382       <span class="keywordflow">if</span> (line[last-1] == 0x0D) testCR=<span class="keyword">true</span>;
01383       <span class="keywordtype">char</span> *posC=strchr(line, sep);
01384       <span class="comment">// if separator isn't the default ; search for TAB</span>
01385       <span class="comment">// suppose there is at least 2 columns</span>
01386       <span class="keywordflow">if</span> (posC == NULL) {
01387         posC=strchr(line, 0x09);
01388         <span class="keywordflow">if</span> (posC != NULL) sep=0x09;
01389         <span class="keywordflow">else</span> {
01390           <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, <span class="stringliteral">"first data line has no separator"</span>);
01391           err=<a class="code" href="namespacecatalog_access.html#a34a16">BAD_FILETYPE</a>;
01392           <span class="keywordflow">break</span>;
01393         }
01394       }
01395     }
01396     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (testCR) line[--last]=<span class="charliteral">'\0'</span>;
01397     i=strncmp(line, <span class="stringliteral">"#Table"</span>, 6);
01398     <span class="keywordflow">if</span> (i == 0) {
01399       sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">": second table start (not read)"</span>;
01400       <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, sortie.str());
01401       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01402       <span class="keywordflow">break</span>;
01403     }
01404     text=line; <span class="comment">/* convert C string to C++ string */</span>
01405     pos=text.find(sep);
01406     <span class="keywordflow">if</span> (pos == std::string::npos) {
01407       sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" without separator, line skipped"</span>;
01408       <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, sortie.str());
01409       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01410       <span class="keywordflow">continue</span>;
01411     }
01412     i=0;
01413     <span class="keywordflow">if</span> (lineSkipped) <span class="keywordflow">break</span>;
01414     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size();
01415     last=0;
01416     <span class="keywordflow">do</span> {
01417       mot=text.substr(0, pos);
01418       <span class="keywordflow">if</span> (i &gt;= err) {
01419         sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" contains too many quantities"</span>;
01420         <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, sortie.str());
01421         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01422         <span class="keywordflow">break</span>;
01423       }
01424       <span class="keywordflow">else</span> {
01425         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>[i]) <a class="code" href="classcatalog_access_1_1_catalog.html#c13">translate_cell</a>(mot, i-last);
01426         <span class="keywordflow">else</span> last++;
01427       }
01428       i++;
01429       <span class="keywordflow">if</span> (pos != std::string::npos) {
01430         text.erase(0, pos+1);
01431         pos=text.find(sep);
01432       }
01433       <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
01434     }
01435     <span class="keywordflow">while</span> (1);
01436     <span class="keywordflow">if</span> (i &lt;  err) {
01437       sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" does not contain all quantities"</span>;
01438       <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, sortie.str());
01439       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01440     }
01441     err=<a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
01442     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>++;
01443   }
01444   <span class="keywordflow">return</span> err;
01445 }
01446 <span class="comment">/**********************************************************************/</span>
01447 <span class="comment">// if a catalog description was already loaded, this method does</span>
01448 <span class="comment">// the same as import() adding selection criteria for loading</span>
<a name="l01449"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a10">01449</a> <span class="keywordtype">int</span> Catalog::importSelected() {
01450 
01451   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"importSelected"</span>;
01452   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#c20">checkImport</a>(origin, <span class="keyword">true</span>);
01453   <span class="keywordflow">if</span> (quantSize &lt; <a class="code" href="namespacecatalog_access.html#a34a11">IS_VOID</a>) <span class="keywordflow">return</span> quantSize;
01454 
01455   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> &gt; 0) {
01456     <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, <span class="stringliteral">"call 'deleteContent' before 'importSelected'"</span>);
01457     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a12">IMPORT_BIS</a>;
01458   }
01459   <span class="keywordtype">int</span> i, err=0,
01460       maxSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size();
01461   <span class="keywordflow">for</span> (i=0; i&lt;maxSize; i++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>[i]) err++;
01462   <span class="keywordflow">if</span> (err &lt; 2) {
01463     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, <span class="stringliteral">"at least 2 quantities must be selected for import"</span>);
01464     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a30">BAD_SEL_QUANT</a>;
01465   }
01466   std::ostringstream sortie; 
01467   sortie &lt;&lt; err &lt;&lt; <span class="stringliteral">" quantities (over "</span> &lt;&lt; maxSize &lt;&lt; <span class="stringliteral">") selected for import"</span>;
01468   <a class="code" href="namespacecatalog_access.html#a33">printLog</a>(1, sortie.str());
01469   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string</span>
01470   <span class="keywordflow">if</span> (err != quantSize) {
01471     <span class="comment">// in fact, due to select*Quantities() restrictions,</span>
01472     <span class="comment">// quantSize can only be greater than err</span>
01473     <a class="code" href="namespacecatalog_access.html#a33">printLog</a>(2, <span class="stringliteral">"Erasing unwanted quantities for importSelected()"</span>);
01474     <a class="code" href="classcatalog_access_1_1_catalog.html#c1">deleteQuantities</a>();
01475   }
01476   err=<a class="code" href="namespacecatalog_access.html#a34a11">IS_VOID</a>; <span class="comment">//IS_OK;</span>
01477   <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.is_open() ) { <span class="comment">// data must be read from file</span>
01478 
01479     <span class="keywordflow">if</span> (!<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>) {
01480       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, <span class="stringliteral">"file import was not succesful"</span>);
01481       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a13">IMPORT_NEED</a>;
01482     }
01483     <span class="comment">// go back to initial position</span>
01484     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.clear(); <span class="comment">// needed to reset flags before seekg</span>
01485     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.seekg(<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>);
01486     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of data lines read</span>
01487     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c19">loadSelected</a>(&amp;tot);
01488     <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>) {
01489       sortie &lt;&lt; tot &lt;&lt; <span class="stringliteral">" data lines read for importSelected()"</span>;
01490       <a class="code" href="namespacecatalog_access.html#a33">printLog</a>(0, sortie.str());
01491       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>;
01492     }
01493 
01494   }
01495   <span class="keywordflow">else</span> { <span class="comment">// data must be querried via web</span>
01496 
01497 
01498   }
01499   <a class="code" href="namespacecatalog_access.html#a32">printWarn</a>(origin, <span class="stringliteral">"function only implemented for column selection"</span>);
01500   <span class="keywordflow">return</span> err;
01501 }
01502 
01503 
01504 <span class="comment">/**********************************************************************/</span>
01505 <span class="comment">// save whole catalog from memory to a FITS file</span>
<a name="l01506"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a11">01506</a> <span class="keywordtype">int</span> Catalog::save(<span class="keyword">const</span> std::string fileName, <span class="keywordtype">bool</span> no_replace) {
01507 
01508   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"save"</span>;
01509   std::string text;
01510   <span class="keywordtype">int</span> err;
01511   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c20">checkImport</a>(origin, <span class="keyword">true</span>);
01512   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a34a11">IS_VOID</a>) <span class="keywordflow">return</span> err;
01513 
01514   err=fileName.length();
01515   <span class="keywordflow">if</span> (err == 0) {
01516     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
01517     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01518     err=<a class="code" href="namespacecatalog_access.html#a34a15">BAD_FILENAME</a>;
01519     <span class="keywordflow">return</span> err;
01520   }
01521   <span class="keywordflow">if</span> (fileName.at(err-1) == <span class="charliteral">']'</span>) {
01522     <span class="comment">// file should be a fits</span>
01523  
01524     text=<span class="stringliteral">": fits FILE not handled now"</span>;
01525     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01526     err=<a class="code" href="namespacecatalog_access.html#a34a16">BAD_FILETYPE</a>;
01527     <span class="keywordflow">return</span> err;
01528   }
01529 
01530   std::fstream file;
01531   <span class="comment">// overwrite existing file ?</span>
01532   <span class="keywordflow">if</span> (no_replace) {
01533     file.open(fileName.c_str(), std::ios::in);
01534     <span class="keywordflow">if</span> (file) {
01535       file.close();
01536       text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" exist (no_replace option)"</span>;
01537       <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01538       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a15">BAD_FILENAME</a>;
01539     }
01540     file.clear();  <span class="comment">// clears all flags associated with the current stream</span>
01541   }
01542   <span class="comment">// open in write mode, if the file already existed it is erased</span>
01543   file.open(fileName.c_str(), std::ios::out | std::ios::trunc);
01544   <span class="keywordflow">if</span> (!file) {
01545     text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" cannot be written"</span>;
01546     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01547     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a15">BAD_FILENAME</a>;
01548   }
01549 
01550   <span class="keywordtype">char</span> tab=0x09, sep=<span class="charliteral">';'</span>;
01551   <span class="keywordtype">int</span> j, vecSize;
01552   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul;
01553   file &lt;&lt; <span class="stringliteral">"#RESOURCE=catalogAccess("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o0">m_code</a> &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; std::endl;
01554   file &lt;&lt; <span class="stringliteral">"#Name: "</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a> &lt;&lt; std::endl;
01555   file &lt;&lt; <span class="stringliteral">"#Title:"</span> &lt;&lt; tab &lt;&lt;  <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a> &lt;&lt; std::endl;
01556   file &lt;&lt; <span class="stringliteral">"#Name: "</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a> &lt;&lt; std::endl;
01557   file &lt;&lt; <span class="stringliteral">"#Title:"</span> &lt;&lt; tab &lt;&lt;  <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a> &lt;&lt; std::endl;
01558   tot+=5;
01559   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01560   <span class="keywordflow">for</span> (j=0; j&lt;vecSize; j++) {
01561     file &lt;&lt; <span class="stringliteral">"#Column"</span> &lt;&lt; tab &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name &lt;&lt; tab &lt;&lt; <span class="stringliteral">"("</span>
01562          &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_format &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; tab;
01563     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name.length() &lt; 8) file &lt;&lt; <span class="stringliteral">"        "</span>;
01564     file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_comment &lt;&lt; tab &lt;&lt; <span class="stringliteral">"[ucd="</span>
01565          &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_ucd &lt;&lt; <span class="stringliteral">"]"</span>
01566          &lt;&lt; std::endl;
01567   }
01568   file &lt;&lt; std::endl;
01569   tot+=vecSize+1;
01570   <span class="comment">// line do NOT end with separator</span>
01571   <span class="keywordflow">for</span> (j=0; j&lt;vecSize-1; j++) {
01572     file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name &lt;&lt; sep;
01573   }
01574   file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name &lt;&lt; std::endl;
01575   <span class="keywordflow">for</span> (j=0; j&lt;vecSize-1; j++) {
01576     file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_unit &lt;&lt; sep;
01577   }
01578   file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_unit &lt;&lt; std::endl;
01579   file &lt;&lt; <span class="stringliteral">"---"</span> &lt;&lt; std::endl;
01580   tot+=3;
01581   <span class="keywordflow">try</span> {
01582     <span class="keywordtype">int</span> i, len, bufSize=0;
01583     <span class="keywordtype">char</span> first, *buffer=NULL;
01584     std::vector&lt;std::string&gt; formats(vecSize, <span class="stringliteral">"%s"</span>);
01585     std::vector&lt;int&gt;         lengths(vecSize, 0);
01586     std::ostringstream sortie;
01587     <span class="keywordtype">double</span> r;
01588     <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) { 
01589       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_format;
01590       j=text.length();
01591       <span class="keywordflow">if</span> (j == 0) <span class="keywordflow">continue</span>;
01592       first=text[0];
01593       text.erase(0, 1);
01594       j=std::atoi(text.c_str());
01595       <span class="keywordflow">if</span> (j &lt;= 0) <span class="keywordflow">continue</span>;
01596       lengths[i]=j;
01597       <span class="keywordflow">if</span> (j &gt; bufSize) {
01598         bufSize=j;
01599         buffer=(<span class="keywordtype">char</span> *)realloc(buffer, bufSize*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
01600         <span class="keywordflow">if</span> (buffer == NULL)
01601           <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"Cannot allocate string buffer"</span>);
01602       }
01603       <span class="keywordflow">switch</span> (first) {
01604       <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
01605         sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">"s"</span>;
01606         formats[i]=sortie.str();
01607         <span class="keywordflow">break</span>;
01608       <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
01609         sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">".0f"</span>;
01610         formats[i]=sortie.str();
01611         <span class="keywordflow">break</span>;
01612       <span class="keywordflow">case</span> <span class="charliteral">'F'</span>:  <span class="comment">// number of decimals is needed from CSV/TSV</span>
01613         <span class="keywordflow">if</span> (i == <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexRA</a>)
01614           sortie &lt;&lt; <span class="stringliteral">"%0"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"f"</span>;
01615         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == <a class="code" href="classcatalog_access_1_1_catalog.html#o29">m_indexDEC</a>)
01616           sortie &lt;&lt; <span class="stringliteral">"%+0"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"f"</span>;
01617         <span class="keywordflow">else</span> sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"f"</span>;
01618         formats[i]=sortie.str();
01619         <span class="keywordflow">break</span>;
01620       <span class="keywordflow">default</span> :  <span class="comment">// number of decimals is needed from CSV/TSV</span>
01621         sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"e"</span>;
01622         formats[i]=sortie.str();
01623         <span class="keywordflow">break</span>;
01624       }
01625       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string</span>
01626     }
01627     <span class="comment">// all the quantities have their sprintf format</span>
01628     <span class="comment">// IF their lengths[] is positive</span>
01629     <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k=0; k&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>; k++) <span class="keywordflow">for</span> (j=0; j&lt;vecSize; ) {   
01630 
01631       <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::NUM) {
01632         r=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01633         <span class="keywordflow">if</span> (isnan(r)) {
01634           len=lengths[j];
01635           <span class="keywordflow">if</span> (len == 0) len=1;
01636           file &lt;&lt; std::setw(len+1) &lt;&lt; std::setfill(<span class="charliteral">' '</span>);
01637         }
01638         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01639           sprintf(buffer, formats[j].c_str(), r);
01640           file.write(buffer, lengths[j]);
01641         }
01642         <span class="keywordflow">else</span> file &lt;&lt; r;
01643       }
01644       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::STRING) {
01645         text=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01646         <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01647           sprintf(buffer, formats[j].c_str(), text.c_str());
01648           file.write(buffer, lengths[j]);
01649         }
01650         <span class="keywordflow">else</span> file &lt;&lt; text;
01651       }
01652       <span class="keywordflow">if</span> (++j == vecSize) file &lt;&lt; std::endl; <span class="keywordflow">else</span> file &lt;&lt; sep;
01653 
01654     } <span class="comment">// loop on rows and quantities</span>
01655     tot+=<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>;
01656     <span class="keywordflow">if</span> (buffer != NULL) free(buffer);
01657   }
01658   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01659     text=std::string(<span class="stringliteral">"EXCEPTION writing rows in file: "</span>)+prob.what();
01660     <a class="code" href="namespacecatalog_access.html#a31">printErr</a>(origin, text);
01661     <span class="keywordflow">throw</span>;
01662   }
01663   file &lt;&lt; std::endl;
01664   tot++;
01665   file.close();
01666   std::ostringstream sortie; 
01667   sortie &lt;&lt; <span class="stringliteral">"output text file is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" lines written)"</span>;
01668   <a class="code" href="namespacecatalog_access.html#a33">printLog</a>(0, sortie.str());
01669   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a34a10">IS_OK</a>;
01670 }
01671 
01672 <span class="comment">/**********************************************************************/</span>
01673 <span class="comment">// save selected rows of catalog from memory to a FITS file</span>
01674 
01675 
01676 
01677 } <span class="comment">// namespace catalogAccess</span>
</pre></div><hr><address style="align: right;"><small>Generated on Fri Jun 10 14:51:22 2005 for catalogAccess by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
