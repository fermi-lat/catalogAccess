<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>catalog_io.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>catalog_io.cxx</h1><a href="catalog__io_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00015 <span class="preprocessor">#include "<a class="code" href="catalog_8h.html">catalog.h</a>"</span>
00016 <span class="preprocessor">#include "tip/Header.h"</span>
00017 
00018 <span class="keyword">namespace </span>catalogAccess {
00019   <span class="keyword">using</span> <span class="keyword">namespace </span>tip;
00020 <span class="comment">/**********************************************************************/</span>
00021 <span class="comment">/*  DEFINING CLASS CONSTANTS                                          */</span>
00022 <span class="comment">/**********************************************************************/</span>
00023 
00024 <span class="comment">// BEWARE: the two constant below are UCD1 standard</span>
00025 <span class="comment">//         need to be changed for UCD1+</span>
00026 
00027 <span class="comment">// the order is important and must be compatible with s_CatalogGeneric</span>
00028 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_List[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00029        <span class="stringliteral">"ID_MAIN"</span>, <span class="stringliteral">"POS_EQ_RA_MAIN"</span>, <span class="stringliteral">"POS_EQ_DEC_MAIN"</span>,
00030         <span class="stringliteral">""</span>,       <span class="stringliteral">"POS_GAL_LON"</span>,    <span class="stringliteral">"POS_GAL_LAT"</span>};
00031 <span class="comment">// "ERROR", "POS_GAL_LON", "POS_GAL_LAT"</span>
00032 <span class="comment">// ERROR do not only refer to the position error</span>
00033 <span class="comment">// ERROR is for any "Uncertainty in Measurements"</span>
00034 
00035 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_Added[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00036        <span class="stringliteral">""</span>, <span class="stringliteral">"_RAJ2000"</span>, <span class="stringliteral">"_DEJ2000"</span>, <span class="stringliteral">""</span>, <span class="stringliteral">"_Glon"</span>, <span class="stringliteral">"_Glat"</span>};
00037 
00038 <span class="comment">// the 2 constants above are only defined in this file,</span>
00039 <span class="comment">// need to set catalog static members for global availability</span>
00040 
<a name="l00041"></a><a class="code" href="classcatalog_access_1_1_catalog.html#r3">00041</a> <span class="keyword">const</span> std::string Catalog::s_genericL = UCD_List[4];
<a name="l00042"></a><a class="code" href="classcatalog_access_1_1_catalog.html#r4">00042</a> <span class="keyword">const</span> std::string Catalog::s_genericB = UCD_List[5];
<a name="l00043"></a><a class="code" href="namespacecatalog_access.html#a2">00043</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[2]={<span class="stringliteral">"CDS-CAT"</span>,
00044                                <span class="stringliteral">"Catalogue designation in CDS nomenclature"</span>};
<a name="l00045"></a><a class="code" href="namespacecatalog_access.html#a3">00045</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[2]={<span class="stringliteral">"CDS-NAME"</span>, <span class="stringliteral">"Table used in a VizieR Query"</span>};
<a name="l00046"></a><a class="code" href="namespacecatalog_access.html#a4">00046</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a4">Key_UCD</a>=<span class="stringliteral">"TBUCD"</span>;
00047 
00048 <span class="comment">/**********************************************************************/</span>
00049 <span class="comment">/*  METHODS for IMPORTING, SAVING, LOADING                            */</span>
00050 <span class="comment">/**********************************************************************/</span>
00051 
00052 <span class="comment">// set m_posErrFactor, suppose that Quantity index exist (private method)</span>
<a name="l00053"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c9">00053</a> <span class="keywordtype">void</span> Catalog::setPosErrFactor(<span class="keyword">const</span> <span class="keywordtype">int</span> index) {
00054 
00055   std::string text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_unit;
00056   <span class="keywordflow">if</span> (text == <span class="stringliteral">""</span>) {
00057     std::ostringstream sortie;
00058     sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_name
00059            &lt;&lt; <span class="stringliteral">") has no unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>;
00060     <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00061   }
00062   <span class="keywordflow">else</span> {
00063     <span class="comment">// use explicit cast to be sure compiler choose the right tolower()</span>
00064     transform(text.begin(), text.end(), text.begin(), (int(*)(int)) tolower);
00065     <span class="keywordflow">if</span> (text == <span class="stringliteral">"deg"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=1.0;
00066     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcsec"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=3600.0;
00067     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcmin"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=60.0;
00068     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"rad"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=1.0/Angle_Conv;
00069     <span class="keywordflow">else</span> {
00070       std::ostringstream sortie;
00071       sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_name
00072              &lt;&lt; <span class="stringliteral">") has unknown unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>;
00073       <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00074     }
00075   }
00076 }
00077 <span class="comment">// search for generic quantities, private: suppose import done (private method)</span>
<a name="l00078"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c10">00078</a> <span class="keywordtype">void</span> Catalog::setGeneric(<span class="keyword">const</span> <span class="keywordtype">int</span> whichCat) {
00079 
00080   <span class="keyword">const</span> std::string epoch=<span class="stringliteral">"J2000"</span>;
00081   <span class="keywordtype">int</span> max=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00082   <span class="keywordtype">int</span> j;
00083   std::string text, name;
00084   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;max; i++)  {
00085 
00086     <span class="keywordflow">if</span> ((whichCat &gt;= 0) &amp;&amp; (whichCat &lt; <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>)) {
00087       <span class="comment">// if it is a known catalog, the generic are defined</span>
00088       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_name;
00089       <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) {
00090         name=Catalog::s_CatalogGeneric[whichCat][j];
00091         <span class="keywordflow">if</span> (name == <span class="stringliteral">"+"</span>) name=UCD_Added[j];
00092         <span class="keywordflow">if</span> (text == name) {
00093           <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric=<span class="keyword">true</span>;
00094           <span class="keywordflow">switch</span> (j) {
00095             <span class="keywordflow">case</span> 1: <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexRA</a>=i;
00096             <span class="keywordflow">break</span>;
00097             <span class="keywordflow">case</span> 2: <a class="code" href="classcatalog_access_1_1_catalog.html#o29">m_indexDEC</a>=i;
00098             <span class="keywordflow">break</span>;
00099             <span class="keywordflow">case</span> 3: <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexErr</a>=i;
00100                     <a class="code" href="classcatalog_access_1_1_catalog.html#c9">setPosErrFactor</a>(i);
00101             <span class="keywordflow">break</span>;
00102             <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
00103           }
00104         }
00105       }<span class="comment">// loop on generic</span>
00106       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_ucd;
00107     }
00108 
00109     <span class="keywordflow">else</span> {
00110       <span class="comment">// otherwise, take first matching UCD</span>
00111       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_ucd;
00112       <span class="keywordflow">if</span> (text != <span class="stringliteral">""</span>) <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) { 
00113         <span class="keywordflow">if</span> (text == UCD_List[j]) {
00114           <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric=<span class="keyword">true</span>;
00115           <span class="keywordflow">if</span> ((j == 1) || (j == 2)) {
00116             <span class="comment">// check that epoch is J2000</span>
00117             name=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_name;
00118             name.erase(0, name.length()-epoch.length());
00119             <span class="comment">// format contains at least 1 char</span>
00120             <span class="keywordflow">if</span> ((name == epoch) &amp;&amp; (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_format[0] == <span class="charliteral">'F'</span>)) {
00121               <span class="keywordflow">if</span> (j == 1) <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexRA</a>=i;
00122               <span class="keywordflow">else</span>        <a class="code" href="classcatalog_access_1_1_catalog.html#o29">m_indexDEC</a>=i;
00123             }
00124             <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric=<span class="keyword">false</span>;
00125           }
00126           <span class="keywordflow">break</span>;
00127         }
00128       }<span class="comment">// loop on generic</span>
00129     }
00130 
00131     <span class="comment">// flag error quantities, useless for already found generic</span>
00132     <span class="keywordflow">if</span> ((text == <span class="stringliteral">"ERROR"</span>) &amp;&amp; (!<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric)) {
00133       <span class="comment">// error column name is e_"associated column" except for position error</span>
00134       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_name;
00135       <span class="keywordflow">if</span> (text.find(<span class="stringliteral">"e_"</span>) == 0) {
00136         text.erase(0, 2);
00137 <span class="preprocessor">        #ifdef DEBUG_CAT</span>
00138 <span class="preprocessor"></span>        std::cout &lt;&lt; <span class="stringliteral">"ERROR column ("</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; std::endl;
00139 <span class="preprocessor">        #endif</span>
00140 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (j=0; j&lt;max; j++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(j).m_name == text) {
00141           <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_statError=text;
00142           <span class="keywordflow">break</span>;
00143         }
00144       }
00145       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((text == <span class="stringliteral">"PosErr"</span>) || (text == <span class="stringliteral">"ErrorRad"</span>)) {
00146         <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_isGeneric=<span class="keyword">true</span>;
00147         <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexErr</a>=i;
00148         <a class="code" href="classcatalog_access_1_1_catalog.html#c9">setPosErrFactor</a>(i);
00149       }
00150     }
00151 
00152   }<span class="comment">// loop on quantities</span>
00153 
00154 }
00155 
00156 <span class="comment">/**********************************************************************/</span>
00157 <span class="comment">// return the number of RAM bytes needed for numRows catalog rows</span>
<a name="l00158"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a5">00158</a> <span class="keywordtype">long</span> Catalog::getRAMsize(<span class="keyword">const</span> <span class="keywordtype">long</span> numRows, <span class="keyword">const</span> <span class="keywordtype">bool</span> writeLog) {
00159 
00160   std::string mot, text;
00161   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00162   <span class="keywordflow">if</span> (quantSize == 0) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a14">IMPORT_NEED</a>;
00163 
00164   <span class="keywordtype">int</span> nD=0, nS=0, nchar=0;
00165   <span class="keywordtype">int</span> i, j;
00166   <span class="keywordflow">for</span> (i=0; i&lt;quantSize; i++) {
00167     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_type == Quantity::NUM) nD++;
00168     <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_type == Quantity::STRING) {
00169       nS++;
00170       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_format;
00171       <span class="keywordflow">if</span> (text.length() &gt; 1) {
00172         text.erase(0, 1);
00173         j=std::atoi(text.c_str());
00174         <span class="keywordflow">if</span> (j &lt;= 0) <span class="keywordflow">continue</span>;        
00175         nchar+=j;
00176       }
00177     }
00178   }
00179   <span class="keywordtype">char</span> buffer[50];
00180   <span class="keywordtype">long</span> sizeD=nD*<span class="keyword">sizeof</span>(double)*numRows;
00181   <span class="keywordtype">long</span> sizeS=nchar*<span class="keyword">sizeof</span>(char)*numRows;
00182   i=1+(quantSize+1)/(<span class="keyword">sizeof</span>(long)*8);
00183   <span class="keywordtype">long</span> sizeB=i*<span class="keyword">sizeof</span>(long)*numRows;
00184   <span class="keywordflow">if</span> (writeLog &amp;&amp; (<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> &gt; 0)) {
00185     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>);
00186     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00187     text=<span class="stringliteral">"Original whole catalog number of rows = "</span>+mot;
00188     <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(1, text);
00189   }
00190   <span class="keywordflow">if</span> (numRows &lt;= 0) <span class="keywordflow">return</span> 0;
00191   <span class="keywordflow">if</span> (writeLog) {
00192     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, numRows);
00193     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00194     text=<span class="stringliteral">"Needed RAM space (MB) for "</span>+mot;
00195     sprintf(buffer, <span class="stringliteral">"%5.1f"</span>, (sizeD+sizeS+sizeB)/(1024.*1024.));
00196     mot=buffer;
00197     text=text+<span class="stringliteral">" data rows = "</span>+mot+<span class="stringliteral">"\n"</span>;
00198     sprintf(buffer, <span class="stringliteral">"%5.0f kB for numericals (%3d double per row)"</span>,
00199                    sizeD/1024., nD);
00200     mot=buffer;
00201     text=text+mot+<span class="stringliteral">"\n"</span>;
00202     sprintf(buffer, <span class="stringliteral">"%5.0f kB for %2d strings (%3d char per row)"</span>,
00203                    sizeS/1024., nS, nchar);
00204     mot=buffer;
00205     text=text+mot+<span class="stringliteral">"\n"</span>;
00206     sprintf(buffer, <span class="stringliteral">"%5.0f kB for select bits (%2d long per row)"</span>,
00207                    sizeB/1024., i);
00208     mot=buffer;
00209     text=text+mot;
00210     <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(1, text);
00211   }
00212   <span class="keywordflow">return</span> (sizeD+sizeS+sizeB);
00213 }
00214 
00215 <span class="comment">/**********************************************************************/</span>
00216 <span class="comment">// creates a new column in m_strings, m_numericals (private method)</span>
<a name="l00217"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c11">00217</a> <span class="keywordtype">void</span> Catalog::create_tables(<span class="keyword">const</span> <span class="keywordtype">int</span> nbQuantAscii) {
00218 
00219   <span class="keywordtype">int</span> vecSize;
00220   std::string errText;
00221   <span class="keywordflow">if</span> (nbQuantAscii &gt; 0) {
00222     <span class="keywordflow">try</span> {
00223       <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.resize(nbQuantAscii);
00224     }
00225     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00226       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00227       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00228       <span class="keywordflow">throw</span>;
00229     }
00230   }
00231   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00232   <span class="keywordflow">if</span> (vecSize &gt; 0) {
00233     <span class="keywordflow">try</span> {
00234       <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.resize(vecSize);
00235     }
00236     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00237       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00238       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00239       <span class="keywordflow">throw</span>;
00240     }
00241   }
00242   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a> &gt; 0) <a class="code" href="classcatalog_access_1_1_catalog.html#c12">add_rows</a>();
00243 
00244 }
00245 <span class="comment">/**********************************************************************/</span>
00246 <span class="comment">// creates a new row in m_strings, m_numericals (private method)</span>
<a name="l00247"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c12">00247</a> <span class="keywordtype">void</span> Catalog::add_rows() {
00248 
00249   <span class="keywordtype">int</span> i, vecSize;
00250   std::string errText;
00251 <span class="comment">//printf("!! %ld / %ld \n", m_numRows, m_numReadRows);</span>
00252   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();
00253   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00254     <span class="keywordflow">try</span> {
00255       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) {
00256         <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>);
00257 <span class="comment">//        for (j=0; j&lt;m_numReadRows; j++) m_strings[i].at(j).resize(20);</span>
00258       }
00259     }
00260     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00261       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00262       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00263       <span class="keywordflow">throw</span>;
00264     }
00265   }
00266   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
00267   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00268     <span class="keywordflow">try</span> {
00269       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>);
00270     }
00271     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00272       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00273       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00274       <span class="keywordflow">throw</span>;
00275     }
00276   } 
00277 
00278 }
00279 
00280 <span class="comment">/**********************************************************************/</span>
00281 <span class="comment">// loads Ascii input in m_quantities (private method)</span>
00282 <span class="comment">// suppose that index really exists: 0 &lt;= index &lt; m_quantities.size()</span>
<a name="l00283"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c13">00283</a> <span class="keywordtype">void</span> Catalog::translate_cell(std::string mot, <span class="keyword">const</span> <span class="keywordtype">int</span> index) {
00284 
00285   <span class="keywordtype">int</span>  j, last;
00286   <span class="keywordtype">char</span> form; 
00287 
00288   <span class="comment">// remove trailing spaces</span>
00289   last=mot.length();
00290 <span class="comment">/* useless Warning, happen many times for last column of 3EG objects (EGRET)</span>
00291 <span class="comment">  if (last == 0) {</span>
00292 <span class="comment">    std::ostringstream sortie;</span>
00293 <span class="comment">    sortie &lt;&lt; "one quantity has no character (row #" &lt;&lt; m_numRows+1 &lt;&lt; ")";</span>
00294 <span class="comment">    printWarn("private translate_cell", sortie.str());</span>
00295 <span class="comment">  }</span>
00296 <span class="comment">  else {*/</span>
00297   <span class="keywordflow">if</span> (last) {
00298     <span class="keywordflow">do</span> last--;
00299     <span class="keywordflow">while</span> ( (last &gt;= 0) &amp;&amp; (mot.at(last) == <span class="charliteral">' '</span>) );
00300   }
00301   last++;
00302   j=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_index;
00303   form=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_format.at(0);
00304   <span class="keywordflow">if</span> (form == <span class="charliteral">'A'</span>) {
00305     <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>)=mot.substr(0, last);
00306   }
00307   <span class="keywordflow">else</span> {
00308     <span class="keywordflow">if</span> (last) {
00309       <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>)=std::atof(mot.c_str());
00310     }
00311     <span class="keywordflow">else</span>
00312       <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>)=0./0.;
00313   }
00314 
00315 }
00316 
00317 <span class="comment">/**********************************************************************/</span>
00318 <span class="comment">// read the catalog from fits file (only description if getDescr is true)</span>
<a name="l00319"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c14">00319</a> <span class="keywordtype">int</span> Catalog::analyze_fits(<span class="keyword">const</span> Table *myDOL, <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr,
00320                           <span class="keyword">const</span> std::string origin) {
00321 
00322   std::string text, mot;
00323   <span class="keywordtype">int</span>  i, j, max,
00324        found=0,
00325        nbQuantAscii=0;
00326   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
00327   <span class="keywordtype">bool</span> binary=<span class="keyword">true</span>;
00328   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
00329   int (*pfunc)(int)=toupper; <span class="comment">// function used by transform</span>
00330   <span class="keyword">const</span> Header &amp;header=myDOL-&gt;getHeader();
00331 
00332   <span class="keywordflow">try</span> {
00333     text=myDOL-&gt;getName();
00334     header.getKeyword(<span class="stringliteral">"XTENSION"</span>, mot);
00335   <span class="comment">/* text.rfind('_');</span>
00336 <span class="comment">    since '/' are replaced by '_' in EXTNAME</span>
00337 <span class="comment">    and  is ambiguous with '_' in catalog name:</span>
00338 <span class="comment">    must search for keywords CDS-CAT  CDS-NAME</span>
00339 <span class="comment">  */</span>
00340   }
00341   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00342     text=<span class="stringliteral">": fits EXTENSION, cannot get name"</span>;
00343     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
00344     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a18">BAD_FITS</a>;
00345   }
00346   std::ostringstream sortie;
00347   sortie &lt;&lt; <span class="stringliteral">"fits extension "</span> &lt;&lt; mot &lt;&lt; <span class="stringliteral">" name = "</span> &lt;&lt; text;
00348   <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(1, sortie.str());
00349   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00350 
00351   <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=<span class="stringliteral">""</span>;   <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a>=<span class="stringliteral">""</span>;
00352   <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=<span class="stringliteral">""</span>; <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a>=<span class="stringliteral">""</span>;
00353   <a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a>=<span class="stringliteral">""</span>;
00354   <span class="keywordflow">if</span> (mot == <span class="stringliteral">"TABLE"</span>) {
00355     binary=<span class="keyword">false</span>;
00356     <a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a>=<span class="stringliteral">"CDS"</span>; <span class="comment">/* to know that format string need to be changed for fits */</span>
00357   }
00358   <span class="keywordflow">try</span> {
00359     header.getKeyword(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0], text);
00360     <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=text;
00361     header.getKeyword(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0], mot);
00362     <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=mot;
00363 
00364   }
00365   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00366     <span class="keywordflow">if</span> (binary) {
00367       <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, <span class="stringliteral">"fits EXTENSION, cannot get CDS header keys"</span>);
00368     }
00369     <span class="keywordflow">else</span> {
00370       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get CDS header keys"</span>);
00371       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a18">BAD_FITS</a>;
00372     }
00373   }
00374   <span class="keywordflow">try</span> {
00375     text=header.getKeyComment(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0]);
00376     mot =header.getKeyComment(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0]);
00377     <span class="comment">// have to use long comment</span>
00378   }
00379   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00380     <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, <span class="stringliteral">"fits EXTENSION, cannot get CDS header comments"</span>);
00381   }
00382 <span class="comment">//  const Table::FieldCont &amp;allCol=myDOL-&gt;getValidFields();</span>
00383   max=myDOL-&gt;getValidFields().size();
00384   <span class="keywordflow">if</span> (max &lt; 1) {
00385     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, need at least 1 column"</span>);
00386     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a17">BAD_FILETYPE</a>;
00387   }
00388   text=<span class="stringliteral">""</span>;
00389   <span class="keywordflow">try</span> {
00390     <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=myDOL-&gt;getNumRecords();
00391     <span class="keyword">const</span> IColumn *myCol = 0;
00392     <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00393       found++;
00394       text=<span class="stringliteral">""</span>;
00395       myCol=myDOL-&gt;getColumn(i);
00396       <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
00397       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>=myCol-&gt;getId();
00398       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_unit</a>=myCol-&gt;getUnits();
00399       sprintf(name, <span class="stringliteral">"TFORM%d"</span>, i+1);
00400       mot=name; <span class="comment">/* convert C string to C++ string */</span>
00401       header.getKeyword(mot, text);
00402       transform(text.begin(), text.end(), text.begin(), pfunc);
00403       j=text.length();
00404       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>=text;
00405 <span class="comment">//printf("'%s', ",  text.c_str());</span>
00406       text=<span class="stringliteral">""</span>;
00407       <span class="keywordflow">if</span> (binary) {
00408         <span class="keywordflow">if</span> ( !myCol-&gt;isScalar() ) {
00409           text=<span class="stringliteral">"unauthorized FITS TABLE vector"</span>;
00410           sortie &lt;&lt; <span class="stringliteral">": VECTOR not supported, column#"</span> &lt;&lt; found;
00411           <span class="keywordflow">throw</span> std::runtime_error(text);
00412         }
00413         <span class="keywordflow">if</span> (j == 0) {
00414           text=<span class="stringliteral">"unauthorized FITS empty format "</span>;
00415           sortie &lt;&lt; <span class="stringliteral">": FITS format is empty, column#"</span> &lt;&lt; found;
00416           <span class="keywordflow">throw</span> std::runtime_error(text);
00417         }
00418         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[j-1] == <span class="charliteral">'A'</span>) readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::STRING;
00419         <span class="keywordflow">else</span> readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::NUM;
00420         sprintf(name, <span class="stringliteral">"%s%d"</span>, <a class="code" href="namespacecatalog_access.html#a4">Key_UCD</a>.c_str(), i+1); mot=name;
00421 <span class="comment">/*        readQ.m_comment=header.getKeyComment(mot);</span>
00422 <span class="comment">        header.getKeyword(mot, text);</span>
00423 <span class="comment">          ARE NOT SET */</span>
00424       }
00425       <span class="keywordflow">else</span> {
00426         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[0] == <span class="charliteral">'A'</span>) readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::STRING;
00427         <span class="keywordflow">else</span> readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::NUM;
00428         sprintf(name, <span class="stringliteral">"TBCOL%d"</span>, i+1); mot=name;
00429         text=header.getKeyComment(mot);
00430         j=4;
00431         <span class="keywordflow">if</span> (text.substr(0,j) == <span class="stringliteral">"UCD="</span>) text.erase(0,j);
00432         pos=text.find(<span class="charliteral">'.'</span>);
00433         <span class="keywordflow">if</span> (pos != std::string::npos) text.erase(pos);;
00434         <span class="comment">/* ONLY  readQ.m_comment  IS NOT SET */</span>
00435       }
00436       transform(text.begin(), text.end(), text.begin(), pfunc);
00437       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m2">m_ucd</a>=text;
00438       <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a> == Quantity::STRING) {
00439         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>=nbQuantAscii;
00440         nbQuantAscii++;
00441       }
00442       <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a> == Quantity::NUM) {
00443         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00444         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::NUM;
00445       }
00446       <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.push_back(readQ); }
00447       <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00448         text=std::string(<span class="stringliteral">"EXCEPTION filling m_quantities: "</span>)+prob.what();
00449         sortie &lt;&lt; text;
00450         <span class="keywordflow">throw</span>;
00451       }
00452     }<span class="comment">/* loop on columns */</span>
00453   }
00454   <span class="keywordflow">catch</span> (...) {
00455     <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.clear();
00456     j=<a class="code" href="namespacecatalog_access.html#a35a17">BAD_FILETYPE</a>;
00457     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=j;
00458     <span class="keywordflow">if</span> ( text.empty() ) {
00459       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, wrong TABLE column#"</span>;
00460       sortie &lt;&lt; found &lt;&lt; <span class="stringliteral">" description"</span>;
00461       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str() );
00462     }
00463     <span class="keywordflow">else</span> {
00464       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str() );
00465       <span class="comment">// exception sent only for vector allocation</span>
00466       <span class="keywordflow">if</span> (text == sortie.str() ) <span class="keywordflow">throw</span>;
00467     }
00468     <span class="keywordflow">return</span> j;
00469   }
00470 <span class="comment">//printf("numRows=%ld\n", m_numOriRows );</span>
00471   <span class="keywordflow">if</span> ((getDescr) || (<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> == 0)) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
00472 
00473   <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a> ) {
00474     <span class="comment">// set the total number of rows to have a maximal value</span>
00475     <span class="comment">// to allocate m_strings, m_numericals buffers.</span>
00476     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>;
00477   }
00478   <a class="code" href="classcatalog_access_1_1_catalog.html#c11">create_tables</a>(nbQuantAscii);
00479   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
00480   <span class="keywordflow">try</span> {
00481     <span class="comment">// Loop over all records (rows) and extract values</span>
00482     <span class="keywordflow">for</span> (Table::ConstIterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end();
00483          ++itor) {
00484 
00485       <span class="comment">// double variable to hold the value of all the numeric fields</span>
00486       <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00487         j=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_index;
00488         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_type == Quantity::NUM)
00489           <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>)=(*itor)[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_name].get();
00490         <span class="keywordflow">else</span> (*itor)[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_name].get(<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>) );
00491       }
00492       <span class="keywordflow">if</span> (++<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> == <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>) <span class="keywordflow">break</span>;
00493     }
00494   }
00495   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00496     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot read after row#"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>+1;
00497     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str() );
00498     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a22">BAD_ROW</a>;
00499   }
00500   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
00501 }
00502 
00503 
00504 <span class="comment">/**********************************************************************/</span>
00505 <span class="comment">// read the catalog header from text file (private method)</span>
<a name="l00506"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c15">00506</a> <span class="keywordtype">int</span> Catalog::analyze_head(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *tot, <span class="keywordtype">int</span> *what, <span class="keywordtype">bool</span> *testCR) {
00507 
00508   std::string text, mot;
00509   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
00510   <span class="keywordtype">char</span> line[<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>];
00511   <span class="keywordtype">int</span>  i, last,
00512        found=0,
00513        err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
00514 
00515   <span class="comment">// must use good instead eof, because eof is still false</span>
00516   <span class="comment">// if getline reads MAX_LINE char ==&gt; infinite loop</span>
00517   <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=<span class="stringliteral">""</span>;   <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a> =<span class="stringliteral">""</span>;
00518   <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=<span class="stringliteral">""</span>; <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a> =<span class="stringliteral">""</span>;
00519   <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.clear();  
00520   <span class="comment">// to reset the state flags (checked by the previous load call)</span>
00521   <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
00522 
00523     <span class="comment">// extract line with delimiter \n which is discarded</span>
00524     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
00525     text=line; <span class="comment">/* convert C string to C++ string */</span>
00526     <span class="keywordflow">if</span> (*tot == 0) {
00527       pos=text.find(<span class="charliteral">' '</span>);
00528       <span class="keywordflow">if</span> (pos != std::string::npos) {
00529         mot=text.substr(0, pos);
00530         <span class="comment">// fits starts with "SIMPLE  ="</span>
00531         <span class="keywordflow">if</span> (mot == <span class="stringliteral">"SIMPLE"</span>) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
00532       }
00533     }
00534     (*tot)++;
00535 
00536     <span class="comment">/* should find something like:</span>
00537 <span class="comment">#RESOURCE=21230079</span>
00538 <span class="comment">#Name: J/ApJS/123/79</span>
00539 <span class="comment">#Title: Third EGRET catalog (3EG) (Hartman+, 1999)</span>
00540 <span class="comment">#Table  J_ApJS_123_79_3eg:</span>
00541 <span class="comment">#Name: J/ApJS/123/79/3eg</span>
00542 <span class="comment">#Title: Third EGRET Source Catalog (table 4)</span>
00543 <span class="comment">#blabla(CoosysG:galactic)</span>
00544 <span class="comment">#Column</span>
00545 <span class="comment">// Column must be followed by at least one separation line </span>
00546 <span class="comment"></span>
00547 <span class="comment">    OR (-meta.all for description)</span>
00548 <span class="comment"></span>
00549 <span class="comment">#RESOURCE=J/ApJS/123/79/3eg</span>
00550 <span class="comment">#INFO   =271Total number of tuples (rows) in the table</span>
00551 <span class="comment">#INFO   =CGRO</span>
00552 <span class="comment">#INFO   =Gamma-ray</span>
00553 <span class="comment">#    Third EGRET catalog (3EG) (Hartman+, 1999)</span>
00554 <span class="comment">#    Third EGRET Source Catalog (table 4)</span>
00555 <span class="comment">#</span>
00556 <span class="comment">*/</span>
00557     <span class="keywordflow">switch</span> (found) {
00558     <span class="keywordflow">case</span> 0:
00559       pos=text.find(<span class="stringliteral">"#RESOURCE="</span>);
00560       <span class="keywordflow">if</span> (pos == 0) {
00561         found++;
00562         last=text.length();
00563         <span class="comment">// test if last char is CR from WINDOWS</span>
00564         <span class="keywordflow">if</span> (text[last-1] == 0x0D) {
00565           *testCR=<span class="keyword">true</span>;
00566           last--;
00567           text.erase(last);
00568         }
00569         <span class="keywordflow">else</span> *testCR=<span class="keyword">false</span>;
00570         mot=text.substr(10);
00571         pos=mot.find(<span class="charliteral">'/'</span>);
00572         <span class="keywordflow">if</span> (pos == std::string::npos) {
00573           <span class="comment">// standard desciption  printf("|%s|\n", mot.c_str());</span>
00574           *what=1;
00575         }
00576         <span class="keywordflow">else</span> {
00577           <span class="comment">// -meta.all OR -meta QUERY</span>
00578           *what=2;
00579           pos=mot.rfind(<span class="charliteral">'/'</span>);
00580           <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=mot.substr(0,pos);
00581           <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=mot;
00582         }
00583       }
00584       <span class="keywordflow">break</span>;
00585 
00586     <span class="keywordflow">case</span> 1: <span class="keywordflow">case</span> 3:
00587       <span class="keywordflow">if</span> (*what &lt; 2) mot=<span class="stringliteral">"#Name:"</span>;  <span class="keywordflow">else</span> mot=<span class="stringliteral">"#INFO"</span>; 
00588       pos=text.find(mot);
00589       <span class="keywordflow">if</span> (pos == 0) {
00590         found++;
00591         last=text.length();
00592         <span class="keywordflow">if</span> (*testCR) text.erase(--last);
00593         <span class="comment">// remove heading spaces</span>
00594         <span class="keywordflow">for</span> (i=mot.length(); i&lt;last; i++) {
00595           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00596         }
00597         <span class="keywordflow">if</span> (i == last) mot=<span class="stringliteral">""</span>;
00598         <span class="keywordflow">else</span> {
00599           mot=text.substr(i, last-i);
00600           <span class="comment">// remove trailing spaces</span>
00601           pos=mot.length();
00602           <span class="keywordflow">do</span> pos--;
00603           <span class="keywordflow">while</span> ((mot[pos] == <span class="charliteral">' '</span>) || (mot[pos] == 0x09));
00604           mot.erase(pos+1);
00605         }
00606         <span class="keywordflow">if</span> (*what &lt; 2) {
00607           <span class="keywordflow">if</span> (found &gt; 2) <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=mot; <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=mot;
00608         }
00609         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (found == 2) {
00610           <span class="keywordflow">if</span> ((!<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>) &amp;&amp; ((last=mot.length()) &gt; 1)) {
00611             <span class="keywordflow">if</span> (mot[0] == <span class="charliteral">'='</span>) mot[0]=<span class="charliteral">' '</span>;
00612             <span class="keywordflow">for</span> (i=1; i&lt;last; i++) { <span class="keywordflow">if</span> (!isdigit(mot[i])) <span class="keywordflow">break</span>; } 
00613             mot.erase(i);
00614             <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=atol(mot.c_str());
00615           }
00616         }
00617       }
00618       <span class="keywordflow">break</span>;
00619 
00620     <span class="keywordflow">case</span> 2: <span class="keywordflow">case</span> 4:
00621       <span class="keywordflow">if</span> (*what &lt; 2) mot=<span class="stringliteral">"#Title:"</span>;  <span class="keywordflow">else</span> mot=<span class="stringliteral">"#INFO"</span>;
00622       pos=text.find(mot);
00623       <span class="keywordflow">if</span> (pos == 0) {
00624         <span class="keywordflow">if</span> (*what &gt;= 2) <span class="keywordflow">break</span>; <span class="comment">// read lines until do not start with #INFO</span>
00625         found++;
00626         last=text.length();
00627         <span class="keywordflow">if</span> (*testCR) text.erase(--last);
00628         <span class="comment">// remove heading spaces</span>
00629         <span class="keywordflow">for</span> (i=mot.length(); i&lt;last; i++) {
00630           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00631         }
00632         <span class="keywordflow">if</span> (i == last) mot=<span class="stringliteral">""</span>;
00633         <span class="keywordflow">else</span> {
00634           mot=text.substr(i, last-i);
00635           <span class="comment">// remove trailing spaces</span>
00636           pos=mot.length();
00637           <span class="keywordflow">do</span> pos--;
00638           <span class="keywordflow">while</span> ((mot[pos] == <span class="charliteral">' '</span>) || (mot[pos] == 0x09));
00639           mot.erase(pos+1);
00640         }
00641         <span class="keywordflow">if</span> (found &gt; 3) <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a>=mot; <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a>=mot;
00642       }
00643       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*what &gt;= 2) {
00644         <span class="comment">// separation '#' found,</span>
00645         <span class="keywordflow">if</span> ((last=text.length()) &lt; 3) { found=5; <span class="keywordflow">break</span>;}
00646         found++;
00647         <span class="keywordflow">if</span> (*testCR) text.erase(--last);
00648         <span class="comment">// remove heading spaces</span>
00649         <span class="keywordflow">for</span> (i=1; i&lt;last; i++) {
00650           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00651         }
00652         <span class="keywordflow">if</span> (i == last) mot=<span class="stringliteral">""</span>;
00653         <span class="keywordflow">else</span> {
00654           mot=text.substr(i, last-i);
00655           <span class="comment">// remove trailing spaces</span>
00656           pos=mot.length();
00657           <span class="keywordflow">do</span> pos--;
00658           <span class="keywordflow">while</span> ((mot[pos] == <span class="charliteral">' '</span>) || (mot[pos] == 0x09));
00659           mot.erase(pos+1);
00660         }
00661         <span class="keywordflow">if</span> (found &gt; 3)  <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a>=mot; 
00662         <span class="keywordflow">else</span> { found=4; <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a>=mot; }
00663       }
00664       <span class="keywordflow">break</span>;
00665 
00666     <span class="keywordflow">default</span>:
00667       <span class="comment">// case only for META file, read until #RESOURCE= or # [ucd=]</span>
00668       <span class="keywordflow">if</span> ((last=text.length()) &gt; 7) {
00669         <span class="keywordflow">if</span> (*testCR) text.erase(--last);
00670         <span class="comment">// for META file with several tables, start of 2nd table</span>
00671         mot=<span class="stringliteral">"#RESOURCE="</span>;
00672         <span class="keywordflow">if</span> (text.find(mot) == 0) { found++; <span class="keywordflow">break</span>; }
00673         <span class="comment">// otherwise, remove heading spaces</span>
00674         <span class="keywordflow">for</span> (i=1; i&lt;last; i++) {
00675           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00676         }
00677         mot=text.substr(i, last-i);
00678         <span class="comment">// before #Column, metaALL must end with following string</span>
00679         <span class="keywordflow">if</span> (mot == <span class="stringliteral">"[ucd=]"</span>) found++;
00680       }
00681       <span class="keywordflow">break</span>;
00682     }
00683 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
00684 <span class="preprocessor"></span>    std::cout &lt;&lt; *tot &lt;&lt;<span class="stringliteral">","</span>;
00685     <span class="keywordflow">if</span> (*tot &lt; 60ul) std::cout &lt;&lt; line &lt;&lt;<span class="stringliteral">"|\n"</span>;
00686 <span class="preprocessor">    #endif</span>
00687 <span class="preprocessor"></span>    err=-1*found;
00688     <span class="keywordflow">if</span> (*what &lt; 2) {
00689       <span class="keywordflow">if</span> (found == 5) { err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>; <span class="keywordflow">break</span>; }
00690     }
00691     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (found &gt; 5) { err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>; <span class="keywordflow">break</span>; }
00692 
00693   }<span class="comment">// loop on inFile lines</span>
00694 <span class="preprocessor">  #ifdef DEBUG_CAT</span>
00695 <span class="preprocessor"></span>  std::cout &lt;&lt; std::endl;
00696 <span class="preprocessor">  #endif</span>
00697 <span class="preprocessor"></span>
00698   <span class="keywordflow">return</span> err;
00699 }
00700 
00701 <span class="comment">/**********************************************************************/</span>
00702 <span class="comment">// read catalog data from text file (private method);</span>
00703 <span class="comment">// read only column/quantity description if getDescr is true</span>
<a name="l00704"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c16">00704</a> <span class="keywordtype">int</span> Catalog::analyze_body(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *tot, <span class="keywordtype">int</span> *what, <span class="keyword">const</span> <span class="keywordtype">bool</span> testCR,
00705                           <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr) {
00706 
00707   std::string  origin, text, mot;
00708   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
00709   <span class="keywordtype">char</span> sep=<span class="charliteral">';'</span>,
00710        line[<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>];
00711   std::ostringstream sortie;
00712   <span class="keywordtype">bool</span> foundColumn=<span class="keyword">false</span>,
00713        lineSkipped=<span class="keyword">false</span>;
00714   <span class="keywordtype">int</span>  i, last, err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>,
00715        found=0,
00716        nbQuantAscii=0,
00717        maxLine=<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>-1; <span class="comment">// to avoid computation each line</span>
00718   int (*pfunc)(int)=toupper; <span class="comment">// function used by transform</span>
00719 
00720   <span class="keywordflow">if</span> (getDescr) origin=<span class="stringliteral">"importDescription"</span>; <span class="keywordflow">else</span> origin=<span class="stringliteral">"import"</span>;
00721   <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
00722 
00723     <span class="comment">// extract line with delimiter \n which is discarded</span>
00724     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
00725     (*tot)++;
00726     <span class="keywordflow">switch</span> (found) {
00727     <span class="keywordflow">case</span> 0:
00728       mot=<span class="stringliteral">"#Column"</span>;
00729       text=line; <span class="comment">/* convert C string to C++ string */</span>
00730       pos=text.find(mot);
00731       <span class="keywordflow">if</span> (pos == 0) {
00732         <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
00733         foundColumn=<span class="keyword">true</span>;
00734       <span class="keywordflow">do</span> {
00735         <span class="comment">// column NAME, FORMAT, DESCR, UCD separated by only 1 TAB</span>
00736         last=text.length();
00737         <span class="keywordflow">for</span> (i=mot.length(); i&lt;last; i++) {
00738           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00739         }
00740         <span class="keywordflow">if</span> (i == last) <span class="keywordflow">break</span>; <span class="comment">//no NAME found</span>
00741         mot=text.substr(i, last-i);
00742         pos=mot.find(0x09);
00743         <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">break</span>;  <span class="comment">// lack end of data</span>
00744 
00745         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>=mot.substr(0, pos);
00746         text=mot;
00747         text.erase(0, pos+1);
00748         pos=text.find(0x09);
00749         <span class="keywordflow">if</span> ((pos == std::string::npos) || (pos &lt; 3)) <span class="keywordflow">break</span>;
00750 
00751         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>=text.substr(1, pos-2); <span class="comment">// disregard ( ) </span>
00752         text.erase(0, pos+1);
00753         last=text.length();
00754         <span class="keywordflow">for</span> (i=0; i&lt;last; i++) {
00755           <span class="keywordflow">if</span> ((text[i] != <span class="charliteral">' '</span>) &amp;&amp; (text[i] != 0x09)) <span class="keywordflow">break</span>;
00756         }
00757         <span class="keywordflow">if</span> (i == last) <span class="keywordflow">break</span>; <span class="comment">// no DESCR found</span>
00758         mot=text.substr(i, last-i);
00759         pos=mot.find(0x09);
00760         <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">break</span>;  <span class="comment">// lack end of data</span>
00761  
00762         text=mot;
00763         text.erase(0, pos+1);
00764         <span class="comment">// remove trailing blanks</span>
00765         <span class="keywordflow">do</span> pos--; <span class="keywordflow">while</span> (mot[pos] == <span class="charliteral">' '</span>);
00766         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m1">m_comment</a>=mot.substr(0, pos+1);
00767         mot=<span class="stringliteral">"[ucd="</span>;
00768         pos=text.find(mot);
00769         <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">break</span>;  <span class="comment">// lack end of data</span>
00770         text.erase(0, mot.length());
00771         pos=text.find(<span class="charliteral">']'</span>);
00772         <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">break</span>;  <span class="comment">// lack last ]</span>
00773 
00774         mot=text.substr(0, pos);
00775         transform(mot.begin(), mot.end(), mot.begin(), pfunc);
00776         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m2">m_ucd</a>=mot;
00777         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[0] == <span class="charliteral">'A'</span>) {
00778           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>=nbQuantAscii;
00779           nbQuantAscii++;
00780           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::STRING;
00781         }
00782         <span class="keywordflow">else</span> {
00783           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00784           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a>=Quantity::NUM;
00785         }
00786         <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.push_back(readQ); }
00787         <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00788           text=std::string(<span class="stringliteral">"EXCEPTION filling m_quantities: "</span>)+prob.what();
00789           <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
00790           <span class="keywordflow">throw</span>;
00791         }
00792       }<span class="keywordflow">while</span>(0);
00793         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a> == Quantity::VECTOR) {
00794           sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" wrong column description"</span>;
00795           <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str());
00796           sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00797           <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.clear();
00798           found++; <span class="keywordflow">break</span>; <span class="comment">// to stop reading file</span>
00799         }
00800       }
00801       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (foundColumn) found++;
00802       <span class="comment">// skip lines before #Column (foundColumn is false);</span>
00803       <span class="comment">// then: at least one line without any information</span>
00804       <span class="keywordflow">break</span>;
00805 
00806     <span class="keywordflow">case</span> 1:
00807       <span class="comment">// If lines are separated by  ;  ==&gt; CSV (what unchanged)</span>
00808       <span class="comment">// If lines are separated by TAB ==&gt; TSV (what * -1)</span>
00809       <span class="comment">// Check that first word match first quantity,</span>
00810       <span class="comment">// if not: considered as separation line and loop on case 1.</span>
00811       text=line; <span class="comment">/* convert C string to C++ string */</span>
00812       pos=text.find(sep);
00813       <span class="keywordflow">if</span> (pos != std::string::npos) {
00814         mot=text.substr(0, pos);
00815         <span class="keywordflow">if</span> (mot == <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(0).m_name) found++;
00816       }
00817       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pos=text.find(0x09)) != std::string::npos) {
00818         <span class="comment">// suppose there is at least 2 columns</span>
00819         mot=text.substr(0, pos);
00820         <span class="keywordflow">if</span> (mot == <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(0).m_name) {
00821           (*what)*=-1;
00822           found++;
00823           sep=0x09;
00824         }
00825       }
00826       <span class="keywordflow">break</span>;
00827 
00828     <span class="keywordflow">case</span> 2:
00829       <span class="comment">// most of decription is read, units on separate line</span>
00830       last=strlen(line);
00831       <span class="keywordflow">if</span> (testCR) line[--last]=<span class="charliteral">'\0'</span>;
00832       <span class="keywordflow">if</span> (last &gt; 0) {
00833         found++;
00834         text=line; <span class="comment">/* convert C string to C++ string */</span>
00835         i=0;
00836         last=text.find(sep);
00837         <span class="keywordflow">do</span> {
00838           pos=last;
00839           mot=text.substr(0, pos);
00840           <span class="keywordflow">if</span> (pos != std::string::npos) {
00841             text.erase(0, pos+1); <span class="comment">// pos); to test exception below</span>
00842             last=text.find(sep);
00843           }
00844           <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(i).m_unit=mot; }
00845           <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00846             <span class="keywordflow">if</span> (i == <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size())
00847               text=<span class="stringliteral">"more units than quantities, ignoring last unit(s)"</span>;
00848             <span class="keywordflow">else</span>
00849               text=std::string(<span class="stringliteral">"EXCEPTION setting m_unit in m_quantities "</span>)
00850                    +prob.what();
00851             <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, text);
00852             <span class="keywordflow">break</span>;
00853           }
00854           i++;
00855         }
00856         <span class="keywordflow">while</span> (pos != std::string::npos);
00857         <span class="keywordflow">if</span> (i &lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size())
00858           <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, <span class="stringliteral">"less units than quantities !"</span>);
00859       }
00860       <span class="keywordflow">break</span>;
00861 
00862     <span class="keywordflow">case</span> 3:
00863       <span class="comment">// decription is read, separation line starting with ---</span>
00864       last=strlen(line);
00865       <span class="keywordflow">if</span> (testCR) line[--last]=<span class="charliteral">'\0'</span>;
00866       <span class="keywordflow">if</span> ((last &gt; 0) &amp;&amp; (line[0] == <span class="charliteral">'-'</span>)) {
00867         found++;
00868         <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
00869         <a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.tellg();
00870         <span class="keywordflow">if</span> (getDescr) <span class="keywordflow">break</span>; <span class="comment">// must NOT read all file and create tables</span>
00871         <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a> ) {
00872           <span class="comment">// read the total number of rows to have a maximal value</span>
00873           <span class="comment">// to allocate m_strings, m_numericals buffers.</span>
00874           <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
00875             <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
00876             <span class="keywordflow">if</span> (strlen(line) &lt; 2) <span class="keywordflow">break</span>; <span class="comment">// 1 CR for WINDOWS</span>
00877             <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>++;
00878           }
00879           <span class="comment">// go back to initial position printf("%ld ReadRows\n", m_numReadRows);</span>
00880           <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.clear(); <span class="comment">// needed to reset flags before seekg</span>
00881           <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.seekg(<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>);
00882           <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>; <span class="comment">// used by importSelected();</span>
00883         }
00884         <a class="code" href="classcatalog_access_1_1_catalog.html#c11">create_tables</a>(nbQuantAscii);
00885       }
00886       <span class="keywordflow">break</span>;
00887 
00888     <span class="keywordflow">default</span>:
00889       last=strlen(line);
00890       <span class="keywordflow">if</span> ((last == 0) || (line[0] == 0x0D)) {
00891         lineSkipped=<span class="keyword">true</span>; <span class="comment">// to have Warning messages below</span>
00892         <span class="keywordflow">break</span>;
00893       }
00894       <span class="comment">// string max size is MAX_LINE-1;</span>
00895       <span class="keywordflow">if</span> (last &gt;= maxLine) {
00896         sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" exceeds maximal size ("</span>
00897                &lt;&lt; <a class="code" href="catalog_8h.html#a3">MAX_LINE</a> &lt;&lt; <span class="stringliteral">")"</span>;
00898         <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str());
00899         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00900         err=<a class="code" href="namespacecatalog_access.html#a35a19">BAD_FILELINE</a>;
00901         <span class="keywordflow">break</span>;
00902       }
00903       i=strncmp(line, <span class="stringliteral">"#Table"</span>, 6);
00904       <span class="keywordflow">if</span> (i == 0) {
00905         sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">": second table start (not read)"</span>;
00906         <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, sortie.str());
00907         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00908         err=<a class="code" href="namespacecatalog_access.html#a35a22">BAD_ROW</a>;
00909         <span class="keywordflow">break</span>;
00910       }
00911       <span class="keywordflow">if</span> (testCR) line[--last]=<span class="charliteral">'\0'</span>;
00912       text=line; <span class="comment">/* convert C string to C++ string */</span>
00913       pos=text.find(sep);
00914       <span class="keywordflow">if</span> (pos == std::string::npos) {
00915         sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" without separator, line skipped"</span>;
00916         <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, sortie.str());
00917         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00918         <span class="keywordflow">break</span>;
00919       }
00920       <span class="keywordflow">if</span> ((<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> == <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>) || lineSkipped) {
00921         err=<a class="code" href="namespacecatalog_access.html#a35a22">BAD_ROW</a>;
00922         <span class="keywordflow">break</span>;
00923       }
00924       i=0;
00925       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00926       <span class="keywordflow">do</span> {
00927         mot=text.substr(0, pos);
00928         <span class="keywordflow">if</span> (i &lt; err) <a class="code" href="classcatalog_access_1_1_catalog.html#c13">translate_cell</a>(mot, i);
00929         <span class="keywordflow">else</span> {
00930           sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" contains too many quantities"</span>;
00931           <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, sortie.str());
00932           sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00933           <span class="keywordflow">break</span>;
00934         }
00935         i++;
00936         <span class="keywordflow">if</span> (pos != std::string::npos) {
00937           text.erase(0, pos+1);
00938           pos=text.find(sep);
00939         }
00940         <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
00941       }
00942       <span class="keywordflow">while</span> (1);
00943       <span class="keywordflow">if</span> (i &lt;  err) {
00944         sortie &lt;&lt; <span class="stringliteral">"line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" does not contain all quantities"</span>;
00945         <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, sortie.str());
00946         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00947       }
00948       err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
00949       <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>++;
00950       <span class="comment">//found++;</span>
00951       <span class="keywordflow">break</span>;
00952     }
00953     <span class="comment">// to have only 1 test when reading all file</span>
00954     <span class="keywordflow">if</span> (found &lt; 4) {
00955       <span class="comment">// when separation line after Column is found,</span>
00956       <span class="comment">// Quantities must be set.</span>
00957       <span class="keywordflow">if</span> (found == 1) {
00958         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size() == 0) { found--; <span class="keywordflow">break</span>; }
00959         <span class="keywordflow">if</span> (*what &gt;= 2) { found=4; <span class="keywordflow">break</span>; }
00960                        <span class="comment">// found changed, no error on META ALL</span>
00961       }
00962     }
00963     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (getDescr) <span class="keywordflow">break</span>;
00964     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a35a22">BAD_ROW</a>) <span class="keywordflow">break</span>; <span class="comment">// just stop, error not taken into account</span>
00965 
00966   }<span class="comment">// loop on file lines</span>
00967   <span class="comment">//only possible errors: BAD_FILELINE or BAD_ROW</span>
00968   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a35a22">BAD_ROW</a>) err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
00969   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a35a19">BAD_FILELINE</a>) <span class="keywordflow">return</span> err;
00970   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (found &lt; 4) <span class="keywordflow">return</span> (-1*found);
00971   
00972   <span class="keywordflow">return</span> err;
00973 }
00974 
00975 <span class="comment">/**********************************************************************/</span>
00976 <span class="comment">// common code between import and importDescription (private method)</span>
<a name="l00977"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c17">00977</a> <span class="keywordtype">int</span> Catalog::load(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string ext,
00978                   <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr) {
00979 
00980   <span class="keywordtype">int</span> i, err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
00981   std::string origin, text;
00982   <span class="keywordflow">if</span> (getDescr) origin=<span class="stringliteral">"importDescription"</span>; <span class="keywordflow">else</span> origin=<span class="stringliteral">"import"</span>;
00983 
00984   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
00985   i=fileName.length();
00986   <span class="keywordflow">if</span> (i == 0) {
00987     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
00988     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
00989     err=<a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
00990     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
00991     <span class="keywordflow">return</span> err;
00992   }
00993   <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.is_open() ) <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.close();
00994   <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.open(fileName.c_str(), std::ios::in);
00995   <span class="comment">// file can be opened ?</span>
00996   <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.is_open() ) {
00997     text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" cannot be opened"</span>;
00998     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
00999     err=<a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
01000     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01001     <span class="keywordflow">return</span> err;
01002   }
01003 <span class="comment">/*  DIR *testDir=opendir(fileName.c_str());</span>
01004 <span class="comment">  if (testDir != NULL) {</span>
01005 <span class="comment">    closedir(testDir);</span>
01006 <span class="comment">    myFile.close();</span>
01007 <span class="comment">    text=": FILENAME \""+fileName+"\" is a directory";</span>
01008 <span class="comment">    printErr(origin, text);</span>
01009 <span class="comment">    err=BAD_FILETYPE;</span>
01010 <span class="comment">    m_numRows=err;</span>
01011 <span class="comment">    return err;</span>
01012 <span class="comment">  }*/</span>
01013   std::ostringstream sortie;
01014   <span class="keywordtype">bool</span> myTest;
01015   <span class="keyword">const</span> Extension *myEXT = 0;
01016   <span class="comment">// cannot use readTable because FITS IMAGE returns also error 1</span>
01017   <span class="keywordflow">try</span> {
01018     myEXT=IFileSvc::instance().readExtension(fileName, ext);
01019   }
01020   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01021     err=x.code();
01022     <span class="keywordflow">if</span> (err == 1) {
01023       <span class="comment">// This non-cfitsio error number means the file does not exist</span>
01024       <span class="comment">// or is not a table, or is not in either Root nor Fits format. </span>
01025       err=<a class="code" href="namespacecatalog_access.html#a35a18">BAD_FITS</a>;
01026 <span class="comment">/*      printWarn(origin, "FILENAME is NOT fits");*/</span>
01027     }
01028     <span class="keywordflow">else</span> {
01029       <span class="comment">// Other errors come from cfitsio, but apply to a file</span>
01030       <span class="comment">// which is in FITS format but has some sort of format error.</span>
01031       sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but cfitsio returned error="</span> &lt;&lt; err;
01032       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str());
01033       err=<a class="code" href="namespacecatalog_access.html#a35a18">BAD_FITS</a>;
01034       <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01035       <span class="keywordflow">return</span> err;
01036     }
01037   }
01038   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) myTest=myEXT-&gt;isTable();
01039   <span class="keyword">delete</span> myEXT;
01040   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) {
01041  
01042     <span class="keywordflow">if</span> (!myTest) {
01043       text=<span class="stringliteral">": FILENAME is FITS, but NOT a TABLE"</span>;
01044       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01045       err=<a class="code" href="namespacecatalog_access.html#a35a18">BAD_FITS</a>;
01046       <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01047       <span class="keywordflow">return</span> err;
01048     }
01049     <span class="keyword">const</span> Table *myDOL = 0;
01050     <span class="keywordflow">try</span> {
01051       myDOL=IFileSvc::instance().readTable(fileName, ext);
01052     }
01053     <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01054       sortie &lt;&lt; <span class="stringliteral">": FITS is TABLE, but cfitsio returned error="</span> &lt;&lt; err;
01055       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str());
01056       err=<a class="code" href="namespacecatalog_access.html#a35a18">BAD_FITS</a>;
01057       <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01058       <span class="keywordflow">return</span> err;
01059     }
01060     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c14">analyze_fits</a>(myDOL, getDescr, origin);
01061     <span class="keyword">delete</span> myDOL;
01062 
01063   }
01064   <span class="keywordflow">else</span> { <span class="comment">// (err == BAD_FITS)</span>
01065 
01066     err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01067     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of lines read</span>
01068     <span class="keywordtype">bool</span> testCR=<span class="keyword">false</span>; <span class="comment">// true if lines ends with CR (on windows)</span>
01069     <span class="keywordtype">int</span> what=0;        <span class="comment">// 0 for unkwown, &gt;0 for csv, &lt;0 to tsv</span>
01070                        <span class="comment">// fabs()=1 for standard, =2 for meta QUERY</span>
01071     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c15">analyze_head</a>(&amp;tot, &amp;what, &amp;testCR);
01072     <span class="keywordflow">if</span> (!tot) {
01073       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is fits without extension[] "</span>
01074              &lt;&lt; <span class="stringliteral">"specified"</span>;
01075       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str());
01076       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01077       text=<span class="stringliteral">"input file"</span>;
01078       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) err=<a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
01079       <span class="comment">// in case, for strange reason, file.good() fails at first time</span>
01080     }
01081     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) {
01082       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is empty or "</span>
01083              &lt;&lt; <span class="stringliteral">"has unknown structure (stopped step "</span> &lt;&lt; -1*err &lt;&lt; <span class="stringliteral">")"</span>;
01084       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str());
01085       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01086       text=<span class="stringliteral">"input file"</span>;
01087       <span class="keywordflow">if</span> (err == 0) err=<a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>; <span class="comment">/* nothing is read */</span>
01088       <span class="keywordflow">else</span> err=<a class="code" href="namespacecatalog_access.html#a35a17">BAD_FILETYPE</a>; <span class="comment">/* can search if catalog name exist */</span>
01089     }
01090     <span class="keywordflow">else</span> {
01091 
01092       <span class="comment">//what is 1 or 2, then negate if TSV type</span>
01093       <span class="keywordflow">if</span> (what == 1) text=<span class="stringliteral">"input text file"</span>;
01094       <span class="keywordflow">else</span> text=<span class="stringliteral">"input META file"</span>;
01095 
01096       <span class="comment">// get columns description and units, data</span>
01097       err=<a class="code" href="classcatalog_access_1_1_catalog.html#c16">analyze_body</a>(&amp;tot, &amp;what, testCR, getDescr);
01098       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a35a19">BAD_FILELINE</a>) {
01099         <span class="comment">// stopped before reading needed stuff (with getDescr false)</span>
01100         text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" couldn't be read (line too long)"</span>;
01101         <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01102       }
01103       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) {
01104         sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName
01105              &lt;&lt; <span class="stringliteral">"\" has wrong type (stopped step "</span> &lt;&lt; 5-1*err &lt;&lt; <span class="stringliteral">")"</span>;
01106         <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str());
01107         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01108         err=<a class="code" href="namespacecatalog_access.html#a35a17">BAD_FILETYPE</a>;
01109       }
01110       <span class="keywordflow">else</span> {
01111         <span class="keywordflow">if</span> (what &gt; 0) sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is CSV type (; separator)"</span>;
01112         <span class="keywordflow">else</span> sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is TSV type (Tab=0x09 separator)"</span>;
01113         <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(1, sortie.str());
01114         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01115       }
01116 
01117     }
01118     <span class="comment">// myFile.close();  to be commented to let file opened</span>
01119     sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">": "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" lines read"</span>;
01120     <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(0, sortie.str());
01121 
01122   }<span class="comment">// file is read</span>
01123   <span class="keywordflow">if</span> (err &lt; 0) {
01124     <a class="code" href="classcatalog_access_1_1_catalog.html#a23">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
01125     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01126     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=0;
01127     <span class="comment">// exit only if nothing is read</span>
01128     <span class="keywordflow">if</span> ((err == <a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>) || (err == <a class="code" href="namespacecatalog_access.html#a35a18">BAD_FITS</a>)) <span class="keywordflow">return</span> err;
01129   }
01130   <span class="comment">// m_quantities vector maybe filled, MUST fill m_selEllipse, m_loadQuantity</span>
01131   <span class="keywordflow">try</span> {
01132     <a class="code" href="classcatalog_access_1_1_catalog.html#o30">m_selEllipse</a>.assign(7, 0.0);
01133     <a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size(), <span class="keyword">true</span>);
01134   }
01135   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01136     text=std::string(<span class="stringliteral">"EXCEPTION on creating m_selEllipse, m_loadQuantity: "</span>)
01137         +prob.what();
01138     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01139     <span class="keywordflow">throw</span>;
01140   }
01141   <a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a>=<span class="stringliteral">"CDS"</span>; <span class="comment">/* to know that format string need to be changed for fits */</span>
01142   <span class="comment">// check if tableName is known to set generic</span>
01143   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="catalog_8h.html#a0">MAX_CAT</a>; i++) {
01144     <span class="keywordflow">if</span> (Catalog::s_CatalogList[2*i+1] == <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>) <span class="keywordflow">break</span>;
01145   }
01146   <span class="keywordflow">if</span> (i == <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>) {
01147     text=<span class="stringliteral">"Unknown table name, all generic quantities may be not found"</span>;
01148     <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, text);
01149   }
01150   <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o0">m_code</a>=Catalog::s_CatalogList[2*i];
01151   <a class="code" href="classcatalog_access_1_1_catalog.html#c10">setGeneric</a>(i);
01152   <span class="keywordflow">return</span> err;
01153 }
01154 <span class="comment">/**********************************************************************/</span>
01155 <span class="comment">// read only the catalog description from file</span>
<a name="l01156"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a6">01156</a> <span class="keywordtype">int</span> Catalog::importDescription(<span class="keyword">const</span> std::string &amp;fileName,
01157                                <span class="keyword">const</span> std::string ext) {
01158   <span class="keywordtype">int</span> err;
01159   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c22">checkImport</a>(<span class="stringliteral">"importDescription"</span>, <span class="keyword">false</span>);
01160   <span class="comment">// must be called before load() which set m_numRows to 0</span>
01161   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> err;
01162 
01163   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c17">load</a>(fileName, ext, <span class="keyword">true</span>);
01164   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) <span class="keywordflow">return</span> err;
01165 
01166   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01167 }
01168 <span class="comment">/**********************************************************************/</span>
01169 <span class="comment">// read from file an entire catalog without selection</span>
<a name="l01170"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a8">01170</a> <span class="keywordtype">int</span> Catalog::import(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRow,
01171                     <span class="keyword">const</span> std::string ext) {
01172   <span class="keywordtype">int</span> err;
01173   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c22">checkImport</a>(<span class="stringliteral">"import"</span>, <span class="keyword">false</span>);
01174   <span class="comment">// after this check, m_numReadRows is 0</span>
01175   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> err;
01176 
01177   <span class="keywordflow">if</span> (maxRow &lt;= 0) {
01178     <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(<span class="stringliteral">"import"</span>, <span class="stringliteral">"trying to get whole catalog file"</span>);
01179     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=0;
01180   }
01181   <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=maxRow;
01182 
01183   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c17">load</a>(fileName, ext, <span class="keyword">false</span>);
01184   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) <span class="keywordflow">return</span> err;
01185   <a class="code" href="classcatalog_access_1_1_catalog.html#a5">getRAMsize</a>(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>, <span class="keyword">true</span>);
01186   <span class="keywordflow">try</span> {
01187     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> &lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>) {
01188       <span class="keywordtype">int</span> i;
01189       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();
01190       <span class="comment">// erase unused memory  printf("ERASING\n");</span>
01191       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>);
01192       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
01193       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>);
01194     }
01195     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()+2;
01196     <span class="comment">// number of required bits including global and region</span>
01197     err=1+(err-1)/(<span class="keyword">sizeof</span>(long)*8);
01198     <a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>.resize(err);
01199 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
01200 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
01201               &lt;&lt; err &lt;&lt; std::endl;
01202 <span class="preprocessor">    #endif</span>
01203 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_numRows)
01204       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>, 0);
01205     <span class="comment">// above lines can be commented to test the try catch mechanism</span>
01206   }
01207   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01208     std::string text;
01209     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
01210     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(<span class="stringliteral">"import"</span>, text);
01211     <span class="keywordflow">throw</span>;
01212   }
01213   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>;
01214 }
01215 
01216 
01217 <span class="comment">/**********************************************************************/</span>
01218 <span class="comment">// common code between importWeb and importDescriptionWeb (private method)</span>
<a name="l01219"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c18">01219</a> <span class="keywordtype">int</span> Catalog::loadWeb(<span class="keyword">const</span> std::string catName, <span class="keyword">const</span> std::string urlCode,
01220                      <span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRow) {
01221 
01222   std::string origin, text, web;
01223   <span class="keywordtype">int</span> i, err;
01224   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
01225   <span class="keywordflow">if</span> (maxRow &gt;= 0) origin=<span class="stringliteral">"importWeb"</span>; <span class="keywordflow">else</span> origin=<span class="stringliteral">"importDescriptionWeb"</span>;
01226 
01227   err=<a class="code" href="namespacecatalog_access.html#a35a20">BAD_URL</a>;
01228   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01229   <span class="keywordflow">if</span> (urlCode.length() == 0) {
01230     text=<span class="stringliteral">": CODE for URL (web http address) is empty"</span>;
01231     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01232     <span class="keywordflow">return</span> err;
01233   }
01234   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="catalog_8h.html#a2">MAX_URL</a>; i++) {
01235     text=Catalog::s_CatalogURL[i]; <span class="comment">/* convert C string to C++ string */</span>
01236     pos=text.find(<span class="charliteral">' '</span>);
01237     <span class="keywordflow">if</span> (pos == std::string::npos) <span class="keywordflow">continue</span>;
01238     <span class="keywordflow">if</span> (text.substr(0, pos) == urlCode) <span class="keywordflow">break</span>;
01239   }
01240   <span class="keywordflow">if</span> (i == <a class="code" href="catalog_8h.html#a2">MAX_URL</a>) {
01241     text=<span class="stringliteral">": CODE for URL (web http address) do not exist"</span>;
01242     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01243     <span class="keywordflow">return</span> err;
01244   }
01245   pos=text.rfind(<span class="charliteral">' '</span>);
01246   <span class="keywordflow">if</span> (pos == std::string::npos) web=text;
01247   <span class="keywordflow">else</span> web=text.substr(pos+1, text.length()-pos);
01248 
01249   <span class="keywordtype">int</span> iCat=<a class="code" href="classcatalog_access_1_1_catalog.html#c23">checkCatName</a>(origin, catName);
01250   <span class="keywordflow">if</span> (iCat &lt; 0) {
01251     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=iCat;
01252     <span class="keywordflow">return</span> iCat;
01253   }
01254   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c22">checkImport</a>(origin, <span class="keyword">false</span>);
01255   <span class="comment">// after this check, m_numOriRows is 0</span>
01256   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> err;
01257 
01258   <span class="keywordflow">if</span> (maxRow == 0) <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, <span class="stringliteral">"trying to query whole catalog"</span>);
01259   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
01260 <span class="comment">/* now, ASCII query must be created</span>
01261 <span class="comment">  and sent, using CDS package to given URL</span>
01262 <span class="comment">*/</span>
01263   err=-9;
01264   text=<span class="stringliteral">"Web query not implemented"</span>;
01265   <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01266 
01267 
01268   <span class="keywordflow">if</span> (err &lt; 0) {
01269     <a class="code" href="classcatalog_access_1_1_catalog.html#a23">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
01270     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=err;
01271     <span class="keywordflow">return</span> err;
01272   }
01273   <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o30">m_selEllipse</a>.assign(7, 0.0); }
01274   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01275     text=std::string(<span class="stringliteral">"EXCEPTION on creating m_selEllipse: "</span>)+prob.what();
01276     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01277     <span class="keywordflow">throw</span>;
01278   }
01279   <a class="code" href="classcatalog_access_1_1_catalog.html#o0">m_code</a>=catName;
01280   <a class="code" href="classcatalog_access_1_1_catalog.html#c10">setGeneric</a>(iCat);
01281   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01282 }
01283 <span class="comment">/**********************************************************************/</span>
01284 <span class="comment">// load only the catalog description from CDS web site</span>
<a name="l01285"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a7">01285</a> <span class="keywordtype">int</span> Catalog::importDescriptionWeb(<span class="keyword">const</span> std::string catName,
01286                                   <span class="keyword">const</span> std::string urlCode,
01287                                   <span class="keyword">const</span> std::string &amp;fileName) {
01288 
01289   <span class="keywordtype">int</span> err;
01290   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c18">loadWeb</a>(catName, urlCode, fileName, -1);
01291   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) <span class="keywordflow">return</span> err;
01292 
01293   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01294 }
01295 <span class="comment">/**********************************************************************/</span>
01296 <span class="comment">// load from CDS web site an entire catalog without selection</span>
<a name="l01297"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a9">01297</a> <span class="keywordtype">int</span> Catalog::importWeb(<span class="keyword">const</span> std::string catName,
01298                        <span class="keyword">const</span> std::string urlCode, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRow,
01299                        <span class="keyword">const</span> std::string &amp;fileName) {
01300 
01301   <span class="keywordtype">int</span> err;
01302   <span class="keywordtype">long</span> limitRow=maxRow;
01303   <span class="keywordflow">if</span> (limitRow &lt; 0) limitRow=0; <span class="comment">// to avoid confusion with importDescriptionWeb</span>
01304   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c18">loadWeb</a>(catName, urlCode, fileName, limitRow);
01305   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) <span class="keywordflow">return</span> err;
01306   <a class="code" href="classcatalog_access_1_1_catalog.html#a5">getRAMsize</a>(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>, <span class="keyword">true</span>);
01307 
01308   <span class="keywordflow">try</span> {
01309     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()+2;
01310     <span class="comment">// number of required bits including global and region</span>
01311     err=1+(err-1)/(<span class="keyword">sizeof</span>(long)*8);
01312     <a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>.resize(err);
01313 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
01314 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
01315               &lt;&lt; err &lt;&lt; std::endl;
01316 <span class="preprocessor">    #endif</span>
01317 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_numRows)
01318       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>, 0);
01319     <span class="comment">// above lines can be commented to test the try catch mechanism</span>
01320   }
01321   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01322     std::string text;
01323     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
01324     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(<span class="stringliteral">"importWeb"</span>, text);
01325     <span class="keywordflow">throw</span>;
01326   }
01327   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>;
01328 }
01329 
01330 
01331 <span class="comment">/**********************************************************************/</span>
<a name="l01332"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c19">01332</a> <span class="keywordtype">int</span> Catalog::loadSelected(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *tot) {
01333 
01334   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"importSelected"</span>;
01335   <span class="keywordtype">int</span>  i, last,
01336        maxLine=<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>-1, <span class="comment">// to avoid computation each line</span>
01337        err=0;
01338   <span class="keywordtype">char</span> sep=<span class="charliteral">';'</span>,
01339        line[<a class="code" href="catalog_8h.html#a3">MAX_LINE</a>];
01340 
01341   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>=0;
01342   <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> ) {
01343     <span class="comment">// read the total number of rows to have a maximal value</span>
01344     <span class="comment">// to allocate m_strings, m_numericals buffers.</span>
01345     <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
01346       <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
01347       <span class="keywordflow">if</span> (strlen(line) &lt; 2) <span class="keywordflow">break</span>; <span class="comment">// 1 CR for WINDOWS</span>
01348       <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>++;
01349     }
01350     <span class="comment">// go back to initial position</span>
01351     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.clear(); <span class="comment">// needed to reset flags before seekg</span>
01352     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.seekg(<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>);
01353   }
01354   <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>;
01355   last=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01356   <span class="keywordflow">for</span> (i=0; i&lt;last; i++)
01357     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_format[0] == <span class="charliteral">'A'</span>) err++;
01358   <a class="code" href="classcatalog_access_1_1_catalog.html#c11">create_tables</a>(err);
01359   <span class="keywordflow">if</span> (!<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numReadRows</a>) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01360 
01361 <span class="comment">//printf("%ld OriRows\n", m_numOriRows);</span>
01362   <span class="keywordtype">bool</span> testCR=<span class="keyword">false</span>,
01363        first=<span class="keyword">true</span>,
01364        lineSkipped=<span class="keyword">false</span>;
01365   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
01366   std::ostringstream sortie;
01367   std::string text, mot;
01368   err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01369   <span class="keywordflow">while</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.good() ) {
01370 
01371     <span class="comment">// extract line with delimiter \n which is discarded</span>
01372     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.getline(line, <a class="code" href="catalog_8h.html#a3">MAX_LINE</a>);
01373     (*tot)++;
01374     last=strlen(line);
01375     <span class="keywordflow">if</span> ((last == 0) || (line[0] == 0x0D)) {
01376       lineSkipped=<span class="keyword">true</span>; <span class="comment">// to have Warning messages below</span>
01377       <span class="keywordflow">continue</span>;
01378     }
01379     <span class="comment">// string max size is MAX_LINE-1;</span>
01380     <span class="keywordflow">if</span> (last &gt;= maxLine) {
01381       sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" exceeds maximal size ("</span>
01382              &lt;&lt; <a class="code" href="catalog_8h.html#a3">MAX_LINE</a> &lt;&lt; <span class="stringliteral">")"</span>;
01383       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str());
01384       err=<a class="code" href="namespacecatalog_access.html#a35a19">BAD_FILELINE</a>;
01385       <span class="keywordflow">break</span>;
01386     }
01387     <span class="keywordflow">if</span> (first) {
01388       first=<span class="keyword">false</span>;
01389       <span class="comment">// test if last char is CR from WINDOWS</span>
01390       <span class="keywordflow">if</span> (line[last-1] == 0x0D) testCR=<span class="keyword">true</span>;
01391       <span class="keywordtype">char</span> *posC=strchr(line, sep);
01392       <span class="comment">// if separator isn't the default ; search for TAB</span>
01393       <span class="comment">// suppose there is at least 2 columns</span>
01394       <span class="keywordflow">if</span> (posC == NULL) {
01395         posC=strchr(line, 0x09);
01396         <span class="keywordflow">if</span> (posC != NULL) sep=0x09;
01397         <span class="keywordflow">else</span> {
01398           <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, <span class="stringliteral">"first data line has no separator"</span>);
01399           err=<a class="code" href="namespacecatalog_access.html#a35a17">BAD_FILETYPE</a>;
01400           <span class="keywordflow">break</span>;
01401         }
01402       }
01403     }
01404     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (testCR) line[--last]=<span class="charliteral">'\0'</span>;
01405     i=strncmp(line, <span class="stringliteral">"#Table"</span>, 6);
01406     <span class="keywordflow">if</span> (i == 0) {
01407       sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">": second table start (not read)"</span>;
01408       <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, sortie.str());
01409       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01410       <span class="keywordflow">break</span>;
01411     }
01412     text=line; <span class="comment">/* convert C string to C++ string */</span>
01413     pos=text.find(sep);
01414     <span class="keywordflow">if</span> (pos == std::string::npos) {
01415       sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" without separator, line skipped"</span>;
01416       <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, sortie.str());
01417       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01418       <span class="keywordflow">continue</span>;
01419     }
01420     i=0;
01421     <span class="keywordflow">if</span> (lineSkipped) <span class="keywordflow">break</span>;
01422     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size();
01423     last=0;
01424     <span class="keywordflow">do</span> {
01425       mot=text.substr(0, pos);
01426       <span class="keywordflow">if</span> (i &gt;= err) {
01427         sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" contains too many quantities"</span>;
01428         <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, sortie.str());
01429         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01430         <span class="keywordflow">break</span>;
01431       }
01432       <span class="keywordflow">else</span> {
01433         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>[i]) <a class="code" href="classcatalog_access_1_1_catalog.html#c13">translate_cell</a>(mot, i-last);
01434         <span class="keywordflow">else</span> last++;
01435       }
01436       i++;
01437       <span class="keywordflow">if</span> (pos != std::string::npos) {
01438         text.erase(0, pos+1);
01439         pos=text.find(sep);
01440       }
01441       <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
01442     }
01443     <span class="keywordflow">while</span> (1);
01444     <span class="keywordflow">if</span> (i &lt;  err) {
01445       sortie &lt;&lt; <span class="stringliteral">"data line #"</span> &lt;&lt; *tot &lt;&lt; <span class="stringliteral">" does not contain all quantities"</span>;
01446       <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, sortie.str());
01447       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
01448     }
01449     err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01450     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>++;
01451   }
01452   <span class="keywordflow">return</span> err;
01453 }
01454 <span class="comment">/**********************************************************************/</span>
01455 <span class="comment">// if a catalog description was already loaded, this method does</span>
01456 <span class="comment">// the same as import() adding selection criteria for loading</span>
<a name="l01457"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a10">01457</a> <span class="keywordtype">int</span> Catalog::importSelected() {
01458 
01459   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"importSelected"</span>;
01460   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#c22">checkImport</a>(origin, <span class="keyword">true</span>);
01461   <span class="keywordflow">if</span> (quantSize &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> quantSize;
01462 
01463   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> &gt; 0) {
01464     <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, <span class="stringliteral">"call 'deleteContent' before 'importSelected'"</span>);
01465     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a13">IMPORT_BIS</a>;
01466   }
01467   <span class="keywordtype">int</span> i, err=0,
01468       maxSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size();
01469   <span class="keywordflow">for</span> (i=0; i&lt;maxSize; i++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>[i]) err++;
01470   <span class="keywordflow">if</span> (err &lt; 2) {
01471     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, <span class="stringliteral">"at least 2 quantities must be selected for import"</span>);
01472     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a31">BAD_SEL_QUANT</a>;
01473   }
01474   std::ostringstream sortie; 
01475   sortie &lt;&lt; err &lt;&lt; <span class="stringliteral">" quantities (over "</span> &lt;&lt; maxSize &lt;&lt; <span class="stringliteral">") selected for import"</span>;
01476   <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(1, sortie.str());
01477   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string</span>
01478   <span class="keywordflow">if</span> (err != quantSize) {
01479     <span class="comment">// in fact, due to select*Quantities() restrictions,</span>
01480     <span class="comment">// quantSize can only be greater than err</span>
01481     <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(2, <span class="stringliteral">"Erasing unwanted quantities for importSelected()"</span>);
01482     <a class="code" href="classcatalog_access_1_1_catalog.html#c1">deleteQuantities</a>();
01483   }
01484   err=<a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>; <span class="comment">//IS_OK;</span>
01485   <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.is_open() ) { <span class="comment">// data must be read from file</span>
01486 
01487     <span class="keywordflow">if</span> (!<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>) {
01488       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, <span class="stringliteral">"file import was not succesful"</span>);
01489       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a14">IMPORT_NEED</a>;
01490     }
01491     <span class="comment">// go back to initial position</span>
01492     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.clear(); <span class="comment">// needed to reset flags before seekg</span>
01493     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">myFile</a>.seekg(<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>);
01494     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of data lines read</span>
01495     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c19">loadSelected</a>(&amp;tot);
01496     <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>) {
01497       sortie &lt;&lt; tot &lt;&lt; <span class="stringliteral">" data lines read for importSelected()"</span>;
01498       <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(0, sortie.str());
01499       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>;
01500     }
01501 
01502   }
01503   <span class="keywordflow">else</span> { <span class="comment">// data must be querried via web</span>
01504 
01505 
01506   }
01507   <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, <span class="stringliteral">"function only implemented for column selection"</span>);
01508   <span class="keywordflow">return</span> err;
01509 }
01510 
01511 <span class="comment">/**********************************************************************/</span>
01512 <span class="comment">// create catalog header from memory to a text file</span>
<a name="l01513"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c20">01513</a> <span class="keywordtype">int</span> Catalog::createText(<span class="keyword">const</span> std::string &amp;fileName, <span class="keywordtype">bool</span> clobber,
01514                         <span class="keyword">const</span> std::string origin) {
01515   std::string  text;
01516   std::fstream file;
01517   <span class="keywordtype">int</span> err;
01518 
01519   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c22">checkImport</a>(origin, <span class="keyword">true</span>);
01520   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> err;
01521 
01522   err=fileName.length();
01523   <span class="keywordflow">if</span> (err == 0) {
01524     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
01525     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01526     err=<a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
01527     <span class="keywordflow">return</span> err;
01528   }
01529 
01530   <span class="comment">// overwrite existing file ?</span>
01531   <span class="keywordflow">if</span> (!clobber) {
01532     file.open(fileName.c_str(), std::ios::in);
01533     <span class="keywordflow">if</span> (file) {
01534       file.close();
01535       text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" exist (clobber=no)"</span>;
01536       <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01537       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
01538     }
01539     file.clear();  <span class="comment">// clears all flags associated with the current stream</span>
01540   }
01541   <span class="comment">// open in write mode, if the file already existed it is erased</span>
01542   file.open(fileName.c_str(), std::ios::out | std::ios::trunc);
01543   <span class="keywordflow">if</span> (!file) {
01544     text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" cannot be written"</span>;
01545     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01546     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
01547   }
01548 
01549   <span class="keywordtype">char</span> tab=0x09, sep=<span class="charliteral">';'</span>;
01550   <span class="keywordtype">int</span> j, vecSize;
01551   <span class="keywordtype">long</span> tot=0l, totData=0l;
01552   <span class="keywordtype">bool</span> saveAll=(origin == <span class="stringliteral">"saveText"</span>);
01553   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> == <a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_numSelRows</a>) saveAll=<span class="keyword">true</span>;
01554 
01555   file &lt;&lt; <span class="stringliteral">"#RESOURCE=catalogAccess("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o0">m_code</a> &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; std::endl;
01556   file &lt;&lt; <span class="stringliteral">"#Name: "</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a> &lt;&lt; std::endl;
01557   file &lt;&lt; <span class="stringliteral">"#Title:"</span> &lt;&lt; tab &lt;&lt;  <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a> &lt;&lt; std::endl;
01558   file &lt;&lt; <span class="stringliteral">"#Name: "</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a> &lt;&lt; std::endl;
01559   file &lt;&lt; <span class="stringliteral">"#Title:"</span> &lt;&lt; tab &lt;&lt;  <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a> &lt;&lt; std::endl;
01560   tot+=5;
01561   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01562   <span class="keywordflow">for</span> (j=0; j&lt;vecSize; j++) {
01563     file &lt;&lt; <span class="stringliteral">"#Column"</span> &lt;&lt; tab &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name &lt;&lt; tab &lt;&lt; <span class="stringliteral">"("</span>
01564          &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_format &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; tab;
01565     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name.length() &lt; 8) file &lt;&lt; <span class="stringliteral">"        "</span>;
01566     file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_comment &lt;&lt; tab &lt;&lt; <span class="stringliteral">"[ucd="</span>
01567          &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_ucd &lt;&lt; <span class="stringliteral">"]"</span>
01568          &lt;&lt; std::endl;
01569   }
01570   file &lt;&lt; std::endl;
01571   tot+=vecSize+1;
01572   <span class="comment">// line do NOT end with separator</span>
01573   <span class="keywordflow">for</span> (j=0; j&lt;vecSize-1; j++) {
01574     file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name &lt;&lt; sep;
01575   }
01576   file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_name &lt;&lt; std::endl;
01577   <span class="keywordflow">for</span> (j=0; j&lt;vecSize-1; j++) {
01578     file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_unit &lt;&lt; sep;
01579   }
01580   file &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_unit &lt;&lt; std::endl;
01581   file &lt;&lt; <span class="stringliteral">"---"</span> &lt;&lt; std::endl;
01582   tot+=3;
01583   <span class="keywordflow">try</span> {
01584     <span class="keywordtype">int</span> i, len, bufSize=0;
01585     <span class="keywordtype">char</span> first, *buffer=NULL;
01586     std::vector&lt;std::string&gt; formats(vecSize, <span class="stringliteral">"%s"</span>);
01587     std::vector&lt;int&gt;         lengths(vecSize, 0);
01588     std::ostringstream sortie;
01589     <span class="keywordtype">double</span> r;
01590     <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) { 
01591       text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i].m_format;
01592       j=text.length();
01593       <span class="keywordflow">if</span> (j == 0) <span class="keywordflow">continue</span>;
01594       first=text[0];
01595       text.erase(0, 1);
01596       j=std::atoi(text.c_str());
01597       <span class="keywordflow">if</span> (j &lt;= 0) <span class="keywordflow">continue</span>;
01598       lengths[i]=j;
01599       <span class="keywordflow">if</span> (j &gt; bufSize) {
01600         bufSize=j;
01601         buffer=(<span class="keywordtype">char</span> *)realloc(buffer, bufSize*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
01602         <span class="keywordflow">if</span> (buffer == NULL)
01603           <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"Cannot allocate string buffer"</span>);
01604       }
01605       <span class="keywordflow">switch</span> (first) {
01606       <span class="keywordflow">case</span> <span class="charliteral">'A'</span>:
01607         sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">"s"</span>;
01608         formats[i]=sortie.str();
01609         <span class="keywordflow">break</span>;
01610       <span class="keywordflow">case</span> <span class="charliteral">'I'</span>:
01611         sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">".0f"</span>;
01612         formats[i]=sortie.str();
01613         <span class="keywordflow">break</span>;
01614       <span class="keywordflow">case</span> <span class="charliteral">'F'</span>:  <span class="comment">// number of decimals is needed from CSV/TSV</span>
01615         <span class="keywordflow">if</span> (i == <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexRA</a>)
01616           sortie &lt;&lt; <span class="stringliteral">"%0"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"f"</span>;
01617         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == <a class="code" href="classcatalog_access_1_1_catalog.html#o29">m_indexDEC</a>)
01618           sortie &lt;&lt; <span class="stringliteral">"%+0"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"f"</span>;
01619         <span class="keywordflow">else</span> sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"f"</span>;
01620         formats[i]=sortie.str();
01621         <span class="keywordflow">break</span>;
01622       <span class="keywordflow">default</span> :  <span class="comment">// number of decimals is needed from CSV/TSV</span>
01623         sortie &lt;&lt; <span class="stringliteral">"%"</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">"e"</span>;
01624         formats[i]=sortie.str();
01625         <span class="keywordflow">break</span>;
01626       }
01627       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string</span>
01628     }
01629     <span class="comment">// all the quantities have their sprintf format</span>
01630     <span class="comment">// IF their lengths[] is positive</span>
01631     <span class="keywordflow">if</span> (saveAll) {
01632 
01633       <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k=0; k&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>; k++) <span class="keywordflow">for</span> (j=0; j&lt;vecSize; ) {
01634         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::NUM) {
01635           r=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01636           <span class="keywordflow">if</span> (isnan(r)) {
01637             len=lengths[j];
01638             <span class="keywordflow">if</span> (len == 0) len=1;
01639             file &lt;&lt; std::setw(len+1) &lt;&lt; std::setfill(<span class="charliteral">' '</span>);
01640           }
01641           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01642             sprintf(buffer, formats[j].c_str(), r);
01643             file.write(buffer, lengths[j]);
01644           }
01645           <span class="keywordflow">else</span> file &lt;&lt; r;
01646         }
01647         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::STRING) {
01648           text=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01649           <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01650             sprintf(buffer, formats[j].c_str(), text.c_str());
01651             file.write(buffer, lengths[j]);
01652           }
01653           <span class="keywordflow">else</span> file &lt;&lt; text;
01654         }
01655         <span class="keywordflow">if</span> (++j == vecSize) file &lt;&lt; std::endl; <span class="keywordflow">else</span> file &lt;&lt; sep;
01656       } <span class="comment">// loop on rows and quantities</span>
01657 
01658     }
01659     <span class="keywordflow">else</span> <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k=0; k&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>; k++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>[0].at(k) &amp; 1) {
01660 
01661       <span class="keywordflow">for</span> (j=0; j&lt;vecSize; ) {
01662         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::NUM) {
01663           r=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01664           <span class="keywordflow">if</span> (isnan(r)) {
01665             len=lengths[j];
01666             <span class="keywordflow">if</span> (len == 0) len=1;
01667             file &lt;&lt; std::setw(len+1) &lt;&lt; std::setfill(<span class="charliteral">' '</span>);
01668           }
01669           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01670             sprintf(buffer, formats[j].c_str(), r);
01671             file.write(buffer, lengths[j]);
01672           }
01673           <span class="keywordflow">else</span> file &lt;&lt; r;
01674         }
01675         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_type == Quantity::STRING) {
01676           text=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j].m_index].at(k);
01677           <span class="keywordflow">if</span> (lengths[j] &gt; 0) {
01678             sprintf(buffer, formats[j].c_str(), text.c_str());
01679             file.write(buffer, lengths[j]);
01680           }
01681           <span class="keywordflow">else</span> file &lt;&lt; text;
01682         }
01683         <span class="keywordflow">if</span> (++j == vecSize) file &lt;&lt; std::endl; <span class="keywordflow">else</span> file &lt;&lt; sep;
01684       }
01685       totData++;
01686       <span class="keywordflow">if</span> (totData == <a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_numSelRows</a>) <span class="keywordflow">break</span>;
01687 
01688     } <span class="comment">// loop on rows and quantities, selected branch</span>
01689 
01690     <span class="keywordflow">if</span> (saveAll) tot+=<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>; <span class="keywordflow">else</span> tot+=<a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_numSelRows</a>;
01691     <span class="keywordflow">if</span> (buffer != NULL) free(buffer);
01692   }
01693   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01694     text=std::string(<span class="stringliteral">"EXCEPTION writing rows in file: "</span>)+prob.what();
01695     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01696     <span class="keywordflow">throw</span>;
01697   }
01698   file &lt;&lt; std::endl;
01699   tot++;
01700   file.close();
01701   std::ostringstream sortie; 
01702   sortie &lt;&lt; <span class="stringliteral">"output text file is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" lines written)"</span>;
01703   <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(0, sortie.str());
01704   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;  
01705 }
01706 <span class="comment">/**********************************************************************/</span>
01707 <span class="comment">// save whole catalog from memory to a text file</span>
<a name="l01708"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a11">01708</a> <span class="keywordtype">int</span> Catalog::saveText(<span class="keyword">const</span> std::string &amp;fileName, <span class="keywordtype">bool</span> clobber) {
01709 
01710   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveText"</span>;
01711   <span class="keywordtype">int</span> err;
01712   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c20">createText</a>(fileName, clobber, origin);
01713   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> err;
01714 
01715   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01716 }
01717 <span class="comment">/**********************************************************************/</span>
01718 <span class="comment">// save selected rows of catalog from memory to a text file</span>
<a name="l01719"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a12">01719</a> <span class="keywordtype">int</span> Catalog::saveSelectedText(<span class="keyword">const</span> std::string &amp;fileName, <span class="keywordtype">bool</span> clobber) {
01720 
01721   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveSelectedText"</span>;
01722   <span class="keywordtype">int</span> err;
01723   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c20">createText</a>(fileName, clobber, origin);
01724   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> err;
01725 
01726   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01727 }
01728 
01729 
01730 <span class="comment">/**********************************************************************/</span>
01731 <span class="comment">// create catalog header from memory to a FITS file</span>
<a name="l01732"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c21">01732</a> <span class="keywordtype">int</span> Catalog::createFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string &amp;extName,
01733                         <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append, <span class="keyword">const</span> std::string origin,
01734                         tip::Table **ptrTable) {
01735 
01736   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
01737   std::string text, newName;
01738   <span class="keywordtype">int</span>  j, err;
01739   <span class="keywordtype">bool</span> create=<span class="keyword">true</span>;
01740 
01741   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c22">checkImport</a>(origin, <span class="keyword">true</span>);
01742   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> err;
01743 
01744   err=fileName.length();
01745   <span class="keywordflow">if</span> (err == 0) {
01746     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
01747     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01748     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
01749   }
01750   <span class="keywordflow">if</span> (extName.length() &gt; 68) {
01751     text=<span class="stringliteral">": EXTENSION name is TOO long (limited to 68 characters)"</span>;
01752     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01753     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
01754   }
01755   <span class="comment">// overwrite existing file ?</span>
01756   <span class="keywordflow">if</span> (!clobber) {
01757     std::fstream file;
01758     file.open(fileName.c_str(), std::ios::in);
01759     <span class="keywordflow">if</span> (file) {
01760       file.close();
01761       create=<span class="keyword">false</span>;
01762       <span class="keywordflow">if</span> (!append) {
01763         text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" exist (clobber=no, append=no)"</span>;
01764         <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01765         <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a16">BAD_FILENAME</a>;
01766       }
01767       <span class="keywordflow">else</span> {
01768         text=<span class="stringliteral">"appending extension to existing FILENAME (method "</span>+origin+<span class="stringliteral">")"</span>;
01769         <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(1, text);
01770       }
01771     }
01772   }
01773   <span class="keywordflow">if</span> (extName.empty()) {
01774     <span class="comment">/* max length is 68, as keyword value starts/ends with ' in 11/80 */</span>
01775     newName=<a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>.substr(0,68);
01776     <span class="comment">/* replace forbidden char. */</span>
01777     err=newName.length();
01778     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01779       <span class="keywordflow">if</span> (newName[j] == <span class="charliteral">'/'</span>) newName[j]=<span class="charliteral">'_'</span>;
01780     }
01781     text=<span class="stringliteral">"EXTENSION name set to '"</span>+newName+<span class="stringliteral">"'"</span>;
01782     <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, text); 
01783     err=<a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01784   }
01785   <span class="keywordflow">else</span> newName=extName;
01786 
01787   <span class="keywordflow">try</span> {
01788     <span class="keywordflow">if</span> (create) IFileSvc::instance().createFile(fileName);
01789     IFileSvc::instance().appendTable(fileName, newName);
01790     (*ptrTable)=IFileSvc::instance().editTable(fileName, newName);
01791   }
01792   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01793     text=<span class="stringliteral">": cannot append and edit fits EXTENSION"</span>;
01794     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01795     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a18">BAD_FITS</a>;
01796   }
01797   Header &amp;header=(*ptrTable)-&gt;getHeader();
01798   <span class="keywordflow">try</span> {
01799     header.setKeyword(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0], <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>);
01800     header.setKeyComment(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0], <a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[1]);
01801     header.setKeyword(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0], <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>);
01802     header.setKeyComment(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0], <a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[1]);
01803     <span class="comment">/* test </span>
01804 <span class="comment">    header.setKeyUnit(KeyTable[0], "deg");*/</span>
01805   }
01806   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01807     text=<span class="stringliteral">"fits EXTENSION, cannot add CDS header keys"</span>;
01808     <a class="code" href="namespacecatalog_access.html#a33">printWarn</a>(origin, text);
01809   }
01810   <span class="keywordflow">try</span> {
01811     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01812     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01813       <span class="keyword">const</span> <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> &amp;readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01814       <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a> == Quantity::NUM) {
01815         text=<span class="stringliteral">"1D"</span>;
01816         <span class="comment">/* to be improved for integers */</span>
01817       }
01818       <span class="keywordflow">else</span> {
01819         text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>;
01820         <span class="keywordflow">if</span> ( isalpha(readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[0]) ) {
01821           text.erase(0,1);
01822           text=text+<span class="stringliteral">"A"</span>;
01823         }
01824       }
01825       (*ptrTable)-&gt;appendField(readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>, text);
01826       text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_unit</a>;
01827       <span class="keywordflow">if</span> ( !text.empty() ) {
01828         sprintf(name, <span class="stringliteral">"TUNIT%d"</span>, j+1);
01829         newName=name; <span class="comment">/* convert C string to C++ string */</span>
01830         header.setKeyword(newName, text);
01831         header.setKeyComment(newName, <span class="stringliteral">"physical unit of field"</span>);
01832       }
01833       sprintf(name, <span class="stringliteral">"%s%d"</span>, <a class="code" href="namespacecatalog_access.html#a4">Key_UCD</a>.c_str(), j+1);
01834       newName=name; <span class="comment">/* convert C string to C++ string */</span>
01835       header.setKeyword(newName, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m2">m_ucd</a>);
01836       header.setKeyComment(newName, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m1">m_comment</a>);
01837     }<span class="comment">/* loop on quantities */</span>
01838   }
01839   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01840     text=<span class="stringliteral">": fits EXTENSION, cannot add column"</span>;
01841     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, text);
01842     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a18">BAD_FITS</a>;
01843   }
01844 <span class="comment">/* NEED new tip methods</span>
01845 <span class="comment">  const IColumn *myCol = 0;</span>
01846 <span class="comment">  try {</span>
01847 <span class="comment">    for (j=0; j &lt; err; j++) {</span>
01848 <span class="comment">      const Quantity &amp;readQ=m_quantities[j];</span>
01849 <span class="comment">      myCol=(*ptrTable)-&gt;getColumn(j);</span>
01850 <span class="comment"></span>
01851 <span class="comment">    }</span>
01852 <span class="comment">  }</span>
01853 <span class="comment">  catch (const TipException &amp;x) {</span>
01854 <span class="comment">    text=": fits EXTENSION, cannot modify column description";</span>
01855 <span class="comment">    printErr(origin, text);</span>
01856 <span class="comment">    return BAD_FITS;</span>
01857 <span class="comment">  }</span>
01858 <span class="comment">*/</span>
01859   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01860 }
01861 <span class="comment">/**********************************************************************/</span>
01862 <span class="comment">// save whole catalog from memory to a FITS file</span>
<a name="l01863"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a13">01863</a> <span class="keywordtype">int</span> Catalog::saveFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string &amp;extName,
01864                       <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append) {
01865 
01866   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveFits"</span>;
01867   Table *myDOL=0;
01868   <span class="keywordtype">int</span> err;
01869   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c21">createFits</a>(fileName, extName, clobber, append, origin, &amp;myDOL);
01870   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> err;
01871 
01872   std::ostringstream sortie;
01873   <span class="keywordtype">long</span> tot=0l;
01874   <span class="keywordtype">int</span>  i, j;
01875 
01876   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a> &gt; 0) {
01877   <span class="keywordflow">try</span> {
01878     myDOL-&gt;setNumRecords(<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>);
01879     <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
01880     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01881     <span class="comment">// Loop over all records (rows) and set values</span>
01882     <span class="keywordflow">for</span> (Table::Iterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end(); ++itor) {
01883       <span class="comment">// double variable to hold the value of all the numeric fields</span>
01884       <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01885         readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01886         i=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>;
01887         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a> == Quantity::NUM) {
01888           (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set( <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(tot) );
01889           <span class="comment">// to be improved for integers</span>
01890         }
01891         <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set( <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].at(tot) );
01892       }
01893       tot++;
01894     }<span class="comment">/* loop on rows */</span>
01895   }
01896   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01897     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot write at row#"</span> &lt;&lt; tot;
01898     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str() );
01899     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a22">BAD_ROW</a>;
01900   }<span class="comment">/* end of try */</span>
01901   }<span class="comment">/* at least 1 row */</span>
01902 
01903   <span class="keyword">delete</span> myDOL; myDOL=0;
01904   sortie &lt;&lt; <span class="stringliteral">"output fits is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" rows written)"</span>;
01905   <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(0, sortie.str());
01906   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01907 }
01908 <span class="comment">/**********************************************************************/</span>
01909 <span class="comment">// save selected rows of catalog from memory to a FITS file</span>
<a name="l01910"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a14">01910</a> <span class="keywordtype">int</span> Catalog::saveSelectedFits(<span class="keyword">const</span> std::string &amp;fileName,
01911                               <span class="keyword">const</span> std::string &amp;extName,
01912                               <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append) {
01913 
01914   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveSelectedFits"</span>;
01915   Table *myDOL=0;
01916   <span class="keywordtype">int</span> err;
01917   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c21">createFits</a>(fileName, extName, clobber, append, origin, &amp;myDOL);
01918   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a35a12">IS_VOID</a>) <span class="keywordflow">return</span> err;
01919 
01920   std::ostringstream sortie;
01921   <span class="keywordtype">long</span> tot=0l;
01922   <span class="keywordtype">int</span>  i, j;
01923 
01924   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_numSelRows</a> &gt; 0) {
01925   <span class="keywordflow">try</span> {
01926     myDOL-&gt;setNumRecords(<a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_numSelRows</a>);
01927     <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
01928     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01929     Table::Iterator itor=myDOL-&gt;begin();
01930     <span class="comment">// Loop over all selected records (rows) and set values</span>
01931     <span class="comment">// first bit indicates global selection</span>
01932     <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k=0; k&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_numRows</a>; k++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o17">m_rowIsSelected</a>[0].at(k) &amp; 1) {
01933       <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01934         readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01935         i=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_index</a>;
01936         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_type</a> == Quantity::NUM) {
01937           (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set( <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(tot) );
01938           <span class="comment">// to be improved for integers</span>
01939         }
01940         <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set( <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].at(tot) );
01941       }
01942       tot++;
01943       itor++;
01944       <span class="keywordflow">if</span> (tot == <a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_numSelRows</a>) <span class="keywordflow">break</span>;
01945     }
01946   }
01947   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01948     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot write at row#"</span> &lt;&lt; tot;
01949     <a class="code" href="namespacecatalog_access.html#a32">printErr</a>(origin, sortie.str() );
01950     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a22">BAD_ROW</a>;
01951   }<span class="comment">/* end of try */</span>
01952   }<span class="comment">/* at least 1 selected row */</span>
01953 
01954   <span class="keyword">delete</span> myDOL; myDOL=0;
01955   sortie &lt;&lt; <span class="stringliteral">"output fits is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" rows written)"</span>;
01956   <a class="code" href="namespacecatalog_access.html#a34">printLog</a>(0, sortie.str());
01957   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a35a11">IS_OK</a>;
01958 }
01959 
01960 } <span class="comment">// namespace catalogAccess</span>
</pre></div><hr><address style="align: right;"><small>Generated on Mon Jun 20 15:18:15 2005 for catalogAccess by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
