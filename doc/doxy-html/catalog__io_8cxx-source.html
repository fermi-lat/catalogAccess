<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>catalog_io.cxx Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>catalog_io.cxx</h1><a href="catalog__io_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00014 <span class="preprocessor">#include "<a class="code" href="catalog_8h.html">catalog.h</a>"</span>
00015 
00016 <span class="keyword">namespace </span>catalogAccess {
00017   <span class="keyword">using</span> <span class="keyword">namespace </span>tip;
00018 <span class="comment">/**********************************************************************/</span>
00019 <span class="comment">/*  DEFINING CLASS CONSTANTS                                          */</span>
00020 <span class="comment">/**********************************************************************/</span>
00021 
00022 <span class="comment">// BEWARE: the two constant below are UCD1 standard</span>
00023 <span class="comment">//         need to be changed for UCD1+</span>
00024 
00025 <span class="comment">// the order is important and must be compatible with s_CatalogGeneric</span>
00026 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_List[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00027        <span class="stringliteral">"ID_MAIN"</span>, <span class="stringliteral">"POS_EQ_RA_MAIN"</span>, <span class="stringliteral">"POS_EQ_DEC_MAIN"</span>,
00028         <span class="stringliteral">""</span>,       <span class="stringliteral">"POS_GAL_LON"</span>,    <span class="stringliteral">"POS_GAL_LAT"</span>};
00029 <span class="comment">// "ERROR", "POS_GAL_LON", "POS_GAL_LAT"</span>
00030 <span class="comment">// ERROR do not only refer to the position error</span>
00031 <span class="comment">// ERROR is for any "Uncertainty in Measurements"</span>
00032 
00033 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *UCD_Added[<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>]={
00034        <span class="stringliteral">""</span>, <span class="stringliteral">"_RAJ2000"</span>, <span class="stringliteral">"_DEJ2000"</span>, <span class="stringliteral">""</span>, <span class="stringliteral">"_Glon"</span>, <span class="stringliteral">"_Glat"</span>};
00035 
00036 <span class="comment">// the 2 constants above are only defined in this file,</span>
00037 <span class="comment">// need to set catalog static members for global availability</span>
00038 
<a name="l00039"></a><a class="code" href="classcatalog_access_1_1_catalog.html#r3">00039</a> <span class="keyword">const</span> std::string Catalog::s_genericL = UCD_List[4];
<a name="l00040"></a><a class="code" href="classcatalog_access_1_1_catalog.html#r4">00040</a> <span class="keyword">const</span> std::string Catalog::s_genericB = UCD_List[5];
<a name="l00041"></a><a class="code" href="namespacecatalog_access.html#a2">00041</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[2]={<span class="stringliteral">"CDS-CAT"</span>,
00042                                <span class="stringliteral">"Catalogue designation in CDS nomenclature"</span>};
<a name="l00043"></a><a class="code" href="namespacecatalog_access.html#a3">00043</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[2]={<span class="stringliteral">"CDS-NAME"</span>, <span class="stringliteral">"Table used in a VizieR Query"</span>};
<a name="l00044"></a><a class="code" href="namespacecatalog_access.html#a4">00044</a> <span class="keyword">const</span> std::string <a class="code" href="namespacecatalog_access.html#a4">Key_UCD</a>=<span class="stringliteral">"TBUCD"</span>;
<a name="l00045"></a><a class="code" href="namespacecatalog_access.html#a5">00045</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="namespacecatalog_access.html#a5">SepNull</a> = <span class="charliteral">'!'</span>;
00046 
00047 <span class="comment">/**********************************************************************/</span>
00048 <span class="comment">/*  METHODS for IMPORTING, SAVING, LOADING                            */</span>
00049 <span class="comment">/**********************************************************************/</span>
00050 
00051 <span class="comment">// set m_posErrFactor, suppose that Quantity index exist (private method)</span>
<a name="l00052"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c10">00052</a> <span class="keywordtype">void</span> Catalog::setPosErrFactor(<span class="keyword">const</span> <span class="keywordtype">int</span> index) {
00053 
00054   std::string text=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_unit;
00055   <span class="keywordflow">if</span> ( text.empty() ) {
00056     std::ostringstream sortie;
00057     sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_name
00058            &lt;&lt; <span class="stringliteral">") has no unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>;
00059     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00060   }
00061   <span class="keywordflow">else</span> {
00062     <span class="comment">// use explicit cast to be sure compiler choose the right tolower()</span>
00063     transform(text.begin(), text.end(), text.begin(), (int(*)(int)) tolower);
00064     <span class="keywordflow">if</span> (text == <span class="stringliteral">"deg"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=1.0;
00065     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcsec"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=3600.0;
00066     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"arcmin"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=60.0;
00067     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text == <span class="stringliteral">"rad"</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>=1.0/Angle_Conv;
00068     <span class="keywordflow">else</span> {
00069       std::ostringstream sortie;
00070       sortie &lt;&lt; <span class="stringliteral">"Generic position error ("</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[index].m_name
00071              &lt;&lt; <span class="stringliteral">") has unknown unit, by default multiply by: 1/"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o9">m_posErrFactor</a>;
00072       <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(<span class="stringliteral">"private setGeneric"</span>, sortie.str());
00073     }
00074   }
00075 }
00076 <span class="comment">// search for generic quantities, private: suppose import done (private method)</span>
<a name="l00077"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c11">00077</a> <span class="keywordtype">void</span> Catalog::setGeneric(<span class="keyword">const</span> <span class="keywordtype">int</span> whichCat) {
00078 
00079   <span class="keyword">const</span> std::string epoch=<span class="stringliteral">"J2000"</span>;
00080   <span class="keywordtype">int</span> max=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00081   <span class="keywordtype">int</span> j;
00082   std::string text, name;
00083   <a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_indexErr</a>= -1;
00084   <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a> = -1;
00085   <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>= -1;
00086   std::vector&lt;Quantity&gt;::iterator itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin();
00087   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.end(); ++itQ, ++i) {
00088 
00089     <span class="keywordflow">if</span> ((whichCat &gt;= 0) &amp;&amp; (whichCat &lt; <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>)) {
00090       <span class="comment">// if it is a known catalog, the generic are defined</span>
00091       text=itQ-&gt;m_name;
00092       <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) {
00093         name=Catalog::s_CatalogGeneric[whichCat][j];
00094         <span class="keywordflow">if</span> (name == <span class="stringliteral">"+"</span>) name=UCD_Added[j];
00095         <span class="keywordflow">if</span> (text == name) {
00096           itQ-&gt;m_isGeneric=<span class="keyword">true</span>;
00097           <span class="keywordflow">switch</span> (j) {
00098             <span class="keywordflow">case</span> 1: <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a>=i;
00099             <span class="keywordflow">break</span>;
00100             <span class="keywordflow">case</span> 2: <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>=i;
00101             <span class="keywordflow">break</span>;
00102             <span class="keywordflow">case</span> 3: <a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_indexErr</a>=i;
00103                     <a class="code" href="classcatalog_access_1_1_catalog.html#c10">setPosErrFactor</a>(i);
00104             <span class="keywordflow">break</span>;
00105             <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
00106           }
00107         }
00108       }<span class="comment">// loop on generic</span>
00109       text=itQ-&gt;m_ucd;
00110     }
00111 
00112     <span class="keywordflow">else</span> {
00113       <span class="comment">// otherwise, take first matching UCD</span>
00114       text=itQ-&gt;m_ucd;
00115       <span class="keywordflow">if</span> (text != <span class="stringliteral">""</span>) <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="catalog_8h.html#a1">MAX_GEN</a>; j++) { 
00116         <span class="keywordflow">if</span> (text == UCD_List[j]) {
00117           itQ-&gt;m_isGeneric=<span class="keyword">true</span>;
00118           <span class="keywordflow">if</span> ((j == 1) || (j == 2)) {
00119             <span class="comment">// check that epoch is J2000</span>
00120             name=itQ-&gt;m_name;
00121             name.erase(0, name.length()-epoch.length());
00122             <span class="comment">// format contains at least 1 char</span>
00123             <span class="keywordflow">if</span> ((name == epoch) &amp;&amp; (itQ-&gt;m_type == Quantity::NUM)) {
00124               <span class="keywordflow">if</span> (j == 1) <a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a>=i;
00125               <span class="keywordflow">else</span>        <a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>=i;
00126             }
00127             <span class="keywordflow">else</span> itQ-&gt;m_isGeneric=<span class="keyword">false</span>;
00128           }
00129           <span class="keywordflow">break</span>;
00130         }
00131       }<span class="comment">// loop on generic</span>
00132     }
00133 
00134     <span class="comment">// flag error quantities, useless for already found generic</span>
00135     <span class="keywordflow">if</span> ((text == <span class="stringliteral">"ERROR"</span>) &amp;&amp; (!itQ-&gt;m_isGeneric)) {
00136       <span class="comment">// error column name is e_"associated column" except for position error</span>
00137       text=itQ-&gt;m_name;
00138       <span class="keywordflow">if</span> (text.find(<span class="stringliteral">"e_"</span>) == 0) {
00139         text.erase(0, 2);
00140 <span class="preprocessor">        #ifdef DEBUG_CAT</span>
00141 <span class="preprocessor"></span>        std::cout &lt;&lt; <span class="stringliteral">"ERROR column ("</span> &lt;&lt; text &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; std::endl;
00142 <span class="preprocessor">        #endif</span>
00143 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (j=0; j&lt;max; j++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.at(j).m_name == text) {
00144           itQ-&gt;m_statError=text;
00145           <span class="keywordflow">break</span>;
00146         }
00147       }
00148       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((text == <span class="stringliteral">"PosErr"</span>) || (text == <span class="stringliteral">"ErrorRad"</span>)) {
00149         itQ-&gt;m_isGeneric=<span class="keyword">true</span>;
00150         <a class="code" href="classcatalog_access_1_1_catalog.html#o26">m_indexErr</a>=i;
00151         <a class="code" href="classcatalog_access_1_1_catalog.html#c10">setPosErrFactor</a>(i);
00152       }
00153     }
00154 
00155   }<span class="comment">// loop on quantities</span>
00156 
00157   <span class="comment">/* since RA, DEC columns can be erased while importSelected() */</span>
00158   <span class="comment">/* must update the existence of elliptical region */</span>
00159   <span class="keywordflow">if</span> ((<a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a> &lt; 0) || (<a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a> &lt; 0)) <a class="code" href="classcatalog_access_1_1_catalog.html#o19">m_selRegion</a>=<span class="keyword">false</span>;
00160 }
00161 
00162 <span class="comment">/**********************************************************************/</span>
00163 <span class="comment">// return the number of RAM bytes needed for numRows catalog rows</span>
<a name="l00164"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a5">00164</a> <span class="keywordtype">long</span> Catalog::getRAMsize(<span class="keyword">const</span> <span class="keywordtype">long</span> numRows, <span class="keyword">const</span> <span class="keywordtype">bool</span> writeLog) {
00165 
00166   std::string mot, text;
00167   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00168   <span class="keywordflow">if</span> (quantSize == 0) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a16">IMPORT_NEED</a>;
00169 
00170   <span class="keywordtype">int</span> nD=0, nS=0, nchar=0;
00171   <span class="keywordtype">int</span> i, j;
00172   std::vector&lt;Quantity&gt;::iterator itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin();
00173   <span class="keywordflow">for</span> (; itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.end(); ++itQ) {
00174     <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::NUM) nD++;
00175     <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (itQ-&gt;m_type == Quantity::STRING) {
00176       nS++;
00177       text=itQ-&gt;m_format;
00178       i=text.length();
00179       <span class="keywordflow">if</span> (i &gt; 1) {
00180         <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a> == <span class="stringliteral">"CDS"</span>) text.erase(0, 1);
00181         <span class="keywordflow">else</span> text.erase(i-1);
00182         j=std::atoi(text.c_str());
00183         <span class="keywordflow">if</span> (j &gt; 0) nchar+=j;
00184       }
00185     }
00186   }
00187   <span class="keywordtype">char</span> buffer[50];
00188   <span class="keywordtype">long</span> sizeD=nD*<span class="keyword">sizeof</span>(double)*numRows;
00189   <span class="keywordtype">long</span> sizeS=nchar*<span class="keyword">sizeof</span>(char)*numRows;
00190   i=1+(quantSize+1)/(<span class="keyword">sizeof</span>(long)*8);
00191   <span class="keywordtype">long</span> sizeB=i*<span class="keyword">sizeof</span>(long)*numRows;
00192   <span class="keywordflow">if</span> (writeLog &amp;&amp; (<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> &gt; 0)) {
00193     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>);
00194     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00195     text=<span class="stringliteral">"Original whole catalog number of rows = "</span>+mot;
00196     <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, text);
00197   }
00198   <span class="keywordflow">if</span> (numRows &lt;= 0) <span class="keywordflow">return</span> 0;
00199   <span class="keywordflow">if</span> (writeLog) {
00200     sprintf(buffer, <span class="stringliteral">"%6ld"</span>, numRows);
00201     mot=buffer; <span class="comment">/* convert C string to C++ string */</span>
00202     text=<span class="stringliteral">"Needed RAM space (MB) for "</span>+mot;
00203     sprintf(buffer, <span class="stringliteral">"%5.1f"</span>, (sizeD+sizeS+sizeB)/(1024.*1024.));
00204     mot=buffer;
00205     text=text+<span class="stringliteral">" data rows = "</span>+mot+<span class="stringliteral">"\n"</span>;
00206     sprintf(buffer, <span class="stringliteral">"%5.0f kB for numericals (%3d double per row)"</span>,
00207                    sizeD/1024., nD);
00208     mot=buffer;
00209     text=text+mot+<span class="stringliteral">"\n"</span>;
00210     sprintf(buffer, <span class="stringliteral">"%5.0f kB for %2d strings (%3d char per row)"</span>,
00211                    sizeS/1024., nS, nchar);
00212     mot=buffer;
00213     text=text+mot+<span class="stringliteral">"\n"</span>;
00214     sprintf(buffer, <span class="stringliteral">"%5.0f kB for select bits (%2d long per row)"</span>,
00215                    sizeB/1024., i);
00216     mot=buffer;
00217     text=text+mot;
00218     <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, text);
00219   }
00220   <span class="keywordflow">return</span> (sizeD+sizeS+sizeB);
00221 }
00222 
00223 
00224 <span class="comment">/**********************************************************************/</span>
00225 <span class="comment">// creates a new column in m_strings, m_numericals (private method)</span>
<a name="l00226"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c12">00226</a> <span class="keywordtype">void</span> Catalog::create_tables(<span class="keyword">const</span> <span class="keywordtype">int</span> nbQuantAscii, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRows) {
00227 
00228   <span class="keywordtype">int</span> vecSize;
00229   std::string errText;
00230   <span class="keywordflow">if</span> (nbQuantAscii &gt; 0) {
00231     <span class="keywordflow">try</span> {
00232       <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.resize(nbQuantAscii);
00233     }
00234     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00235       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00236       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00237       <span class="keywordflow">throw</span>;
00238     }
00239   }
00240   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00241 <span class="comment">// printf("sizes = %d , %d\n", nbQuantAscii, vecSize);</span>
00242   <span class="keywordflow">if</span> (vecSize &gt; 0) {
00243     <span class="keywordflow">try</span> {
00244       <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.resize(vecSize);
00245     }
00246     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00247       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00248       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"private create_tables"</span>, errText);
00249       <span class="keywordflow">throw</span>;
00250     }
00251   }
00252   <span class="keywordflow">if</span> (maxRows &gt; 0) <a class="code" href="classcatalog_access_1_1_catalog.html#c13">add_rows</a>(maxRows);
00253 
00254 }
00255 <span class="comment">/**********************************************************************/</span>
00256 <span class="comment">// creates a new row in m_strings, m_numericals (private method)</span>
<a name="l00257"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c13">00257</a> <span class="keywordtype">void</span> Catalog::add_rows(<span class="keyword">const</span> <span class="keywordtype">long</span> maxRows) {
00258 
00259   <span class="keywordtype">int</span> i, vecSize;
00260   std::string errText;
00261 <span class="comment">// printf("!! %ld / %ld \n", m_numRows, maxRows);</span>
00262   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();
00263   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00264     <span class="keywordflow">try</span> {
00265       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) {
00266         <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(maxRows);
00267 <span class="comment">//        for (j=0; j&lt;maxRows; j++) m_strings[i].at(j).resize(20);</span>
00268       }
00269     }
00270     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00271       errText=std::string(<span class="stringliteral">"EXCEPTION on m_strings: "</span>)+err.what();
00272       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00273       <span class="keywordflow">throw</span>;
00274     }
00275   }
00276   vecSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
00277   <span class="keywordflow">if</span> (vecSize &gt; 0 ) {
00278     <span class="keywordflow">try</span> {
00279       <span class="keywordflow">for</span> (i=0; i&lt;vecSize; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(maxRows);
00280     }
00281     <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;err) {
00282       errText=std::string(<span class="stringliteral">"EXCEPTION on m_numericals: "</span>)+err.what();
00283       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"private add_rows"</span>, errText);
00284       <span class="keywordflow">throw</span>;
00285     }
00286   } 
00287 
00288 }
00289 
00290 
00291 <span class="comment">/**********************************************************************/</span>
00292 <span class="comment">// read the catalog from fits file (only description if getDescr is true)</span>
<a name="l00293"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c15">00293</a> <span class="keywordtype">int</span> Catalog::analyze_fits(<span class="keyword">const</span> Table *myDOL, <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr,
00294                           <span class="keyword">const</span> std::string origin, <span class="keywordtype">long</span> *maxRows) {
00295   std::string text, mot;
00296   <span class="keywordtype">int</span>  i, j, max,
00297        nbQuantAscii=0;
00298   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
00299   <span class="keywordtype">bool</span> binary=<span class="keyword">true</span>;
00300   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
00301   int (*pfunc)(int)=toupper; <span class="comment">// function used by transform</span>
00302   <span class="keyword">const</span> Header &amp;header=myDOL-&gt;getHeader();
00303 
00304   <span class="keywordflow">try</span> {
00305     text=myDOL-&gt;getName();
00306     header.getKeyword(<span class="stringliteral">"XTENSION"</span>, mot);
00307   <span class="comment">/* text.rfind('_');</span>
00308 <span class="comment">    since '/' are replaced by '_' in EXTNAME</span>
00309 <span class="comment">    and  is ambiguous with '_' in catalog name:</span>
00310 <span class="comment">    must search for keywords CDS-CAT  CDS-NAME</span>
00311 <span class="comment">  */</span>
00312   }
00313   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00314     text=<span class="stringliteral">": fits EXTENSION, cannot get name"</span>;
00315     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00316     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00317   }
00318   std::ostringstream sortie;
00319   sortie &lt;&lt; <span class="stringliteral">"fits extension "</span> &lt;&lt; mot &lt;&lt; <span class="stringliteral">" name = "</span> &lt;&lt; text;
00320   <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, sortie.str());
00321   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00322 
00323   <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=<span class="stringliteral">""</span>;   <a class="code" href="classcatalog_access_1_1_catalog.html#o3">m_catRef</a>=<span class="stringliteral">""</span>;
00324   <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=<span class="stringliteral">""</span>; <a class="code" href="classcatalog_access_1_1_catalog.html#o5">m_tableRef</a>=<span class="stringliteral">""</span>;
00325   <a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a>=<span class="stringliteral">""</span>;
00326   <span class="keywordflow">if</span> (mot == <span class="stringliteral">"TABLE"</span>) {
00327     binary=<span class="keyword">false</span>;
00328     <a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a>=<span class="stringliteral">"CDS"</span>; <span class="comment">/* to know that format string need to be changed for fits */</span>
00329   }
00330   <span class="keywordflow">try</span> {
00331     header.getKeyword(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0], text);
00332     <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>=text;
00333     header.getKeyword(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0], mot);
00334     <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>=mot;
00335 
00336   }
00337   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00338     <span class="keywordflow">if</span> (binary) {
00339       <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, <span class="stringliteral">"fits EXTENSION, cannot get CDS header keys"</span>);
00340     }
00341     <span class="keywordflow">else</span> {
00342       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get CDS header keys"</span>);
00343       <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00344     }
00345   }
00346   <span class="keywordflow">try</span> {
00347     text=header.getKeyComment(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0]);
00348     mot =header.getKeyComment(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0]);
00349     <span class="comment">// have to use long comment</span>
00350   }
00351   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00352     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, <span class="stringliteral">"fits EXTENSION, cannot get CDS header comments"</span>);
00353   }
00354 <span class="comment">//  const Table::FieldCont &amp;allCol=myDOL-&gt;getValidFields();</span>
00355   <span class="keywordflow">try</span> {
00356     max=myDOL-&gt;getValidFields().size();
00357     <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=myDOL-&gt;getNumRecords();
00358   }
00359   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00360     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get number of rows or columns"</span>);
00361     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00362   }
00363   <span class="keywordflow">if</span> (max &lt; 1) {
00364     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, need at least 1 column"</span>);
00365     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00366   }
00367   text=<span class="stringliteral">""</span>;
00368   std::vector&lt;double&gt; colNull(max, 0.0);
00369   <span class="keywordflow">try</span> {
00370     <span class="keyword">const</span> IColumn *myCol = 0;
00371     <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00372       text=<span class="stringliteral">""</span>;
00373       myCol=myDOL-&gt;getColumn(i);
00374       <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
00375       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>=myCol-&gt;getId();
00376       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_unit</a>=myCol-&gt;getUnits();
00377       sprintf(name, <span class="stringliteral">"TFORM%d"</span>, i+1);
00378       mot=name; <span class="comment">/* convert C string to C++ string */</span>
00379       header.getKeyword(mot, text);
00380       transform(text.begin(), text.end(), text.begin(), pfunc);
00381       j=text.length();
00382       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>=text;
00383       text=<span class="stringliteral">""</span>;
00384       <span class="keywordflow">if</span> (binary) {
00385         <span class="keywordflow">if</span> ( !myCol-&gt;isScalar() ) {
00386           text=<span class="stringliteral">"unauthorized FITS TABLE vector"</span>;
00387           sortie &lt;&lt; <span class="stringliteral">": VECTOR not supported, column#"</span> &lt;&lt; i+1;
00388           <span class="keywordflow">throw</span> std::runtime_error(text);
00389         }
00390         <span class="keywordflow">if</span> (j == 0) {
00391           text=<span class="stringliteral">"unauthorized FITS empty format "</span>;
00392           sortie &lt;&lt; <span class="stringliteral">": FITS format is empty, column#"</span> &lt;&lt; i+1;
00393           <span class="keywordflow">throw</span> std::runtime_error(text);
00394         }
00395         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[j-1] == <span class="charliteral">'A'</span>) readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a>=Quantity::STRING;
00396         <span class="keywordflow">else</span> readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a>=Quantity::NUM;
00397         sprintf(name, <span class="stringliteral">"TNULL%d"</span>, i+1); mot=name;
00398         <span class="keywordflow">try</span> { header.getKeyword(mot, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>); }
00399         <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00400         colNull.at(i)=atof(readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>.c_str());
00401         <span class="keywordflow">if</span> ( !readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>.empty() ) {
00402           sprintf(name, <span class="stringliteral">"TSCAL%d"</span>, i+1); mot=name;
00403           <span class="keywordflow">try</span> { header.getKeyword(mot, text); }
00404           <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00405           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>+=<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>+text;
00406           <span class="keywordflow">if</span> ( !text.empty() ) colNull.at(i)*=atof(text.c_str());
00407           text=<span class="stringliteral">""</span>;
00408           sprintf(name, <span class="stringliteral">"TZERO%d"</span>, i+1); mot=name;
00409           <span class="keywordflow">try</span> { header.getKeyword(mot, text); }
00410           <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00411           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>+=<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>+text;
00412           <span class="keywordflow">if</span> ( !text.empty() ) colNull.at(i)+=atof(text.c_str());
00413           text=<span class="stringliteral">""</span>;
00414         }
00415 <span class="comment">// printf("'%s'\n",  readQ.m_null.c_str() );</span>
00416         sprintf(name, <span class="stringliteral">"%s%d"</span>, <a class="code" href="namespacecatalog_access.html#a4">Key_UCD</a>.c_str(), i+1); mot=name;
00417         <span class="keywordflow">try</span> {
00418           readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m1">m_comment</a>=header.getKeyComment(mot);
00419           header.getKeyword(mot, text);
00420         }
00421         <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00422           sortie &lt;&lt; <span class="stringliteral">"missing keyword "</span> &lt;&lt; mot &lt;&lt; <span class="stringliteral">" for column#"</span> &lt;&lt; i+1;
00423           <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, sortie.str() );
00424           sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00425         }
00426       }
00427       <span class="keywordflow">else</span> {
00428         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[0] == <span class="charliteral">'A'</span>) readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a>=Quantity::STRING;
00429         <span class="keywordflow">else</span> readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a>=Quantity::NUM;
00430         sprintf(name, <span class="stringliteral">"TBCOL%d"</span>, i+1); mot=name;
00431         text=header.getKeyComment(mot);
00432         j=4;
00433         <span class="keywordflow">if</span> (text.substr(0,j) == <span class="stringliteral">"UCD="</span>) text.erase(0,j);
00434         pos=text.find(<span class="charliteral">'.'</span>);
00435         <span class="keywordflow">if</span> (pos != std::string::npos) text.erase(pos);
00436         <span class="comment">/* ONLY  readQ.m_comment  IS NOT SET */</span>
00437       }
00438       transform(text.begin(), text.end(), text.begin(), pfunc);
00439       readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m2">m_ucd</a>=text;
00440       <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a> == Quantity::STRING) {
00441         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m7">m_index</a>=nbQuantAscii;
00442         nbQuantAscii++;
00443       }
00444       <span class="keywordflow">else</span> <span class="keywordflow">if</span>  (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a> == Quantity::NUM) {
00445         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m7">m_index</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()-nbQuantAscii;
00446         readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a>=Quantity::NUM;
00447       }
00448       <span class="keywordflow">try</span> { <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.push_back(readQ); }
00449       <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00450         text=std::string(<span class="stringliteral">"EXCEPTION filling m_quantities: "</span>)+prob.what();
00451         sortie &lt;&lt; text;
00452         <span class="keywordflow">throw</span>;
00453       }
00454     }<span class="comment">/* loop on columns */</span>
00455   }
00456   <span class="keywordflow">catch</span> (...) {
00457     <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.clear();
00458     j=<a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00459     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=j;
00460     <span class="keywordflow">if</span> ( text.empty() ) {
00461       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, error reading TABLE column#"</span>;
00462       sortie &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">" description"</span>;
00463       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00464     }
00465     <span class="keywordflow">else</span> {
00466       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00467       <span class="comment">// exception sent only for vector allocation</span>
00468       <span class="keywordflow">if</span> (text == sortie.str() ) <span class="keywordflow">throw</span>;
00469     }
00470     <span class="keywordflow">return</span> j;
00471   }
00472 <span class="comment">// printf("numRows=%ld\n", m_numOriRows );</span>
00473   <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=0;
00474   <span class="keywordflow">if</span> ( !*maxRows ) *maxRows=<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>;
00475   <span class="keywordflow">if</span> ((getDescr) || (<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> == 0)) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00476 
00477   <a class="code" href="classcatalog_access_1_1_catalog.html#c12">create_tables</a>(nbQuantAscii, *maxRows);
00478   <span class="keywordflow">try</span> {
00479     <span class="keywordtype">double</span> rowVal;
00480     std::vector&lt;Quantity&gt;::iterator itQ;
00481     <span class="comment">// Loop over all records (rows) and extract values</span>
00482     <span class="keywordflow">for</span> (Table::ConstIterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end();
00483          ++itor) {
00484       i=0;
00485       <span class="keywordflow">for</span> (itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin(); itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.end(); ++itQ, ++i) {
00486         j=itQ-&gt;m_index;
00487         <span class="comment">// double variable to hold the value of all the numeric fields</span>
00488         <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::NUM) {
00489           rowVal=(*itor)[itQ-&gt;m_name].get();
00490           <span class="keywordflow">if</span> ( itQ-&gt;m_null.empty() ) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=rowVal;
00491           <span class="keywordflow">else</span> {
00492             <span class="keywordflow">if</span> (rowVal == colNull.at(i)) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=MissNAN;
00493             <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=rowVal;
00494           }
00495         }
00496         <span class="keywordflow">else</span> (*itor)[itQ-&gt;m_name].get(<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[j].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>) );
00497       }
00498       <span class="keywordflow">if</span> (++<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> == *maxRows) <span class="keywordflow">break</span>;
00499     }<span class="comment">/* loop on rows*/</span>
00500   }
00501   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00502     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot read after row#"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>+1;
00503     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00504     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a24">BAD_ROW</a>;
00505   }
00506   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00507 }
00508 <span class="comment">/**********************************************************************/</span>
00509 <span class="comment">/* PRIVATE METHODS analyze_head, analyze_body in file "catalog_ioText.cxx" */</span>
00510 <span class="comment">/**********************************************************************/</span>
00511 <span class="comment">// common code between import and importDescription (private method)</span>
<a name="l00512"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c18">00512</a> <span class="keywordtype">int</span> Catalog::load(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string ext,
00513                   <span class="keyword">const</span> <span class="keywordtype">bool</span> getDescr, <span class="keywordtype">long</span> *maxRows) {
00514 
00515   <span class="keywordtype">int</span> i, err=<a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00516   std::string origin, text;
00517   <span class="keywordflow">if</span> (getDescr) origin=<span class="stringliteral">"importDescription"</span>; <span class="keywordflow">else</span> origin=<span class="stringliteral">"import"</span>;
00518 
00519   <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=0;
00520   i=fileName.length();
00521   <span class="keywordflow">if</span> (i == 0) {
00522     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
00523     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00524     err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
00525     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00526     <span class="keywordflow">return</span> err;
00527   }
00528   std::fstream myFile (fileName.c_str(), std::ios::in);
00529   <span class="comment">// file can be opened ?</span>
00530   <span class="keywordflow">if</span> ( !myFile.is_open() ) {
00531     text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" cannot be opened"</span>;
00532     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00533     err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
00534     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00535     <span class="keywordflow">return</span> err;
00536   }
00537 <span class="comment">/*  DIR *testDir=opendir(fileName.c_str());</span>
00538 <span class="comment">  if (testDir != NULL) {</span>
00539 <span class="comment">    closedir(testDir);</span>
00540 <span class="comment">    text=": FILENAME \""+fileName+"\" is a directory";</span>
00541 <span class="comment">    printErr(origin, text);</span>
00542 <span class="comment">    err=BAD_FILETYPE;</span>
00543 <span class="comment">    m_numRows=err;</span>
00544 <span class="comment">    return err;</span>
00545 <span class="comment">  }*/</span>
00546   myFile.close();
00547   std::ostringstream sortie;
00548   <span class="keywordtype">bool</span>  myTest;
00549   <span class="keyword">const</span> Extension *myEXT = 0;
00550   <span class="comment">// cannot use readTable because FITS IMAGE returns also error 1</span>
00551   <span class="keywordflow">try</span> {
00552     myEXT=IFileSvc::instance().readExtension(fileName, ext);
00553   }
00554   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00555     err=x.code();
00556     <span class="keywordflow">if</span> (err == 1) {
00557       <span class="comment">// This non-cfitsio error number means the file does not exist</span>
00558       <span class="comment">// or is not a table, or is not either Root nor Fits format. </span>
00559       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00560 <span class="comment">/*      printWarn(origin, "FILENAME is NOT fits");*/</span>
00561     }
00562     <span class="keywordflow">else</span> {
00563       <span class="comment">// Other errors come from cfitsio, but apply to a file</span>
00564       <span class="comment">// which is in FITS format but has some sort of format error.</span>
00565       sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but cfitsio returned error="</span> &lt;&lt; err;
00566       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00567       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00568       <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00569       <span class="keyword">delete</span> myEXT;
00570       <span class="keywordflow">return</span> err;
00571     }
00572   }
00573   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) myTest=myEXT-&gt;isTable();
00574   <span class="keyword">delete</span> myEXT;
00575   <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) {
00576  
00577     <span class="keywordflow">if</span> (!myTest) {
00578       text=<span class="stringliteral">": FILENAME is FITS, but NOT a TABLE"</span>;
00579       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00580       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00581       <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00582       <span class="keywordflow">return</span> err;
00583     }
00584     <span class="keyword">const</span> Table *myDOL = 0;
00585     <span class="keywordflow">try</span> {
00586       myDOL=IFileSvc::instance().readTable(fileName, ext);
00587     }
00588     <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00589       sortie &lt;&lt; <span class="stringliteral">": FITS is TABLE, but cfitsio returned error="</span> &lt;&lt; x.code();
00590       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00591       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00592       <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00593       <span class="keyword">delete</span> myDOL;
00594       <span class="keywordflow">return</span> err;
00595     }
00596     <span class="keyword">const</span> <span class="keywordtype">char</span> lf = 0x0A;
00597     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>=fileName+lf+ext;
00598     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c15">analyze_fits</a>(myDOL, getDescr, origin, maxRows);
00599     <span class="keyword">delete</span> myDOL;
00600 
00601   }
00602   <span class="keywordflow">else</span> { <span class="comment">// (err == BAD_FITS)</span>
00603 
00604     err=<a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00605     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of lines read</span>
00606     <span class="keywordtype">bool</span> testCR=<span class="keyword">false</span>; <span class="comment">// true if lines ends with CR (on windows)</span>
00607     <span class="keywordtype">int</span> what=0;        <span class="comment">// 0 for unkwown, &gt;0 for csv, &lt;0 to tsv</span>
00608                        <span class="comment">// fabs()=1 for standard, =2 for meta QUERY</span>
00609 
00610     myFile.open(fileName.c_str(), std::ios::in);
00611     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c16">analyze_head</a>(&amp;tot, &amp;what, &amp;testCR, &amp;myFile);
00612     <span class="keywordflow">if</span> (!tot) {
00613       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is fits without extension[] "</span>
00614              &lt;&lt; <span class="stringliteral">"specified"</span>;
00615       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00616       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00617       text=<span class="stringliteral">"input file"</span>;
00618       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
00619       <span class="comment">// in case, for strange reason, file.good() fails at first time</span>
00620     }
00621     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) {
00622       sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">"\" is empty or "</span>
00623              &lt;&lt; <span class="stringliteral">"has unknown structure (stopped step "</span> &lt;&lt; -1*err &lt;&lt; <span class="stringliteral">")"</span>;
00624       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00625       sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00626       text=<span class="stringliteral">"input file"</span>;
00627       <span class="keywordflow">if</span> (err == 0) err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>; <span class="comment">/* nothing is read */</span>
00628       <span class="keywordflow">else</span> err=<a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>; <span class="comment">/* can search if catalog name exist */</span>
00629     }
00630     <span class="keywordflow">else</span> {
00631 
00632       <span class="comment">//what is 1 or 2, then negate if TSV type</span>
00633       <span class="keywordflow">if</span> (what == 1) text=<span class="stringliteral">"input text file"</span>;
00634       <span class="keywordflow">else</span> text=<span class="stringliteral">"input META file"</span>;
00635 
00636       <span class="comment">// get columns description and units, data</span>
00637       err=<a class="code" href="classcatalog_access_1_1_catalog.html#c17">analyze_body</a>(&amp;tot, &amp;what, testCR, getDescr, &amp;myFile, maxRows);
00638       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a21">BAD_FILELINE</a>) {
00639         <span class="comment">// stopped before reading needed stuff (with getDescr false)</span>
00640         text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" couldn't be read (line too long)"</span>;
00641         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00642       }
00643       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) {
00644         sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName
00645              &lt;&lt; <span class="stringliteral">"\" has wrong type (stopped step "</span> &lt;&lt; 5-1*err &lt;&lt; <span class="stringliteral">")"</span>;
00646         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00647         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00648         err=<a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00649       }
00650       <span class="keywordflow">else</span> {
00651         <span class="keywordflow">if</span> (what &gt; 0) sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is CSV type (; separator)"</span>;
00652         <span class="keywordflow">else</span> sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">" is TSV type (Tab=0x09 separator)"</span>;
00653         <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, sortie.str());
00654         sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string.</span>
00655       }
00656 
00657     }
00658     myFile.close();
00659     sortie &lt;&lt; text &lt;&lt; <span class="stringliteral">": "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" lines read"</span>;
00660     <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(0, sortie.str());
00661     <a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>=fileName;
00662     <a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a>=<span class="stringliteral">"CDS"</span>; <span class="comment">/* to know that format string need to be changed for fits */</span>
00663 
00664   }<span class="comment">// file is read</span>
00665   <span class="keywordflow">if</span> (err &lt; 0) {
00666     <a class="code" href="classcatalog_access_1_1_catalog.html#a23">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
00667     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
00668     <span class="comment">// exit only if nothing is read</span>
00669     <span class="keywordflow">if</span> ((err == <a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>) || (err == <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>)) <span class="keywordflow">return</span> err;
00670   }
00671   <span class="comment">// m_quantities vector maybe filled, MUST fill m_selEllipse, m_loadQuantity</span>
00672   <span class="keywordflow">try</span> {
00673     <a class="code" href="classcatalog_access_1_1_catalog.html#o29">m_selEllipse</a>.assign(7, 0.0);
00674     <a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size(), <span class="keyword">true</span>);
00675   }
00676   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00677     text=std::string(<span class="stringliteral">"EXCEPTION on creating m_selEllipse, m_loadQuantity: "</span>)
00678         +prob.what();
00679     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
00680     <span class="keywordflow">throw</span>;
00681   }
00682   <span class="comment">// check if tableName is known to set generic</span>
00683   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="catalog_8h.html#a0">MAX_CAT</a>; i++) {
00684     <span class="keywordflow">if</span> (Catalog::s_CatalogList[2*i+1] == <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>) <span class="keywordflow">break</span>;
00685   }
00686   <span class="keywordflow">if</span> (i == <a class="code" href="catalog_8h.html#a0">MAX_CAT</a>) {
00687     text=<span class="stringliteral">"Unknown table name, all generic quantities may be not found"</span>;
00688     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, text);
00689   }
00690   <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o0">m_code</a>=Catalog::s_CatalogList[2*i];
00691   <a class="code" href="classcatalog_access_1_1_catalog.html#c11">setGeneric</a>(i);
00692   <span class="keywordflow">return</span> err;
00693 }
00694 <span class="comment">/**********************************************************************/</span>
00695 <span class="comment">// read only the catalog description from file</span>
<a name="l00696"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a6">00696</a> <span class="keywordtype">int</span> Catalog::importDescription(<span class="keyword">const</span> std::string &amp;fileName,
00697                                <span class="keyword">const</span> std::string ext) {
00698   <span class="keywordtype">int</span> err;
00699   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c24">checkImport</a>(<span class="stringliteral">"importDescription"</span>, <span class="keyword">false</span>);
00700   <span class="comment">// must be called before load() which set m_numRows to 0</span>
00701   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
00702 
00703   <span class="keywordtype">long</span> maxRows=0l;
00704   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c18">load</a>(fileName, ext, <span class="keyword">true</span>, &amp;maxRows);
00705   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) <span class="keywordflow">return</span> err;
00706 
00707   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
00708 }
00709 <span class="comment">/**********************************************************************/</span>
00710 <span class="comment">// read from file an entire catalog without selection</span>
<a name="l00711"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a8">00711</a> <span class="keywordtype">int</span> Catalog::import(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> <span class="keywordtype">long</span> maxRows,
00712                     <span class="keyword">const</span> std::string ext) {
00713   <span class="keywordtype">int</span> err;
00714   <span class="keywordtype">long</span> maxR=maxRows;
00715   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c24">checkImport</a>(<span class="stringliteral">"import"</span>, <span class="keyword">false</span>);
00716   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
00717 
00718   <span class="keywordflow">if</span> (maxR &lt;= 0) {
00719     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(<span class="stringliteral">"import"</span>, <span class="stringliteral">"trying to get whole catalog file"</span>);
00720     maxR=0;
00721   }
00722 
00723   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c18">load</a>(fileName, ext, <span class="keyword">false</span>, &amp;maxR);
00724   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) <span class="keywordflow">return</span> err;
00725   <a class="code" href="classcatalog_access_1_1_catalog.html#a5">getRAMsize</a>(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>, <span class="keyword">true</span>);
00726   <span class="keywordflow">try</span> {
00727     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> &lt; maxR) {
00728       <span class="keywordtype">int</span> i;
00729       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();
00730       <span class="comment">// erase unused memory  printf("ERASING\n");</span>
00731       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
00732       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
00733       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
00734     }
00735     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()+2;
00736     <span class="comment">// number of required bits including global and region</span>
00737     err=1+(err-1)/(<span class="keyword">sizeof</span>(long)*8);
00738     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>.resize(err);
00739 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
00740 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
00741               &lt;&lt; err &lt;&lt; std::endl;
00742 <span class="preprocessor">    #endif</span>
00743 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_numRows)
00744       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>, 0);
00745     <span class="comment">// above lines can be commented to test the try catch mechanism</span>
00746   }
00747   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
00748     std::string text;
00749     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
00750     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"import"</span>, text);
00751     <span class="keywordflow">throw</span>;
00752   }
00753   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>;
00754 }
00755 
00756 
00757 <span class="comment">/**********************************************************************/</span>
<a name="l00758"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c20">00758</a> <span class="keywordtype">int</span> Catalog::loadSelectFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string ext,
00759                             <span class="keywordtype">long</span> *maxRows, std::string &amp;filter)
00760 {
00761   <span class="keyword">const</span> std::string  origin=<span class="stringliteral">"importSelected"</span>;
00762   std::ostringstream sortie;
00763   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>       i, max;
00764   <span class="keyword">const</span> Table *myDOL = 0;
00765 
00766   <span class="comment">/* create the selection string */</span>
00767   <span class="keywordtype">char</span> value[20];
00768   <span class="keywordtype">bool</span> test, probCase=<span class="keyword">false</span>;
00769   std::vector&lt;bool&gt; isSelected;
00770   <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#c2">existCriteria</a>(&amp;isSelected) &amp;&amp; (<a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a> != <span class="stringliteral">"CDS"</span>)) {
00771     <span class="keywordflow">if</span> (m_selRegion) {
00772       <span class="comment">/* !! cannot concatenate Cstring and char !! */</span>
00773       filter+=<span class="charliteral">'('</span>+<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>].m_name+<span class="stringliteral">" &gt;= "</span>;
00774       sprintf(value, <span class="stringliteral">"%9.5f"</span>, <a class="code" href="classcatalog_access_1_1_catalog.html#o21">m_selEllipseCentDEC_deg</a>-<a class="code" href="classcatalog_access_1_1_catalog.html#o23">m_selEllipseMajAxis_deg</a>);
00775       filter+=value;
00776       filter+=<span class="stringliteral">" &amp;&amp; "</span>+<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>].m_name+<span class="stringliteral">" &lt;= "</span>;
00777       sprintf(value, <span class="stringliteral">"%9.5f"</span>, <a class="code" href="classcatalog_access_1_1_catalog.html#o21">m_selEllipseCentDEC_deg</a>+<a class="code" href="classcatalog_access_1_1_catalog.html#o23">m_selEllipseMajAxis_deg</a>);
00778       filter+=value;
00779       <span class="comment">/* AND has higher priority than OR, needn't parenthesis (isnull...)*/</span>
00780       <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a>].m_rejectNaN )
00781         filter+=<span class="stringliteral">" || isnull("</span>+<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a>].m_name+<span class="charliteral">')'</span>;
00782       <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>].m_rejectNaN )
00783         filter+=<span class="stringliteral">" || isnull("</span>+<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>].m_name+<span class="charliteral">')'</span>;
00784       filter+=<span class="charliteral">')'</span>;
00785     }
00786     max=isSelected.size();
00787     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j, nbV;
00788     <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
00789     <span class="keywordtype">double</span>   rVal;
00790     <span class="comment">// first boolean is for elliptical region (m_selRegion)</span>
00791     <span class="keywordflow">for</span> (i=1; i&lt;max; i++) <span class="keywordflow">if</span> ( isSelected[i] ) {
00792       <span class="keywordflow">if</span> ( !filter.empty() ) {
00793         <span class="keywordflow">if</span> (m_criteriaORed) filter+=<span class="stringliteral">" || "</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" &amp;&amp; "</span>;
00794       }
00795       filter+=<span class="charliteral">'('</span>;
00796       readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i-1];
00797       <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a> == Quantity::STRING) {
00798         nbV=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m12">m_listValS</a>.size(); <span class="comment">/* nbV is &gt;0 because criteria exist */</span>
00799         test=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m16">m_excludeList</a>;
00800         filter+=<span class="charliteral">'('</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>;
00801         <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">" != '"</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" == '"</span>;
00802         filter+=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m12">m_listValS</a>[0]+<span class="stringliteral">"')"</span>;
00803         <span class="keywordflow">for</span> (j=1; j&lt;nbV; j++) {
00804           <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">" &amp;&amp; "</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" || "</span>;
00805           filter+=<span class="charliteral">'('</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>;
00806           <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">" != '"</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" == '"</span>;
00807           filter+=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m12">m_listValS</a>[j]+<span class="stringliteral">"')"</span>;
00808         }
00809         <span class="keywordflow">if</span> ((!<a class="code" href="classcatalog_access_1_1_catalog.html#o18">m_criteriaORed</a>) &amp;&amp; (!readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m19">m_cutORed</a>)) probCase=<span class="keyword">true</span>;
00810       }
00811       <span class="keywordflow">else</span> {
00812         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m18">m_rejectNaN</a> == <span class="keyword">false</span>) {
00813           filter+=<span class="stringliteral">"isnull("</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>+<span class="stringliteral">") || "</span>;  
00814           <span class="comment">/* can put OR because criteria exist */</span>
00815           <span class="comment">/* AND has higher priority than OR, needn't parenthesis (isnull...)*/</span>
00816         }
00817         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m13">m_lowerCut</a> &lt; <a class="code" href="quantity_8h.html#a0">NO_SEL_CUT</a>) {
00818           filter+=<span class="charliteral">'('</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>+<span class="stringliteral">" &gt;= "</span>;          
00819           sprintf(value, <span class="stringliteral">"%.9E"</span>, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m13">m_lowerCut</a>);
00820           filter+=value; filter+=<span class="charliteral">')'</span>;
00821           test=<span class="keyword">true</span>;
00822         }
00823         <span class="keywordflow">else</span> test=<span class="keyword">false</span>;
00824         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m14">m_upperCut</a> &lt; <a class="code" href="quantity_8h.html#a0">NO_SEL_CUT</a>) {
00825           <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">" &amp;&amp; "</span>;
00826           filter+=<span class="charliteral">'('</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>+<span class="stringliteral">" &lt;= "</span>;          
00827           sprintf(value, <span class="stringliteral">"%.9E"</span>, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m14">m_upperCut</a>);
00828           filter+=value; filter+=<span class="charliteral">')'</span>;
00829           test=<span class="keyword">true</span>;
00830         }
00831         nbV=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m15">m_listValN</a>.size();
00832         <span class="keywordflow">if</span> (nbV) { 
00833           <span class="keywordflow">if</span> (test) {
00834             <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m19">m_cutORed</a>) filter+=<span class="stringliteral">" || ("</span>; <span class="keywordflow">else</span> filter+=<span class="stringliteral">" &amp;&amp; ("</span>;
00835           }
00836           <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m16">m_excludeList</a>) filter+=<span class="stringliteral">"!("</span>;
00837           filter+=<span class="stringliteral">"near("</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>+<span class="stringliteral">", "</span>;
00838           rVal=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m15">m_listValN</a>[0];
00839           sprintf(value, <span class="stringliteral">"%.9E"</span>, rVal);
00840           filter+=value; filter+=<span class="stringliteral">", "</span>;
00841           <span class="keywordflow">if</span> (fabs(rVal) &gt; NearZero) rVal*=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m17">m_precision</a>;
00842           <span class="keywordflow">else</span> rVal=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m17">m_precision</a>;
00843           sprintf(value, <span class="stringliteral">"%.9E"</span>, rVal);
00844           filter+=value; filter+=<span class="charliteral">')'</span>;
00845           <span class="keywordflow">for</span> (j=1; j&lt;nbV; j++) {
00846             filter+=<span class="stringliteral">" || near("</span>+readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>+<span class="stringliteral">", "</span>;
00847             rVal=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m15">m_listValN</a>[j];
00848             sprintf(value, <span class="stringliteral">"%.9E"</span>, rVal);
00849             filter+=value; filter+=<span class="stringliteral">", "</span>;
00850             <span class="keywordflow">if</span> (fabs(rVal) &gt; NearZero) rVal*=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m17">m_precision</a>;
00851             <span class="keywordflow">else</span> rVal=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m17">m_precision</a>;
00852             sprintf(value, <span class="stringliteral">"%.9E"</span>, rVal);
00853             filter+=value; filter+=<span class="charliteral">')'</span>;
00854           }
00855           <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m16">m_excludeList</a>) filter+=<span class="stringliteral">")"</span>;
00856           <span class="keywordflow">if</span> (test) filter+=<span class="stringliteral">")"</span>;
00857         }
00858       }
00859       filter+=<span class="charliteral">')'</span>;
00860     }
00861     <span class="keywordflow">if</span> (probCase) <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin,
00862       <span class="stringliteral">"filter (for binary fits) is NOT case sensitive for string"</span>);
00863   }
00864   <span class="keywordflow">try</span> {
00865     myDOL=IFileSvc::instance().readTable(fileName, ext, filter);
00866   }
00867   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00868     sortie &lt;&lt; <span class="stringliteral">": FITS is TABLE, but cfitsio returned error="</span> &lt;&lt; x.code();
00869     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00870     <span class="keyword">delete</span> myDOL;
00871     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00872   }
00873   <span class="keywordflow">try</span> {
00874     max=myDOL-&gt;getValidFields().size();
00875     <a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>=myDOL-&gt;getNumRecords();
00876   }
00877   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00878     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, cannot get number of rows or columns"</span>);
00879     <span class="keyword">delete</span> myDOL;
00880     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00881   }
00882   <span class="keywordflow">if</span> (max &lt; 1) {
00883     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">": fits EXTENSION, need at least 1 column"</span>);
00884     <span class="keyword">delete</span> myDOL;
00885     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00886   }
00887   <span class="comment">/* beware some initial quantities can be skipped */</span>
00888   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size() != max) {
00889     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, number of fields ("</span> &lt;&lt; max;
00890     sortie &lt;&lt; <span class="stringliteral">") differ from previous import call ("</span>;
00891     sortie &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size() &lt;&lt; <span class="stringliteral">")"</span>;
00892     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
00893     <span class="keyword">delete</span> myDOL;
00894     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00895   }
00896 <span class="comment">//std::cout &lt;&lt; "Initial number of COL = " &lt;&lt; max &lt;&lt; std::endl;</span>
00897   <span class="keyword">const</span> Header &amp;header=myDOL-&gt;getHeader();
00898   std::string text, unit, mot, rescale, form;
00899   <span class="keywordtype">int</span>  err=0;
00900   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
00901   std::vector&lt;double&gt; colNull(max, 0.0);
00902   std::vector&lt;Quantity&gt;::iterator itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin();
00903   <span class="keywordflow">try</span> {
00904     <span class="keyword">const</span> IColumn *myCol = 0;
00905     <span class="keywordflow">for</span> (i=0; i &lt; max; i++) {
00906       text=<span class="stringliteral">"start"</span>;
00907       rescale=<span class="stringliteral">""</span>;
00908       myCol=myDOL-&gt;getColumn(i);
00909       text=myCol-&gt;getId();
00910       unit=myCol-&gt;getUnits();
00911       sprintf(name, <span class="stringliteral">"TNULL%d"</span>, i+1); mot=name;
00912       <span class="keywordflow">try</span> { header.getKeyword(mot, rescale); }
00913       <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00914       colNull.at(i)=atof(rescale.c_str());
00915       <span class="keywordflow">if</span> ( !rescale.empty() ) {
00916           form=<span class="stringliteral">""</span>;
00917           sprintf(name, <span class="stringliteral">"TSCAL%d"</span>, i+1); mot=name;
00918           <span class="keywordflow">try</span> { header.getKeyword(mot, form); }
00919           <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00920           rescale+=<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>+form;
00921           <span class="keywordflow">if</span> ( !form.empty() ) colNull.at(i)*=atof(form.c_str());
00922           form=<span class="stringliteral">""</span>;
00923           sprintf(name, <span class="stringliteral">"TZERO%d"</span>, i+1); mot=name;
00924           <span class="keywordflow">try</span> { header.getKeyword(mot, form); }
00925           <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {}
00926           rescale+=<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>+form;
00927           <span class="keywordflow">if</span> ( !form.empty() ) colNull.at(i)+=atof(form.c_str());
00928       }
00929       sprintf(name, <span class="stringliteral">"TFORM%d"</span>, i+1);
00930       mot=name; <span class="comment">/* convert C string to C++ string */</span>
00931       header.getKeyword(mot, form);
00932       <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>[i]) {
00933 <span class="comment">//std::cout &lt;&lt; itQ-&gt;m_index &lt;&lt; " ";</span>
00934         <span class="keywordflow">if</span> ( (text!=itQ-&gt;m_name) || (unit!=itQ-&gt;m_unit)
00935             || (rescale!=itQ-&gt;m_null) || (form!=itQ-&gt;m_format) ) {
00936           text=<span class="stringliteral">""</span>;
00937           <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">"fileDiff"</span>);
00938         }
00939         <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::STRING) err++;
00940         itQ++;
00941       }
00942     }<span class="comment">/* loop on columns */</span>
00943   }
00944   <span class="keywordflow">catch</span> (...) {
00945     <span class="keywordflow">if</span> ( text.empty() ) {
00946       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, column#"</span>;
00947       sortie &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">" differ from previous import call"</span>;
00948       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00949       err=<a class="code" href="namespacecatalog_access.html#a37a19">BAD_FILETYPE</a>;
00950     }
00951     <span class="keywordflow">else</span> {
00952       sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, error reading TABLE column#"</span>;
00953       sortie &lt;&lt; i+1 &lt;&lt; <span class="stringliteral">" description"</span>;
00954       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00955       err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
00956     }
00957     <span class="keyword">delete</span> myDOL;
00958     <span class="keywordflow">return</span> err;
00959   }
00960 <span class="comment">//std::cout &lt;&lt; std::endl;</span>
00961 <span class="comment">//std::cout &lt;&lt; m_numOriRows &lt;&lt; " OriRows" &lt;&lt; std::endl;</span>
00962   <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=0;
00963   <span class="keywordflow">if</span> ( !*maxRows ) *maxRows=<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a>;
00964   <span class="keywordflow">if</span> ( !<a class="code" href="classcatalog_access_1_1_catalog.html#o14">m_numOriRows</a> ) <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00965 
00966   <a class="code" href="classcatalog_access_1_1_catalog.html#c12">create_tables</a>(err, *maxRows);
00967   <span class="keywordflow">try</span> {
00968     <span class="keywordtype">double</span> rowVal;
00969     <span class="comment">// max=m_quantities.size();</span>
00970     <span class="keywordflow">for</span> (Table::ConstIterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end();
00971          ++itor, ++<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>) {
00972       err=0;
00973       <span class="keywordflow">for</span> (itQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.begin(); itQ != <a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.end(); ++itQ, ++err) {
00974         i=itQ-&gt;m_index;
00975         <span class="keywordflow">if</span> (itQ-&gt;m_type == Quantity::NUM) {
00976           rowVal=(*itor)[itQ-&gt;m_name].get();
00977           <span class="keywordflow">if</span> ( itQ-&gt;m_null.empty() ) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=rowVal;
00978           <span class="keywordflow">else</span> {
00979             <span class="keywordflow">if</span> (rowVal == colNull[err]) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=MissNAN;
00980             <span class="keywordflow">else</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>)=rowVal;
00981           }
00982         }
00983         <span class="keywordflow">else</span> (*itor)[itQ-&gt;m_name].get(<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].at(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>) );
00984       }
00985     }<span class="comment">/* loop on rows*/</span>
00986   }
00987   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
00988     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot read after row#"</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>+1;
00989     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
00990     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a24">BAD_ROW</a>;
00991   }
00992   <span class="keyword">delete</span> myDOL;
00993   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
00994 }
00995 <span class="comment">/**********************************************************************/</span>
00996 <span class="comment">/* PRIVATE METHOD loadSelected is in file "catalog_ioText.cxx"        */</span>
00997 <span class="comment">/**********************************************************************/</span>
00998 <span class="comment">// if a catalog description was already loaded, this method does</span>
00999 <span class="comment">// the same as import() adding selection criteria for loading</span>
<a name="l01000"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a10">01000</a> <span class="keywordtype">int</span> Catalog::importSelected(std::string &amp;filter) {
01001 
01002   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"importSelected"</span>;
01003   <span class="keywordtype">int</span> quantSize=<a class="code" href="classcatalog_access_1_1_catalog.html#c24">checkImport</a>(origin, <span class="keyword">true</span>);
01004   <span class="keywordflow">if</span> (quantSize &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> quantSize;
01005 
01006   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> &gt; 0) {
01007     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, <span class="stringliteral">"call 'deleteContent' before 'importSelected'"</span>);
01008     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a15">IMPORT_BIS</a>;
01009   }
01010   <span class="keywordtype">int</span> i, err=0,
01011       maxSize=<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>.size();
01012   <span class="keywordflow">for</span> (i=0; i&lt;maxSize; i++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o11">m_loadQuantity</a>[i]) err++;
01013   <span class="keywordflow">if</span> (err &lt; 2) {
01014     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">"at least 2 quantities must be selected for import"</span>);
01015     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a33">BAD_SEL_QUANT</a>;
01016   }
01017   filter=<span class="stringliteral">""</span>;
01018   std::ostringstream sortie; 
01019   sortie &lt;&lt; err &lt;&lt; <span class="stringliteral">" quantities (over "</span> &lt;&lt; maxSize &lt;&lt; <span class="stringliteral">") selected for import"</span>;
01020   <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, sortie.str());
01021   sortie.str(<span class="stringliteral">""</span>); <span class="comment">// Will empty the string</span>
01022   <span class="keywordflow">if</span> (err != quantSize) {
01023     <span class="comment">// in fact, due to select*Quantities() restrictions,</span>
01024     <span class="comment">// quantSize can only be greater than err</span>
01025     <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(2, <span class="stringliteral">"Erasing unwanted quantities for importSelected()"</span>);
01026     <a class="code" href="classcatalog_access_1_1_catalog.html#c1">deleteQuantities</a>();
01027   }
01028   err=<a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>;
01029   std::string text;
01030   <span class="keywordtype">long</span> maxRows=0l;
01031   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos=<a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>.find(0x0A);
01032   <span class="keywordflow">if</span> (pos == std::string::npos) {
01033 
01034     <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>.empty() ) {
01035       <span class="comment">// data must be querried via web</span>
01036 
01037 
01038     }
01039     <span class="keywordflow">else</span> {
01040       <span class="keywordflow">if</span> (!<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>) {
01041         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, <span class="stringliteral">"file import was not succesful"</span>);
01042         <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a16">IMPORT_NEED</a>;
01043       }
01044       std::fstream myFile (<a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>.c_str(), std::ios::in);
01045       <span class="comment">// file can be opened ?</span>
01046       <span class="keywordflow">if</span> ( !myFile.is_open() ) {
01047         text=<span class="stringliteral">": FILENAME \""</span>+<a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>+<span class="stringliteral">"\" cannot be opened"</span>;
01048         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01049         err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01050         <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
01051         <span class="keywordflow">return</span> err;
01052       }
01053       <span class="comment">// go back to initial position</span>
01054       myFile.clear(); <span class="comment">// needed to reset flags before seekg</span>
01055       myFile.seekg(<a class="code" href="classcatalog_access_1_1_catalog.html#o7">m_filePos</a>);
01056       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tot=0ul; <span class="comment">// number of data lines read</span>
01057       err=<a class="code" href="classcatalog_access_1_1_catalog.html#c21">loadSelected</a>(&amp;tot, &amp;myFile, &amp;maxRows);
01058       <span class="keywordflow">if</span> (err == <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>) {
01059         sortie &lt;&lt; tot &lt;&lt; <span class="stringliteral">" data lines read for importSelected()"</span>;
01060         <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(0, sortie.str());
01061       }
01062       myFile.close();
01063     }
01064 
01065   }
01066   <span class="keywordflow">else</span> { <span class="comment">//fits file</span>
01067 
01068     text=<a class="code" href="classcatalog_access_1_1_catalog.html#o6">m_filename</a>;
01069     std::string fileName=text.substr(0, pos);
01070     text.erase(0, pos+1);
01071     <span class="keyword">const</span> Extension *myEXT = 0;
01072     <span class="comment">// cannot use readTable because FITS IMAGE returns also error 1</span>
01073     <span class="keywordflow">try</span> {
01074       myEXT=IFileSvc::instance().readExtension(fileName, text);
01075     }
01076     <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01077       err=x.code();
01078       <span class="keywordflow">if</span> (err == 1) {
01079         <span class="comment">// This non-cfitsio error number means the file does not exist</span>
01080         <span class="comment">// or is not a table, or is not either Root nor Fits format. </span>
01081         sortie &lt;&lt; <span class="stringliteral">": FILENAME \""</span> &lt;&lt; fileName;
01082         sortie &lt;&lt; <span class="stringliteral">"\" cannot be opened or is NOT fits"</span>;
01083         err=<a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01084       }
01085       <span class="keywordflow">else</span> {
01086         <span class="comment">// Other errors come from cfitsio, but apply to a file</span>
01087         <span class="comment">// which is in FITS format but has some sort of format error.</span>
01088         sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but cfitsio returned error="</span> &lt;&lt; err;
01089         err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
01090       }
01091     }
01092     <span class="keywordflow">if</span> (err &gt;= <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) {
01093       <span class="keywordflow">if</span> ( !myEXT-&gt;isTable() ) {
01094         sortie &lt;&lt; <span class="stringliteral">": FILENAME is FITS, but NOT a TABLE"</span>;
01095         err=<a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
01096       }
01097     }
01098     <span class="keyword">delete</span> myEXT;
01099     <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) {
01100       <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str());
01101       <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
01102       <span class="keywordflow">return</span> err;
01103     }
01104     err=<a class="code" href="classcatalog_access_1_1_catalog.html#c20">loadSelectFits</a>(fileName, text, &amp;maxRows, filter);
01105 
01106   }
01107   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) {
01108     <a class="code" href="classcatalog_access_1_1_catalog.html#a23">deleteContent</a>(); <span class="comment">// to erase data already loaded in memory</span>
01109     <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>=err;
01110     <span class="keywordflow">return</span> err;
01111   }
01112   <span class="keywordflow">try</span> {
01113     <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> &lt; maxRows) {
01114       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>.size();
01115       <span class="comment">// erase unused memory  printf("ERASING\n")</span>
01116       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
01117       err=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>.size();
01118       <span class="keywordflow">for</span> (i=0; i&lt;err; i++) <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].resize(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
01119     }
01120     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size()+2;
01121     <span class="comment">// number of required bits including global and region</span>
01122     maxSize=<span class="keyword">sizeof</span>(long)*8;
01123     err=1+(err-1)/maxSize;
01124     <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>.resize(err);
01125 <span class="preprocessor">    #ifdef DEBUG_CAT</span>
01126 <span class="preprocessor"></span>    std::cout &lt;&lt; <span class="stringliteral">"Number of unsigned long required for m_rowIsSelected = "</span>
01127               &lt;&lt; err &lt;&lt; std::endl;
01128 <span class="preprocessor">    #endif</span>
01129 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_numRows) {
01130       std::vector&lt;bool&gt; isSelected;
01131       <span class="keywordflow">if</span> ( <a class="code" href="classcatalog_access_1_1_catalog.html#c2">existCriteria</a>(&amp;isSelected) ) {
01132 
01133         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> quantBit;
01134         <span class="keywordtype">int</span> j, k;
01135         quantSize=isSelected.size();
01136         <span class="keywordflow">if</span> ((<a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a> == <span class="stringliteral">"CDS"</span>) || (m_criteriaORed)) {
01137           <span class="keywordflow">for</span> (j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>, 0);
01138           <span class="comment">/* for the moment, no selection applied */</span>
01139           std::vector&lt;std::string&gt; list;
01140           std::string mot;
01141           <span class="keywordtype">int</span> nbV, (*pfunc)(int)=tolower; <span class="comment">// function used by transform</span>
01142           <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
01143           <span class="keywordtype">double</span>   myVal, precis;
01144           <span class="keywordtype">bool</span>     check, reject;
01145           <span class="keywordflow">for</span> (i=1; i&lt;quantSize; i++) <span class="keywordflow">if</span> (isSelected[i]) {
01146             readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[i-1];
01147             quantBit=<a class="code" href="classcatalog_access_1_1_catalog.html#c29">bitPosition</a>(i-1, &amp;k);
01148 <span class="comment">//std::cout &lt;&lt; m_criteriaORed &lt;&lt;"byte #"&lt;&lt; k &lt;&lt; " unsigned long="&lt;&lt;quantBit;</span>
01149             <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a> == Quantity::STRING) {
01150               nbV=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m12">m_listValS</a>.size(); <span class="comment">/* &gt;0 because criteria exist */</span>
01151               list.assign(nbV, <span class="stringliteral">""</span>);
01152               <span class="keywordflow">for</span> (j=0; j&lt;nbV; j++) {
01153                 mot=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m12">m_listValS</a>.at(j);
01154                 <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m19">m_cutORed</a>)
01155                   transform(mot.begin(), mot.end(), mot.begin(), pfunc);
01156                 list.at(j)=mot;
01157               }
01158               <span class="keywordflow">for</span> (maxRows=0; maxRows&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>; maxRows++) {
01159                 mot=<a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m7">m_index</a>].at(maxRows);
01160                 <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m19">m_cutORed</a>)
01161                   transform(mot.begin(), mot.end(), mot.begin(), pfunc);
01162                 check=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m16">m_excludeList</a>;
01163                 <span class="keywordflow">for</span> (j=0; j&lt;nbV; j++) {
01164                   <span class="keywordflow">if</span> (mot == list[j]) {check=!readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m16">m_excludeList</a>; <span class="keywordflow">break</span>;}
01165                 }
01166                 <span class="comment">// setting required bit</span>
01167                 <span class="keywordflow">if</span> (check)
01168                   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[k].at(maxRows)|= quantBit;
01169                 <span class="keywordflow">else</span>
01170                   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[k].at(maxRows)&amp;= (Max_Test-quantBit);
01171               }
01172             }
01173             <span class="keywordflow">else</span> { <span class="comment">// numerical quantity</span>
01174               j=i-1;
01175               nbV=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m7">m_index</a>;
01176               reject=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m18">m_rejectNaN</a>;
01177               precis=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m17">m_precision</a>;
01178               <span class="keywordflow">for</span> (maxRows=0; maxRows&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>; maxRows++) {
01179                 myVal=<a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[nbV].at(maxRows);
01180                 <span class="keywordflow">if</span> (!readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m19">m_cutORed</a>) <span class="comment">// usual case</span>
01181                   check=<a class="code" href="classcatalog_access_1_1_catalog.html#c4">checkNUM</a>(myVal,j, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m16">m_excludeList</a>,reject,precis);
01182                 <span class="keywordflow">else</span>
01183                   check=<a class="code" href="classcatalog_access_1_1_catalog.html#c5">checkNUMor</a>(myVal,j, reject,precis);
01184                 <span class="comment">// setting required bit</span>
01185                 <span class="keywordflow">if</span> (check)
01186                   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[k].at(maxRows)|= quantBit;
01187                 <span class="keywordflow">else</span>
01188                   <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[k].at(maxRows)&amp;= (Max_Test-quantBit);
01189               }<span class="comment">// loop on rows</span>
01190             }
01191           }<span class="comment">/*loop on selected quantities */</span>
01192           <a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>=0;
01193           <span class="keywordflow">for</span> (maxRows=0; maxRows&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>; maxRows++) {
01194             <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#c6">rowSelect</a>(maxRows, isSelected) == <span class="keyword">true</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>++;
01195           }
01196         }
01197         <span class="keywordflow">else</span> {<span class="comment">// from binary fits, only if criteria ANDed</span>
01198           <a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>=<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>;
01199           <span class="comment">/* easy, as criteria are ANDed: bit to 1 */</span>
01200           std::vector&lt;unsigned long&gt; selBits(err, 0);
01201           selBits[0]=1ul;
01202           j=0;
01203           quantBit=2ul;
01204           <span class="keywordflow">for</span> (i=0; i&lt;quantSize; ) {
01205             <span class="keywordflow">if</span> (isSelected[i]) selBits[j]|=quantBit;
01206             <span class="keywordflow">if</span> ((++i % maxSize) == 0) {
01207               quantBit=1ul; <span class="comment">// first bit</span>
01208               j++;          <span class="comment">// of next vector index.</span>
01209             }
01210             <span class="keywordflow">else</span> quantBit*=2ul;
01211           }
01212 <span class="comment">//std::cout &lt;&lt; m_criteriaORed &lt;&lt;"first unsigned long selection="&lt;&lt; selBits[0];</span>
01213           <span class="keywordflow">for</span> (j=0; j&lt;err; j++)
01214             <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>, selBits[j]);
01215         }
01216         <span class="keywordflow">if</span> (m_selRegion) {
01217           sortie &lt;&lt; origin &lt;&lt; <span class="stringliteral">", selecting region from "</span> &lt;&lt; <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>;
01218           sortie &lt;&lt; <span class="stringliteral">" loaded rows"</span>;
01219           <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, sortie.str());
01220           <span class="keywordtype">int</span> nRA =<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o27">m_indexRA</a>].m_index,
01221               nDEC=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[<a class="code" href="classcatalog_access_1_1_catalog.html#o28">m_indexDEC</a>].m_index;
01222           <span class="keywordtype">bool</span> check;
01223           <span class="keywordflow">for</span> (maxRows=0; maxRows&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>; maxRows++) {
01224             check=<a class="code" href="classcatalog_access_1_1_catalog.html#c3">checkRegion</a>(maxRows, nRA, nDEC);
01225             <span class="keywordflow">if</span> (!check) {<span class="comment">// setting 2nd bit to 0</span>
01226               <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[0].at(maxRows)&amp;=(Max_Test-2ul);
01227               <span class="keywordflow">if</span> (!<a class="code" href="classcatalog_access_1_1_catalog.html#o18">m_criteriaORed</a>) {<span class="comment">// setting 1st bit to 0</span>
01228                 <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[0].at(maxRows)&amp;=(Max_Test-1ul);
01229                 <a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>--;
01230               }
01231               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#c6">rowSelect</a>(maxRows, isSelected) == <span class="keyword">false</span>) <a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>--;
01232             }
01233           }<span class="comment">/* loop on rows */</span>
01234         }
01235         <a class="code" href="classcatalog_access_1_1_catalog.html#a67">eraseNonSelected</a>();
01236 
01237       }
01238       <span class="keywordflow">else</span>  <span class="comment">// lines can be commented to test the try catch mechanism</span>
01239         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;err; j++) <a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[j].assign(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>, 0);
01240     }<span class="comment">/* row exist ==&gt; MUST create selection array */</span>
01241   }
01242   <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;prob) {
01243     std::string text;
01244     text=std::string(<span class="stringliteral">"EXCEPTION filling m_rowIsSelected: "</span>)+prob.what();
01245     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(<span class="stringliteral">"import"</span>, text);
01246     <span class="keywordflow">throw</span>;
01247   }
01248   <span class="keywordflow">return</span> <a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>;
01249 }
01250 
01251 
01252 <span class="comment">/**********************************************************************/</span>
01253 <span class="comment">// create catalog header from memory to a FITS file</span>
<a name="l01254"></a><a class="code" href="classcatalog_access_1_1_catalog.html#c23">01254</a> <span class="keywordtype">int</span> Catalog::createFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string &amp;extName,
01255                         <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append, <span class="keyword">const</span> std::string origin,
01256                         tip::Table **ptrTable) {
01257 
01258   <span class="keywordtype">char</span> name[9]; <span class="comment">/* 8 char maximum for header key */</span>
01259   std::string text, newName;
01260   <span class="keywordtype">int</span>  j, err;
01261   <span class="keywordtype">bool</span> create=<span class="keyword">true</span>;
01262 
01263   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c24">checkImport</a>(origin, <span class="keyword">true</span>);
01264   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
01265 
01266   err=fileName.length();
01267   <span class="keywordflow">if</span> (err == 0) {
01268     text=<span class="stringliteral">": FILENAME is EMPTY"</span>;
01269     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01270     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01271   }
01272   <span class="keywordflow">if</span> (extName.length() &gt; 68) {
01273     text=<span class="stringliteral">": EXTENSION name is TOO long (limited to 68 characters)"</span>;
01274     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01275     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01276   }
01277   <span class="comment">// overwrite existing file ?</span>
01278   <span class="keywordflow">if</span> (!clobber) {
01279     std::fstream file;
01280     file.open(fileName.c_str(), std::ios::in);
01281     <span class="keywordflow">if</span> (file) {
01282       file.close();
01283       create=<span class="keyword">false</span>;
01284       <span class="keywordflow">if</span> (!append) {
01285         text=<span class="stringliteral">": FILENAME \""</span>+fileName+<span class="stringliteral">"\" exist (clobber=no, append=no)"</span>;
01286         <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01287         <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a18">BAD_FILENAME</a>;
01288       }
01289       <span class="keywordflow">else</span> {
01290         text=<span class="stringliteral">"appending extension to existing FILENAME (method "</span>+origin+<span class="stringliteral">")"</span>;
01291         <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(1, text);
01292       }
01293     }
01294   }
01295   <span class="keywordflow">if</span> ( extName.empty() ) {
01296     <span class="comment">/* max length is 68, as keyword value starts/ends with ' in 11/80 */</span>
01297     newName=<a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>.substr(0,68);
01298     <span class="comment">/* replace forbidden char. */</span>
01299     err=newName.length();
01300     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01301       <span class="keywordflow">if</span> (newName[j] == <span class="charliteral">'/'</span>) newName[j]=<span class="charliteral">'_'</span>;
01302     }
01303     text=<span class="stringliteral">"EXTENSION name set to '"</span>+newName+<span class="stringliteral">"'"</span>;
01304     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, text); 
01305     err=<a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
01306   }
01307   <span class="keywordflow">else</span> newName=extName;
01308 
01309   <span class="keywordflow">try</span> {
01310     <span class="keywordflow">if</span> (create) IFileSvc::instance().createFile(fileName);
01311     IFileSvc::instance().appendTable(fileName, newName);
01312     (*ptrTable)=IFileSvc::instance().editTable(fileName, newName);
01313   }
01314   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01315     text=<span class="stringliteral">": cannot append and edit fits EXTENSION"</span>;
01316     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01317     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
01318   }
01319   Header &amp;header=(*ptrTable)-&gt;getHeader();
01320   <span class="keywordflow">try</span> {
01321     header.setKeyword(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0], <a class="code" href="classcatalog_access_1_1_catalog.html#o2">m_catName</a>);
01322     header.setKeyComment(<a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[0], <a class="code" href="namespacecatalog_access.html#a2">KeyCatal</a>[1]);
01323     header.setKeyword(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0], <a class="code" href="classcatalog_access_1_1_catalog.html#o4">m_tableName</a>);
01324     header.setKeyComment(<a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[0], <a class="code" href="namespacecatalog_access.html#a3">KeyTable</a>[1]);
01325     <span class="comment">/* test </span>
01326 <span class="comment">    header.setKeyUnit(KeyTable[0], "deg");*/</span>
01327   }
01328   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01329     text=<span class="stringliteral">"fits EXTENSION, cannot add CDS header keys"</span>;
01330     <a class="code" href="namespacecatalog_access.html#a35">printWarn</a>(origin, text);
01331   }
01332   <span class="keywordflow">try</span> {
01333     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos;
01334     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01335     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01336       <span class="keyword">const</span> <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> &amp;readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01337       <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a> == Quantity::NUM) {
01338         <span class="keywordflow">if</span> ( !readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>.empty() ) {
01339           sprintf(name, <span class="stringliteral">"TNULL%d"</span>, j+1);
01340           newName=name; <span class="comment">/* convert C string to C++ string */</span>
01341           text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>;
01342           <span class="comment">// to be improved for integers</span>
01343         }
01344         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o1">m_URL</a> == <span class="stringliteral">"CDS"</span>) text=<span class="stringliteral">"1D"</span>;
01345         <span class="keywordflow">else</span> text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>;
01346       }
01347       <span class="keywordflow">else</span> {
01348         text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>;
01349         <span class="keywordflow">if</span> ( isalpha(readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m3">m_format</a>[0]) ) {
01350           text.erase(0,1);
01351           text=text+<span class="stringliteral">"A"</span>;
01352         }
01353       }
01354       (*ptrTable)-&gt;appendField(readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>, text);
01355       text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>;
01356       <span class="keywordflow">if</span> ( !text.empty() ) {
01357         header.setKeyword(newName, atoi(text.c_str()) );
01358         header.setKeyComment(newName, <span class="stringliteral">"Undefined value of field"</span>);
01359         pos=text.find(<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>); <span class="comment">/* always exist */</span>
01360         text.erase(0, pos+1);
01361         pos=text.find(<a class="code" href="namespacecatalog_access.html#a5">SepNull</a>);
01362         <span class="keywordflow">if</span> (pos &gt; 0) {
01363           sprintf(name, <span class="stringliteral">"TSCAL%d"</span>, j+1);
01364           newName=name; <span class="comment">/* convert C string to C++ string */</span>
01365           header.setKeyword(newName, atoi(text.c_str()) );
01366           header.setKeyComment(newName, <span class="stringliteral">"to rescale data"</span>);
01367         }
01368         text.erase(0, pos+1);
01369         <span class="keywordflow">if</span> ( !text.empty() ) {
01370           sprintf(name, <span class="stringliteral">"TZERO%d"</span>, j+1);
01371           newName=name; <span class="comment">/* convert C string to C++ string */</span>
01372           header.setKeyword(newName, atoi(text.c_str()) );
01373           header.setKeyComment(newName, <span class="stringliteral">"offset for unsigned integers"</span>);
01374         }
01375       }
01376       text=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m6">m_unit</a>;
01377       <span class="keywordflow">if</span> ( !text.empty() ) {
01378         sprintf(name, <span class="stringliteral">"TUNIT%d"</span>, j+1);
01379         newName=name; <span class="comment">/* convert C string to C++ string */</span>
01380         header.setKeyword(newName, text);
01381         header.setKeyComment(newName, <span class="stringliteral">"physical unit of field"</span>);
01382       }
01383       sprintf(name, <span class="stringliteral">"%s%d"</span>, <a class="code" href="namespacecatalog_access.html#a4">Key_UCD</a>.c_str(), j+1);
01384       newName=name; <span class="comment">/* convert C string to C++ string */</span>
01385       header.setKeyword(newName, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m2">m_ucd</a>);
01386       header.setKeyComment(newName, readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m1">m_comment</a>);
01387     }<span class="comment">/* loop on quantities */</span>
01388   }
01389   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01390     text=<span class="stringliteral">": fits EXTENSION, cannot add column"</span>;
01391     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, text);
01392     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a20">BAD_FITS</a>;
01393   }
01394 <span class="comment">/* NEED new tip methods</span>
01395 <span class="comment">  const IColumn *myCol = 0;</span>
01396 <span class="comment">  try {</span>
01397 <span class="comment">    for (j=0; j &lt; err; j++) {</span>
01398 <span class="comment">      const Quantity &amp;readQ=m_quantities[j];</span>
01399 <span class="comment">      myCol=(*ptrTable)-&gt;getColumn(j);</span>
01400 <span class="comment"></span>
01401 <span class="comment">    }</span>
01402 <span class="comment">  }</span>
01403 <span class="comment">  catch (const TipException &amp;x) {</span>
01404 <span class="comment">    text=": fits EXTENSION, cannot modify column description";</span>
01405 <span class="comment">    printErr(origin, text);</span>
01406 <span class="comment">    return BAD_FITS;</span>
01407 <span class="comment">  }</span>
01408 <span class="comment">*/</span>
01409   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
01410 }
01411 <span class="comment">/**********************************************************************/</span>
01412 <span class="comment">// save whole catalog from memory to a FITS file</span>
<a name="l01413"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a13">01413</a> <span class="keywordtype">int</span> Catalog::saveFits(<span class="keyword">const</span> std::string &amp;fileName, <span class="keyword">const</span> std::string &amp;extName,
01414                       <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append) {
01415 
01416   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveFits"</span>;
01417   Table *myDOL=0;
01418   <span class="keywordtype">int</span> err;
01419   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c23">createFits</a>(fileName, extName, clobber, append, origin, &amp;myDOL);
01420   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
01421 
01422   std::ostringstream sortie;
01423   <span class="keywordtype">long</span> tot=0l;
01424   <span class="keywordtype">int</span>  i, j;
01425 
01426   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a> &gt; 0) {
01427   <span class="keywordflow">try</span> {
01428     myDOL-&gt;setNumRecords(<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>);
01429     <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
01430     <span class="keywordtype">double</span> rowVal;
01431     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01432     std::vector&lt;long&gt; colNull(err, 0);
01433     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01434       readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01435       colNull[j]=atoi( readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>.c_str() );
01436     }
01437     <span class="comment">// Loop over all records (rows) and set values</span>
01438     <span class="keywordflow">for</span> (Table::Iterator itor=myDOL-&gt;begin(); itor != myDOL-&gt;end(); ++itor) {
01439       <span class="comment">// double variable to hold the value of all the numeric fields</span>
01440       <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01441         readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01442         i=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m7">m_index</a>;
01443         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a> == Quantity::NUM) {
01444           rowVal= <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(tot);
01445           <span class="keywordflow">if</span> ( readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>.empty() ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set(rowVal);
01446           <span class="keywordflow">else</span> {
01447             <span class="keywordflow">if</span> ( isnan(rowVal) ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set(colNull[j]);
01448             <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set(rowVal);
01449           }
01450         }
01451         <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set( <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].at(tot) );
01452       }
01453       tot++;
01454     }<span class="comment">/* loop on rows */</span>
01455   }
01456   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01457     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot write at row#"</span> &lt;&lt; tot;
01458     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
01459     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a24">BAD_ROW</a>;
01460   }<span class="comment">/* end of try */</span>
01461   }<span class="comment">/* at least 1 row */</span>
01462 
01463   <span class="keyword">delete</span> myDOL; myDOL=0;
01464   sortie &lt;&lt; <span class="stringliteral">"output fits is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" rows written)"</span>;
01465   <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(0, sortie.str());
01466   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
01467 }
01468 <span class="comment">/**********************************************************************/</span>
01469 <span class="comment">// save selected rows of catalog from memory to a FITS file</span>
<a name="l01470"></a><a class="code" href="classcatalog_access_1_1_catalog.html#a14">01470</a> <span class="keywordtype">int</span> Catalog::saveSelectedFits(<span class="keyword">const</span> std::string &amp;fileName,
01471                               <span class="keyword">const</span> std::string &amp;extName,
01472                               <span class="keywordtype">bool</span> clobber, <span class="keywordtype">bool</span> append) {
01473 
01474   <span class="keyword">const</span> std::string origin=<span class="stringliteral">"saveSelectedFits"</span>;
01475   Table *myDOL=0;
01476   <span class="keywordtype">int</span> err;
01477   err=<a class="code" href="classcatalog_access_1_1_catalog.html#c23">createFits</a>(fileName, extName, clobber, append, origin, &amp;myDOL);
01478   <span class="keywordflow">if</span> (err &lt; <a class="code" href="namespacecatalog_access.html#a37a14">IS_VOID</a>) <span class="keywordflow">return</span> err;
01479 
01480   std::ostringstream sortie;
01481   <span class="keywordtype">long</span> tot=0l;
01482   <span class="keywordtype">int</span>  i, j;
01483 
01484   <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a> &gt; 0) {
01485   <span class="keywordflow">try</span> {
01486     myDOL-&gt;setNumRecords(<a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>);
01487     <a class="code" href="classcatalog_access_1_1_quantity.html">Quantity</a> readQ;
01488     <span class="keywordtype">double</span> rowVal;
01489     err=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>.size();
01490     std::vector&lt;long&gt; colNull(err, 0);
01491     <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01492       readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01493       colNull[j]=atoi( readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>.c_str() );
01494     }
01495     Table::Iterator itor=myDOL-&gt;begin();
01496     <span class="comment">// Loop over all selected records (rows) and set values</span>
01497     <span class="comment">// first bit indicates global selection</span>
01498     <span class="keywordflow">for</span> (<span class="keywordtype">long</span> k=0; k&lt;<a class="code" href="classcatalog_access_1_1_catalog.html#o15">m_numRows</a>; k++) <span class="keywordflow">if</span> (<a class="code" href="classcatalog_access_1_1_catalog.html#o16">m_rowIsSelected</a>[0].at(k) &amp; 1) {
01499       <span class="keywordflow">for</span> (j=0; j &lt; err; j++) {
01500         readQ=<a class="code" href="classcatalog_access_1_1_catalog.html#o10">m_quantities</a>[j];
01501         i=readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m7">m_index</a>;
01502         <span class="keywordflow">if</span> (readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m5">m_type</a> == Quantity::NUM) {
01503           rowVal= <a class="code" href="classcatalog_access_1_1_catalog.html#o13">m_numericals</a>[i].at(tot);
01504           <span class="keywordflow">if</span> ( readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m4">m_null</a>.empty() ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set(rowVal);
01505           <span class="keywordflow">else</span> {
01506             <span class="keywordflow">if</span> ( isnan(rowVal) ) (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set(colNull[j]);
01507             <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set(rowVal);
01508             <span class="comment">// to be improved for integers</span>
01509           }
01510         }
01511         <span class="keywordflow">else</span> (*itor)[readQ.<a class="code" href="classcatalog_access_1_1_quantity.html#m0">m_name</a>].set( <a class="code" href="classcatalog_access_1_1_catalog.html#o12">m_strings</a>[i].at(tot) );
01512       }
01513       tot++;
01514       itor++;
01515       <span class="keywordflow">if</span> (tot == <a class="code" href="classcatalog_access_1_1_catalog.html#o25">m_numSelRows</a>) <span class="keywordflow">break</span>;
01516     }
01517   }
01518   <span class="keywordflow">catch</span> (<span class="keyword">const</span> TipException &amp;x) {
01519     sortie &lt;&lt; <span class="stringliteral">": fits EXTENSION, cannot write at row#"</span> &lt;&lt; tot;
01520     <a class="code" href="namespacecatalog_access.html#a34">printErr</a>(origin, sortie.str() );
01521     <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a24">BAD_ROW</a>;
01522   }<span class="comment">/* end of try */</span>
01523   }<span class="comment">/* at least 1 selected row */</span>
01524 
01525   <span class="keyword">delete</span> myDOL; myDOL=0;
01526   sortie &lt;&lt; <span class="stringliteral">"output fits is closed ( "</span> &lt;&lt; tot &lt;&lt; <span class="stringliteral">" rows written)"</span>;
01527   <a class="code" href="namespacecatalog_access.html#a36">printLog</a>(0, sortie.str());
01528   <span class="keywordflow">return</span> <a class="code" href="namespacecatalog_access.html#a37a13">IS_OK</a>;
01529 }
01530 
01531 } <span class="comment">// namespace catalogAccess</span>
</pre></div><hr><address style="align: right;"><small>Generated on Wed Jul 13 10:50:51 2005 for catalogAccess by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
